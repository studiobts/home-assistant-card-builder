import{aS as e,aD as t,aC as i,aK as o,aB as n,aG as s,aE as r,aF as l,aH as a,aM as c,aN as d,aT as u,aR as h}from"./card-builder-shared-DM_W7S1D.js";import{d as p,a as v,b as g,m as f,e as b,c as y}from"./card-builder-shared-Ky8KdkrL.js";const m=e("blocks-renderer");function k(e){return"object"==typeof e&&null!==e&&"rules"in e}class S{constructor(e,t={}){this.hass=e,this.options=t}evaluate(e,t={}){var i,o,n,s,r;const{defaultValue:l,defaultEntityId:a}=t,c=(null==(i=e.entity)?void 0:i.slotId)??void 0,d=c?null==(n=(o=this.options).resolveSlotEntity)?void 0:n.call(o,c):void 0,u=c?d:(null==(s=e.entity)?void 0:s.entityId)||a,h=(null==(r=e.entity)?void 0:r.source)||"state",p="state"===h?void 0:h;if(!u)return{value:l??e.default,success:!0};try{const t=function(e,t){if(!t.state)return e.default;switch(e.mode){case"direct":return function(e,t){const i=$(t.state,t.attribute);if(!e.inputRange&&!e.outputRange)return i??e.default;const o=_(i);if(null===o)return e.default;const n=e.inputRange??[0,100],s=e.outputRange??[0,100];return function(e,t,i,o,n){const s=Math.max(t,Math.min(i,e));return o+(s-t)/(i-t)*(n-o)}(o,n[0],n[1],s[0],s[1])}(e,t);case"map":return function(e,t){const i=$(t.state,t.attribute),o=String(i);if(o in e.map)return e.map[o];const n=o.toLowerCase();for(const[s,r]of Object.entries(e.map))if(s.toLowerCase()===n)return r;return e.default}(e,t);case"threshold":return function(e,t){const i=$(t.state,t.attribute),o=_(i);if(null===o)return e.default;const n=function(e,t){for(const i of t){const t=void 0===i.min||e>=i.min,o=void 0===i.max||e<i.max;if(t&&o)return i}return null}(o,e.thresholds);if(n)return n.value;return e.default}(e,t);case"condition":return function(e,t){for(const i of e.conditions){if(x(i.condition,t.getState,t.entityId))return i.value}return e.default}(e,t);case"template":return function(e,t){const i=t.state,o={value:$(i,t.attribute),state:i.state,attributes:i.attributes,entity:i.entity_id,last_changed:i.last_changed,last_updated:i.last_updated},n=function(e,t){if(!e)return"";const i=/\{\{(.+?)\}\}/g;return e.replace(i,(e,i)=>{const o=function(e,t){const i=e.split("|").map(e=>e.trim());let o=function(e,t){switch(e){case"value":return t.value;case"state":return t.state;case"entity":return t.entity;case"last_changed":return t.last_changed;case"last_updated":return t.last_updated}if(e.startsWith("attributes.")){const i=e.slice(11);return function(e,t){const i=t.split(".");let o=e;for(const n of i){if(null==o)return;if("object"!=typeof o)return;o=o[n]}return o}(t.attributes,i)}if(e in t.attributes)return t.attributes[e];return}(i[0],t);for(let n=1;n<i.length;n++){o=B(i[n],o)}return o}(i.trim(),t);return null!=o?String(o):""})}(e.template,o);return n||e.default}(e,t);default:return console.warn(`[ValueResolver] Unknown binding mode: ${e.mode}`),e.default}}(e,{state:this._getEntityState(u),attribute:p,entityId:u,getState:e=>this._getEntityState(e)});return void 0===t?{value:l??e.default,success:!0}:{value:t,success:!0}}catch(v){return console.warn("[BindingEvaluator] Evaluation failed:",v),{value:l??e.default,success:!1,error:v instanceof Error?v.message:"Unknown error"}}}_getEntityState(e){const t=this.hass.states[e];if(t)return{entity_id:t.entity_id,state:t.state,attributes:t.attributes||{},last_changed:t.last_changed,last_updated:t.last_updated,context:t.context}}}function x(e,t,i){return k(e)?function(e,t,i){if(!e.rules||0===e.rules.length)return!0;if("and"===e.operator)return e.rules.every(e=>x(e,t,i));if("or"===e.operator)return e.rules.some(e=>x(e,t,i));return!1}(e,t,i):function(e,t,i){const o=e.entity||i;if(!o)return console.warn("[ConditionEvaluator] No entity specified for condition rule"),!1;const n=t(o);if(!n)return!1;return function(e,t,i){switch(t){case"==":return I(e,i);case"!=":return!I(e,i);case">":return w(e,i,(e,t)=>e>t);case"<":return w(e,i,(e,t)=>e<t);case">=":return w(e,i,(e,t)=>e>=t);case"<=":return w(e,i,(e,t)=>e<=t);case"contains":return function(e,t){if("string"==typeof e&&"string"==typeof t)return e.toLowerCase().includes(t.toLowerCase());if(Array.isArray(e))return e.some(e=>I(e,t));return!1}(e,i);case"in":return function(e,t){if(!Array.isArray(t))return!1;return t.some(t=>I(e,t))}(e,i);default:return console.warn(`[ConditionEvaluator] Unknown operator: ${t}`),!1}}(function(e,t){if(!t||"state"===t)return e.state;if(t.includes("."))return function(e,t){const i=t.split(".");let o=e;for(const n of i){if(null==o)return;if("object"!=typeof o)return;o=o[n]}return o}(e.attributes,t);return e.attributes[t]}(n,e.attribute),e.operator,e.value)}(e,t,i)}function I(e,t){if(e===t)return!0;if("string"==typeof e&&"string"==typeof t)return e.toLowerCase()===t.toLowerCase();if("string"==typeof e&&"number"==typeof t)return parseFloat(e)===t;if("number"==typeof e&&"string"==typeof t)return e===parseFloat(t);if("boolean"==typeof t){if("boolean"==typeof e)return e===t;if("string"==typeof e){const i=e.toLowerCase();return!0===t?"true"===i||"on"===i||"yes"===i||"1"===i:"false"===i||"off"===i||"no"===i||"0"===i}}return!1}function w(e,t,i){const o=C(e),n=C(t);return null!==o&&null!==n&&i(o,n)}function C(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}const E={round:(e,t="0")=>{const i=D(e);if(null===i)return e;const o=parseInt(t,10)||0;return i.toFixed(o)},int:e=>{const t=D(e);return null===t?e:Math.floor(t)},float:(e,t)=>{const i=D(e);if(null===i)return e;if(void 0!==t){const e=parseInt(t,10)||0;return parseFloat(i.toFixed(e))}return i},upper:e=>String(e).toUpperCase(),lower:e=>String(e).toLowerCase(),capitalize:e=>{const t=String(e);return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},title:e=>String(e).split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),default:(e,t="")=>null==e||""===e?t:e,replace:(e,t="",i="")=>String(e).split(t).join(i),truncate:(e,t="20",i="...")=>{const o=String(e),n=parseInt(t,10)||20;return o.length<=n?o:o.slice(0,n-i.length)+i},abs:e=>{const t=D(e);return null===t?e:Math.abs(t)},multiply:(e,t="1")=>{const i=D(e),o=D(t);return null===i||null===o?e:i*o},divide:(e,t="1")=>{const i=D(e),o=D(t);return null===i||null===o||0===o?e:i/o},add:(e,t="0")=>{const i=D(e),o=D(t);return null===i||null===o?e:i+o},subtract:(e,t="0")=>{const i=D(e),o=D(t);return null===i||null===o?e:i-o},percentage:(e,t="0")=>{const i=D(e);if(null===i)return e;const o=parseInt(t,10)||0;return i.toFixed(o)+"%"},relative_time:e=>{if("string"!=typeof e)return e;try{const t=new Date(e),i=(new Date).getTime()-t.getTime(),o=Math.floor(i/1e3),n=Math.floor(o/60),s=Math.floor(n/60),r=Math.floor(s/24);return r>0?`${r}d ago`:s>0?`${s}h ago`:n>0?`${n}m ago`:`${o}s ago`}catch{return e}},timestamp:(e,t="HH:mm")=>{if("string"!=typeof e)return e;try{const i=new Date(e);return t.replace("YYYY",String(i.getFullYear())).replace("MM",String(i.getMonth()+1).padStart(2,"0")).replace("DD",String(i.getDate()).padStart(2,"0")).replace("HH",String(i.getHours()).padStart(2,"0")).replace("mm",String(i.getMinutes()).padStart(2,"0")).replace("ss",String(i.getSeconds()).padStart(2,"0"))}catch{return e}}};function B(e,t){const i=e.match(/^(\w+)(?:\((.+)\))?$/);if(!i)return console.warn(`[TemplateParser] Invalid filter expression: ${e}`),t;const o=i[1],n=i[2],s=E[o];if(!s)return console.warn(`[TemplateParser] Unknown filter: ${o}`),t;const r=n?function(e){const t=[];let i="",o=!1,n="";for(const s of e)'"'!==s&&"'"!==s||o?s===n&&o?(o=!1,n=""):","!==s||o?i+=s:(t.push(i.trim()),i=""):(o=!0,n=s);i.trim()&&t.push(i.trim());return t.map(e=>e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e)}(n):[];try{return s(t,...r)}catch(l){return console.warn(`[TemplateParser] Error applying filter ${o}:`,l),t}}function D(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}function $(e,t){return t&&"state"!==t?t.includes(".")?function(e,t){const i=t.split(".");let o=e;for(const n of i){if(null==o)return;if("object"!=typeof o)return;o=o[n]}return o}(e.attributes,t):e.attributes[t]:e.state}function _(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}class z extends EventTarget{constructor(){super(),this.blocks={},this.rootId="root",this.selectedId=null,this.selectedStyleSlotId=null,this.slots={},this._elementRegistry=new Map,this._reset(),this._initialize()}createBlock(e,t="root",i={},o={},n){const s=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,r=this.blocks[t],l=o.layout||"flow",a=o.entityConfig||i.entityConfig||{mode:"inherited"},c={id:s,type:e,parentId:t,canBeDeleted:o.canBeDeleted??i.canBeDeleted,canBeDuplicated:o.canBeDuplicated??i.canBeDuplicated,canChangeLayoutMode:o.canChangeLayoutMode??i.canChangeLayoutMode,requireEntity:o.requireEntity??i.requireEntity,parentManaged:o.parentManaged||!1,label:o.label||void 0,layout:l,children:[],props:{...i.props||{},...o.props||{}},order:n||0,deviceStyles:o.deviceStyles,zIndex:Object.keys(this.blocks).length,entityConfig:a};return this.blocks[s]=c,void 0!==n?(r.children.splice(n,0,s),r.children.forEach((e,t)=>{this.blocks[e].order=t})):r.children.push(s),this.blocks={...this.blocks,[s]:c},this._emit("block-created",{block:c}),this._emit("change",{action:"create",block:c}),c}updateBlock(e,t){const i=this.blocks[e];if(!i)return;const o={...i},n="stylePresetId"in t||"deviceStyles"in t||"styleSlots"in t;t.props&&(o.props={...o.props,...t.props},delete t.props),t.deviceStyles&&(o.deviceStyles=t.deviceStyles,delete t.deviceStyles),"stylePresetId"in t&&(o.stylePresetId=t.stylePresetId,delete t.stylePresetId),t.styleSlots&&(o.styleSlots=t.styleSlots,delete t.styleSlots),Object.assign(o,t),this.blocks={...this.blocks,[e]:o},this._emit("change",{action:"update",block:o,styleChanged:n}),this._emit("block-updated",{block:o})}updateBlockId(e,t){const i=t.trim().toLowerCase().replaceAll(" ","-");if(!i)return{success:!1,error:"ID cannot be empty"};if(i===e)return{success:!0};if(e===this.rootId)return{success:!1,error:"Root block ID cannot be changed"};if(this.blocks[i])return{success:!1,error:"ID already exists"};const o=this.blocks[e];if(!o)return{success:!1,error:"Block not found"};const n={...this.blocks},s={...o,id:i};delete n[e],n[i]=s;const r=new Set([i]);Object.values(n).forEach(t=>{var o;let s=t,l=!1;if(s.parentId===e&&(s={...s,parentId:i},l=!0),null==(o=s.children)?void 0:o.includes(e)){const t=s.children.map(t=>t===e?i:t);s={...s,children:t},l=!0}l&&(n[s.id]=s,r.add(s.id))}),this.blocks=n;return this.selectedId===e&&this.select(i),this._emit("change",{action:"update",block:s}),r.forEach(e=>{this._emit("block-updated",{block:n[e]})}),{success:!0}}deleteBlock(e,t=!1){const i=this.blocks[e];if(!i||"root"===e)return;if(!this.canDeleteBlock(e)&&!t)return void console.warn(`Cannot delete parent-managed block: ${e}`);const o=this.blocks[i.parentId];o&&o.children&&(o.children=o.children.filter(t=>t!==e)),i.children&&[...i.children].forEach(e=>this.deleteBlock(e)),delete this.blocks[e],this.selectedId===e&&(this.selectedId=null,this._emit("selection-changed",{selectedId:null})),this._emit("block-deleted",{blockId:e}),this._emit("change",{action:"delete",block:i})}moveBlock(e,t,i){const o=this.blocks[e],n=this.blocks[o.parentId],s=this.blocks[t];o&&s&&s.children&&(n&&n.children&&(n.children=n.children.filter(t=>t!==e)),o.parentId=t,s.children.splice(i,0,e),s.children.forEach((e,t)=>{this.blocks[e].order=t}),this._emit("block-moved",{block:o,oldParentId:null==n?void 0:n.id,newParentId:t,newIndex:i}),this._emit("change",{action:"move",block:o}))}select(e){this.selectedId=e,this.selectedStyleSlotId=null,this._emit("selection-changed",{selectedId:e,selectedBlock:e?this.blocks[e]:void 0}),this._emit("style-slot-changed",{selectedId:e,slotId:null})}getSelected(){return this.selectedId?this.blocks[this.selectedId]:null}selectStyleSlot(e){this.selectedStyleSlotId!==e&&(this.selectedStyleSlotId=e,this._emit("style-slot-changed",{selectedId:this.selectedId,slotId:e}))}getSelectedStyleSlotId(){return this.selectedStyleSlotId}canDeleteBlock(e){const t=this.blocks[e];return!(!t||"root"===e)&&(t.canBeDeleted??!0)}canDuplicateBlock(e){return this.blocks[e].canBeDuplicated??!0}canChangeLayoutMode(e){return this.blocks[e].canChangeLayoutMode??!0}isEntityRequired(e){return this.blocks[e].requireEntity??!1}duplicateBlock(e){const t=this.blocks[e];if(!t||!this.canDuplicateBlock(e))return console.warn(`Cannot duplicate block: ${e}`),null;const i=this.blocks[t.parentId];if(!i||!i.children)return null;const o=i.children.indexOf(e);if(-1===o)return null;const n=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,s={...t,id:n,order:o+1,children:[]};return this.blocks={...this.blocks,[n]:s},i.children.splice(o+1,0,n),i.children.forEach((e,t)=>{this.blocks[e].order=t}),t.children&&t.children.length>0&&t.children.forEach(e=>{this.blocks[e]&&this._duplicateBlockRecursive(e,n)}),this._emit("block-created",{block:s}),this._emit("change",{action:"duplicate",block:s}),this.select(n),s}getBlock(e){return this.blocks[e]}getChildren(e){const t=this.blocks[e];return t&&t.children?t.children.map(e=>this.blocks[e]).filter(Boolean).sort((e,t)=>e.order-t.order):[]}getBlockLabel(e){var t;const i="string"==typeof e?this.blocks[e]:e;return(null==(t=null==i?void 0:i.label)?void 0:t.trim())||void 0}getBlockDisplayName(e,t){const i="string"==typeof e?this.blocks[e]:e;return i?this.getBlockLabel(i)||t||i.type:t||""}resolveEntityForBlock(e){const t=this.blocks[e];if(!t)return{entityId:void 0,source:"none"};const i=t.entityConfig;if(!i)return this._resolveInheritedEntity(t);if("fixed"===i.mode)return{entityId:i.entityId,source:"fixed"};if("slot"===i.mode){const e=i.slotId;return{entityId:e?this.resolveSlotEntity(e):void 0,source:"slot",slotId:e}}return this._resolveInheritedEntity(t)}resolveSlotEntity(e){var t;return null==(t=this.slots[e])?void 0:t.entityId}getBlockEntities(e){var t,i,o;if(!e)return[];const n=this.getElement(e.id),s=null==(t=null==n?void 0:n.getBlockEntities)?void 0:t.call(n);if(void 0!==s)return s;if("fixed"===(null==(i=e.entityConfig)?void 0:i.mode)||"slot"===(null==(o=e.entityConfig)?void 0:o.mode)){const t=this.resolveEntityForBlock(e.id).entityId;return t?[t]:[]}return[]}getStyleBindingEntities(e){var t,i;if(!e)return[];const o=new Set;if(null==e?void 0:e.deviceStyles)for(const n of Object.values(e.deviceStyles))if(n)for(const i of Object.values(n))if(i)for(const n of Object.values(i)){if(!n||"object"!=typeof n)continue;const i=n;if(i.binding){M(i.binding,e,this).forEach(e=>o.add(e))}if(null==(t=i.animation)?void 0:t.binding){M(i.animation.binding,e,this).forEach(e=>o.add(e))}}if(null==e?void 0:e.styleSlots)for(const n of Object.values(e.styleSlots))if(null==n?void 0:n.deviceStyles)for(const t of Object.values(n.deviceStyles))if(t)for(const n of Object.values(t))if(n)for(const t of Object.values(n)){if(!t||"object"!=typeof t)continue;const n=t;if(n.binding){M(n.binding,e,this).forEach(e=>o.add(e))}if(null==(i=n.animation)?void 0:i.binding){M(n.animation.binding,e,this).forEach(e=>o.add(e))}}return Array.from(o)}getTraitBindingEntities(e){if(!e)return[];const t={};for(const[i,o]of Object.entries(e.props??{})){if(!o||"object"!=typeof o)continue;const e=o;e.binding&&(t[i]=e.binding)}return 0===Object.keys(t).length?[]:function(e,t,i){const o=new Set,n=Array.isArray(e)?e:Object.values(e);for(const s of n){if(!s)continue;M(s,t,i).forEach(e=>o.add(e))}return Array.from(o)}(t,e,this)}getAllTrackedEntities(e){return{blockEntities:this.getBlockEntities(e),styleEntities:this.getStyleBindingEntities(e),traitBindingEntities:this.getTraitBindingEntities(e)}}getTrackedEntitiesFlat(e){const{blockEntities:t,styleEntities:i,traitBindingEntities:o}=this.getAllTrackedEntities(e);return[...new Set([...t,...i,...o])]}getSlots(){return Object.values(this.slots).sort((e,t)=>e.id.localeCompare(t.id))}getSlot(e){return this.slots[e]}createSlot(e){var t,i,o;const n=this._normalizeSlotId(e.id);if(!n)return{success:!1,error:"Slot ID cannot be empty"};if(this.slots[n])return{success:!1,error:"Slot ID already exists"};const s={id:n,name:(null==(t=e.name)?void 0:t.trim())||void 0,description:(null==(i=e.description)?void 0:i.trim())||void 0,entityId:(null==(o=e.entityId)?void 0:o.trim())||void 0};return this.slots={...this.slots,[n]:s},this._emitSlotsChanged("create",s),this._emit("change",{action:"update"}),{success:!0,slot:s}}updateSlot(e,t){const i=this.slots[e];if(!i)return{success:!1,error:"Slot not found"};const o=t.id?this._normalizeSlotId(t.id):e;if(!o)return{success:!1,error:"Slot ID cannot be empty"};if(o!==e&&this.slots[o])return{success:!1,error:"Slot ID already exists"};const n={...i,...t,id:o,name:void 0!==t.name?t.name.trim()||void 0:i.name,description:void 0!==t.description?t.description.trim()||void 0:i.description,entityId:void 0!==t.entityId?t.entityId.trim()||void 0:i.entityId};if(o!==e){const t={...this.slots};delete t[e],t[o]=n,this.slots=t;const i=this._replaceSlotReferences(e,o);this._notifySlotUsageChanged(i)}else if(this.slots={...this.slots,[e]:n},"entityId"in t){const t=this._getSlotReferenceBlockIds(e);this._notifySlotUsageChanged(t)}return this._emitSlotsChanged("update",n),this._emit("change",{action:"update"}),{success:!0,slot:n}}deleteSlot(e){if(!this.slots[e])return{success:!1,error:"Slot not found"};const t={...this.slots},i=t[e];return delete t[e],this.slots=t,this._emitSlotsChanged("delete",i),this._emit("change",{action:"update"}),{success:!0,slot:i}}findSlotReferences(e){var t,i;const o=[];for(const n of Object.values(this.blocks)){const s=n.entityConfig;if("slot"===(null==s?void 0:s.mode)&&(null==s?void 0:s.slotId)===e&&o.push({blockId:n.id,kind:"block-entity"}),this._collectSlotReferencesFromDeviceStyles(n.id,e,n.deviceStyles,o),n.styleSlots)for(const[t,i]of Object.entries(n.styleSlots))this._collectSlotReferencesFromDeviceStyles(n.id,e,null==i?void 0:i.deviceStyles,o,t);if(n.props)for(const[r,l]of Object.entries(n.props))if(l&&"object"==typeof l){const s=l;(null==(i=null==(t=s.binding)?void 0:t.entity)?void 0:i.slotId)===e&&o.push({blockId:n.id,kind:"trait-binding",propName:r}),this._isSlotPropReference(r,s.value,e)&&o.push({blockId:n.id,kind:"trait-slot",propName:r})}else this._isSlotPropReference(r,l,e)&&o.push({blockId:n.id,kind:"trait-slot",propName:r})}return o}toJSON(){return{blocks:this.blocks,rootId:this.rootId,slots:this.slots}}fromJSON(e){this.blocks=e.blocks,this.rootId=e.rootId,this.slots=e.slots||{},this.selectedId=null,this.selectedStyleSlotId=null,this._emitSlotsReloaded(),this._emit("change",{action:"load"})}buildTree(){const e=this.blocks[this.rootId],t=e=>e.children?{...e,tree:e.children.map(e=>t(this.blocks[e]))}:e;return t(e)}registerElement(e,t){const i="string"==typeof e?e:e.id;this.blocks[i]?t?this._elementRegistry.set(i,t):this._elementRegistry.delete(i):t&&console.error(`[DocumentModel] Block ${i} not found, element cannot be registered`)}getElement(e){const t="string"==typeof e?e:e.id;if(this.blocks[t])return this._elementRegistry.get(t);console.warn(`[DocumentModel] Block ${t} not found, element cannot be retrieved`)}clear(){this._reset(),this._initialize()}loadFromConfig(e){this._reset(),e.blocks&&"object"==typeof e.blocks&&(this.blocks=e.blocks),e.rootId&&"string"==typeof e.rootId&&(this.rootId=e.rootId),e.slots&&"object"==typeof e.slots&&(this.slots=e.slots),this.dispatchEvent(new CustomEvent("document-loaded")),this._emitSlotsReloaded(),this._emit("change",{action:"load"})}exportToConfig(){return{blocks:this.blocks,rootId:this.rootId,slots:this.slots,version:1}}_initialize(){this.blocks[this.rootId]={label:"Card",id:this.rootId,type:"canvas",parentId:null,canBeDeleted:!1,canBeDuplicated:!1,canChangeLayoutMode:!1,requireEntity:!1,parentManaged:!1,layout:"flow",children:[],props:{},order:0,zIndex:0}}_reset(){Object.keys(this.blocks).forEach(e=>delete this.blocks[e]),this.selectedId=null,this.selectedStyleSlotId=null,this.slots={}}_duplicateBlockRecursive(e,t){const i=this.blocks[e];if(!i)return;const o=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,n=this.blocks[t],s={...i,id:o,parentId:t,order:n.children?n.children.length:0,children:[]};this.blocks={...this.blocks,[o]:s},n.children&&n.children.push(o),i.children&&i.children.length>0&&i.children.forEach(e=>{this._duplicateBlockRecursive(e,o)})}_resolveInheritedEntity(e){let t=e.parentId;for(;t;){const e=this.blocks[t];if(!e)break;const i=e.entityConfig;if("fixed"===(null==i?void 0:i.mode))return{entityId:i.entityId,source:"inherited",inheritedFromId:e.id,inheritedFromDisplayName:this.getBlockDisplayName(e),inheritedFromType:e.type};if("slot"===(null==i?void 0:i.mode)){const t=i.slotId;return{entityId:t?this._resolveSlotEntity(t):void 0,source:"inherited",inheritedFromId:e.id,inheritedFromDisplayName:this.getBlockDisplayName(e),inheritedFromType:e.type,slotId:t}}t=e.parentId}return{entityId:void 0,source:"none"}}_resolveSlotEntity(e){var t;if(e)return null==(t=this.slots[e])?void 0:t.entityId}_normalizeSlotId(e){return e.trim().toLowerCase().replaceAll(" ","-")}_emitSlotsChanged(e,t){this.dispatchEvent(new CustomEvent("slots-changed",{detail:{action:e,slot:t}}))}_emitSlotsReloaded(){this.dispatchEvent(new CustomEvent("slots-changed",{detail:{action:"load"}}))}_collectSlotReferencesFromDeviceStyles(e,t,i,o,n){var s,r,l,a,c;if(i)for(const d of Object.values(i))if(d)for(const[i,u]of Object.entries(d))if(u)for(const[d,h]of Object.entries(u)){if(!h||"object"!=typeof h)continue;const u=h;(null==(r=null==(s=u.binding)?void 0:s.entity)?void 0:r.slotId)===t&&o.push({blockId:e,kind:"style-binding",category:i,property:d,styleSlotId:n}),(null==(c=null==(a=null==(l=u.animation)?void 0:l.binding)?void 0:a.entity)?void 0:c.slotId)===t&&o.push({blockId:e,kind:"style-animation",category:i,property:d,styleSlotId:n})}}_replaceSlotReferences(e,t){var i,o;const n={...this.blocks},s=new Set;for(const[r,l]of Object.entries(this.blocks)){let a=l,c=!1;if("slot"===(null==(i=l.entityConfig)?void 0:i.mode)&&(null==(o=l.entityConfig)?void 0:o.slotId)===e&&(a={...a,entityConfig:{...l.entityConfig,slotId:t}},c=!0),l.deviceStyles){const{deviceStyles:i,changed:o}=this._updateSlotIdInDeviceStyles(l.deviceStyles,e,t);o&&(a={...a,deviceStyles:i},c=!0)}if(l.styleSlots){let i=!1;const o={...l.styleSlots};for(const[n,s]of Object.entries(l.styleSlots)){if(!(null==s?void 0:s.deviceStyles))continue;const{deviceStyles:r,changed:l}=this._updateSlotIdInDeviceStyles(s.deviceStyles,e,t);l&&(o[n]={...s,deviceStyles:r},i=!0)}i&&(a={...a,styleSlots:o},c=!0)}if(l.props){let i=!1;const o={...l.props};for(const[n,s]of Object.entries(l.props)){const r=this._updateSlotIdInTraitValue(n,s,e,t);r.changed&&(o[n]=r.value,i=!0)}i&&(a={...a,props:o},c=!0)}c&&(n[r]=a,s.add(r))}return s.size>0&&(this.blocks=n),s}_updateSlotIdInDeviceStyles(e,t,i){let o=!1;const n={};for(const[s,r]of Object.entries(e)){if(!r)continue;let e=!1;const l={...r};for(const[o,n]of Object.entries(r)){if(!n)continue;let s=!1;const r={...n};for(const[e,o]of Object.entries(n)){if(!o||"object"!=typeof o)continue;const n=this._updateSlotIdInStylePropertyValue(o,t,i);n.changed&&(r[e]=n.value,s=!0)}s&&(l[o]=r,e=!0)}e?(n[s]=l,o=!0):n[s]=r}return{deviceStyles:o?n:e,changed:o}}_updateSlotIdInStylePropertyValue(e,t,i){var o,n,s,r,l;const a=e;let c=!1,d=a.binding,u=a.animation;return(null==(n=null==(o=a.binding)?void 0:o.entity)?void 0:n.slotId)===t&&(d={...a.binding,entity:{...a.binding.entity,slotId:i}},c=!0),(null==(l=null==(r=null==(s=a.animation)?void 0:s.binding)?void 0:r.entity)?void 0:l.slotId)===t&&(u={...a.animation,binding:{...a.animation.binding,entity:{...a.animation.binding.entity,slotId:i}}},c=!0),c?{value:{...a,binding:d,animation:u},changed:!0}:{value:e,changed:!1}}_updateSlotIdInTraitValue(e,t,i,o){var n,s;if(t&&"object"==typeof t){const r=t;let l=!1,a=r.value,c=r.binding;return(null==(s=null==(n=r.binding)?void 0:n.entity)?void 0:s.slotId)===i&&(c={...r.binding,entity:{...r.binding.entity,slotId:o}},l=!0),this._isSlotPropReference(e,r.value,i)&&(a=o,l=!0),l?{value:{...r,value:a,binding:c},changed:!0}:{value:t,changed:!1}}return this._isSlotPropReference(e,t,i)?{value:o,changed:!0}:{value:t,changed:!1}}_isSlotPropReference(e,t,i){return"string"==typeof t&&(t===i&&e.toLowerCase().includes("slot"))}_getSlotReferenceBlockIds(e){const t=new Set;for(const i of this.findSlotReferences(e))t.add(i.blockId);return t}_notifySlotUsageChanged(e){if(0!==e.size)for(const t of e){const e=this.blocks[t];e&&(this._emit("block-updated",{block:e}),this._emit("change",{action:"update",block:e,styleChanged:!0}))}}_emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}}const R=e("document-model");function M(e,t,i){if(!e||"object"!=typeof e)return[];const o=new Set,n=e,s=function(e,t,i){return(null==e?void 0:e.slotId)?i.resolveSlotEntity(e.slotId):(null==e?void 0:e.entityId)?e.entityId:i.resolveEntityForBlock(t.id).entityId}(n.entity,t,i);if(s&&o.add(s),"condition"===n.mode){const e=n;if(e.conditions)for(const t of e.conditions){A(t.condition).forEach(e=>o.add(e))}}const r=e;if("showWhen"in r&&r.showWhen){A(r.showWhen).forEach(e=>o.add(e))}if("hideWhen"in r&&r.hideWhen){A(r.hideWhen).forEach(e=>o.add(e))}if("activeWhen"in r&&r.activeWhen){A(r.activeWhen).forEach(e=>o.add(e))}return Array.from(o)}function A(e){const t=new Set;if(k(e))for(const o of e.rules){A(o).forEach(e=>t.add(e))}else"object"==typeof(i=e)&&null!==i&&"operator"in i&&!("rules"in i)&&e.entity&&t.add(e.entity);var i;return Array.from(t)}const P=e("event-bus");class T{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}addEventListener(e,t){this.on(e,t)}off(e,t){const i=this.listeners.get(e);i&&(i.delete(t),0===i.size&&this.listeners.delete(e))}removeEventListener(e,t){this.off(e,t)}emit(e,t){const i=this.listeners.get(e);i&&i.forEach(i=>{try{i(t)}catch(o){console.error(`Error in event listener for "${e}":`,o)}})}dispatchEvent(e,t){this.emit(e,t)}once(e,t){const i=o=>{t(o),this.off(e,i)};this.on(e,i)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){var t;return(null==(t=this.listeners.get(e))?void 0:t.size)||0}hasListeners(e){return this.listenerCount(e)>0}}class O extends T{constructor(e={}){super(),this.devices=new Map,this.baseDeviceId=null;if((e.devices||[{id:"desktop",name:"Desktop",width:void 0,order:1,isDefault:!0},{id:"tablet",name:"Tablet",width:768,order:2,isDefault:!1},{id:"mobile",name:"Mobile",width:480,order:3,isDefault:!1}]).forEach(e=>this.setDevice(e)),!this.baseDeviceId)throw new Error("No default device found");this.activeDeviceId=e.activeDeviceId||this.baseDeviceId}static fromJSON(e){return new O(e)}getDevices(){return Array.from(this.devices.values()).sort((e,t)=>e.order-t.order)}getDevice(e,t=!0){const i=this.devices.get(e);if(!i&&t)throw new Error(`Device ${e} not found`);return i}getBaseDevice(){return this.devices.get(this.baseDeviceId)}getActiveDevice(){return this.devices.get(this.activeDeviceId)||this.getBaseDevice()}setActiveDevice(e){if(!this.devices.has(e))throw new Error(`Device ${e} not found`);const t=this.activeDeviceId;this.activeDeviceId=e,this.emit("device-changed",{deviceId:e,device:this.devices.get(e),previousDeviceId:t})}setDevice(e){if(this.devices.has(e.id))throw new Error(`Device is already registered: ${e.id}`);if(e.isDefault){if(this.baseDeviceId)throw new Error(`Device ${e.id} can not be registered since there is already a base device: ${this.baseDeviceId}`);this.baseDeviceId=e.id}this.devices.set(e.id,e),this.emit("devices-updated",{devices:this.getDevices()})}removeDevice(e){if(this.getDevice(e).isDefault)throw new Error(`Cannot remove default device ${e}`);this.devices.delete(e),this.activeDeviceId===e&&this.setActiveDevice(this.baseDeviceId),this.emit("devices-updated",{devices:this.getDevices()})}renameDevice(e,t){this.getDevice(e).name=t,this.emit("devices-updated",{devices:this.getDevices()})}getFallbackChain(e){const t=this.getDevice(e),i=this.getDevices(),o=[];if(o.push(t),t.isDefault)return o;const n=i.filter(e=>e.order<t.order).sort((e,t)=>t.order-e.order);return o.push(...n),o.some(e=>e.isDefault)||o.push(this.getBaseDevice()),o}getDeviceForWidth(e){const t=this.getDevices().reverse();for(const i of t){if(void 0===i.width)return i;if(e<=i.width)return i}return this.getBaseDevice()}toJSON(){return{devices:this.getDevices(),activeDeviceId:this.activeDeviceId}}}new O;const L=e("device-manager");var j=Object.defineProperty,N=(e,t,i,o)=>{for(var n,s=void 0,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(t,i,s)||s);return s&&j(t,i,s),s};const W=e("drag-drop-manager");class F extends t{constructor(){super(...arguments),this.blockId="",this.canvasId="",this._registered=!1,this._wasDisconnected=!1}get dropId(){return this.blockId}get dropElement(){return this}get blockType(){return this.tagName.toLowerCase()}get isBlockDraggable(){return!0}get isBlockDroppable(){return!0}get isBlockContainer(){return!1}get blockTypesAcceptedAsChildren(){return null}connectedCallback(){super.connectedCallback(),this.dragDropManager}disconnectedCallback(){this.dragDropManager&&(this._wasDisconnected=!0,this._unregisterFromManager()),super.disconnectedCallback()}updated(e){if(!this.dragDropManager)return;const t=this.blockId&&this.canvasId,i=e.has("blockId")||e.has("canvasId"),o=!this._registered||i||this._wasDisconnected;t&&o&&((i||this._wasDisconnected)&&this._registered&&(this._registered=!1),this._wasDisconnected=!1,this._registerWithManager())}getBlockedDropInstructions(){return null}_registerWithManager(){this.dragDropManager.registerBlock(this),this._registered=!0,this.blockId}_unregisterFromManager(){this._registered&&this.blockId&&(this.dragDropManager.unregisterBlock(this),this._registered=!1,this.blockId)}}N([i({type:String,attribute:"block-id"})],F.prototype,"blockId"),N([i({type:String,attribute:"canvas-id"})],F.prototype,"canvasId"),N([o({context:W})],F.prototype,"dragDropManager");const V="data-dnd-draggable",U=`[${V}="true"]`;var H=(e=>(e.CANVAS="canvas",e.SOURCE_ZONE="source-zone",e))(H||{}),Z=(e=>(e.CANVAS="canvas",e.CONTAINER="container",e.BLOCK="block",e))(Z||{}),G=(e=>(e.SOURCE_NOT_ALLOWED="source_not_allowed",e.BLOCK_TYPE_NOT_ALLOWED="block_type_not_allowed",e.CONTAINER_REFUSES="container_refuses",e.BOUND_BLOCK_LOCKED="bound_block_locked",e.TRANSFER_NOT_ALLOWED="transfer_not_allowed",e))(G||{});class q{constructor(e,t,i){this.restrictionManager=e,this.shakeAnimator=t,this.eventTarget=i,this.draggables=new Map}attachToBlock(e){if(this.draggables.has(e))return e.blockId,void e.canvasId;e.blockId,e.blockType,e.setAttribute(V,"true");const t=p({element:e,getInitialData:()=>{const t={sourceType:H.CANVAS,sourceId:e.canvasId,blockType:e.blockType,blockId:e.blockId};return e.blockId,t},onGenerateDragPreview:()=>{e.blockId;const t={blockId:e.blockId,blockType:e.blockType,canvasId:e.canvasId};this.eventTarget.dispatchEvent(new CustomEvent("block-drag-on-generate-preview",{detail:t,bubbles:!0,composed:!0}))},onDragStart:()=>{e.blockId;const t={blockId:e.blockId,blockType:e.blockType,canvasId:e.canvasId};this.eventTarget.dispatchEvent(new CustomEvent("block-drag-started",{detail:t,bubbles:!0,composed:!0})),e.style.opacity="0.5"},onDrop:()=>{e.blockId,e.style.opacity="1"},canDrag:()=>{const t={sourceType:H.CANVAS,sourceId:e.canvasId,blockType:e.blockType,blockId:e.blockId};e.blockId;const i=this.restrictionManager.canStartDrag(t);if(!i.allowed){i.reason,i.message;const t={blockType:e.blockType,blockId:e.blockId,sourceZoneId:e.canvasId,reason:i.reason,message:i.message||"Drag operation not allowed",element:e};return this.eventTarget.dispatchEvent(new CustomEvent("block-rejected",{detail:t,bubbles:!0,composed:!0})),this.shakeAnimator.playShake(e),!1}return e.blockId,!0}});this.draggables.set(e,t),e.blockId}detachFromBlock(e){const t=this.draggables.get(e);t&&(e.blockId,t(),this.draggables.delete(e))}destroy(){this.draggables.forEach(e=>e()),this.draggables.clear()}}class K{constructor(){this.sourceAllowlist=new Map,this.blockTypeRestrictions=new Map,this.containerAcceptance=new Map,this.boundBlocks=new Set,this.transferRules=[]}setRestrictions(e){e.sourceAllowlist&&(this.sourceAllowlist=e.sourceAllowlist),e.blockTypeRestrictions&&(this.blockTypeRestrictions=e.blockTypeRestrictions),e.containerAcceptance&&(this.containerAcceptance=e.containerAcceptance),e.boundBlocks&&(this.boundBlocks=e.boundBlocks)}setTransferRules(e){this.transferRules=e}canStartDrag(e,t){return t&&this.boundBlocks.has(t)?{allowed:!1,reason:G.BOUND_BLOCK_LOCKED,message:"This block is locked and cannot be moved"}:{allowed:!0}}canDropInCanvas(e,t){if(this.sourceAllowlist.has(t)){if(!this.sourceAllowlist.get(t).has(e.sourceId))return{allowed:!1,reason:G.SOURCE_NOT_ALLOWED,message:"Blocks from this source cannot be dropped in this canvas"}}if(this.blockTypeRestrictions.has(t)){if(!this.blockTypeRestrictions.get(t).has(e.blockType))return{allowed:!1,reason:G.BLOCK_TYPE_NOT_ALLOWED,message:"This block type is not allowed in this canvas"}}return{allowed:!0}}canNestInContainer(e,t,i=null){if(i&&i.length>0&&!i.includes(e.blockType))return{allowed:!1,reason:G.CONTAINER_REFUSES,message:"This container does not accept this block type"};if(this.containerAcceptance.has(t)){if(!this.containerAcceptance.get(t).has(e.blockType))return{allowed:!1,reason:G.CONTAINER_REFUSES,message:"This container type does not accept this block"}}return{allowed:!0}}canTransferBetweenCanvases(e,t,i){if(t===i)return{allowed:!0};if(0===this.transferRules.length)return{allowed:!0};for(const o of this.transferRules){const n=o.sourceCanvasId===t&&o.targetCanvasId===i,s=o.bidirectional&&o.sourceCanvasId===i&&o.targetCanvasId===t;if(n||s)return o.allowedBlockTypes&&o.allowedBlockTypes.length>0&&!o.allowedBlockTypes.includes(e.blockType)?{allowed:!1,reason:G.TRANSFER_NOT_ALLOWED,message:"This block type cannot be transferred between these canvases"}:{allowed:!0}}return{allowed:!1,reason:G.TRANSFER_NOT_ALLOWED,message:"Transfer between these canvases is not allowed"}}addBoundBlock(e){this.boundBlocks.add(e)}removeBoundBlock(e){this.boundBlocks.delete(e)}}class X{constructor(e,t){this.restrictionManager=e,this.eventTarget=t,this.dropTargets=new Map}register(e){this.dropTargets.has(e.dropElement)?console.warn(`[${this.getAdapterName()}] Drop target already registered, skip: `,e.dropElement):(this.getAdapterName(),e.dropId,this._attachDropTarget(e))}unregister(e){const t=this.dropTargets.get(e.dropElement);t&&(t(),this.dropTargets.delete(e.dropElement))}destroy(){this.dropTargets.forEach(e=>e()),this.dropTargets.clear()}_attachDropTarget(e){const t=v({element:e.dropElement,canDrop:({source:t})=>{const i=t.data;return this._canDrop(i,e)},getData:({input:t,element:i})=>{const o=this._getBlockChildren(i),n=this._getDropTargetData(e),s=this._getBlockedInstructions(e,o.length),r={"reorder-before":s.includes("reorder-before")?"not-available":"available","reorder-after":s.includes("reorder-after")?"not-available":"available",combine:s.includes("combine")?"not-available":"available"};return g(n,{input:t,element:i,axis:"vertical",operations:r})}});this.dropTargets.set(e.dropElement,t)}_getBlockChildren(e){return Array.from(e.children).filter(e=>e instanceof F)}_getBlockedInstructions(e,t){return[]}}class Y extends X{constructor(e,t){super(e,t)}registerBlock(e){this.register(e)}unregisterBlock(e){this.unregister(e)}getAdapterName(){return"BlockDropAdapter"}_canDrop(e,t){const i=this.restrictionManager.canDropInCanvas(e,t.canvasId);return e.blockId!==t.blockId&&i.allowed}_getDropTargetData(e){return{type:Z.BLOCK,canvasId:e.canvasId,targetBlockId:e.dropId,targetBlockType:e.blockType}}_getBlockedInstructions(e,t){return["combine"]}}class J extends X{constructor(e,t){super(e,t)}registerCanvas(e){this.register(e)}unregisterCanvas(e){this.unregister(e)}getAdapterName(){return"CanvasAdapter"}_canDrop(e,t){return this.restrictionManager.canDropInCanvas(e,t.dropId).allowed}_getDropTargetData(e){return{type:Z.CANVAS,canvasId:e.dropId}}_getBlockedInstructions(e,t){return["combine"]}}class Q extends X{constructor(e,t){super(e,t)}attachToContainer(e){this.register(e)}unregisterContainer(e){this.unregister(e)}getAdapterName(){return"ContainerAdapter"}_canDrop(e,t){return this.restrictionManager.canNestInContainer(e,t.blockType,t.blockTypesAcceptedAsChildren).allowed}_getDropTargetData(e){return{type:Z.CONTAINER,canvasId:e.canvasId,targetBlockId:e.dropId,targetBlockType:e.blockType}}_getBlockedInstructions(e,t){const i=e.getBlockedDropInstructions();return null!==i?i:[]}}function ee(e,t){const i=new CSSStyleSheet;i.replaceSync(t),e.adoptedStyleSheets=[...e.adoptedStyleSheets,i]}const te="\n@keyframes dnd-shake {\n  0%, 100% { transform: translateX(0); }\n  25% { transform: translateX(-4px); }\n  50% { transform: translateX(4px); }\n  75% { transform: translateX(-4px); }\n}\n\n.dnd-shaking {\n  animation: dnd-shake 0.4s ease-in-out;\n}\n";class ie{constructor(){this.injectedRoots=new WeakSet}playShake(e){this._ensureStyles(e),e.classList.add("dnd-shaking");const t=()=>{e.classList.remove("dnd-shaking"),e.removeEventListener("animationend",t)};e.addEventListener("animationend",t)}destroy(){}_ensureStyles(e){const t=e.getRootNode();if(t instanceof ShadowRoot&&!this.injectedRoots.has(t))ee(t,te),this.injectedRoots.add(t);else if(t instanceof Document&&!document.getElementById("dnd-shake-styles")){const e=document.createElement("style");e.id="dnd-shake-styles",e.textContent=te,document.head.appendChild(e)}}}class oe{constructor(e,t,i){this.restrictionManager=e,this.shakeAnimator=t,this.eventTarget=i,this.zones=new Map,this.cleanupFunctions=new Map}registerZone(e){this.zones.has(e.sourceId)?console.warn(`Source zone ${e.sourceId} already registered`):(this.zones.set(e.sourceId,e),this._attachDraggables(e))}destroy(){this.cleanupFunctions.forEach(e=>{e.forEach(e=>e())}),this.cleanupFunctions.clear(),this.zones.clear()}_attachDraggables(e){const t=[];e.sourceElement.querySelectorAll(U).forEach(i=>{if(!(i instanceof HTMLElement))return;const o=i.getAttribute("block-type")||i.dataset.blockType;if(o)if(!e.sourceAllowedBlockTypes||e.sourceAllowedBlockTypes.includes(o))try{const n={sourceType:H.SOURCE_ZONE,sourceId:e.sourceId,blockType:o},s=p({element:i,getInitialData:()=>n,canDrag:()=>{const t=this.restrictionManager.canStartDrag(n);if(!t.allowed){t.reason,t.message;const n={blockType:o,sourceZoneId:e.sourceId,reason:t.reason,message:t.message||"Drag operation not allowed",element:i};return this.eventTarget.dispatchEvent(new CustomEvent("block-rejected",{detail:n,bubbles:!0,composed:!0})),this.shakeAnimator.playShake(i),!1}return!0}});t.push(s)}catch(n){console.error(`[SourceAdapter] Error attaching draggable to ${o}:`,n)}else e.sourceId;else console.warn("[SourceAdapter] Block missing data-block-type:",i)}),t.length,this.cleanupFunctions.set(e.sourceId,t)}}class ne{constructor(){this.transferRules=[],this.blockOwnership=new Map}setRules(e){this.transferRules=e}getRules(){return this.transferRules}canTransfer(e,t,i){if(e===t)return!0;if(0===this.transferRules.length)return!0;for(const o of this.transferRules){const n=o.sourceCanvasId===e&&o.targetCanvasId===t,s=o.bidirectional&&o.sourceCanvasId===t&&o.targetCanvasId===e;if(n||s)return!(o.allowedBlockTypes&&o.allowedBlockTypes.length>0)||o.allowedBlockTypes.includes(i)}return!1}trackBlock(e,t){this.blockOwnership.set(e,t)}untrackBlock(e){this.blockOwnership.delete(e)}getBlockCanvas(e){return this.blockOwnership.get(e)}destroy(){this.transferRules=[],this.blockOwnership.clear()}}const se="\n.dnd-drop-indicator {\n  position: absolute;\n  background: var(--dnd-indicator-color, #0078d4);\n  pointer-events: none;\n  z-index: 10000;\n  border-radius: var(--dnd-indicator-radius, 2px);\n  transition: margin-left 0.15s ease-out;\n}\n\n.dnd-drop-indicator.dnd-edge-top,\n.dnd-drop-indicator.dnd-edge-bottom {\n  height: var(--dnd-indicator-width, 2px);\n  left: 0;\n  right: 0;\n}\n\n.dnd-drop-indicator.dnd-edge-top {\n  top: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-bottom {\n  bottom: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-left,\n.dnd-drop-indicator.dnd-edge-right {\n  width: var(--dnd-indicator-width, 2px);\n  top: 0;\n  bottom: 0;\n}\n\n.dnd-drop-indicator.dnd-edge-left {\n  left: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-right {\n  right: -1px;\n}\n\n.dnd-drop-indicator-indented {\n  box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.3);\n}\n";class re{constructor(){this.indicator=null,this.currentParent=null,this.injectedRoots=new WeakSet}show(e,t,i=0){var o;if(!t)return void this.hide();this._ensureStyles(e),this.indicator||(this.indicator=document.createElement("div"),this.indicator.className="dnd-drop-indicator"),this.indicator.className=`dnd-drop-indicator dnd-edge-${t}`,i>0&&(this.indicator.className+=" dnd-drop-indicator-indented");const n=e.parentElement;if(n&&n!==this.currentParent&&(this.currentParent&&this.indicator.parentElement===this.currentParent&&this.currentParent.removeChild(this.indicator),this.currentParent=n),this.currentParent&&!this.indicator.parentElement)if("top"===t)this.currentParent.insertBefore(this.indicator,e);else{const t=e.nextSibling;t?this.currentParent.insertBefore(this.indicator,t):this.currentParent.appendChild(this.indicator)}const s=e.getBoundingClientRect(),r=null==(o=this.currentParent)?void 0:o.getBoundingClientRect();if(r){const e=s.left-r.left,o=s.top-r.top,n=20*i;"top"===t||"bottom"===t?(this.indicator.style.left=`${e+n}px`,this.indicator.style.width=s.width-n+"px",this.indicator.style.top="top"===t?`${o}px`:`${o+s.height}px`):(this.indicator.style.top=`${o}px`,this.indicator.style.height=`${s.height}px`,this.indicator.style.left="left"===t?`${e}px`:`${e+s.width}px`)}}hide(){this.indicator&&this.indicator.parentElement&&this.indicator.parentElement.removeChild(this.indicator),this.currentParent=null}destroy(){this.hide(),this.indicator=null}_ensureStyles(e){const t=e.getRootNode();if(t instanceof ShadowRoot&&!this.injectedRoots.has(t))ee(t,se),this.injectedRoots.add(t);else if(t instanceof Document&&!document.getElementById("dnd-indicator-styles")){const e=document.createElement("style");e.id="dnd-indicator-styles",e.textContent=se,document.head.appendChild(e)}}}const le=class e extends EventTarget{constructor(){super(),this.autoScrollCleanup=null,this.monitorCleanup=null,this.autoScrollInitialized=!1,this.autoScrollConfig={maxScrollSpeed:"standard",startEdgeThreshold:30},this._applyEventRetargetingPatch(),this.restrictionManager=new K,this.transferManager=new ne,this.dropIndicator=new re,this.shakeAnimator=new ie,this.sourceAdapter=new oe(this.restrictionManager,this.shakeAnimator,this),this.canvasAdapter=new J(this.restrictionManager,this),this.blockDropAdapter=new Y(this.restrictionManager,this),this.blockDraggableAdapter=new q(this.restrictionManager,this.shakeAnimator,this),this.containerAdapter=new Q(this.restrictionManager,this),this._setupMonitor()}registerSourceZone(e){e.sourceId,this.sourceAdapter.registerZone(e)}registerCanvas(e){e.dropId,this.canvasAdapter.registerCanvas(e)}registerBlock(e){e.isBlockDroppable&&(e.isBlockContainer?this.containerAdapter.attachToContainer(e):this.blockDropAdapter.registerBlock(e)),e.isBlockDraggable&&this.blockDraggableAdapter.attachToBlock(e),e.blockId,e.isBlockContainer,e.isBlockDraggable,e.isBlockDroppable}unregisterBlock(e){e.blockId,this.blockDropAdapter.unregisterBlock(e),this.blockDraggableAdapter.detachFromBlock(e),this.containerAdapter.unregisterContainer(e)}setRestrictions(e){this.restrictionManager.setRestrictions(e)}enableCrossCanvasTransfer(e){this.transferManager.setRules(e),this.restrictionManager.setTransferRules(e)}setAutoScrollConfig(e,t){this.autoScrollElement=e,this.autoScrollConfig={...this.autoScrollConfig,...t},this.autoScrollInitialized&&this.autoScrollCleanup&&this.autoScrollCleanup(),this._setupAutoScroll()}addBoundBlock(e){this.restrictionManager.addBoundBlock(e)}removeBoundBlock(e){this.restrictionManager.removeBoundBlock(e)}destroy(){this.sourceAdapter.destroy(),this.canvasAdapter.destroy(),this.blockDropAdapter.destroy(),this.blockDraggableAdapter.destroy(),this.containerAdapter.destroy(),this.dropIndicator.destroy(),this.shakeAnimator.destroy(),this.transferManager.destroy(),this.monitorCleanup&&(this.monitorCleanup(),this.monitorCleanup=null),this.autoScrollCleanup&&(this.autoScrollCleanup(),this.autoScrollCleanup=null)}_applyEventRetargetingPatch(){if(e._isEventRetargetingPatchApplied)return void console.warn("[DragDropManager] Event retargeting patch already applied");const t=(e,t)=>{const i=function(e,t){var i;if(!e)return null;let o=e;for(;o;){if(null==(i=o.matches)?void 0:i.call(o,t))return o;if(o.parentElement)o=o.parentElement;else{const e=o.getRootNode();if(!(e instanceof ShadowRoot&&e.host))break;o=e.host}}return null}(e.composedPath()[0],t);i&&e.target!==i&&Object.defineProperty(e,"target",{value:i,enumerable:!0,configurable:!0})};["dragstart","drag","dragend"].forEach(e=>{window.addEventListener(e,e=>t(e,U),{capture:!0})}),["dragenter","dragover","dragleave","drop"].forEach(e=>{window.addEventListener(e,e=>t(e,'[data-dnd-drop-target="true"]'),{capture:!0})})}_setupMonitor(){this.monitorCleanup=f({onDrag:({source:e,location:t})=>{const i=t.current.dropTargets;if(0===i.length)return void this.dropIndicator.hide();const o=i[0],n=e.data,s=e.element,r=o.element;if(n.blockId&&this._isTargetDescendantOfSource(s,r))return void this.dropIndicator.hide();const l=b(o.data);if(!l||l.blocked)return void this.dropIndicator.hide();let a=null;switch(l.operation){case"reorder-before":case"combine":a="top";break;case"reorder-after":a="bottom"}if(a&&r){const e=0;this.dropIndicator.show(r,a,e)}else this.dropIndicator.hide()},onDropTargetChange:({location:e})=>{e.current.dropTargets},onDrop:({source:e,location:t})=>{if(this.dropIndicator.hide(),0===t.current.dropTargets.length)return;const i=t.current.dropTargets[0],o=e.data,n=e.element,s=i.element,r=i.data;if(o.blockId&&this._isTargetDescendantOfSource(n,s))return void console.warn("[DragDropManager] Drop rejected: Cannot drop a block inside itself or its descendants");const l=b(r),a=l?{operation:l.operation,blocked:l.blocked}:void 0,c={blockType:o.blockType,sourceZoneId:o.sourceId,targetCanvasId:r.canvasId,targetBlockId:r.targetBlockId,targetBlockType:r.targetBlockType,targetIsContainer:r.type===Z.CONTAINER,instruction:a};if(o.sourceType===H.SOURCE_ZONE){const e=c;this.dispatchEvent(new CustomEvent("block-created",{detail:e,bubbles:!0,composed:!0}))}else{const e={...c,blockId:o.blockId};this.dispatchEvent(new CustomEvent("block-reordered",{detail:e,bubbles:!0,composed:!0}))}}})}_isTargetDescendantOfSource(e,t){const i=e.getAttribute("block-id");if(!i)return!1;let o=t;for(;o;){if(o.getAttribute("block-id")===i)return!0;if(o.parentElement)o=o.parentElement;else{if(!o.getRootNode||!o.getRootNode().host)break;o=o.getRootNode().host}}return!1}_setupAutoScroll(){this.autoScrollCleanup=y({element:this.autoScrollElement,canScroll:({element:e})=>e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth,getConfiguration:()=>({maxScrollSpeed:this.autoScrollConfig.maxScrollSpeed})}),this.autoScrollInitialized=!0}};le._isEventRetargetingPatchApplied=!1;let ae=le;function ce(e,t){if(!e)return t||{};if(!t)return e;const i={...e};for(const o of Object.keys(t)){const n=e[o],s=t[o];s&&(i[o]=n?{...n,...s}:{...s})}return i}const de=e("hass");var ue=Object.defineProperty,he=(e,t,i,o)=>{for(var n,s=void 0,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(t,i,s)||s);return s&&ue(t,i,s),s};const pe=class extends F{constructor(){super(...arguments),this.activeDeviceId="desktop",this.isDragging=!1,this.isResizing=!1,this.canvasWidth=0,this.canvasHeight=0,this.selected=!1}get slotId(){var e,t;return null==(t=null==(e=this.block)?void 0:e.entityConfig)?void 0:t.slotId}static getBlockConfig(){return null}static getAvailableStyleSlotIds(e,t){return Object.keys(t)}getPanelConfig(){return{}}connectedCallback(){var e;super.connectedCallback(),this.entity=this.resolvedEntityId(),this.selected=this.documentModel.selectedId===(null==(e=this.block)?void 0:e.id),this.documentModel.addEventListener("change",e=>{var t;(null==(t=(null==e?void 0:e.detail).block)?void 0:t.parentId)===this.block.id&&this.requestUpdate()}),this.documentModel.addEventListener("selection-changed",e=>{const t=e.detail;this.selected=this.block.id===t.selectedId,this.selected?this.classList.add("block-selected"):this.classList.remove("block-selected")}),this.documentModel.addEventListener("slots-changed",()=>{const e=this.resolvedEntityId();this.entity!==e&&(this.entity=e),this.requestUpdate()}),this.eventBus.addEventListener("block-drag-start",({block:e})=>{e.id===this.block.id&&(this.isDragging=!0)}),this.eventBus.addEventListener("block-drag-end",({block:e})=>{e.id===this.block.id&&(this.isDragging=!1)}),this.eventBus.addEventListener("block-resize-start",({block:e})=>{e.id===this.block.id&&(this.isResizing=!0)}),this.eventBus.addEventListener("block-resize-end",({block:e})=>{e.id===this.block.id&&(this.isResizing=!1)}),this.eventBus.addEventListener("canvas-size-changed",({width:e,height:t})=>{this.canvasWidth=e,this.canvasHeight=t})}shouldUpdate(e){var t,i;if(e.has("block")||e.has("entity"))return!0;if(e.has("hass")){const i=e.get("hass");if(!i)return!0;const o=this.documentModel.getTrackedEntitiesFlat(this.block);if(0===o.length)return!1;for(const e of o){if(i.states[e]!==(null==(t=this.hass)?void 0:t.states[e]))return!0}return!1}return(null==(i=super.shouldUpdate)?void 0:i.call(this,e))??!0}willUpdate(e){var t;super.willUpdate(e),this.activeStyleSlotId=this.selected?this.documentModel.getSelectedStyleSlotId():null,this.resolvedRenderContext=this.renderer.resolvedRenderContext(this.block),(e.has("hass")||this.hass&&!this.bindingEvaluator)&&(this.bindingEvaluator=new S(this.hass,{resolveSlotEntity:e=>this.documentModel.resolveSlotEntity(e)})),null==(t=this.block)||t.type}updated(e){super.updated(e),e.has("block")&&this.block&&(this.entity=this.resolvedEntityId()),this.className="",this.resolvedRenderContext.classes.filter(e=>!!e).forEach(e=>this.classList.add(e)),this.selected&&this.classList.add("block-selected");const t=this.getResolvedContextStyles();this.style.cssText=this.stylesToString(t)}getBlockEntities(){}getResolvedContextStyles(){return this.resolvedRenderContext.styles}resolvedEntityId(){if(!this.block||!this.documentModel)return;return this.documentModel.resolveEntityForBlock(this.block.id).entityId}getEntityState(){return this.hass&&this.entity?this.hass.states[this.entity]:null}isEntityAvailable(){const e=this.getEntityState();return!!e&&"unavailable"!==e.state&&"unknown"!==e.state}getSlotStyle(e){var t;return(null==(t=this.resolvedRenderContext)?void 0:t.slotStyles[e])||{}}isStyleSlotActive(e){return this.activeStyleSlotId===e}stylesToString(e){return Object.entries(e).map(([e,t])=>`${e.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${t}`).join("; ")}getPropBinding(e){const t=this.getPropValue(e);if(t)return t.binding}resolvePropBinding(e,t){const i=this.getPropBinding(e),o=this.getPropValue(e),n=t??(null==o?void 0:o.value);if(!i||!this.bindingEvaluator)return n;const s=this.bindingEvaluator.evaluate(i,{defaultEntityId:this.resolvedEntityId(),defaultValue:n});return void 0===s.value?n:s.value}getPropValue(e){var t,i;const o=null==(i=null==(t=this.block)?void 0:t.props)?void 0:i[e];if(!o||"object"!=typeof o)return;return"value"in o||"binding"in o?o:void 0}};pe.styles=[n`
            :host {
                display: block;
                user-select: none;
                outline: 2px solid transparent;
                outline-offset: -2px;
                transition: 
                    all 0.5s ease, /* FIXME: This may be very dangerous, we must add transition only for some properties */
                    outline 0.15s ease;
                box-sizing: border-box;
                pointer-events: auto;
                overflow: hidden;
                line-height: normal;
            }

            :host(.block-absolute) {
                position: absolute;
            }

            :host(.block-flow) {
                position: relative;
                width: 100%;
            }

            :host(.block-selected) {
                transition: none !important;
                outline-color: var(--accent-color, #0078d4);
                z-index: 1000;
            }

            :host(.snap-highlight) {
                outline: 1px solid #ff4081 !important;
                outline-offset: 1px !important;
                box-shadow: 0 0 0 4px rgba(255, 64, 129, 0.15) !important;
                transition: none !important;
                z-index: 999;
            }

            .style-slot-active {
                outline: 1px dashed var(--accent-color, #0078d4);
                outline-offset: 2px;
                box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.12);
            }
        `];let ve=pe;he([o({context:m})],ve.prototype,"renderer"),he([o({context:R})],ve.prototype,"documentModel"),he([o({context:L})],ve.prototype,"deviceManager"),he([o({context:P})],ve.prototype,"eventBus"),he([o({context:de,subscribe:!0}),i({attribute:!1})],ve.prototype,"hass"),he([i({type:Object})],ve.prototype,"block"),he([i({type:String})],ve.prototype,"activeDeviceId"),he([s()],ve.prototype,"entity"),he([s()],ve.prototype,"activeStyleSlotId"),he([s()],ve.prototype,"isDragging"),he([s()],ve.prototype,"isResizing"),he([s()],ve.prototype,"canvasWidth"),he([s()],ve.prototype,"canvasHeight");var ge=Object.getOwnPropertyDescriptor;let fe=class extends ve{static getBlockConfig(){return{definition:{label:"Text",icon:'<ha-icon icon="mdi:format-text"></ha-icon>',category:"basic"},defaults:{},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"content",label:"Content",traits:[{type:"text",name:"text",label:"Text",placeholder:"Enter text...",binding:{type:"text",placeholder:"Enter text..."}}]}]},styles:{preset:"full"}}}render(){var e;const t=(null==(e=this.block)?void 0:e.props)||{},i="object"==typeof t.text&&null!==t.text?t.text:void 0,o="string"==typeof(null==i?void 0:i.value)?i.value:"",n=this.resolvePropBinding("text",o||"Text"),s=null==n?"Text":String(n);return r`
            <div class="text-content">
                ${s}
            </div>
        `}};fe.styles=[...ve.styles,n`
            :host {
                overflow: hidden;
            }
            .text-content {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        `],fe=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?ge(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-text")],fe);const be=class extends ve{resolveValue(e,t=""){const i=this.resolveRawValue(e,t);return null==i?t:"string"==typeof i?i:String(i)}resolveNumber(e,t){const i=this.resolveRawValue(e,t);if("number"==typeof i)return Number.isNaN(i)?t:i;const o=parseFloat(String(i));return Number.isNaN(o)?t:o}resolveBoolean(e,t=!1){const i=this.resolveRawValue(e,t);return"boolean"==typeof i?i:"string"==typeof i?"true"===i.toLowerCase():"number"==typeof i?0!==i:t}getEntityAttribute(e){var t;const i=this.getEntityState();return null==(t=null==i?void 0:i.attributes)?void 0:t[e]}formatNumber(e,t){return void 0!==t&&t>=0?e.toFixed(t):String(e)}getEntityIcon(e){return this.getEntityAttribute("icon")||e}getEntityName(){return this.getEntityAttribute("friendly_name")||this.entity||"Unknown"}getEntityDomain(){return this.entity?this.entity.split(".")[0]:null}getAttributeConfig(){var e,t;const i=this.resolveRawValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributes,[]);return Array.isArray(i)?i:[]}resolveRawValue(e,t){if(null==e)return t;if("object"==typeof e){if("value"in e&&"isTemplate"in e){const i=e;return i.isTemplate?`[Template: ${i.value}]`:i.value??t}if("binding"in e||"value"in e&&!("isTemplate"in e)){const i=e,o=i.value??t;if(i.binding&&this.bindingEvaluator){return this.bindingEvaluator.evaluate(i.binding,{defaultEntityId:this.resolvedEntityId(),defaultValue:o}).value??o}return o}}return e}isStateVisible(){var e,t;return this.resolveBoolean(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.showState,!0)}isAttributeVisible(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.visible)??!1}getVisibleAttributes(){return this.getAttributeConfig().filter(e=>e.visible)}getAttributeLabel(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.label)?t.label:e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}};be.styles=[...ve.styles,n`
      .no-entity {
        color: var(--warning-color, #ff9800);
        font-size: 14px;
        padding: 8px;
        text-align: center;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
      }
    `];let ye=be;const me=class extends ye{get hasLockedEntity(){var e,t;return"inherited"===(null==(t=null==(e=this.block)?void 0:e.entityConfig)?void 0:t.mode)}get isParentManaged(){var e;return this.resolveBoolean(null==(e=this.block)?void 0:e.parentManaged,!1)}getBlockEntities(){var e,t;if(!this.block)return[];if("fixed"===(null==(e=this.block.entityConfig)?void 0:e.mode)&&this.block.entityConfig.entityId)return[this.block.entityConfig.entityId];const i=null==(t=this.documentModel)?void 0:t.resolveEntityForBlock(this.block.id);return(null==i?void 0:i.entityId)?[i.entityId]:[]}getAttributeConfig(){var e,t;const i=this.resolveRawValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributes,[]);return Array.isArray(i)?i:[]}isStateVisible(){var e,t;return this.resolveBoolean(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.showState,!0)}isAttributeVisible(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.visible)??!1}getVisibleAttributes(){return this.getAttributeConfig().filter(e=>e.visible)}getAttributeLabel(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.label)?t.label:e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}renderAttribute(e){const t=this.getEntityAttribute(e),i=this.getAttributeLabel(e),o=this.getAttributeConfig().find(t=>t.name===e),n=(null==o?void 0:o.showLabel)??!0;return r`
      <div class="attribute-row">
        ${n?r`<span class="attribute-label">${i}</span>`:""}
        <span class="attribute-value">${void 0!==t?t:""}</span>
      </div>
    `}renderAttributes(){const e=this.getVisibleAttributes();return 0===e.length?r``:r`
      <div class="attributes-container">
        ${e.map(e=>this.renderAttribute(e.name))}
      </div>
    `}};me.styles=[...ye.styles];let ke=me;var Se=Object.getOwnPropertyDescriptor;let xe=class extends ke{static getBlockConfig(){return{definition:{label:"Entity Attribute",icon:'<ha-icon icon="mdi:tag-text-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{attributeName:"",showLabel:!0,customLabel:"",labelPosition:"top",format:"text",precision:1,prefix:"",suffix:""}},entityDefaults:{mode:"inherited"},styleSlots:{label:{label:"Label",description:"Label shown for the attribute name",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},value:{label:"Value",description:"Formatted attribute value",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}getPanelConfig(){return{properties:{groups:[{id:"attribute",label:"Attribute",traits:[{type:"text",name:"attributeName",label:"Attribute Name",placeholder:"Enter attribute name"}]},{id:"label",label:"Label",traits:[{type:"checkbox",name:"showLabel",label:"Show Label"},{type:"text",name:"customLabel",label:"Custom Label",placeholder:"Auto-generated from attribute name"},{type:"select",name:"labelPosition",label:"Label Position",options:[{value:"top",label:"Top"},{value:"left",label:"Left"},{value:"inline",label:"Inline"}]}]},{id:"formatting",label:"Formatting",traits:[{type:"select",name:"format",label:"Format",options:[{value:"text",label:"Text"},{value:"numeric",label:"Numeric"},{value:"integer",label:"Integer"},{value:"date",label:"Date"},{value:"boolean",label:"Boolean"}]},{type:"number",name:"precision",label:"Precision",min:0,max:10},{type:"text",name:"prefix",label:"Prefix",templateSupport:!0},{type:"text",name:"suffix",label:"Suffix",templateSupport:!0}]}]},styles:{preset:"full"}}}render(){var e,t,i,o,n,s,l,d,u,h;if(!this.entity)return r`
        <div class="no-entity">No entity selected</div>
      `;if(!this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributeName))return r`
          <div class="no-entity">No attribute selected</div>
      `;const p=this.getAttributeValue(),v=this.formatValue(p),g=this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.prefix),f=this.resolveValue(null==(s=null==(n=this.block)?void 0:n.props)?void 0:s.suffix),b=this.resolveBoolean(null==(d=null==(l=this.block)?void 0:l.props)?void 0:d.showLabel,!0),y=this.getLabelText(),m=this.resolveValue(null==(h=null==(u=this.block)?void 0:u.props)?void 0:h.labelPosition,"top"),k=this.getSlotStyle("label"),S=this.getSlotStyle("value"),x=this.isStyleSlotActive("label"),I=this.isStyleSlotActive("value");return r`
      
        <div class="attribute-container layout-${m}">
          ${b?r`
            <div
              class="attribute-label ${x?"style-slot-active":a}"
              style=${c(k)}
              data-style-slot="label"
            >${y}:</div>
          `:a}
          <div
            class="attribute-value ${I?"style-slot-active":a}"
            style=${c(S)}
            data-style-slot="value"
          >
            <div class="value-content">
              ${g?r`<span class="value-prefix">${g}</span>`:a}
              <span>${v}</span>
              ${f?r`<span class="value-suffix">${f}</span>`:a}
            </div>
          </div>
        </div>
      
    `}getAttributeValue(){var e,t;const i=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributeName);if(i)return this.getEntityAttribute(i)}formatValue(e){var t,i,o,n;if(null==e)return"";const s=this.resolveValue(null==(i=null==(t=this.block)?void 0:t.props)?void 0:i.format,"text");if("numeric"===s||"integer"===s){const t="number"==typeof e?e:parseFloat(String(e));if(!isNaN(t)){const e="integer"===s?0:this.resolveNumber(null==(n=null==(o=this.block)?void 0:o.props)?void 0:n.precision,1);return this.formatNumber(t,e)}}if("date"===s&&e)try{const t=new Date(e);if(!isNaN(t.getTime()))return t.toLocaleString()}catch(r){}if("boolean"===s){return!0===e||"on"===e||"true"===e||"1"===e?"Yes":"No"}return String(e)}getLabelText(){var e,t,i,o;const n=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.customLabel);if(n)return n;const s=this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.attributeName);return s?this.getAttributeLabel(s):"Attribute"}};xe.styles=[...ke.styles,n`
      .attribute-container {
        width: 100%;
        height: 100%;
        display: flex;
        box-sizing: border-box;
      }
      
      .attribute-container.layout-top {
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      .attribute-container.layout-left {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      
      .attribute-container.layout-inline {
        flex-direction: row;
        align-items: baseline;
        gap: 4px;
      }
      
      .attribute-label {
        font-size: 12px;
        white-space: nowrap;
      }
      
      .layout-top .attribute-label {
        margin-bottom: 4px;
      }
      
      .attribute-value {
        font-size: 14px;
        white-space: nowrap;
      }
      
      .value-content {
        display: flex;
        align-items: baseline;
        gap: 4px;
      }
    `],xe=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?Se(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-entity-field-attribute")],xe);var Ie=Object.getOwnPropertyDescriptor;let we=class extends ke{static getBlockConfig(){return{definition:{label:"Entity Icon",icon:'<ha-icon icon="mdi:gamepad-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{customIcon:"",useStateIcon:!0,iconSize:24,color:"",colorMode:"fixed",stateColors:[],availableColor:"",unavailableColor:"#9e9e9e"}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"icon",label:"Icon",traits:[{type:"icon-picker",name:"customIcon",label:"Custom Icon",placeholder:"mdi:icon-name",binding:{type:"text",placeholder:"mdi:icon-name"}},{type:"checkbox",name:"useStateIcon",label:"Use State Icon"},{type:"number",name:"iconSize",label:"Icon Size",min:12,max:128}]},{id:"color",label:"Color",traits:[{type:"select",name:"colorMode",label:"Color Mode",options:[{value:"fixed",label:"Fixed"},{value:"state",label:"State-based"},{value:"availability",label:"Availability-based"}]},{type:"color",name:"color",label:"Color",visible:{prop:"colorMode",eq:"fixed"}},{type:"color",name:"availableColor",label:"Available Color",visible:{prop:"colorMode",eq:"availability"}},{type:"color",name:"unavailableColor",label:"Unavailable Color",visible:{prop:"colorMode",eq:"availability"}}]}]},styles:{preset:"full"}}}render(){var e,t;if(!this.entity)return r`
        <div class="no-entity">No entity selected</div>
      `;const i=this.getIcon(),o=this.resolveNumber(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.iconSize,24),n=this.getIconColor();return i?r`
      
        <div 
          class="icon-container"
          style="
            --mdc-icon-size: ${o}px;
            ${n?`--icon-primary-color: ${n};`:""}
          "
        >
          <ha-icon 
            class="entity-icon"
            .icon="${i}"
          ></ha-icon>
        </div>
    `:r`
          <div class="icon-container">
            <div class="fallback-icon">?</div>
          </div>
      `}getIcon(){var e,t,i,o;const n=null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.customIcon,s="object"==typeof n&&null!==n&&"value"in n?this.resolveValue(n.value):"",r=this.resolvePropBinding("customIcon",s),l="string"==typeof r?r:null!=r?String(r):"";if(l)return l;return this.resolveBoolean(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.useStateIcon,!0)?this.getEntityIcon()||"mdi:alert-circle-outline":""}getIconColor(){var e,t,i,o,n,s,r,l,a,c,d;const u=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.colorMode,"fixed");if("fixed"===u){return this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.color)||void 0}if("state"===u){const e=null==(n=this.getEntityState())?void 0:n.state,t=this.resolveRawValue(null==(r=null==(s=this.block)?void 0:s.props)?void 0:r.stateColors,[]),i=(Array.isArray(t)?t:[]).find(t=>t.state===e);return null==i?void 0:i.color}if("availability"===u){const e=this.isEntityAvailable(),t=this.resolveValue(null==(a=null==(l=this.block)?void 0:l.props)?void 0:a.availableColor),i=this.resolveValue(null==(d=null==(c=this.block)?void 0:c.props)?void 0:d.unavailableColor,"#9e9e9e");return e?t||void 0:i}}};we.styles=[...ke.styles,n`
      .icon-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
      }
      
      .entity-icon {
        width: var(--mdc-icon-size, 24px);
        height: var(--mdc-icon-size, 24px);
        color: var(--icon-primary-color, currentColor);
        transition: color 0.3s ease;
      }
      
      .entity-icon svg,
      .entity-icon ha-icon,
      .entity-icon mwc-icon {
        width: 100%;
        height: 100%;
        fill: currentColor;
      }
      
      .fallback-icon {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--mdc-icon-size, 24px);
      }
    `],we=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?Ie(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-entity-field-icon")],we);var Ce=Object.getOwnPropertyDescriptor;let Ee=class extends ke{static getBlockConfig(){return{definition:{label:"Entity Image",icon:'<ha-icon icon="mdi:image-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{customImageUrl:"",fallbackIcon:"mdi:image-off-outline",objectFit:"cover"}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"image",label:"Image",traits:[{type:"text",name:"customImageUrl",label:"Custom Image URL",placeholder:"Leave empty to use entity_picture"},{type:"icon-picker",name:"fallbackIcon",label:"Fallback Icon",placeholder:"mdi:image-off-outline"},{type:"select",name:"objectFit",label:"Object Fit",options:[{value:"contain",label:"Contain"},{value:"cover",label:"Cover"},{value:"fill",label:"Fill"},{value:"scale-down",label:"Scale Down"}]}]}]},styles:{preset:"full"}}}render(){var e,t;if(!this.entity)return r`
        <div class="no-entity">No entity selected</div>
      `;const i=this.getImageUrl(),o=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.objectFit,"cover");if(!i){const e=this.getFallbackIcon();return r`
        
        <div class="image-container">
          <div class="fallback-icon-container">
            <ha-icon class="fallback-icon" .icon="${e}"></ha-icon>
          </div>
        </div>
      `}return r`
      <div class="image-container">
        <img 
          class="entity-picture"
          src="${i}"
          alt="${this.getEntityName()}"
          style="--object-fit: ${o};"
          @error="${this._handleImageError}"
        />
      </div>
    `}getImageUrl(){var e,t;const i=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.customImageUrl);if(i)return i;return this.getEntityAttribute("entity_picture")||null}getFallbackIcon(){var e,t;return this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.fallbackIcon,"mdi:image-off-outline")}_handleImageError(e){const t=e.target,i=this.getFallbackIcon(),o=t.parentElement;o&&(o.innerHTML=`\n        <div class="fallback-icon-container">\n          <ha-icon class="fallback-icon" icon="${i}"></ha-icon>\n        </div>\n      `)}};Ee.styles=[...ke.styles,n`
      .image-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        overflow: hidden;
      }
      .entity-picture {
        width: 100%;
        height: 100%;
        object-fit: var(--object-fit, cover);
        transition: filter 0.3s ease;
      }
      
      .fallback-icon-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .fallback-icon {
        width: 50%;
        height: 50%;
        max-width: 48px;
        max-height: 48px;
      }
      
      .fallback-icon svg,
      .fallback-icon ha-icon {
        width: 100%;
        height: 100%;
        fill: currentColor;
      }
    `],Ee=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?Ce(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-entity-field-image")],Ee);var Be=Object.getOwnPropertyDescriptor;let De=class extends ke{static getBlockConfig(){return{definition:{label:"Entity Name",icon:'<ha-icon icon="mdi:alphabetical-variant"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{customName:"",useEntityName:!0,showDomain:!1,case:"none",maxLength:0,ellipsis:!0}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{styles:{preset:"full"}}}render(){var e,t,i,o,n,s;if(!this.entity)return r`
                <div class="no-entity">No entity selected</div>
            `;const l=this.getDisplayName(),a=this.formatName(l),c=this.truncateName(a),d=this.resolveBoolean(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.showDomain,!1)?this.getEntityDomain():null,u=this.resolveBoolean(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.ellipsis,!0),h=this.resolveNumber(null==(s=null==(n=this.block)?void 0:n.props)?void 0:s.maxLength,0);return r`
      <div class="name-container">
        <div class="name-text ${u&&0===h?"ellipsis":""}">
          ${d?r`<span class="domain">${d}.</span>`:""}
          ${c}
        </div>
      </div>
    `}getDisplayName(){var e,t,i,o;const n=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.customName);if(n)return n;return this.resolveBoolean(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.useEntityName,!0)?this.getEntityName():""}formatName(e){var t,i;switch(this.resolveValue(null==(i=null==(t=this.block)?void 0:t.props)?void 0:i.case,"none")){case"upper":return e.toUpperCase();case"lower":return e.toLowerCase();case"title":return e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ");default:return e}}truncateName(e){var t,i,o,n;const s=this.resolveNumber(null==(i=null==(t=this.block)?void 0:t.props)?void 0:i.maxLength,0);if(s>0&&e.length>s){return this.resolveBoolean(null==(n=null==(o=this.block)?void 0:o.props)?void 0:n.ellipsis,!0)?e.substring(0,s)+"...":e.substring(0,s)}return e}};De.styles=[...ke.styles,n`
      .name-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: var(--text-align, flex-start);
        box-sizing: border-box;
      }
      
      .name-text {
        overflow: hidden;
        white-space: nowrap;
      }
      
      .name-text.ellipsis {
        text-overflow: ellipsis;
      }
      
      .name-text.wrap {
        white-space: normal;
        word-break: break-word;
      }
      
      .domain {
        opacity: 0.6;
        margin-right: 2px;
      }
    `],De=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?Be(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-entity-field-name")],De);var $e=Object.getOwnPropertyDescriptor;let _e=class extends ke{static getBlockConfig(){return{definition:{label:"Entity State",icon:'<ha-icon icon="mdi:state-machine"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{format:"text",precision:1,prefix:"",suffix:"",showUnit:!0,customUnit:""}},entityDefaults:{mode:"inherited"},styleSlots:{state:{label:"State value",description:"Main state text with prefix and suffix",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},unit:{label:"Unit",description:"Unit of measurement displayed after the value",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}getPanelConfig(){return{properties:{groups:[{id:"formatting",label:"Formatting",traits:[{type:"select",name:"format",label:"Format",options:[{value:"text",label:"Text"},{value:"numeric",label:"Numeric"},{value:"integer",label:"Integer"},{value:"boolean",label:"Boolean"}]},{type:"number",name:"precision",label:"Precision",min:0,max:10,visible:{prop:"format",in:["numeric"]}},{type:"text",name:"prefix",label:"Prefix",templateSupport:!0},{type:"text",name:"suffix",label:"Suffix",templateSupport:!0}]},{id:"unit",label:"Unit",traits:[{type:"checkbox",name:"showUnit",label:"Show Unit"},{type:"text",name:"customUnit",label:"Custom Unit",placeholder:"Leave empty for auto"}]}]},styles:{preset:"full"}}}render(){var e,t,i,o,n,s;if(!this.entity)return r`
                <div class="no-entity">No entity selected</div>
            `;if(!this.hass||!this.getEntityState())return r`
                <div class="state-container">
                    <div class="state-value"></div>
                </div>
            `;const l=this.getDisplayValue(),a=this.formatValue(l),d=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.prefix),u=this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.suffix),h=this.getUnit(),p=this.resolveValue(null==(s=null==(n=this.block)?void 0:n.props)?void 0:s.format,"text"),v="numeric"===p||"integer"===p,g=this.getSlotStyle("state"),f=this.getSlotStyle("unit"),b=this.isStyleSlotActive("state"),y=this.isStyleSlotActive("unit");return r`
            <div class="state-container">
                ${d?r`<span class="state-prefix">${d}</span>`:""}
                <div
                    class="state-value ${b?"style-slot-active":""}"
                    style=${c(g)}
                    data-style-slot="state"
                >
                    <span class="${v?"state-number":""}">${a}</span>
                </div>
                ${u?r`<span class="state-suffix">${u}</span>`:""}
                ${h?r`
                    <span
                        class="state-unit ${y?"style-slot-active":""}"
                        style=${c(f)}
                        data-style-slot="unit"
                    >${h}</span>
                `:""}
            </div>
        `}getDisplayValue(){var e;return(null==(e=this.getEntityState())?void 0:e.state)||""}formatValue(e){var t,i,o,n;const s=this.resolveValue(null==(i=null==(t=this.block)?void 0:t.props)?void 0:i.format,"text");if("numeric"===s||"integer"===s){const t=parseFloat(e);if(!isNaN(t)){const e="integer"===s?0:this.resolveNumber(null==(n=null==(o=this.block)?void 0:o.props)?void 0:n.precision,1);return this.formatNumber(t,e)}}if("boolean"===s){return"on"===e||"true"===e||"1"===e?"On":"Off"}return e}getUnit(){var e,t,i,o;if(!this.resolveBoolean(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.showUnit,!0))return"";const n=this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.customUnit);return n||(this.getEntityAttribute("unit_of_measurement")||"")}getValueColor(){var e,t,i,o,n,s,r,l,a;const c=this.resolveValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.colorMode,"fixed");if("fixed"===c){return this.resolveValue(null==(o=null==(i=this.block)?void 0:i.props)?void 0:o.color)||void 0}if("state"===c){const e=null==(n=this.getEntityState())?void 0:n.state,t=this.resolveRawValue(null==(r=null==(s=this.block)?void 0:s.props)?void 0:r.stateColors,[]),i=(Array.isArray(t)?t:[]).find(t=>t.state===e);return null==i?void 0:i.color}if("range"===c){const e=parseFloat(this.getDisplayValue());if(!isNaN(e)){const t=this.resolveRawValue(null==(a=null==(l=this.block)?void 0:l.props)?void 0:a.rangeColors,[]),i=[...Array.isArray(t)?t:[]].sort((e,t)=>t.threshold-e.threshold).find(t=>e>=t.threshold);return null==i?void 0:i.color}}}};_e.styles=[...ke.styles,n`
            .state-value {
                font-size: 16px;
                white-space: nowrap;
                display: inline-block;
            }
            .state-number {
                font-variant-numeric: tabular-nums;
            }
            .state-unit {
                font-size: 0.8em;
                margin-left: 2px;
            }
        `],_e=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?$e(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-entity-field-state")],_e);const ze="desktop";class Re{constructor(e,t,i,o={}){this.documentModel=e,this.presetService=t,this.blockRegistry=i,this.cache=new Map,this.listeners=new Map,this.bindingContext={},this.mergedPresetCache=new Map,this.config={enableCache:o.enableCache??!0,maxCacheSize:o.maxCacheSize??1e3,cacheTTL:o.cacheTTL??3e5,evaluateBindings:o.evaluateBindings??!0}}setBindingEvaluator(e){this.bindingEvaluator=e,this.config.evaluateBindings&&this.clearCache()}setBindingContext(e){this.bindingContext=e,this.config.evaluateBindings&&this.bindingEvaluator&&this.clearCache()}setEvaluateBindings(e){this.config.evaluateBindings!==e&&(this.config.evaluateBindings=e,this.clearCache())}resolve(e,t,i){return this.resolveTarget(e,t,void 0,i)}resolveSlot(e,t,i,o){return this.resolveTarget(e,i,t,o)}resolveProperty(e,t,i,o){var n;return null==(n=this.resolve(e,t)[i])?void 0:n[o]}resolveSlotProperty(e,t,i,o,n){var s;return null==(s=this.resolveSlot(e,t,i)[o])?void 0:s[n]}invalidate(e){let t=0;switch(e.level){case"all":t=this.cache.size,this.cache.clear(),this.mergedPresetCache.clear();break;case"block":if(e.blockId)if(e.deviceId){const i=this.getCacheKey(e.blockId,e.deviceId);this.cache.delete(i)&&t++;for(const[o,n]of this.cache)n.blockId===e.blockId&&n.deviceId===e.deviceId&&(this.cache.delete(o),t++)}else for(const[i,o]of this.cache)o.blockId===e.blockId&&(this.cache.delete(i),t++);break;case"device":if(e.deviceId)for(const[i,o]of this.cache)o.deviceId===e.deviceId&&(this.cache.delete(i),t++);break;case"preset":if(e.presetId){this.mergedPresetCache.delete(e.presetId);for(const[t]of this.mergedPresetCache){this.presetService.getInheritanceChain(t).some(t=>t.id===e.presetId)&&this.mergedPresetCache.delete(t)}for(const[i,o]of this.cache)o.presetId===e.presetId&&(this.cache.delete(i),t++)}break;case"block-type":if(e.blockType)for(const[i,o]of this.cache){const n=this.documentModel.blocks[o.blockId];(null==n?void 0:n.type)===e.blockType&&(this.cache.delete(i),t++)}break;case"entity":if(e.entityId)for(const[i,o]of this.cache){const n=this.documentModel.blocks[o.blockId];this.blockUsesEntity(n,e.entityId)&&(this.cache.delete(i),t++)}}return this.emit("cache-invalidated",{target:e,affectedEntries:t}),t}invalidateByEntity(e){return this.invalidate({level:"entity",entityId:e})}clearCache(){this.cache.clear(),this.mergedPresetCache.clear()}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var i;null==(i=this.listeners.get(e))||i.delete(t)}}resolveTarget(e,t,i,o){var n,s;const r=o||this.bindingContext,l=this.getCacheKey(e,t,i);if(this.config.enableCache&&!r&&!this.config.evaluateBindings){const e=this.getCachedByKey(l);if(e)return e.resolved}const a=this.documentModel.getBlock(e);if(!a)return{};const c=i?null==(s=null==(n=a.styleSlots)?void 0:n[i])?void 0:s.stylePresetId:a.stylePresetId,d={blockId:e,slotId:i,deviceId:t,blockType:a.type,presetId:c},u=this.resolveAllCategories(a,d,r);return this.config.enableCache&&this.setCache(e,i,t,c,u),u}resolveAllCategories(e,t,i){const o={},n=this.getAllCategories(e,t);for(const s of n){const n=this.resolveCategory(e,t,s,i);Object.keys(n).length>0&&(o[s]=n)}return o}getAllCategories(e,t){var i,o;const n=new Set,s=null==(i=this.blockRegistry)?void 0:i.getBlockDefaults(t.blockType);if(s&&!t.slotId&&Object.keys(s).forEach(e=>n.add(e)),t.presetId){const e=this.presetService.getCachedPreset(t.presetId);if(null==(o=null==e?void 0:e.data)?void 0:o.devices)for(const t of Object.values(e.data.devices))t&&Object.keys(t).forEach(e=>n.add(e))}const r=this.getInlineSources(e,t);for(const l of r)l&&Object.keys(l).forEach(e=>n.add(e));return Array.from(n)}resolveCategory(e,t,i,o){const n={},s=this.getAllPropertiesInCategory(e,t,i);for(const r of s){const s=this.resolvePropertyValue(e,t,i,r,o);s&&(n[r]=s)}return n}getAllPropertiesInCategory(e,t,i){var o,n,s;const r=new Set,l=null==(o=this.blockRegistry)?void 0:o.getBlockDefaults(t.blockType);if(!t.slotId&&(null==l?void 0:l[i])&&Object.keys(l[i]).forEach(e=>r.add(e)),t.presetId){const e=this.getPresetStylesForDevice(t.presetId,t.deviceId);(null==(n=e.styles)?void 0:n[i])&&Object.keys(e.styles[i]).forEach(e=>r.add(e))}const a=this.getInlineStylesWithFallback(e,t.deviceId,t.slotId);return(null==(s=a.styles)?void 0:s[i])&&Object.keys(a.styles[i]).forEach(e=>r.add(e)),Array.from(r)}resolvePropertyValue(e,t,i,o,n){const s=this.hasLocalOverride(e,t.deviceId,i,o,t.slotId),r=this.getPropertyFromInline(e,t.deviceId,i,o,t.slotId);if(void 0!==r.value)return this.createResolvedValue(r,"inline",t.deviceId,s,void 0,n);if(t.deviceId!==ze){const r=this.getPropertyFromInline(e,ze,i,o,t.slotId);if(void 0!==r.value)return this.createResolvedValue(r,"inline-fallback",ze,s,void 0,n)}if(t.presetId){const e=this.getPropertyFromPreset(t.presetId,t.deviceId,i,o);if(void 0!==e.value)return this.createResolvedValue(e,"preset",t.deviceId,s,t.presetId,n);if(t.deviceId!==ze){const e=this.getPropertyFromPreset(t.presetId,ze,i,o);if(void 0!==e.value)return this.createResolvedValue(e,"preset-fallback",ze,s,t.presetId,n)}}if(!t.slotId){const e=this.getPropertyFromBlockDefaults(t.blockType,i,o);if(void 0!==e.value)return this.createResolvedValue(e,"block-type-default",void 0,s,void 0,n)}}hasLocalOverride(e,t,i,o,n){var s,r,l,a,c,d,u,h;return n?void 0!==(null==(c=null==(a=null==(l=null==(r=null==(s=e.styleSlots)?void 0:s[n])?void 0:r.deviceStyles)?void 0:l[t])?void 0:a[i])?void 0:c[o]):void 0!==(null==(h=null==(u=null==(d=e.deviceStyles)?void 0:d[t])?void 0:u[i])?void 0:h[o])}createResolvedValue(e,t,i,o,n,s){const r=e.value,l=r.binding,a=r.unit;let c;if(l&&this.config.evaluateBindings&&this.bindingEvaluator){c=this.bindingEvaluator.evaluate(l,{defaultEntityId:(null==s?void 0:s.defaultEntityId)||this.bindingContext.defaultEntityId,defaultValue:r.value}).value}else c=l?l.default??r.value:r.value;return{value:c,unit:a,origin:t,originDevice:i,presetId:n,binding:l,hasLocalOverride:o}}getInlineStylesWithFallback(e,t,i){var o,n;const s=i?null==(n=null==(o=e.styleSlots)?void 0:o[i])?void 0:n.deviceStyles:e.deviceStyles;return(null==s?void 0:s[t])?{styles:s[t],originDevice:t}:t!==ze&&(null==s?void 0:s[ze])?{styles:s[ze],originDevice:ze}:{styles:void 0,originDevice:void 0}}getInlineSources(e,t){var i;if(t.slotId){const o=null==(i=e.styleSlots)?void 0:i[t.slotId];return(null==o?void 0:o.deviceStyles)?Object.values(o.deviceStyles).filter(Boolean):[]}return e.deviceStyles?Object.values(e.deviceStyles).filter(Boolean):[]}getPresetStylesForDevice(e,t){const i=this.getMergedPreset(e);return(null==i?void 0:i.devices)?i.devices[t]?{styles:i.devices[t],originDevice:t}:t!==ze&&i.devices[ze]?{styles:i.devices[ze],originDevice:ze}:{styles:void 0,originDevice:void 0}:{styles:void 0,originDevice:void 0}}getPropertyFromInline(e,t,i,o,n){var s,r,l,a,c,d,u,h;return{value:n?null==(c=null==(a=null==(l=null==(r=null==(s=e.styleSlots)?void 0:s[n])?void 0:r.deviceStyles)?void 0:l[t])?void 0:a[i])?void 0:c[o]:null==(h=null==(u=null==(d=e.deviceStyles)?void 0:d[t])?void 0:u[i])?void 0:h[o]}}getPropertyFromPreset(e,t,i,o){var n,s,r;const l=this.getMergedPreset(e);return{value:null==(r=null==(s=null==(n=null==l?void 0:l.devices)?void 0:n[t])?void 0:s[i])?void 0:r[o]}}getPropertyFromBlockDefaults(e,t,i){var o,n;const s=null==(o=this.blockRegistry)?void 0:o.getBlockDefaults(e);return{value:null==(n=null==s?void 0:s[t])?void 0:n[i]}}getMergedPreset(e){if(this.mergedPresetCache.has(e))return this.mergedPresetCache.get(e);const t=this.mergePresetChain(e);return t&&this.mergedPresetCache.set(e,t),t}mergePresetChain(e,t=new Set){if(t.has(e))return void console.warn(`[StyleResolver] Circular preset inheritance detected: ${Array.from(t).join("  ")}  ${e}`);if(t.size>10)return void console.warn("[StyleResolver] Max preset inheritance depth exceeded");const i=this.presetService.getCachedPreset(e);if(!i)return void console.warn(`[StyleResolver] Preset not found: ${e}`);if(t.add(e),!i.extendsPresetId)return i.data;return function(e,t){if(!e)return t||{devices:{}};if(!t)return e;const i={devices:{}},o=new Set([...Object.keys(e.devices),...Object.keys(t.devices)]);for(const n of o)i.devices[n]=ce(e.devices[n],t.devices[n]);return i}(this.mergePresetChain(i.extendsPresetId,t),i.data)}getCachedByKey(e){const t=this.cache.get(e);if(t){if(!(Date.now()-t.timestamp>this.config.cacheTTL))return t;this.cache.delete(e)}}setCache(e,t,i,o,n){this.cache.size>=this.config.maxCacheSize&&this.evictOldestEntries(Math.floor(.1*this.config.maxCacheSize));const s=this.getCacheKey(e,i,t);this.cache.set(s,{blockId:e,slotId:t,deviceId:i,presetId:o,resolved:n,timestamp:Date.now()})}getCacheKey(e,t,i){return i?`${e}:${i}:${t}`:`${e}:${t}`}evictOldestEntries(e){const t=Array.from(this.cache.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp).slice(0,e);for(const[i]of t)this.cache.delete(i)}blockUsesEntity(e,t){if(!e)return!1;if(!(null==e?void 0:e.deviceStyles)&&!(null==e?void 0:e.styleSlots))return!1;const i=[];if(e.deviceStyles&&i.push(...Object.values(e.deviceStyles).filter(Boolean)),e.styleSlots)for(const o of Object.values(e.styleSlots))(null==o?void 0:o.deviceStyles)&&i.push(...Object.values(o.deviceStyles).filter(Boolean));return this.blockDeviceStylesUsesEntity(i,e,t)}blockDeviceStylesUsesEntity(e,t,i){for(const o of e)for(const e of Object.values(o))if(e)for(const o of Object.values(e)){if(!o||"object"!=typeof o)continue;const e=o;if(e.binding){if(M(e.binding,t,this.documentModel).includes(i))return!0}}return!1}emit(e,t){var i;null==(i=this.listeners.get(e))||i.forEach(e=>{try{e(t)}catch(i){console.error("[StyleResolver] Event handler error:",i)}})}}const Me=["px","rem","em","%","vh","vw","vmin","vmax","ch","ex","cm","mm","in","pt","pc"],Ae=["px","rem","em","vh","vw","vmin","vmax","ch","ex","cm","mm","in","pt","pc"],Pe=[...Me,"auto"],Te=[...Me,"none"],Oe={"size.width":Pe,"size.height":Pe,"size.minWidth":Pe,"size.maxWidth":Te,"size.minHeight":Pe,"size.maxHeight":Te,"spacing.margin":Me,"spacing.padding":Me,"spacing.marginTop":Me,"spacing.marginRight":Me,"spacing.marginBottom":Me,"spacing.marginLeft":Me,"spacing.paddingTop":Me,"spacing.paddingRight":Me,"spacing.paddingBottom":Me,"spacing.paddingLeft":Me,"typography.fontSize":Me,"typography.letterSpacing":Ae,"border.borderWidth":Ae,"border.borderTopWidth":Ae,"border.borderRightWidth":Ae,"border.borderBottomWidth":Ae,"border.borderLeftWidth":Ae,"border.borderRadius":Me,"border.borderTopLeftRadius":Me,"border.borderTopRightRadius":Me,"border.borderBottomRightRadius":Me,"border.borderBottomLeftRadius":Me,"flex.gap":Me,"flex.rowGap":Me,"flex.columnGap":Me,"flex.flexBasis":Pe},Le={"size.width":"px","size.height":"px","size.minWidth":"px","size.maxWidth":"px","size.minHeight":"px","size.maxHeight":"px","spacing.margin":"px","spacing.padding":"px","spacing.marginTop":"px","spacing.marginRight":"px","spacing.marginBottom":"px","spacing.marginLeft":"px","spacing.paddingTop":"px","spacing.paddingRight":"px","spacing.paddingBottom":"px","spacing.paddingLeft":"px","typography.fontSize":"px","typography.letterSpacing":"px","border.borderWidth":"px","border.borderTopWidth":"px","border.borderRightWidth":"px","border.borderBottomWidth":"px","border.borderLeftWidth":"px","border.borderRadius":"px","border.borderTopLeftRadius":"px","border.borderTopRightRadius":"px","border.borderBottomRightRadius":"px","border.borderBottomLeftRadius":"px","flex.gap":"px","flex.rowGap":"px","flex.columnGap":"px","flex.flexBasis":"px"},je={width:"px",height:"px",minWidth:"px",maxWidth:"px",minHeight:"px",maxHeight:"px",margin:"px",padding:"px",marginTop:"px",marginRight:"px",marginBottom:"px",marginLeft:"px",paddingTop:"px",paddingRight:"px",paddingBottom:"px",paddingLeft:"px",fontSize:"px",letterSpacing:"px",borderWidth:"px",borderRadius:"px",borderTopWidth:"px",borderRightWidth:"px",borderBottomWidth:"px",borderLeftWidth:"px",borderTopLeftRadius:"px",borderTopRightRadius:"px",borderBottomRightRadius:"px",borderBottomLeftRadius:"px",rowGap:"px",columnGap:"px",gap:"px",flexBasis:"px"};function Ne(e,t){return Oe[`${e}.${t}`]}function We(e,t){return Le[`${e}.${t}`]}function Fe(e,t){var i,o,n,s;if(!t)return!0;if(t.only){const n=(null==(i=t.only.categories)?void 0:i.includes(e))??!1,s=(null==(o=t.only.properties)?void 0:o.some(t=>t.startsWith(`${e}.`)))??!1;return n||s}if(t.exclude){return!((null==(n=t.exclude.categories)?void 0:n.includes(e))??!1)||((null==(s=t.include)?void 0:s.some(t=>t.startsWith(`${e}.`)))??!1)}return!0}function Ve(e,t,i){var o,n,s,r,l;if(!i)return!0;const a=`${e}.${t}`;if(i.only){const t=(null==(o=i.only.categories)?void 0:o.includes(e))??!1,s=(null==(n=i.only.properties)?void 0:n.includes(a))??!1;return t||s}if(i.exclude){const t=(null==(s=i.exclude.categories)?void 0:s.includes(e))??!1,o=(null==(r=i.exclude.properties)?void 0:r.includes(a))??!1;return!!(null==(l=i.include)?void 0:l.includes(a))||!t&&!o}return!0}function Ue(e,t={}){const{filter:i,append:o}=t,n={};for(const[s,r]of Object.entries(e)){if(!r)continue;if("_internal"===s)continue;if(!Fe(s,i))continue;const e=He(s,r,t);Object.assign(n,e)}return o&&Object.assign(n,o),n}function He(e,t,i={}){const o={};switch(e){case"layout":Object.assign(o,function(e,t,i){var o,n,s,r,l;const a={},{useCSSVars:c,varPrefix:d,filter:u}=i;if(void 0!==(null==(o=t.display)?void 0:o.value)&&Ve(e,"display",u)){const e=`${t.display.value}`;a.display=c?`var(--${d}-layout-display, ${e})`:e}if(void 0!==(null==(n=t.positionX)?void 0:n.value)&&Ve(e,"positionX",u)){const e=`${t.positionX.value}px`;a.top=c?`var(--${d}-layout-position-x, ${e})`:e}if(void 0!==(null==(s=t.positionY)?void 0:s.value)&&Ve(e,"positionY",u)){const e=`${null==(r=t.positionY)?void 0:r.value}px`;a.left=c?`var(--${d}-layout-position-y, ${e})`:e}if(void 0!==(null==(l=t.zIndex)?void 0:l.value)&&Ve(e,"zIndex",u)){const e=`${t.zIndex.value}`;a.zIndex=c?`var(--${d}-layout-z-index, ${e})`:e}return a}(e,t,i));break;case"size":Object.assign(o,function(e,t,i){var o,n,s,r,l,a;const c={},{useCSSVars:d,varPrefix:u,filter:h}=i;if(void 0!==(null==(o=t.width)?void 0:o.value)&&Ve(e,"width",h)){const e=Ge(t.width.value,t.width.unit,We("size","width"));void 0!==e&&(c.width=d?`var(--${u}-size-width, ${e})`:e)}if(void 0!==(null==(n=t.height)?void 0:n.value)&&Ve(e,"height",h)){const e=Ge(t.height.value,t.height.unit,We("size","height"));void 0!==e&&(c.height=d?`var(--${u}-size-height, ${e})`:e)}if(void 0!==(null==(s=t.minWidth)?void 0:s.value)&&Ve(e,"minWidth",h)){const e=Ge(t.minWidth.value,t.minWidth.unit,We("size","minWidth"));void 0!==e&&(c.minWidth=d?`var(--${u}-size-min-width, ${e})`:e)}if(void 0!==(null==(r=t.maxWidth)?void 0:r.value)&&Ve(e,"maxWidth",h)){const e=Ge(t.maxWidth.value,t.maxWidth.unit,We("size","maxWidth"));void 0!==e&&(c.maxWidth=d?`var(--${u}-size-max-width, ${e})`:e)}if(void 0!==(null==(l=t.minHeight)?void 0:l.value)&&Ve(e,"minHeight",h)){const e=Ge(t.minHeight.value,t.minHeight.unit,We("size","minHeight"));void 0!==e&&(c.minHeight=d?`var(--${u}-size-min-height, ${e})`:e)}if(void 0!==(null==(a=t.maxHeight)?void 0:a.value)&&Ve(e,"maxHeight",h)){const e=Ge(t.maxHeight.value,t.maxHeight.unit,We("size","maxHeight"));void 0!==e&&(c.maxHeight=d?`var(--${u}-size-max-height, ${e})`:e)}return c}(e,t,i));break;case"spacing":Object.assign(o,function(e,t,i){var o,n,s,r;const l={},{useCSSVars:a,varPrefix:c,filter:d}=i;if(void 0!==(null==(o=t.margin)?void 0:o.value)&&Ve(e,"margin",d)){const e=qe(t.margin.value,t.margin.unit,We("spacing","margin")??"px");l.margin=a?`var(--${c}-spacing-margin, ${e})`:e}if(void 0!==(null==(n=t.padding)?void 0:n.value)&&Ve(e,"padding",d)){const e=qe(t.padding.value,t.padding.unit,We("spacing","padding")??"px");l.padding=a?`var(--${c}-spacing-padding, ${e})`:e}for(const u of["marginTop","marginRight","marginBottom","marginLeft"])if(void 0!==(null==(s=t[u])?void 0:s.value)&&Ve(e,u,d)){const e=Ge(t[u].value,t[u].unit,We("spacing",u));void 0!==e&&(l[u]=a?`var(--${c}-spacing-${u}, ${e})`:e)}for(const u of["paddingTop","paddingRight","paddingBottom","paddingLeft"])if(void 0!==(null==(r=t[u])?void 0:r.value)&&Ve(e,u,d)){const e=Ge(t[u].value,t[u].unit,We("spacing",u));void 0!==e&&(l[u]=a?`var(--${c}-spacing-${u}, ${e})`:e)}return l}(e,t,i));break;case"typography":Object.assign(o,function(e,t,i){var o,n,s,r,l,a,c,d,u,h;const p={},{useCSSVars:v,varPrefix:g,filter:f}=i;if(void 0!==(null==(o=t.fontFamily)?void 0:o.value)&&Ve(e,"fontFamily",f)){const e=String(t.fontFamily.value);p.fontFamily=v?`var(--${g}-typography-fontFamily, ${e})`:e}if(void 0!==(null==(n=t.fontSize)?void 0:n.value)&&Ve(e,"fontSize",f)){const e=Ge(t.fontSize.value,t.fontSize.unit,We("typography","fontSize"));void 0!==e&&(p.fontSize=v?`var(--${g}-typography-fontSize, ${e})`:e)}if(void 0!==(null==(s=t.fontWeight)?void 0:s.value)&&Ve(e,"fontWeight",f)){const e=String(t.fontWeight.value);p.fontWeight=v?`var(--${g}-typography-fontWeight, ${e})`:e}if(void 0!==(null==(r=t.fontStyle)?void 0:r.value)&&Ve(e,"fontStyle",f)){const e=String(t.fontStyle.value);p.fontStyle=v?`var(--${g}-typography-fontStyle, ${e})`:e}if(void 0!==(null==(l=t.lineHeight)?void 0:l.value)&&Ve(e,"lineHeight",f)){const e=String(t.lineHeight.value);p.lineHeight=v?`var(--${g}-typography-lineHeight, ${e})`:e}if(void 0!==(null==(a=t.letterSpacing)?void 0:a.value)&&Ve(e,"letterSpacing",f)){const e=Ge(t.letterSpacing.value,t.letterSpacing.unit,We("typography","letterSpacing"));void 0!==e&&(p.letterSpacing=v?`var(--${g}-typography-letterSpacing, ${e})`:e)}if(void 0!==(null==(c=t.textAlign)?void 0:c.value)&&Ve(e,"textAlign",f)){const e=String(t.textAlign.value);p.textAlign=v?`var(--${g}-typography-textAlign, ${e})`:e}if(void 0!==(null==(d=t.textDecoration)?void 0:d.value)&&Ve(e,"textDecoration",f)){const e=String(t.textDecoration.value);p.textDecoration=v?`var(--${g}-typography-textDecoration, ${e})`:e}if(void 0!==(null==(u=t.textTransform)?void 0:u.value)&&Ve(e,"textTransform",f)){const e=String(t.textTransform.value);p.textTransform=v?`var(--${g}-typography-textTransform, ${e})`:e}if(void 0!==(null==(h=t.color)?void 0:h.value)&&Ve(e,"color",f)){const e=String(t.color.value);p.color=v?`var(--${g}-typography-color, ${e})`:e}return p}(e,t,i));break;case"background":Object.assign(o,function(e,t,i){var o,n,s,r,l,a,c,d,u,h,p,v;const g={},{useCSSVars:f,varPrefix:b,filter:y}=i;if(void 0!==(null==(o=t.backgroundColor)?void 0:o.value)&&Ve(e,"backgroundColor",y)){const e=String(t.backgroundColor.value);g.backgroundColor=f?`var(--${b}-background-color, ${e})`:e}if(void 0!==(null==(n=t.color)?void 0:n.value)&&Ve(e,"color",y)){const e=String(t.color.value);g.backgroundColor=f?`var(--${b}-background-color, ${e})`:e}if(void 0!==(null==(s=t.backgroundImage)?void 0:s.value)&&Ve(e,"backgroundImage",y)){const e=Xe(t.backgroundImage.value);void 0!==e&&(g.backgroundImage=f?`var(--${b}-background-image, ${e})`:e)}if(void 0!==(null==(r=t.image)?void 0:r.value)&&Ve(e,"image",y)){const e=Xe(t.image.value);void 0!==e&&(g.backgroundImage=f?`var(--${b}-background-image, ${e})`:e)}if(void 0!==(null==(l=t.backgroundSize)?void 0:l.value)&&Ve(e,"backgroundSize",y)){const e=String(t.backgroundSize.value);g.backgroundSize=f?`var(--${b}-background-size, ${e})`:e}void 0!==(null==(a=t.size)?void 0:a.value)&&Ve(e,"size",y)&&(g.backgroundSize=String(t.size.value));if(void 0!==(null==(c=t.backgroundRepeat)?void 0:c.value)&&Ve(e,"backgroundRepeat",y)){const e=String(t.backgroundRepeat.value);g.backgroundRepeat=f?`var(--${b}-background-repeat, ${e})`:e}void 0!==(null==(d=t.repeat)?void 0:d.value)&&Ve(e,"repeat",y)&&(g.backgroundRepeat=String(t.repeat.value));if(void 0!==(null==(u=t.backgroundPosition)?void 0:u.value)&&Ve(e,"backgroundPosition",y)){const e=String(t.backgroundPosition.value);g.backgroundPosition=f?`var(--${b}-background-position, ${e})`:e}void 0!==(null==(h=t.position)?void 0:h.value)&&Ve(e,"position",y)&&(g.backgroundPosition=String(t.position.value));if(void 0!==(null==(p=t.boxShadow)?void 0:p.value)&&Ve(e,"boxShadow",y)){const e=String(t.boxShadow.value);g.boxShadow=f?`var(--${b}-background-box-shadow, ${e})`:e}if(void 0!==(null==(v=t.backgroundBlendMode)?void 0:v.value)&&Ve(e,"backgroundBlendMode",y)){const e=String(t.backgroundBlendMode.value);g.backgroundBlendMode=f?`var(--${b}-background-blend-mode, ${e})`:e}return g}(e,t,i));break;case"border":Object.assign(o,function(e,t,i){var o,n,s,r,l,a,c,d,u,h;const p={},{useCSSVars:v,varPrefix:g,filter:f}=i;if(void 0!==(null==(o=t.borderWidth)?void 0:o.value)&&Ve(e,"borderWidth",f)){const e=Ge(t.borderWidth.value,t.borderWidth.unit,We("border","borderWidth"));void 0!==e&&(p.borderWidth=v?`var(--${g}-border-width, ${e})`:e)}if(void 0!==(null==(n=t.width)?void 0:n.value)&&Ve(e,"width",f)){const e=Ge(t.width.value,t.width.unit,We("border","borderWidth"));void 0!==e&&(p.borderWidth=e)}if(void 0!==(null==(s=t.borderStyle)?void 0:s.value)&&Ve(e,"borderStyle",f)){const e=String(t.borderStyle.value);p.borderStyle=v?`var(--${g}-border-style, ${e})`:e}void 0!==(null==(r=t.style)?void 0:r.value)&&Ve(e,"style",f)&&(p.borderStyle=String(t.style.value));if(void 0!==(null==(l=t.borderColor)?void 0:l.value)&&Ve(e,"borderColor",f)){const e=String(t.borderColor.value);p.borderColor=v?`var(--${g}-border-color, ${e})`:e}void 0!==(null==(a=t.color)?void 0:a.value)&&Ve(e,"color",f)&&(p.borderColor=String(t.color.value));if(void 0!==(null==(c=t.borderRadius)?void 0:c.value)&&Ve(e,"borderRadius",f)){const e=Ke(t.borderRadius.value,t.borderRadius.unit,We("border","borderRadius")??"px");p.borderRadius=v?`var(--${g}-border-radius, ${e})`:e}void 0!==(null==(d=t.radius)?void 0:d.value)&&Ve(e,"radius",f)&&(p.borderRadius=Ke(t.radius.value,t.radius.unit,We("border","borderRadius")??"px"));for(const b of["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"])if(void 0!==(null==(u=t[b])?void 0:u.value)&&Ve(e,b,f)){const e=Ge(t[b].value,t[b].unit,We("border",b));void 0!==e&&(p[b]=e)}for(const b of["borderTopLeftRadius","borderTopRightRadius","borderBottomRightRadius","borderBottomLeftRadius"])void 0!==(null==(h=t[b])?void 0:h.value)&&Ve(e,b,f)&&(p[b]=Ke(t[b].value,t[b].unit,We("border",b)??"px"));return p}(e,t,i));break;case"flex":Object.assign(o,function(e,t,i){var o,n,s,r,l,a,c,d,u,h,p;const v={},{useCSSVars:g,varPrefix:f,filter:b}=i;if(void 0!==(null==(o=t.flexDirection)?void 0:o.value)&&Ve(e,"flexDirection",b)){const e=String(t.flexDirection.value);v.flexDirection=g?`var(--${f}-flex-direction, ${e})`:e}void 0!==(null==(n=t.direction)?void 0:n.value)&&Ve(e,"direction",b)&&(v.flexDirection=String(t.direction.value));if(void 0!==(null==(s=t.justifyContent)?void 0:s.value)&&Ve(e,"justifyContent",b)){const e=String(t.justifyContent.value);v.justifyContent=g?`var(--${f}-flex-justify, ${e})`:e}void 0!==(null==(r=t.justify)?void 0:r.value)&&Ve(e,"justify",b)&&(v.justifyContent=String(t.justify.value));if(void 0!==(null==(l=t.alignItems)?void 0:l.value)&&Ve(e,"alignItems",b)){const e=String(t.alignItems.value);v.alignItems=g?`var(--${f}-flex-align, ${e})`:e}void 0!==(null==(a=t.align)?void 0:a.value)&&Ve(e,"align",b)&&(v.alignItems=String(t.align.value));if(void 0!==(null==(c=t.flexWrap)?void 0:c.value)&&Ve(e,"flexWrap",b)){const e=String(t.flexWrap.value);v.flexWrap=g?`var(--${f}-flex-wrap, ${e})`:e}void 0!==(null==(d=t.wrap)?void 0:d.value)&&Ve(e,"wrap",b)&&(v.flexWrap=String(t.wrap.value));if(void 0!==(null==(u=t.gap)?void 0:u.value)&&Ve(e,"gap",b)){const e=Ge(t.gap.value,t.gap.unit,We("flex","gap"));void 0!==e&&(v.gap=g?`var(--${f}-flex-gap, ${e})`:e)}if(void 0!==(null==(h=t.rowGap)?void 0:h.value)&&Ve(e,"rowGap",b)){const e=Ge(t.rowGap.value,t.rowGap.unit,We("flex","rowGap"));void 0!==e&&(v.rowGap=g?`var(--${f}-flex-rowGap, ${e})`:e)}if(void 0!==(null==(p=t.columnGap)?void 0:p.value)&&Ve(e,"columnGap",b)){const e=Ge(t.columnGap.value,t.columnGap.unit,We("flex","columnGap"));void 0!==e&&(v.columnGap=g?`var(--${f}-flex-columnGap, ${e})`:e)}return v}(e,t,i));break;case"effects":Object.assign(o,function(e,t,i){var o,n,s,r;const l={},{useCSSVars:a,varPrefix:c,filter:d}=i;if(void 0!==(null==(o=t.opacity)?void 0:o.value)&&Ve(e,"opacity",d)){const e=String(t.opacity.value);l.opacity=a?`var(--${c}-effects-opacity, ${e})`:e}if(void 0!==(null==(n=t.boxShadow)?void 0:n.value)&&Ve(e,"boxShadow",d)){const e=String(t.boxShadow.value);l.boxShadow=a?`var(--${c}-effects-boxShadow, ${e})`:e}if(void 0!==(null==(s=t.transform)?void 0:s.value)&&Ve(e,"transform",d)){const e=String(t.transform.value);l.transform=a?`var(--${c}-effects-transform, ${e})`:e}if(void 0!==(null==(r=t.filter)?void 0:r.value)&&Ve(e,"filter",d)){const e=String(t.filter.value);l.filter=a?`var(--${c}-effects-filter, ${e})`:e}return l}(e,t,i));break;default:Object.assign(o,function(e,t,i){const o={},{useCSSVars:n,varPrefix:s,filter:r}=i;for(const[l,a]of Object.entries(t)){if(void 0===(null==a?void 0:a.value))continue;if(!Ve(e,l,r))continue;const t=String(a.value);o[l]=n?`var(--${s}-${e}-${l}, ${t})`:t}return o}(e,t,i))}return o}function Ze(e,t,i={}){if(!t||void 0===t.value)return;const o=function(e,t,i){if(null==t)return;const o=function(e){return je[e]}(e);switch(e){case"margin":case"padding":return qe(t,i,o??"px");case"borderRadius":case"radius":return Ke(t,i,o??"px");case"fontSize":case"letterSpacing":case"borderWidth":case"borderTopWidth":case"borderRightWidth":case"borderBottomWidth":case"borderLeftWidth":case"width":case"height":case"minWidth":case"maxWidth":case"minHeight":case"maxHeight":case"rowGap":case"columnGap":case"gap":return Ge(t,i,o)??String(t);case"backgroundImage":case"image":return Xe(t);default:return String(t)}}(e,t.value,t.unit);return void 0!==o?i.useCSSVar&&i.varName?`var(${i.varName}, ${o})`:o:void 0}function Ge(e,t,i){if(null==e)return;if("string"==typeof e)return e;const o=t??i;return o?"auto"===o||"none"===o?o:`${e}${o}`:String(e)}function qe(e,t,i="px"){if("string"==typeof e)return e;const o=t??i;return"auto"===o||"none"===o?o:"number"==typeof e?`${e}${o}`:`${e.top||0}${o} ${e.right||0}${o} ${e.bottom||0}${o} ${e.left||0}${o}`}function Ke(e,t,i="px"){if("string"==typeof e)return e;const o=t??i;return"auto"===o||"none"===o?o:"number"==typeof e?`${e}${o}`:"object"==typeof e?`${e.topLeft||0}${o} ${e.topRight||0}${o} ${e.bottomRight||0}${o} ${e.bottomLeft||0}${o}`:String(e)}function Xe(e){if(null==e)return;const t=String(e).trim();if(!t)return;const i=t.toLowerCase();return"none"===i||i.startsWith("url(")||i.startsWith("var(")||i.startsWith("image-set(")||i.includes("gradient(")?t:`url(${t})`}const Ye=e("style-resolver");var Je=Object.getOwnPropertyDescriptor;const Qe={groups:["background","border","flex"],properties:["layout.display","spacing.padding"]};let et=class extends ve{get isBlockDraggable(){return!1}get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Drop Zone",icon:'<ha-icon icon="mdi:download-box-outline"></ha-icon>',internal:!0},defaults:{canBeDeleted:!1,canBeDuplicated:!1,canChangeLayoutMode:!1},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{styles:this._getParentStyleConfig()??Qe}}render(){var e;const t=(null==(e=this.block)?void 0:e.children)||[],i=t.length>0,o=t.map(e=>this.documentModel.getBlock(e)).filter(e=>!!e);return r`
      ${i?d(o,e=>e.id,e=>this.renderer.renderBlock(e)):r`<div class="empty-state">
                  <div class="empty-state-message">
                      Drop Blocks Here
                  </div>
              </div>`}
    `}getBlockedDropInstructions(){const e=this.documentModel.getBlock(this.blockId),t=this.documentModel.getBlock(e.parentId),i=this.documentModel.getElement(t),o=(null==i?void 0:i.getBlockedDropInstructions())??null;return o&&o.includes("combine")?["reorder-before","reorder-after"]:null}getResolvedContextStyles(){var e;const t=this.documentModel.getBlock(this.blockId)??this.block,i=null==t?void 0:t.parentId,o=this.documentModel.getElement(i),n=null==(e=null==o?void 0:o.getDropZoneResolvedStyleData)?void 0:e.call(o,this.block);return n?Ue(n):this.resolvedRenderContext.styles}_getParentStyleConfig(){var e;const t=this.documentModel.getBlock(this.blockId)??this.block,i=null==t?void 0:t.parentId;if(!i)return;const o=this.documentModel.getElement(i);return null==(e=null==o?void 0:o.getDropZoneStyleConfig)?void 0:e.call(o)}};et.styles=[...ve.styles,n`
      :host {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 20px;
        width: 100%;
        height: 100%;
        position: relative;
      }
      /* Empty state - shown only when no children */
      .empty-state {
        min-height: 40px;
        height: 100%;
        padding: 5px;
      }
      .empty-state-message {
        display: flex;
        align-items: center;
        justify-content: center;
        color: black;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        border: 2px dashed rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.2);
        text-align: center;
        box-sizing: border-box;
        height: 100%;
      }
    `],et=((e,t,i,o)=>{for(var n,s=o>1?void 0:o?Je(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(s)||s);return s})([l("block-drop-zone")],et);const tt=new class{constructor(){this.blocks=new Map,this.classes=new Map}get allBlocks(){const e={};return this.blocks.forEach((t,i)=>{null!==t.definition&&(e[i]=t.definition)}),e}register(e,t,i){this.blocks.has(e)&&console.warn(`[BlockRegistry] Block type "${e}" is already registered. Overwriting.`),this._validateRegistration(e,i),this.blocks.set(e,i),this.classes.set(e,t)}getBlock(e){var t;return null==(t=this.blocks.get(e))?void 0:t.definition}getBlockClass(e){return this.classes.get(e)}getDefaults(e){var t;return null==(t=this.blocks.get(e))?void 0:t.defaults}getByCategory(e){const t=[];return this.blocks.forEach((i,o)=>{null!==i.definition&&i.definition.category===e&&t.push({type:o,...i.definition})}),t}getAllTypes(){return Array.from(this.blocks.keys())}isRegistered(e){return this.blocks.has(e)}getRegistration(e){return this.blocks.get(e)}getBlockStyleSlots(e){var t;return null==(t=this.blocks.get(e))?void 0:t.styleSlots}getBlockStyleSlotsForBlock(e){var t;const i=null==(t=this.blocks.get(e.type))?void 0:t.styleSlots;if(!i)return;const o=this.classes.get(e.type);if(!o)return i;const n=o.getAvailableStyleSlotIds(e,i);if(n.length===Object.keys(i).length)return i;const s={};for(const r of n){const e=i[r];e&&(s[r]=e)}return s}getBlockSlotDefinition(e,t){var i,o;return null==(o=null==(i=this.blocks.get(e))?void 0:i.styleSlots)?void 0:o[t]}getBlockSlotStyleConfig(e,t){var i,o,n;return null==(n=null==(o=null==(i=this.blocks.get(e))?void 0:i.styleSlots)?void 0:o[t])?void 0:n.styles}getBlockDefaults(e){var t;return null==(t=this.blocks.get(e))?void 0:t.styleDefaults}getEntityDefaults(e){const t=this.blocks.get(e);return(null==t?void 0:t.entityDefaults)?t.entityDefaults:{mode:"inherited"}}_validateRegistration(e,t){const{definition:i}=t;if(null!==i){if(!i.label)throw new Error(`[BlockRegistry] Block "${e}" missing required field: label`);if(!i.icon)throw new Error(`[BlockRegistry] Block "${e}" missing required field: icon`);if(!i.category&&!i.internal)throw new Error(`[BlockRegistry] Block "${e}" missing required field: category`)}if(t.styleSlots)for(const[o,n]of Object.entries(t.styleSlots))if(!n.label)throw new Error(`[BlockRegistry] Block "${e}" slot "${o}" missing required field: label`)}},it=e("block-registry");var ot=Object.defineProperty,nt=Object.getOwnPropertyDescriptor,st=(e,t,i,o)=>{for(var n,s=o>1?void 0:o?nt(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=(o?n(t,i,s):n(s))||s);return o&&s&&ot(t,i,s),s};let rt=class extends ve{constructor(){super(...arguments),this._resizeState=null,this._resizeHandleIndex=null,this._handleResizeMove=e=>{if(!this._resizeState||!this.block)return;const t=(e.clientX-this._resizeState.startX)/this._resizeState.containerWidth*100;let i=this._resizeState.startLeft+t,o=this._resizeState.totalPair-i;i<1?(i=1,o=this._resizeState.totalPair-i):o<1&&(o=1,i=this._resizeState.totalPair-o),this._setDropZoneWidthsPercent([{zoneId:this._resizeState.leftId,width:i},{zoneId:this._resizeState.rightId,width:o}]),this._resizeState.currentLeft=i,this._resizeState.currentRight=o,this.requestUpdate()},this._handleResizeEnd=e=>{if(this._resizeState){const t=e.target;(null==t?void 0:t.releasePointerCapture)&&t.releasePointerCapture(e.pointerId)}this._resizeState=null,this._resizeHandleIndex=null,this.requestUpdate(),window.removeEventListener("pointermove",this._handleResizeMove),window.removeEventListener("pointerup",this._handleResizeEnd),window.removeEventListener("pointercancel",this._handleResizeEnd)}}get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Columns",icon:'<ha-icon icon="mdi:view-column-outline"></ha-icon>',category:"layout"},defaults:{props:{columns:2,gap:0}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"layout",label:"Layout",traits:[{type:"number",name:"columns",label:"Columns",min:1,max:12},{type:"number",name:"gap",label:"Gap",min:0,max:100}]}]},styles:{preset:"full"}}}getDropZoneStyleConfig(){return{...Qe,properties:["size.width","spacing.padding"]}}getDropZoneResolvedStyleData(e){const t=this.documentModel.resolveEntityForBlock(e.id).entityId,i=t?{defaultEntityId:t}:void 0,o=this.renderer.resolveBlockStyles(e,this.activeDeviceId,i),{size:n,...s}=o??{};return s}updated(e){if(super.updated(e),e.has("block")&&this.block){const t=e.get("block"),i=this.block.props.columns||2,o=(null==t?void 0:t.props.columns)||0;if(!t||o!==i){this._ensureDropZones();const e=this._getDropZones();t&&o!==i&&this._resetDropZoneWidths(e,i)}}}render(){var e,t;const i=((null==(e=this.block)?void 0:e.props)||{}).gap||0,o=((null==(t=this.block)?void 0:t.children)||[]).map(e=>this.documentModel.getBlock(e)).filter(e=>!!e),n=0===o.length||!o.every(e=>{var t;return null==(t=e.children)?void 0:t.length}),s=o.length>0?100/o.length:0,l=this._resizeState&&this._resizeState.index<o.length-1?(()=>{const e=o.map(e=>this._getDropZoneWidthPercent(e,s)).slice(0,this._resizeState.index).reduce((e,t)=>e+t,0),t=`${this._formatPercent(this._resizeState.currentLeft)}%`,i=`${this._formatPercent(this._resizeState.currentRight)}%`;return r`
            <div
              class="column-resize-overlay"
              style=${c({left:`${e}%`,width:`${this._resizeState.currentLeft}%`})}
            >
              <div class="column-resize-overlay__label">${t}</div>
            </div>
            <div
              class="column-resize-overlay"
              style=${c({left:`${e+this._resizeState.currentLeft}%`,width:`${this._resizeState.currentRight}%`})}
            >
              <div class="column-resize-overlay__label">${i}</div>
            </div>
          `})():null;return r`
      <div class="content ${n?"empty-state":""}" style="--columns-gap: ${i}px;">
        ${d(o,e=>e.id,(e,t)=>{const i=this.documentModel.resolveEntityForBlock(e.id).entityId,n=i?{defaultEntityId:i}:void 0,s=this.renderer.resolveBlockStyles(e,this.activeDeviceId,n),{size:l,...a}=s??{},d=Ue({size:l}??{}),u=t<o.length-1,h=this._resizeHandleIndex===t;return r`
            <div class="column-slot" style=${c(d)}>
              ${u?r`
                <div
                  class="column-resize-handle ${h?"active":""}"
                  @pointerdown=${e=>this._handleResizeStart(e,t)}
                ></div>
              `:null}
              ${this.renderer.renderBlock(e)}
            </div>
          `})}
        ${l}
      </div>
    `}getBlockedDropInstructions(){return["combine"]}_getDropZones(){const e=this.block?this.documentModel.getBlock(this.block.id)??this.block:null;return(null==e?void 0:e.children)?e.children.map(e=>this.documentModel.getBlock(e)).filter(e=>Boolean(e)):[]}_getConfiguredDeviceIds(e){const t=new Set;t.add(this.deviceManager.getBaseDevice().id);for(const i of e)if(i.deviceStyles)for(const e of Object.keys(i.deviceStyles))t.add(e);return Array.from(t)}_resetDropZoneWidths(e,t){var i;const o=t>0?100/t:0,n=this._getConfiguredDeviceIds(e);for(const s of e){const e={};for(const t of n){const n={...(null==(i=s.deviceStyles)?void 0:i[t])||{}},r={...n.size||{}};r.width={value:this._roundPercent(o),unit:"%"},n.size=r,e[t]=n}this.documentModel.updateBlock(s.id,{deviceStyles:e})}}_roundPercent(e){return Math.round(1e3*e)/1e3}_formatPercent(e){return e.toFixed(1)}_getDropZoneWidthPercent(e,t){var i;const o=this.documentModel.resolveEntityForBlock(e.id).entityId,n=o?{defaultEntityId:o}:void 0,s=null==(i=this.renderer.resolveBlockStyles(e,this.activeDeviceId,n).size)?void 0:i.width;if(s){if("%"===s.unit&&"number"==typeof s.value)return s.value;if("string"==typeof s.value&&s.value.endsWith("%")){const e=parseFloat(s.value);if(!Number.isNaN(e))return e}}return t}_setDropZoneWidthsPercent(e){var t;const i=this.activeDeviceId;for(const o of e){const e=this.documentModel.getBlock(o.zoneId);if(!e)continue;const n={...(null==(t=e.deviceStyles)?void 0:t[i])||{}},s={...n.size||{}};s.width={value:this._roundPercent(o.width),unit:"%"},n.size=s,this.documentModel.updateBlock(e.id,{deviceStyles:{[i]:n}})}}_handleResizeStart(e,t){var i;if(!this.block)return;const o=null==(i=this.renderRoot)?void 0:i.querySelector(".content");if(!o)return;const n=o.getBoundingClientRect();if(n.width<=0)return;e.preventDefault(),e.stopPropagation();const s=this._getDropZones();if(t<0||t>=s.length-1)return;const r=s.length>0?100/s.length:0,l=s[t],a=s[t+1],c=this._getDropZoneWidthPercent(l,r),d=this._getDropZoneWidthPercent(a,r);this._resizeState={index:t,startX:e.clientX,containerWidth:n.width,startLeft:c,startRight:d,totalPair:c+d,leftId:l.id,rightId:a.id,currentLeft:c,currentRight:d},this._resizeHandleIndex=t,this.requestUpdate();const u=e.currentTarget;(null==u?void 0:u.setPointerCapture)&&u.setPointerCapture(e.pointerId),window.addEventListener("pointermove",this._handleResizeMove),window.addEventListener("pointerup",this._handleResizeEnd),window.addEventListener("pointercancel",this._handleResizeEnd)}_ensureDropZones(){if(!this.block)return;const e=this.block.props.columns||2,t=this.block.children||[];if(t.length<e){const i=e-t.length,o=t.length,n={};n[this.activeDeviceId]={size:{width:{value:this._roundPercent(100/e),unit:"%"}}};for(let e=0;e<i;e++)this.documentModel.createBlock("block-drop-zone",this.blockId,this.blockRegistry.getDefaults("block-drop-zone"),{label:`Column ${o+e+1}`,props:{columnIndex:o+e},deviceStyles:n})}else if(t.length>e){t.slice(e).forEach(e=>this.documentModel.deleteBlock(e,!0))}const i=this.documentModel.getBlock(this.block.id);(null==i?void 0:i.children)&&i.children.forEach((e,t)=>{const i=this.documentModel.getBlock(e);if(!i)return;i.props.columnIndex!==t&&this.documentModel.updateBlock(e,{props:{...i.props||{},columnIndex:t}})})}};function lt(e){return"minmax"===e.unit&&void 0!==e.minValue&&void 0!==e.maxValue?`minmax(${e.minValue}px, ${e.maxValue}px)`:"auto"===e.unit?"auto":"fr"===e.unit?`minmax(0, ${e.value}fr)`:`${e.value}${e.unit}`}function at(e){return e.map(lt).join(" ")}rt.styles=[...ve.styles,n`
      .content {
        display: flex;
        flex-direction: row;
        gap: var(--columns-gap, 0);
        position: relative;
      }
      .column-slot {
          display: flex;
          flex-direction: column;
          min-width: 0;
          position: relative;
      }
      .column-resize-handle {
          position: absolute;
          top: 0;
          right: calc(min(var(--columns-gap, 0px), 5px) / -2);
          width: 10px;
          height: 100%;
          cursor: col-resize;
          touch-action: none;
          z-index: 200;
      }
      .column-resize-handle::before {
          content: '';
          position: absolute;
          left: 100%;
          top: 0;
          width: 2px;
          height: 100%;
          background: var(--accent-color, #ddd);
          opacity: 0;
          transform: translateX(-50%);
      }
      .column-resize-handle:hover::before,
      .column-resize-handle.active::before {
          opacity: 1;
      }
      .column-resize-overlay {
          position: absolute;
          top: 0;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0, 0, 0, 0.08);
          pointer-events: none;
          z-index: 250;
      }
      .column-resize-overlay__label {
          padding: 6px 10px;
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(0, 0, 0, 0.08);
          font-size: 12px;
          font-weight: 600;
          color: var(--primary-text-color, #111);
      }
      :host(.block-selected) .content {
          box-shadow: 0 0 1px 1px var(--border-color, #ddd);
      }
    `],st([o({context:it})],rt.prototype,"blockRegistry",2),rt=st([l("block-columns")],rt);var ct=Object.defineProperty,dt=Object.getOwnPropertyDescriptor,ut=(e,t,i,o)=>{for(var n,s=o>1?void 0:o?dt(t,i):t,r=e.length-1;r>=0;r--)(n=e[r])&&(s=(o?n(t,i,s):n(s))||s);return o&&s&&ct(t,i,s),s};const ht={rows:2,columns:2,rowSizes:[{value:1,unit:"fr"},{value:1,unit:"fr"}],columnSizes:[{value:1,unit:"fr"},{value:1,unit:"fr"}],areas:[],gap:{row:0,column:0}};let pt=class extends ve{constructor(){super(...arguments),this._onBlockUpdated=e=>{const t=e.detail,i=t.block;"block-drop-zone"===i.type&&i.parentId===this.block.id&&this._handleDropZoneLabelUpdate(t.block)}}get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Grid",icon:'<ha-icon icon="mdi:grid"></ha-icon>',category:"layout"},defaults:{props:{gridConfig:{...ht}}},entityDefaults:{mode:"inherited"}}}connectedCallback(){super.connectedCallback(),this.documentModel.addEventListener("block-updated",this._onBlockUpdated)}disconnectedCallback(){this.documentModel.removeEventListener("block-updated",this._onBlockUpdated),super.disconnectedCallback()}getPanelConfig(){return{properties:{groups:[{id:"grid-editor",label:"Grid Layout",traits:[{type:"action",name:"editGrid",label:"Grid Editor",buttonLabel:"Edit Grid Layout",actionId:"open-grid-editor",icon:""},{type:"info",name:"gridInfo",label:"Grid Info",description:"Configure grid rows, columns and areas"}]}]},styles:{preset:"full"}}}getDropZoneStyleConfig(){}updated(e){super.updated(e),e.has("block")&&this.block&&this._ensureDropZones()}render(){var e,t;const i=(null==(e=this.block)?void 0:e.props.gridConfig)||ht,o=((null==(t=this.block)?void 0:t.children)||[]).map(e=>this.documentModel.getBlock(e)).filter(e=>!!e),n=0===o.length||!o.every(e=>{var t;return null==(t=e.children)?void 0:t.length}),s={gridTemplateRows:at(i.rowSizes),gridTemplateColumns:at(i.columnSizes),gap:`${i.gap.row}px ${i.gap.column}px`};if(i.areas.length>0){const e=function(e,t,i){if(0===e.length)return"";const o=[];for(let n=0;n<t;n++){o[n]=[];for(let e=0;e<i;e++)o[n][e]="."}return e.forEach(e=>{for(let n=e.rowStart;n<e.rowEnd;n++)for(let s=e.columnStart;s<e.columnEnd;s++)n<t&&s<i&&(o[n][s]=e.id)}),o.map(e=>`"${e.join(" ")}"`).join("\n    ")}(i.areas,i.rows,i.columns);e&&(s.gridTemplateAreas=e)}return r`
      <div class="grid-content ${n?"empty-state":""}" style=${c(s)}>
        ${d(o,e=>e.id,e=>{const t={gridArea:e.props.areaId||e.props.gridArea};return r`
              <div class="grid-zone" style=${c(t)}>
                ${this.renderer.renderBlock(e)}
              </div>
            `})}
      </div>
    `}getBlockedDropInstructions(){return["combine"]}_ensureDropZones(){const e=this.block.props.gridConfig||ht,t=e.areas||[],i=t.length>0?t.length:e.rows*e.columns,o=this.block.children||[];if(o.length<i){const n=i-o.length;for(let i=0;i<n;i++){const o=i,n={zoneIndex:o};let s=`Grid Area ${o+1}`;const r=t.length>0?t[o]:void 0;if(r)n.areaName=r.name,n.gridArea=r.name,s=r.name;else{const t=Math.floor(o/e.columns),i=o%e.columns;n.row=t,n.column=i,n.gridArea=`${t+1} / ${i+1} / span 1 / span 1`}this.documentModel.createBlock("block-drop-zone",this.blockId,this.blockRegistry.getDefaults("block-drop-zone"),{label:s,props:n})}}else if(o.length>i){o.slice(i).forEach(e=>this.documentModel.deleteBlock(e,!0))}o.forEach((i,o)=>{const n=this.documentModel.getBlock(i);if(!n)return;const s={zoneIndex:o},r=t.length>0?t[o]:void 0;if(r)s.areaId=r.id,s.areaName=r.name,s.gridArea=r.name;else{const t=Math.floor(o/e.columns),i=o%e.columns;s.areaId=void 0,s.areaName=void 0,s.row=t,s.column=i,s.gridArea=`${t+1} / ${i+1} / span 1 / span 1`}const l=Object.keys(s).some(e=>n.props[e]!==s[e]),a=r&&n.label!==r.name;if(l||a){const e={};l&&(e.props=s),a&&(e.label=null==r?void 0:r.name),this.documentModel.updateBlock(i,e)}})}_handleDropZoneLabelUpdate(e){var t;const i=this.block.props.gridConfig||ht;if(!i.areas.length)return;const o="number"==typeof e.props.zoneIndex?e.props.zoneIndex:this.block.children.indexOf(e.id);if(o<0||o>=i.areas.length)return;const n=null==(t=e.label)?void 0:t.trim();if(!n)return;const s=i.areas[o];if(!s||s.name===n)return;const r=i.areas.map((e,t)=>t===o?{...e,name:n}:e);this.documentModel.updateBlock(this.block.id,{props:{gridConfig:{...i,areas:r}}})}};pt.styles=[...ve.styles,n`
      .grid-content {
        display: grid;
      }
      .grid-zone {
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        position: relative;
      }
    `],ut([o({context:it})],pt.prototype,"blockRegistry",2),pt=ut([l("block-grid")],pt),[{type:"block-text",blockClass:fe},{type:"block-columns",blockClass:rt},{type:"block-drop-zone",blockClass:et},{type:"block-grid",blockClass:pt},{type:"block-entity-field-state",blockClass:_e},{type:"block-entity-field-icon",blockClass:we},{type:"block-entity-field-name",blockClass:De},{type:"block-entity-field-attribute",blockClass:xe},{type:"block-entity-field-image",blockClass:Ee}].forEach(({type:e,blockClass:t})=>{const i=t.getBlockConfig();i?tt.register(e,t,i):console.warn(`[BlockRegistry] Block class "${e}" does not provide getBlockConfig()`)});const vt="card_builder",gt=`${vt}/cards`;class ft{constructor(e){this.hass=e}async listCards(){return this.hass.callWS({type:`${gt}/list`})}async getCard(e){return(await this.listCards()).find(t=>t.id===e)}async createCard(e){return this.hass.callWS({type:`${gt}/create`,...e})}async updateCard(e,t){return this.hass.callWS({type:`${gt}/update`,card_id:e,...t})}async deleteCard(e){await this.hass.callWS({type:`${gt}/delete`,card_id:e})}async subscribeToUpdates(e){return await this.hass.connection.subscribeMessage(()=>{e()},{type:`${gt}/subscribe`})}}const bt=`${vt}/style_presets`;class yt{constructor(e){this.hass=e,this.cache=new Map,this.initialized=!1,this.subscribers=new Set,this.unsubscribe=null}async initialize(){this.initialized||(await this.loadPresets(),await this.subscribeToUpdates(),this.initialized=!0)}dispose(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.cache.clear(),this.subscribers.clear(),this.initialized=!1}async loadPresets(){const e=await this.hass.callWS({type:`${bt}/list`});this.cache.clear();for(const t of e)this.cache.set(t.id,t);return e}getAllPresets(){return Array.from(this.cache.values())}getCachedPreset(e){return this.cache.get(e)}async getPreset(e){try{const t=await this.hass.callWS({type:`${bt}/get`,preset_id:e});return this.cache.set(t.id,t),t}catch{return}}async createPreset(e){const t=await this.hass.callWS({type:`${bt}/create`,name:e.name,description:e.description||"",extends_preset_id:e.extendsPresetId,data:e.data});return this.cache.set(t.id,t),this.notifySubscribers(),t}async updatePreset(e,t){const i=await this.hass.callWS({type:`${bt}/update`,preset_id:e,...t});return this.cache.set(i.id,i),this.notifySubscribers(),i}async deletePreset(e){await this.hass.callWS({type:`${bt}/delete`,preset_id:e}),this.cache.delete(e),this.notifySubscribers()}subscribe(e){return this.subscribers.add(e),e(this.getAllPresets()),()=>{this.subscribers.delete(e)}}hasPreset(e){return this.cache.has(e)}getChildPresets(e){return this.getAllPresets().filter(t=>t.extendsPresetId===e)}getInheritanceChain(e){const t=[],i=new Set;let o=e;for(;o&&!i.has(o);){i.add(o);const e=this.cache.get(o);if(!e)break;t.unshift(e),o=e.extendsPresetId}return t}async subscribeToUpdates(){try{this.unsubscribe=await this.hass.connection.subscribeMessage(e=>{e.preset&&(this.cache.set(e.preset.id,e.preset),this.notifySubscribers())},{type:`${bt}/subscribe`})}catch(e){console.warn("[StylePresetService] Failed to subscribe to updates:",e)}}notifySubscribers(){const e=this.getAllPresets();for(const i of this.subscribers)try{i(e)}catch(t){console.error("[StylePresetService] Subscriber error:",t)}}}let mt=null,kt=null;function St(e){return mt&&mt.hass===e||(mt=new ft(e)),mt}async function xt(e){return kt&&kt.hass===e||(kt=new yt(e),await kt.initialize()),kt}const It=50,wt=50,Ct="top-left",Et="px",Bt=e=>"number"==typeof e&&!Number.isNaN(e),Dt=(e,t)=>Bt(e)?e:t,$t=e=>{var t,i,o,n,s,r,l,a,c,d;const u=(e=>{const t=(null==e?void 0:e.anchor)??Ct,i=(null==e?void 0:e.originPoint)??t,o=(null==e?void 0:e.unitSystem)??Et;return{x:Bt(null==e?void 0:e.x)?e.x:It,y:Bt(null==e?void 0:e.y)?e.y:wt,anchor:t,originPoint:i,unitSystem:o}})(null==(i=null==(t=e._internal)?void 0:t.position_config)?void 0:i.value);return{position:{x:Dt(null==(n=null==(o=e.layout)?void 0:o.positionX)?void 0:n.value,u.x),y:Dt(null==(r=null==(s=e.layout)?void 0:s.positionY)?void 0:r.value,u.y)},size:{width:Dt(null==(a=null==(l=e.size)?void 0:l.width)?void 0:a.value,0),height:Dt(null==(d=null==(c=e.size)?void 0:c.height)?void 0:d.value,0)},positionConfig:u}};function _t(e,t){const{width:i,height:o}=t;switch(e){case"top-left":return{x:0,y:0};case"top-center":return{x:i/2,y:0};case"top-right":return{x:i,y:0};case"middle-left":return{x:0,y:o/2};case"middle-center":return{x:i/2,y:o/2};case"middle-right":return{x:i,y:o/2};case"bottom-left":return{x:0,y:o};case"bottom-center":return{x:i/2,y:o};case"bottom-right":return{x:i,y:o}}}class zt{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}toMoveableSpace(e){const{anchorPoint:t,originPoint:i,unitSystem:o,x:n,y:s}=e;let r=n,l=s;"%"===o&&(r=n/100*this.config.containerSize.width,l=s/100*this.config.containerSize.height),t.includes("right")&&(r=-r),t.includes("bottom")&&(l=-l);const a=_t(t,this.config.containerSize),c=_t(i,this.config.elementSize);return{x:a.x+r-c.x,y:a.y+l-c.y}}fromMoveableSpace(e){const{anchorPoint:t,originPoint:i,unitSystem:o}=this.config,n=_t(i,this.config.containerSize),s=_t(i,this.config.elementSize);let r=e.x-n.x+s.x,l=e.y-n.y+s.y;t.includes("right")&&(r=-r),t.includes("bottom")&&(l=-l);let a=r,c=l;return"%"===o?(a=r/this.config.containerSize.width*100,c=l/this.config.containerSize.height*100,a=Math.round(100*a)/100,c=Math.round(100*c)/100):(a=Math.round(a),c=Math.round(c)),{x:a,y:c,anchorPoint:t,originPoint:i,unitSystem:o}}convertUnits(e,t){if(e.unitSystem===t)return e;const i=this.toMoveableSpace(e),o={...this.config,unitSystem:t};return new zt(o).fromMoveableSpace(i)}convertAnchor(e,t,i){const o=this.toMoveableSpace(e),n={...this.config,anchorPoint:t,originPoint:i||t};return new zt(n).fromMoveableSpace(o)}clampToContainer(e){const t=this.config.containerSize.width-this.config.elementSize.width,i=this.config.containerSize.height-this.config.elementSize.height;return{x:Math.max(0,Math.min(e.x,t)),y:Math.max(0,Math.min(e.y,i))}}getConfig(){return{...this.config}}}class Rt{constructor(){this.subscriptions=new Map,this.previousStates=new Map}setHass(e){const t=this.hass;if(this.hass=e,t)for(const i of this.subscriptions.keys()){const t=this.previousStates.get(i),o=e.states[i];t!==o&&(this.previousStates.set(i,o),this.notifySubscribers(i,o,t))}else for(const i of this.subscriptions.keys())this.previousStates.set(i,e.states[i])}getHass(){return this.hass}subscribe(e,t){return this.subscriptions.has(e)||(this.subscriptions.set(e,new Set),this.hass&&this.previousStates.set(e,this.hass.states[e])),this.subscriptions.get(e).add(t),()=>{const i=this.subscriptions.get(e);null==i||i.delete(t),0===(null==i?void 0:i.size)&&(this.subscriptions.delete(e),this.previousStates.delete(e))}}subscribeMultiple(e,t){const i=e.map(e=>this.subscribe(e,t));return()=>{i.forEach(e=>e())}}isSubscribed(e){return this.subscriptions.has(e)}getSubscribedEntities(){return Array.from(this.subscriptions.keys())}getSubscriberCount(e){var t;return(null==(t=this.subscriptions.get(e))?void 0:t.size)??0}getEntityState(e){var t;return null==(t=this.hass)?void 0:t.states[e]}clear(){this.subscriptions.clear(),this.previousStates.clear()}notifySubscribers(e,t,i){const o=this.subscriptions.get(e);if(o)for(const s of o)try{s(e,t,i)}catch(n){console.error(`[EntitySubscriptionManager] Error in callback for ${e}:`,n)}}}var Mt=Object.defineProperty,At=(e,t,i,o)=>{for(var n,s=void 0,r=e.length-1;r>=0;r--)(n=e[r])&&(s=n(t,i,s)||s);return s&&Mt(t,i,s),s};const Pt=class extends t{constructor(){super(...arguments),this.rendererManager=this,this.rootBlocks=[],this.activeDeviceId="desktop",this.canvas=null,this.entitySubscriptionManager=new Rt,this.resizeObserver=null,this.blockEntityUnsubscribers=new Map}renderBlock(e){if(!customElements.get(e.type))throw new Error(`Block type "${e.type}" not registered as custom element`);return this.doBlockRender(e,{tag:u(e.type)})}connectedCallback(){super.connectedCallback(),this.documentModel.registerElement(this.documentModel.rootId,this),this.activeDeviceId=this.deviceManager.getActiveDevice().id,this.setupResizeObserver(),this.deviceManager.on("device-changed",e=>{this.activeDeviceId=e.deviceId,this.requestUpdate()})}disconnectedCallback(){super.disconnectedCallback();for(const e of this.blockEntityUnsubscribers.values())e();this.resizeObserver&&this.resizeObserver.disconnect(),this.blockEntityUnsubscribers.clear(),this.entitySubscriptionManager.clear(),this.documentModel.registerElement(this.documentModel.rootId,void 0)}shouldUpdate(e){var t,i;if(e.has("hass")&&1===e.size){const i=e.get("hass");if(!i)return!0;const o=this.documentModel.getTrackedEntitiesFlat(this.documentModel.getBlock(this.documentModel.rootId));if(0===o.length)return!1;for(const e of o){if(i.states[e]!==(null==(t=this.hass)?void 0:t.states[e]))return!0}return!1}return(null==(i=super.shouldUpdate)?void 0:i.call(this,e))??!0}async updated(e){e.has("hass")&&this.hass&&this.entitySubscriptionManager.setHass(this.hass),super.updated(e)}setupResizeObserver(){this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(e=>{for(const t of e){const{width:e,height:i}=t.contentRect,o=this.canvasWidth!==e||this.canvasHeight!==i;this.canvasWidth=e,this.canvasHeight=i,o&&(this.eventBus.dispatchEvent("canvas-size-changed",{width:e,height:i}),this.canvasSizeChanged(),this.requestUpdate())}}),this.updateComplete.then(()=>{if(this.canvas){this.resizeObserver.observe(this.canvas);const e=this.canvas.getBoundingClientRect();e.width>0&&e.height>0&&(this.canvasWidth=e.width,this.canvasHeight=e.height,this.eventBus.dispatchEvent("canvas-size-changed",{width:this.canvasWidth,height:this.canvasHeight}))}})}getRenderData(e={}){var t,i,o,n,s,r;const l=this.rootBlocks.filter(e=>"absolute"===e.layout),a=this.rootBlocks.filter(e=>"flow"===e.layout).sort((e,t)=>e.order-t.order),c=this.styleResolver.resolve(this.documentModel.rootId,this.activeDeviceId),d=["background.boxShadow","border.borderRadius"],u=Ue(c,{filter:{only:{properties:d}},append:e}),h=Ue(c,{filter:{exclude:{properties:d}}}),p={};((null==(t=c.background)?void 0:t.background)||(null==(i=c.background)?void 0:i.backgroundColor))&&(p["--ha-card-background"]="transparent"),(null==(o=c.border)?void 0:o.borderStyle)&&"none"!==(null==(n=c.border)?void 0:n.borderStyle.value)&&(p["--ha-card-border-color"]="transparent",p["--ha-card-border-width"]="0"),(null==(s=c.border)?void 0:s.borderRadius)&&(p["--ha-card-border-radius"]=null==(r=c.border)?void 0:r.borderRadius.value);return{absoluteBlocks:l,flowBlocks:a,haCardStyles:Ue(c,{filter:{only:{properties:["border.borderRadius"]}},append:{...p,...e}}),canvasStyles:u,canvasFlowContainerStyles:h}}resolveBlockStyles(e,t=this.activeDeviceId,i){return this.styleResolver.resolve(e.id,t,i)}resolveBlockSlotStyles(e,t,i=this.activeDeviceId,o){return this.styleResolver.resolveSlot(e.id,t,i,o)}resolvedRenderContext(e,t=null){const i=["absolute"===e.layout?"block-absolute":"block-flow","flow"===e.layout?"item":""],o=this.documentModel.resolveEntityForBlock(e.id).entityId,n=o?{defaultEntityId:o}:void 0;t=t??this.resolveBlockStyles(e,this.activeDeviceId,n);const s=$t(t),r=Ue(t),l={},a=this.blockRegistry.getBlockStyleSlotsForBlock(e);if(a)for(const d of Object.keys(a)){const t=this.styleResolver.resolveSlot(e.id,d,this.activeDeviceId,n);l[d]=Ue(t)}const c={zIndex:String(e.zIndex||"auto")};if(Object.assign(c,r),"absolute"===e.layout&&s){s.size=this.getRuntimeBlockSize(e,s);const t=this.blockToMoveable(s,this.canvasWidth,this.canvasHeight);c.left=`${t.left}px`,c.top=`${t.top}px`}else c.left="initial",c.top="initial";return{classes:i,styles:c,slotStyles:l}}computeAbsoluteBlockSize(e){const t=this.documentModel.getElement(e);if(!t)return;const i=t.getBoundingClientRect();return{width:i.width,height:i.height}}getRuntimeBlockSize(e,t){if(t.size.width&&t.size.height)return t.size;return this.computeAbsoluteBlockSize(e.id)??t.size}canvasSizeChanged(){}blockToMoveable(e,t,i){if("%"===e.positionConfig.unitSystem){const o={containerSize:{width:t,height:i},elementSize:{width:e.size.width,height:e.size.height},anchorPoint:e.positionConfig.anchor,originPoint:e.positionConfig.originPoint,unitSystem:e.positionConfig.unitSystem},n=new zt(o),s={x:e.positionConfig.x,y:e.positionConfig.y,anchorPoint:e.positionConfig.anchor,originPoint:e.positionConfig.originPoint,unitSystem:e.positionConfig.unitSystem},r=n.toMoveableSpace(s);return{left:r.x,top:r.y}}return{left:e.position.x,top:e.position.y}}moveableToBlock(e,t,i,o,n){const s={x:e.left,y:e.top},r={containerSize:{width:o,height:n},elementSize:{width:i.width,height:i.height},anchorPoint:t.anchor,originPoint:t.originPoint,unitSystem:t.unitSystem},l=new zt(r).fromMoveableSpace(s);return{position:{x:Math.round(s.x),y:Math.round(s.y)},positionConfig:{anchor:l.anchorPoint,x:l.x,y:l.y,unitSystem:l.unitSystem,originPoint:l.originPoint??l.anchorPoint}}}moveableResizeToBlock(e,t,i,o,n){const s={x:e.left,y:e.top},r={containerSize:{width:o,height:n},elementSize:{width:t.width,height:t.height},anchorPoint:i.anchor,originPoint:i.originPoint,unitSystem:i.unitSystem},l=new zt(r).fromMoveableSpace(s);return{position:{x:Math.round(s.x),y:Math.round(s.y)},size:t,positionConfig:{anchor:l.anchorPoint,x:l.x,y:l.y,unitSystem:l.unitSystem,originPoint:l.originPoint??l.anchorPoint}}}subscribeBlockEntities(e,t){if(this.unsubscribeBlockEntities(e),0===t.length)return;const i=this.entitySubscriptionManager.subscribeMultiple(t,e=>this.handleBlockEntityChange(e));this.blockEntityUnsubscribers.set(e,i)}unsubscribeBlockEntities(e){const t=this.blockEntityUnsubscribers.get(e);t&&(t(),this.blockEntityUnsubscribers.delete(e))}handleBlockEntityChange(e){var t;null==(t=this.styleResolver)||t.invalidateByEntity(e),this.requestUpdate()}};Pt.styles=[n`
            .canvas {
                min-height: 1px;
                position: relative;
                border-radius: var(--ha-card-border-radius, var(--ha-border-radius-lg));
                box-sizing: border-box;
                overflow: hidden;
            }

            .canvas-flow-container {
                background: var(--bg-primary);
                border-radius: inherit;
                box-sizing: border-box;
                inset: 0;
                display: flex;
                flex-direction: column;
            }
        `];let Tt=Pt;At([o({context:R})],Tt.prototype,"documentModel"),At([o({context:it})],Tt.prototype,"blockRegistry"),At([o({context:L})],Tt.prototype,"deviceManager"),At([o({context:Ye})],Tt.prototype,"styleResolver"),At([o({context:P})],Tt.prototype,"eventBus"),At([h({context:m})],Tt.prototype,"rendererManager"),At([o({context:de,subscribe:!0}),i({attribute:!1})],Tt.prototype,"hass"),At([s()],Tt.prototype,"rootBlocks"),At([s()],Tt.prototype,"activeDeviceId"),At([s()],Tt.prototype,"canvasWidth"),At([s()],Tt.prototype,"canvasHeight");export{S as B,ht as D,T as E,zt as P,Re as S,R as a,it as b,tt as c,W as d,xt as e,$t as f,at as g,Ne as h,We as i,L as j,P as k,Tt as l,de as m,z as n,O as o,ae as p,St as q,Ye as s,Ze as v};
