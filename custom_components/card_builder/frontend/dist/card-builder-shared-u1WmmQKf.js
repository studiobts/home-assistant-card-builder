import{aK as e,aD as t,aC as i,aL as n,aT as o,aU as s,aV as r,aW as l,aB as a,aH as c,aI as d,aN as u,aE as h,aF as p,aX as g,aP as v,aO as b,aY as m,aM as f,aZ as y,aJ as k,a_ as _,aS as x}from"./card-builder-shared-BOSUXB7z.js";import{d as S,a as w,b as I,m as P,e as A,c as T}from"./card-builder-shared-CR_SzKoS.js";const C=e("blocks-renderer");function E(e){return"object"==typeof e&&null!==e&&"rules"in e}const M="Template error",L=[{key:"value",description:"Current value (state or attribute)"},{key:"state",description:"Entity state string"},{key:"attributes",description:"Entity attributes object"},{key:"entity",description:"Entity ID"},{key:"last_changed",description:"Last changed timestamp"},{key:"last_updated",description:"Last updated timestamp"}],B=[...L,{key:"name",description:"Entity friendly name"}];function D(e,t,i){const n={};return e?(n.value=void 0!==t?t:e.state,n.state=e.state,n.attributes=e.attributes||{},n.entity=e.entity_id,n.last_changed=e.last_changed,n.last_updated=e.last_updated):n.value=t,n}class ${constructor(e,t={}){this.hass=e,this.callbacks=t,this.requestId=0}update(e){var t;const i=null==(t=e.template)?void 0:t.trim();if(!i)return this.lastResult=void 0,this.lastError=void 0,this.lastKey=void 0,void this._cleanup();const n=this._buildKey({...e,template:i});if(this.lastKey===n)return;this.lastKey=n,this.lastError=void 0;const o=e.debounceMs??0;this.debounceId&&(window.clearTimeout(this.debounceId),this.debounceId=void 0),o>0?this.debounceId=window.setTimeout(()=>{this.debounceId=void 0,this._subscribe({...e,template:i})},o):this._subscribe({...e,template:i})}dispose(){this.debounceId&&(window.clearTimeout(this.debounceId),this.debounceId=void 0),this._cleanup()}getResult(){return this.lastResult}getError(){return this.lastError}async _subscribe(e){var t,i;this.requestId+=1;const n=this.requestId;this._cleanup();try{this.unsubscribe=await this.hass.connection.subscribeMessage(e=>{var t,i,o,s;if(n===this.requestId){if(function(e){return void 0!==e.error}(e))return this.lastError=e,this.lastResult=void 0,null==(i=(t=this.callbacks).onError)||i.call(t,e),void this._cleanup();var r;this.lastResult=e,this.lastError=void 0,null==(s=(o=this.callbacks).onResult)||s.call(o,e),r=e.listeners,Boolean(r.all||r.time||r.entities&&r.entities.length>0||r.domains&&r.domains.length>0)||this._cleanup()}},{type:"render_template",template:e.template,variables:e.variables,entity_ids:e.entityIds,strict:e.strict,report_errors:e.reportErrors??!0})}catch(o){const e={error:o instanceof Error?o.message:"Template render failed",level:"ERROR"};this.lastError=e,this.lastResult=void 0,null==(i=(t=this.callbacks).onError)||i.call(t,e),this._cleanup()}}_cleanup(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=void 0)}_buildKey(e){const t=e.variables?function(e){try{return R(e)}catch{return""}}(e.variables):"",i=Array.isArray(e.entityIds)?e.entityIds.join(","):e.entityIds??"";return[e.template,t,i,e.strict?"1":"0",!1===e.reportErrors?"0":"1"].join("::")}}function R(e){if(null==e)return String(e);if("object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e))return"["+e.map(e=>R(e)).join(",")+"]";const t=e;return"{"+Object.keys(t).sort().map(e=>`${JSON.stringify(e)}:${R(t[e])}`).join(",")+"}"}class O{constructor(e,t={}){this.hass=e,this.options=t,this.templateSessions=new Map,this.bindingTemplateKeys=new WeakMap}evaluate(e,t={}){var i,n,o,s,r;const{defaultValue:l,defaultEntityId:a}=t,c=(null==(i=e.entity)?void 0:i.slotId)??void 0,d=c?null==(o=(n=this.options).resolveSlotEntity)?void 0:o.call(n,c):void 0,u=c?d:(null==(s=e.entity)?void 0:s.entityId)||a,h=(null==(r=e.entity)?void 0:r.source)||"state",p="state"===h?void 0:h;if(!u)return{value:l??e.default,success:!0};try{const t={state:this._getEntityState(u),attribute:p,entityId:u,getState:e=>this._getEntityState(e)};if("template"===e.mode){return{value:this._evaluateTemplateBinding(e,t,l),success:!0}}const i=function(e,t){if(!t.state)return e.default;switch(e.mode){case"direct":return function(e,t){const i=U(t.state,t.attribute);if(!e.inputRange&&!e.outputRange)return i??e.default;const n=G(i);if(null===n)return e.default;const o=e.inputRange??[0,100],s=e.outputRange??[0,100];return function(e,t,i,n,o){const s=Math.max(t,Math.min(i,e));return n+(s-t)/(i-t)*(o-n)}(n,o[0],o[1],s[0],s[1])}(e,t);case"map":return function(e,t){const i=U(t.state,t.attribute),n=String(i);if(n in e.map)return e.map[n];const o=n.toLowerCase();for(const[s,r]of Object.entries(e.map))if(s.toLowerCase()===o)return r;return e.default}(e,t);case"threshold":return function(e,t){const i=U(t.state,t.attribute),n=G(i);if(null===n)return e.default;const o=function(e,t){for(const i of t){const t=void 0===i.min||e>=i.min,n=void 0===i.max||e<i.max;if(t&&n)return i}return null}(n,e.thresholds);if(o)return o.value;return e.default}(e,t);case"condition":return function(e,t){for(const i of e.conditions){if(z(i.condition,t.getState,t.entityId))return i.value}return e.default}(e,t);case"template":return function(e,t){const i=t.state,n={value:U(i,t.attribute),state:i.state,attributes:i.attributes,entity:i.entity_id,last_changed:i.last_changed,last_updated:i.last_updated},o=function(e,t){if(!e)return"";const i=/\{\{(.+?)\}\}/g;return e.replace(i,(e,i)=>{const n=function(e,t){const i=e.split("|").map(e=>e.trim());let n=function(e,t){switch(e){case"value":return t.value;case"state":return t.state;case"entity":return t.entity;case"last_changed":return t.last_changed;case"last_updated":return t.last_updated}if(e.startsWith("attributes.")){const i=e.slice(11);return function(e,t){const i=t.split(".");let n=e;for(const o of i){if(null==n)return;if("object"!=typeof n)return;n=n[o]}return n}(t.attributes,i)}if(e in t.attributes)return t.attributes[e];return}(i[0],t);for(let o=1;o<i.length;o++){n=H(i[o],n)}return n}(i.trim(),t);return null!=n?String(n):""})}(e.template,n);return o||e.default}(e,t);default:return console.warn(`[ValueResolver] Unknown binding mode: ${e.mode}`),e.default}}(e,t);return void 0===i?{value:l??e.default,success:!0}:{value:i,success:!0}}catch(g){return console.warn("[BindingEvaluator] Evaluation failed:",g),{value:l??e.default,success:!1,error:g instanceof Error?g.message:"Unknown error"}}}_evaluateTemplateBinding(e,t,i){var n,o;const s=null==(n=e.template)?void 0:n.trim(),r=t.state;if(!s||!r)return this._clearBindingTemplateSession(e),i??e.default;const l=D(r,this._extractValue(r,t.attribute)),a=this._getTemplateSessionKey(s,t);this._trackBindingTemplateKey(e,a);const c=this._getTemplateSession(a);c.update({template:s,variables:l,reportErrors:!0});if(c.getError())return M;const d=null==(o=c.getResult())?void 0:o.result;return void 0!==d?d:i??e.default}_trackBindingTemplateKey(e,t){const i=this.bindingTemplateKeys.get(e);if(i&&i!==t){const e=this.templateSessions.get(i);e&&(e.dispose(),this.templateSessions.delete(i))}this.bindingTemplateKeys.set(e,t)}_clearBindingTemplateSession(e){const t=this.bindingTemplateKeys.get(e);if(!t)return;const i=this.templateSessions.get(t);i&&(i.dispose(),this.templateSessions.delete(t)),this.bindingTemplateKeys.delete(e)}_getTemplateSession(e){let t=this.templateSessions.get(e);return t||(t=new $(this.hass,{onResult:t=>{var i,n;return null==(n=(i=this.options).onTemplateResult)?void 0:n.call(i,{key:e,value:t.result})},onError:t=>{var i,n;return null==(n=(i=this.options).onTemplateResult)?void 0:n.call(i,{key:e,error:t})}}),this.templateSessions.set(e,t)),t}_getTemplateSessionKey(e,t){return`${t.entityId??""}::${t.attribute??"state"}::${e}`}_extractValue(e,t){var i;if(!t||"state"===t)return e.state;if("last_changed"===t)return e.last_changed;if("last_updated"===t)return e.last_updated;if(t.includes(".")){const i=t.split(".");let n=e.attributes;for(const e of i){if(null==n)return;if("object"!=typeof n)return;n=n[e]}return n}return null==(i=e.attributes)?void 0:i[t]}_getEntityState(e){const t=this.hass.states[e];if(t)return{entity_id:t.entity_id,state:t.state,attributes:t.attributes||{},last_changed:t.last_changed,last_updated:t.last_updated,context:t.context}}}function z(e,t,i){return E(e)?function(e,t,i){if(!e.rules||0===e.rules.length)return!0;if("and"===e.operator)return e.rules.every(e=>z(e,t,i));if("or"===e.operator)return e.rules.some(e=>z(e,t,i));return!1}(e,t,i):function(e,t,i){const n=e.entity||i;if(!n)return console.warn("[ConditionEvaluator] No entity specified for condition rule"),!1;const o=t(n);if(!o)return!1;return function(e,t,i){switch(t){case"==":return N(e,i);case"!=":return!N(e,i);case">":return F(e,i,(e,t)=>e>t);case"<":return F(e,i,(e,t)=>e<t);case">=":return F(e,i,(e,t)=>e>=t);case"<=":return F(e,i,(e,t)=>e<=t);case"contains":return function(e,t){if("string"==typeof e&&"string"==typeof t)return e.toLowerCase().includes(t.toLowerCase());if(Array.isArray(e))return e.some(e=>N(e,t));return!1}(e,i);case"in":return function(e,t){if(!Array.isArray(t))return!1;return t.some(t=>N(e,t))}(e,i);default:return console.warn(`[ConditionEvaluator] Unknown operator: ${t}`),!1}}(function(e,t){if(!t||"state"===t)return e.state;if("last_changed"===t)return e.last_changed;if("last_updated"===t)return e.last_updated;if(t.includes("."))return function(e,t){const i=t.split(".");let n=e;for(const o of i){if(null==n)return;if("object"!=typeof n)return;n=n[o]}return n}(e.attributes,t);return e.attributes[t]}(o,e.attribute),e.operator,e.value)}(e,t,i)}function N(e,t){if(e===t)return!0;if("string"==typeof e&&"string"==typeof t)return e.toLowerCase()===t.toLowerCase();if("string"==typeof e&&"number"==typeof t)return parseFloat(e)===t;if("number"==typeof e&&"string"==typeof t)return e===parseFloat(t);if("boolean"==typeof t){if("boolean"==typeof e)return e===t;if("string"==typeof e){const i=e.toLowerCase();return!0===t?"true"===i||"on"===i||"yes"===i||"1"===i:"false"===i||"off"===i||"no"===i||"0"===i}}return!1}function F(e,t,i){const n=V(e),o=V(t);return null!==n&&null!==o&&i(n,o)}function V(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}const j={round:(e,t="0")=>{const i=W(e);if(null===i)return e;const n=parseInt(t,10)||0;return i.toFixed(n)},int:e=>{const t=W(e);return null===t?e:Math.floor(t)},float:(e,t)=>{const i=W(e);if(null===i)return e;if(void 0!==t){const e=parseInt(t,10)||0;return parseFloat(i.toFixed(e))}return i},upper:e=>String(e).toUpperCase(),lower:e=>String(e).toLowerCase(),capitalize:e=>{const t=String(e);return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},title:e=>String(e).split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),default:(e,t="")=>null==e||""===e?t:e,replace:(e,t="",i="")=>String(e).split(t).join(i),truncate:(e,t="20",i="...")=>{const n=String(e),o=parseInt(t,10)||20;return n.length<=o?n:n.slice(0,o-i.length)+i},abs:e=>{const t=W(e);return null===t?e:Math.abs(t)},multiply:(e,t="1")=>{const i=W(e),n=W(t);return null===i||null===n?e:i*n},divide:(e,t="1")=>{const i=W(e),n=W(t);return null===i||null===n||0===n?e:i/n},add:(e,t="0")=>{const i=W(e),n=W(t);return null===i||null===n?e:i+n},subtract:(e,t="0")=>{const i=W(e),n=W(t);return null===i||null===n?e:i-n},percentage:(e,t="0")=>{const i=W(e);if(null===i)return e;const n=parseInt(t,10)||0;return i.toFixed(n)+"%"},relative_time:e=>{if("string"!=typeof e)return e;try{const t=new Date(e),i=(new Date).getTime()-t.getTime(),n=Math.floor(i/1e3),o=Math.floor(n/60),s=Math.floor(o/60),r=Math.floor(s/24);return r>0?`${r}d ago`:s>0?`${s}h ago`:o>0?`${o}m ago`:`${n}s ago`}catch{return e}},timestamp:(e,t="HH:mm")=>{if("string"!=typeof e)return e;try{const i=new Date(e);return t.replace("YYYY",String(i.getFullYear())).replace("MM",String(i.getMonth()+1).padStart(2,"0")).replace("DD",String(i.getDate()).padStart(2,"0")).replace("HH",String(i.getHours()).padStart(2,"0")).replace("mm",String(i.getMinutes()).padStart(2,"0")).replace("ss",String(i.getSeconds()).padStart(2,"0"))}catch{return e}}};function H(e,t){const i=e.match(/^(\w+)(?:\((.+)\))?$/);if(!i)return console.warn(`[TemplateParser] Invalid filter expression: ${e}`),t;const n=i[1],o=i[2],s=j[n];if(!s)return console.warn(`[TemplateParser] Unknown filter: ${n}`),t;const r=o?function(e){const t=[];let i="",n=!1,o="";for(const s of e)'"'!==s&&"'"!==s||n?s===o&&n?(n=!1,o=""):","!==s||n?i+=s:(t.push(i.trim()),i=""):(n=!0,o=s);i.trim()&&t.push(i.trim());return t.map(e=>e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e)}(o):[];try{return s(t,...r)}catch(l){return console.warn(`[TemplateParser] Error applying filter ${n}:`,l),t}}function W(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}function U(e,t){return t&&"state"!==t?"last_changed"===t?e.last_changed:"last_updated"===t?e.last_updated:t.includes(".")?function(e,t){const i=t.split(".");let n=e;for(const o of i){if(null==n)return;if("object"!=typeof n)return;n=n[o]}return n}(e.attributes,t):e.attributes[t]:e.state}function G(e){if("number"==typeof e)return isNaN(e)?null:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?null:t}return null}const q=3;class Z extends EventTarget{constructor(){super(),this.version=3,this.rootId="root",this.slots={entities:{},actions:{}},this.blocks={},this.selectedId=null,this.selectedStyleTargetId=null,this.linkModeState={enabled:!1,mode:"idle",activeLinkId:null},this.linkEditorSelection={blockId:null,pointId:null,segmentIndex:null,handle:null},this.linkAnchorHighlight={blockId:null},this.linkGridColor="#000000",this._elementRegistry=new Map,this._reset(),this._initialize()}createBlock(e,t="root",i={},n={},o){const s=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,r=this.blocks[t],l=n.layout||"flow",a=n.entityConfig||i.entityConfig||{mode:"inherited"},c={id:s,type:e,parentId:t,canBeDeleted:n.canBeDeleted??i.canBeDeleted,canBeDuplicated:n.canBeDuplicated??i.canBeDuplicated,canChangeLayoutMode:n.canChangeLayoutMode??i.canChangeLayoutMode,isHidden:n.isHidden??i.isHidden,requireEntity:n.requireEntity??i.requireEntity,parentManaged:n.parentManaged||!1,label:n.label||void 0,layout:l,children:[],props:{...i.props||{},...n.props||{}},order:o||0,styles:n.styles,zIndex:Object.keys(this.blocks).length,entityConfig:a};return this.blocks[s]=c,void 0!==o?(r.children.splice(o,0,s),r.children.forEach((e,t)=>{this.blocks[e].order=t})):r.children.push(s),this.blocks={...this.blocks,[s]:c},this._emit("block-created",{block:c}),this._emit("change",{action:"create",block:c}),c}updateBlock(e,t){const i=this.blocks[e];if(!i)return;const n={...i},o="styles"in t||"layout"in t;t.props&&(n.props={...n.props,...t.props},delete t.props),"styles"in t&&(n.styles=t.styles,delete t.styles),Object.assign(n,t),this.blocks={...this.blocks,[e]:n},this._emit("change",{action:"update",block:n,styleChanged:o}),this._emit("block-updated",{block:n})}updateBlockId(e,t){const i=t.trim().toLowerCase().replaceAll(" ","-");if(!i)return{success:!1,error:"ID cannot be empty"};if(i===e)return{success:!0};if(e===this.rootId)return{success:!1,error:"Root block ID cannot be changed"};if(this.blocks[i])return{success:!1,error:"ID already exists"};const n=this.blocks[e];if(!n)return{success:!1,error:"Block not found"};const o={...this.blocks},s={...n,id:i};delete o[e],o[i]=s;const r=new Set([i]);Object.values(o).forEach(t=>{var n;let s=t,l=!1;if(s.parentId===e&&(s={...s,parentId:i},l=!0),null==(n=s.children)?void 0:n.includes(e)){const t=s.children.map(t=>t===e?i:t);s={...s,children:t},l=!0}l&&(o[s.id]=s,r.add(s.id))}),this.blocks=o;return this.selectedId===e&&this.select(i),this._emit("change",{action:"update",block:s}),r.forEach(e=>{this._emit("block-updated",{block:o[e]})}),{success:!0}}deleteBlock(e,t=!1){const i=this.blocks[e];if(!i||"root"===e)return;if(!this.canDeleteBlock(e)&&!t)return void console.warn(`Cannot delete parent-managed block: ${e}`);const n=this.blocks[i.parentId];n&&n.children&&(n.children=n.children.filter(t=>t!==e)),i.children&&[...i.children].forEach(e=>this.deleteBlock(e)),delete this.blocks[e],this.selectedId===e&&(this.selectedId=null,this._emit("selection-changed",{selectedId:null})),this._emit("block-deleted",{blockId:e}),this._emit("change",{action:"delete",block:i})}moveBlock(e,t,i){const n=this.blocks[e],o=this.blocks[n.parentId],s=this.blocks[t];if(!n||!s||!s.children)return;let r=i;if((null==o?void 0:o.id)===t&&(null==o?void 0:o.children)){const t=o.children.indexOf(e);-1!==t&&t<r&&(r-=1)}o&&o.children&&(o.children=o.children.filter(t=>t!==e));const l=s.children.length;r<0&&(r=0),r>l&&(r=l),n.parentId=t,s.children.splice(r,0,e),s.children.forEach((e,t)=>{this.blocks[e].order=t}),this._emit("block-moved",{block:n,oldParentId:null==o?void 0:o.id,newParentId:t,newIndex:r}),this._emit("change",{action:"move",block:n})}select(e){this.selectedId=e,this.selectedStyleTargetId=null,this._emit("selection-changed",{selectedId:e,selectedBlock:e?this.blocks[e]:void 0}),this._emit("style-target-changed",{selectedId:e,targetId:null})}getSelected(){return this.selectedId?this.blocks[this.selectedId]:null}selectStyleTarget(e){this.selectedStyleTargetId!==e&&(this.selectedStyleTargetId=e,this._emit("style-target-changed",{selectedId:this.selectedId,targetId:e}))}getSelectedStyleTargetId(){return this.selectedStyleTargetId}getLinkModeState(){return this.linkModeState}setLinkModeState(e){this.linkModeState={...this.linkModeState,...e},this._emit("link-mode-changed",{state:this.linkModeState})}getLinkEditorSelection(){return this.linkEditorSelection}setLinkEditorSelection(e){this.linkEditorSelection={...this.linkEditorSelection,...e},this._emit("link-editor-selection-changed",{selection:this.linkEditorSelection})}getLinkAnchorHighlight(){return this.linkAnchorHighlight}setLinkAnchorHighlight(e){this.linkAnchorHighlight.blockId!==e&&(this.linkAnchorHighlight={blockId:e},this._emit("link-anchor-highlight-changed",{blockId:e}))}getLinkGridColor(){return this.linkGridColor}setLinkGridColor(e){this.linkGridColor!==e&&(this.linkGridColor=e,this._emit("link-grid-color-changed",{color:e}))}canDeleteBlock(e){const t=this.blocks[e];return!(!t||"root"===e)&&(t.canBeDeleted??!0)}canDuplicateBlock(e){return this.blocks[e].canBeDuplicated??!0}canChangeLayoutMode(e){return this.blocks[e].canChangeLayoutMode??!0}isHidden(e){return!0===this.blocks[e].isHidden}isEntityRequired(e){return this.blocks[e].requireEntity??!1}duplicateBlock(e){const t=this.blocks[e];if(!t||!this.canDuplicateBlock(e))return console.warn(`Cannot duplicate block: ${e}`),null;const i=this.blocks[t.parentId];if(!i||!i.children)return null;const n=i.children.indexOf(e);if(-1===n)return null;const o=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,s={...t,id:o,order:n+1,children:[]};return this.blocks={...this.blocks,[o]:s},i.children.splice(n+1,0,o),i.children.forEach((e,t)=>{this.blocks[e].order=t}),t.children&&t.children.length>0&&t.children.forEach(e=>{this.blocks[e]&&this._duplicateBlockRecursive(e,o)}),this._emit("block-created",{block:s}),this._emit("change",{action:"duplicate",block:s}),this.select(o),s}getBlock(e){return this.blocks[e]}getChildren(e){const t=this.blocks[e];return t&&t.children?t.children.map(e=>this.blocks[e]).filter(Boolean).sort((e,t)=>e.order-t.order):[]}getBlockLabel(e){var t;const i="string"==typeof e?this.blocks[e]:e;return(null==(t=null==i?void 0:i.label)?void 0:t.trim())||void 0}getBlockDisplayName(e,t){const i="string"==typeof e?this.blocks[e]:e;return i?this.getBlockLabel(i)||t||i.type:t||""}resolveEntityForBlock(e){const t=this.blocks[e];if(!t)return{entityId:void 0,source:"none"};const i=t.entityConfig;if(!i)return this._resolveInheritedEntity(t);if("fixed"===i.mode)return{entityId:i.entityId,source:"fixed"};if("slot"===i.mode){const e=i.slotId;return{entityId:e?this.resolveSlotEntity(e):void 0,source:"slot",slotId:e}}return this._resolveInheritedEntity(t)}resolveSlotEntity(e){var t;return null==(t=this.slots.entities[e])?void 0:t.entityId}resolveSlotAction(e){return this.slots.actions[e]}getBlockEntities(e){var t,i,n;if(!e)return[];const o=this.getElement(e.id),s=null==(t=null==o?void 0:o.getBlockEntities)?void 0:t.call(o);if(void 0!==s)return s;if("fixed"===(null==(i=e.entityConfig)?void 0:i.mode)||"slot"===(null==(n=e.entityConfig)?void 0:n.mode)){const t=this.resolveEntityForBlock(e.id).entityId;return t?[t]:[]}return[]}getStyleBindingEntities(e){var t;if(!e)return[];const i=new Set;if(e.styles)for(const n of Object.values(e.styles))if(null==n?void 0:n.containers)for(const o of Object.values(n.containers))if(o)for(const n of Object.values(o))if(n)for(const o of Object.values(n)){if(!o||"object"!=typeof o)continue;const n=o;if(n.binding){X(n.binding,e,this).forEach(e=>i.add(e))}if(null==(t=n.animation)?void 0:t.binding){X(n.animation.binding,e,this).forEach(e=>i.add(e))}}return Array.from(i)}getTraitBindingEntities(e){if(!e)return[];const t={};for(const[i,n]of Object.entries(e.props??{})){if(!n||"object"!=typeof n)continue;const e=n;e.binding&&(t[i]=e.binding)}return 0===Object.keys(t).length?[]:function(e,t,i){const n=new Set,o=Array.isArray(e)?e:Object.values(e);for(const s of o){if(!s)continue;X(s,t,i).forEach(e=>n.add(e))}return Array.from(n)}(t,e,this)}getAllTrackedEntities(e){return{blockEntities:this.getBlockEntities(e),styleEntities:this.getStyleBindingEntities(e),traitBindingEntities:this.getTraitBindingEntities(e)}}getTrackedEntitiesFlat(e){const{blockEntities:t,styleEntities:i,traitBindingEntities:n}=this.getAllTrackedEntities(e);return[...new Set([...t,...i,...n])]}getAllTrackedEntitiesRecursive(e){if(!e)return{blockId:void 0,blockEntities:[],styleEntities:[],traitBindingEntities:[],children:[]};const t=this.getAllTrackedEntities(e),i=this.getChildren(e.id).map(e=>this.getAllTrackedEntitiesRecursive(e));return{blockId:e.id,blockEntities:t.blockEntities,styleEntities:t.styleEntities,traitBindingEntities:t.traitBindingEntities,children:i}}getTrackedEntitiesRecursiveFlat(e){if(!e)return[];const t=new Set;this.getTrackedEntitiesFlat(e).forEach(e=>t.add(e));const i=this.getChildren(e.id);for(const n of i){this.getTrackedEntitiesRecursiveFlat(n).forEach(e=>t.add(e))}return Array.from(t)}isDescendant(e,t){if(!e||!t||e===t)return!1;if(!this.blocks[e])return!1;const i=this.getChildren(e);if(i.some(e=>e.id===t))return!0;for(const n of i)if(this.isDescendant(n.id,t))return!0;return!1}getSlotEntities(){return Object.values(this.slots.entities).sort((e,t)=>e.id.localeCompare(t.id))}getSlotEntity(e){return this.slots.entities[e]}getSlotActions(){return Object.values(this.slots.actions).sort((e,t)=>e.id.localeCompare(t.id))}getSlotAction(e){return this.slots.actions[e]}createSlotEntity(e){var t,i,n,o;const s=this._normalizeSlotId(e.id);if(!s)return{success:!1,error:"Slot ID cannot be empty"};if(this.slots.entities[s])return{success:!1,error:"Slot ID already exists"};const r=null==(t=e.domains)?void 0:t.filter(e=>e.trim()).map(e=>e.trim().toLowerCase()),l=(null==(i=e.entityId)?void 0:i.trim())||void 0;if(r&&r.length>0&&l){const e=l.split(".")[0];if(!r.includes(e))return{success:!1,error:`Default entity domain '${e}' must be one of: ${r.join(", ")}`}}const a={id:s,name:(null==(n=e.name)?void 0:n.trim())||void 0,description:(null==(o=e.description)?void 0:o.trim())||void 0,entityId:l,domains:r&&r.length>0?r:void 0};return this.slots={...this.slots,entities:{...this.slots.entities,[s]:a}},this._emitSlotEntitiesChanged("create",a),this._emit("change",{action:"update"}),{success:!0,slot:a}}updateSlotEntity(e,t){var i;const n=this.slots.entities[e];if(!n)return{success:!1,error:"Slot not found"};const o=t.id?this._normalizeSlotId(t.id):e;if(!o)return{success:!1,error:"Slot ID cannot be empty"};if(o!==e&&this.slots.entities[o])return{success:!1,error:"Slot ID already exists"};const s=void 0!==t.domains?(null==(i=t.domains)?void 0:i.filter(e=>e.trim()).map(e=>e.trim().toLowerCase()))||[]:n.domains,r=void 0!==t.entityId?t.entityId.trim()||void 0:n.entityId;if(s&&s.length>0&&r){const e=r.split(".")[0];if(!s.includes(e))return{success:!1,error:`Entity domain '${e}' must be one of: ${s.join(", ")}`}}const l={...n,...t,id:o,name:void 0!==t.name?t.name.trim()||void 0:n.name,description:void 0!==t.description?t.description.trim()||void 0:n.description,entityId:r,domains:s&&s.length>0?s:void 0};if(o!==e){const t={...this.slots.entities};delete t[e],t[o]=l,this.slots={...this.slots,entities:t};const i=this._replaceSlotEntityReferences(e,o);this._notifySlotUsageChanged(i)}else if(this.slots={...this.slots,entities:{...this.slots.entities,[e]:l}},"entityId"in t){const t=this._getSlotEntityReferenceBlockIds(e);this._notifySlotUsageChanged(t)}return this._emitSlotEntitiesChanged("update",l),this._emit("change",{action:"update"}),{success:!0,slot:l}}deleteSlotEntity(e){if(!this.slots.entities[e])return{success:!1,error:"Slot not found"};const t={...this.slots.entities},i=t[e];return delete t[e],this.slots={...this.slots,entities:t},this._emitSlotEntitiesChanged("delete",i),this._emit("change",{action:"update"}),{success:!0,slot:i}}createSlotAction(e){var t,i;const n=this._normalizeSlotId(e.id);if(!n)return{success:!1,error:"Slot ID cannot be empty"};if(this.slots.actions[n])return{success:!1,error:"Slot ID already exists"};if(!e.trigger)return{success:!1,error:"Trigger is required"};if(!e.action||"none"===e.action.action)return{success:!1,error:"Action is required"};const o={id:n,name:(null==(t=e.name)?void 0:t.trim())||void 0,description:(null==(i=e.description)?void 0:i.trim())||void 0,trigger:e.trigger,action:e.action};return this.slots={...this.slots,actions:{...this.slots.actions,[n]:o}},this._emitSlotActionsChanged("create",o),this._emit("change",{action:"update"}),{success:!0,slot:o}}updateSlotAction(e,t){const i=this.slots.actions[e];if(!i)return{success:!1,error:"Slot not found"};const n=t.id?this._normalizeSlotId(t.id):e;if(!n)return{success:!1,error:"Slot ID cannot be empty"};if(n!==e&&this.slots.actions[n])return{success:!1,error:"Slot ID already exists"};if(void 0!==t.trigger&&!t.trigger)return{success:!1,error:"Trigger is required"};if(t.action&&"none"===t.action.action)return{success:!1,error:"Action is required"};const o={...i,...t,id:n,name:void 0!==t.name?t.name.trim()||void 0:i.name,description:void 0!==t.description?t.description.trim()||void 0:i.description,trigger:t.trigger??i.trigger,action:t.action??i.action};if(n!==e){const t={...this.slots.actions};delete t[e],t[n]=o,this.slots={...this.slots,actions:t};const i=this._replaceSlotActionReferences(e,n);this._notifySlotUsageChanged(i)}else if(this.slots={...this.slots,actions:{...this.slots.actions,[e]:o}},"action"in t||"trigger"in t){const t=this._getSlotActionReferenceBlockIds(e);this._notifySlotUsageChanged(t)}return this._emitSlotActionsChanged("update",o),this._emit("change",{action:"update"}),{success:!0,slot:o}}deleteSlotAction(e){if(!this.slots.actions[e])return{success:!1,error:"Slot not found"};const t={...this.slots.actions},i=t[e];return delete t[e],this.slots={...this.slots,actions:t},this._emitSlotActionsChanged("delete",i),this._emit("change",{action:"update"}),{success:!0,slot:i}}findSlotEntityReferences(e){var t,i;const n=[];for(const o of Object.values(this.blocks)){const s=o.entityConfig;if("slot"===(null==s?void 0:s.mode)&&(null==s?void 0:s.slotId)===e&&n.push({blockId:o.id,kind:"block-entity"}),o.styles)for(const[t,i]of Object.entries(o.styles))this._collectSlotReferencesFromContainerStyles(o.id,e,null==i?void 0:i.containers,n,"block"===t?void 0:t);if(o.props)for(const[r,l]of Object.entries(o.props))if(l&&"object"==typeof l){const s=l;(null==(i=null==(t=s.binding)?void 0:t.entity)?void 0:i.slotId)===e&&n.push({blockId:o.id,kind:"trait-binding",propName:r}),this._isSlotPropReference(r,s.value,e)&&n.push({blockId:o.id,kind:"trait-slot",propName:r})}else this._isSlotPropReference(r,l,e)&&n.push({blockId:o.id,kind:"trait-slot",propName:r})}return n}findSlotActionReferences(e){var t,i;const n=[];for(const o of Object.values(this.blocks))if(null==(t=o.actions)?void 0:t.targets)for(const[t,s]of Object.entries(o.actions.targets))if(Array.isArray(s))for(const r of s)r===e&&n.push({blockId:o.id,kind:"action-slot",propName:t,actionTrigger:null==(i=this.slots.actions[e])?void 0:i.trigger});return n}buildTree(){const e=this.blocks[this.rootId],t=e=>e.children?{...e,tree:e.children.map(e=>t(this.blocks[e]))}:e;return t(e)}registerElement(e,t){const i="string"==typeof e?e:e.id;this.blocks[i]?t?(this._elementRegistry.set(i,t),this._emit("element-registered",{blockId:i,element:t})):this._elementRegistry.delete(i):t&&console.error(`[DocumentModel] Block ${i} not found, element cannot be registered`)}getElement(e){const t="string"==typeof e?e:e.id;if(this.blocks[t])return this._elementRegistry.get(t);console.warn(`[DocumentModel] Block ${t} not found, element cannot be retrieved`)}clear(){this._reset(),this._initialize()}loadFromConfig(e){this._reset(),this.version=e.version,this.rootId=e.rootId,this.slots=e.slots,this.blocks=e.blocks,this.dispatchEvent(new CustomEvent("document-loaded")),this._emitSlotEntitiesReloaded(),this._emitSlotActionsReloaded(),this._emit("change",{action:"load"})}exportToConfig(){return{version:this.version,rootId:this.rootId,slots:this.slots,blocks:this.blocks}}_initialize(){this.blocks[this.rootId]={label:"Card",id:this.rootId,type:"canvas",parentId:null,canBeDeleted:!1,canBeDuplicated:!1,canChangeLayoutMode:!1,isHidden:!1,requireEntity:!1,parentManaged:!1,layout:"flow",children:[],props:{overflow_allow_blocks_outside:{value:!0},overflow_show:{value:!0}},order:0,zIndex:0}}_reset(){Object.keys(this.blocks).forEach(e=>delete this.blocks[e]),this.selectedId=null,this.selectedStyleTargetId=null,this.linkModeState={enabled:!1,mode:"idle",activeLinkId:null},this.linkEditorSelection={blockId:null,pointId:null,segmentIndex:null,handle:null},this.linkAnchorHighlight={blockId:null},this.linkGridColor="#000000",this.slots={entities:{},actions:{}},this.version=3}_duplicateBlockRecursive(e,t){const i=this.blocks[e];if(!i)return;const n=`block-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,o=this.blocks[t],s={...i,id:n,parentId:t,order:o.children?o.children.length:0,children:[]};this.blocks={...this.blocks,[n]:s},o.children&&o.children.push(n),i.children&&i.children.length>0&&i.children.forEach(e=>{this._duplicateBlockRecursive(e,n)})}_resolveInheritedEntity(e){let t=e.parentId;for(;t;){const e=this.blocks[t];if(!e)break;const i=e.entityConfig;if("fixed"===(null==i?void 0:i.mode))return{entityId:i.entityId,source:"inherited",inheritedFromId:e.id,inheritedFromDisplayName:this.getBlockDisplayName(e),inheritedFromType:e.type};if("slot"===(null==i?void 0:i.mode)){const t=i.slotId;return{entityId:t?this._resolveSlotEntity(t):void 0,source:"inherited",inheritedFromId:e.id,inheritedFromDisplayName:this.getBlockDisplayName(e),inheritedFromType:e.type,slotId:t}}t=e.parentId}return{entityId:void 0,source:"none"}}_resolveSlotEntity(e){var t;if(e)return null==(t=this.slots.entities[e])?void 0:t.entityId}_normalizeSlotId(e){return e.trim().toLowerCase().replaceAll(" ","-")}_emitSlotEntitiesChanged(e,t){this.dispatchEvent(new CustomEvent("slots-changed",{detail:{action:e,slot:t}}))}_emitSlotEntitiesReloaded(){this.dispatchEvent(new CustomEvent("slots-changed",{detail:{action:"load"}}))}_emitSlotActionsChanged(e,t){this.dispatchEvent(new CustomEvent("slot-actions-changed",{detail:{action:e,slot:t}}))}_emitSlotActionsReloaded(){this.dispatchEvent(new CustomEvent("slot-actions-changed",{detail:{action:"load"}}))}_collectSlotReferencesFromContainerStyles(e,t,i,n,o){var s,r,l,a,c;if(i)for(const d of Object.values(i))if(d)for(const[i,u]of Object.entries(d))if(u)for(const[d,h]of Object.entries(u)){if(!h||"object"!=typeof h)continue;const u=h;(null==(r=null==(s=u.binding)?void 0:s.entity)?void 0:r.slotId)===t&&n.push({blockId:e,kind:"style-binding",category:i,property:d,styleTargetId:o}),(null==(c=null==(a=null==(l=u.animation)?void 0:l.binding)?void 0:a.entity)?void 0:c.slotId)===t&&n.push({blockId:e,kind:"style-animation",category:i,property:d,styleTargetId:o})}}_replaceSlotEntityReferences(e,t){var i,n;const o={...this.blocks},s=new Set;for(const[r,l]of Object.entries(this.blocks)){let a=l,c=!1;if("slot"===(null==(i=l.entityConfig)?void 0:i.mode)&&(null==(n=l.entityConfig)?void 0:n.slotId)===e&&(a={...a,entityConfig:{...l.entityConfig,slotId:t}},c=!0),l.styles){let i=!1;const n={...l.styles};for(const[o,s]of Object.entries(l.styles)){if(!(null==s?void 0:s.containers))continue;const{containerStyles:r,changed:l}=this._updateSlotIdInContainerStyles(s.containers,e,t);l&&(n[o]={...s,containers:r},i=!0)}i&&(a={...a,styles:n},c=!0)}if(l.props){let i=!1;const n={...l.props};for(const[o,s]of Object.entries(l.props)){const r=this._updateSlotIdInTraitValue(o,s,e,t);r.changed&&(n[o]=r.value,i=!0)}i&&(a={...a,props:n},c=!0)}c&&(o[r]=a,s.add(r))}return s.size>0&&(this.blocks=o),s}_replaceSlotActionReferences(e,t){var i;const n={...this.blocks},o=new Set;for(const[s,r]of Object.entries(this.blocks)){if(!(null==(i=r.actions)?void 0:i.targets))continue;let l=!1;const a={...r.actions.targets};for(const[i,n]of Object.entries(r.actions.targets)){if(!Array.isArray(n))continue;let o=!1;const s=n.map(i=>i===e?(o=!0,t):i);o&&(a[i]=s,l=!0)}l&&(n[s]={...r,actions:{targets:a}},o.add(s))}return o.size>0&&(this.blocks=n),o}_updateSlotIdInContainerStyles(e,t,i){let n=!1;const o={};for(const[s,r]of Object.entries(e)){if(!r)continue;let e=!1;const l={...r};for(const[n,o]of Object.entries(r)){if(!o)continue;let s=!1;const r={...o};for(const[e,n]of Object.entries(o)){if(!n||"object"!=typeof n)continue;const o=this._updateSlotIdInStylePropertyValue(n,t,i);o.changed&&(r[e]=o.value,s=!0)}s&&(l[n]=r,e=!0)}e?(o[s]=l,n=!0):o[s]=r}return{containerStyles:n?o:e,changed:n}}_updateSlotIdInStylePropertyValue(e,t,i){var n,o,s,r,l;const a=e;let c=!1,d=a.binding,u=a.animation;return(null==(o=null==(n=a.binding)?void 0:n.entity)?void 0:o.slotId)===t&&(d={...a.binding,entity:{...a.binding.entity,slotId:i}},c=!0),(null==(l=null==(r=null==(s=a.animation)?void 0:s.binding)?void 0:r.entity)?void 0:l.slotId)===t&&(u={...a.animation,binding:{...a.animation.binding,entity:{...a.animation.binding.entity,slotId:i}}},c=!0),c?{value:{...a,binding:d,animation:u},changed:!0}:{value:e,changed:!1}}_updateSlotIdInTraitValue(e,t,i,n){var o,s;if(t&&"object"==typeof t){const r=t;let l=!1,a=r.value,c=r.binding;return(null==(s=null==(o=r.binding)?void 0:o.entity)?void 0:s.slotId)===i&&(c={...r.binding,entity:{...r.binding.entity,slotId:n}},l=!0),this._isSlotPropReference(e,r.value,i)&&(a=n,l=!0),l?{value:{...r,value:a,binding:c},changed:!0}:{value:t,changed:!1}}return this._isSlotPropReference(e,t,i)?{value:n,changed:!0}:{value:t,changed:!1}}_isSlotPropReference(e,t,i){return"string"==typeof t&&(t===i&&e.toLowerCase().includes("slot"))}_getSlotEntityReferenceBlockIds(e){const t=new Set;for(const i of this.findSlotEntityReferences(e))t.add(i.blockId);return t}_getSlotActionReferenceBlockIds(e){const t=new Set;for(const i of this.findSlotActionReferences(e))t.add(i.blockId);return t}_notifySlotUsageChanged(e){if(0!==e.size)for(const t of e){const e=this.blocks[t];e&&(this._emit("block-updated",{block:e}),this._emit("change",{action:"update",block:e,styleChanged:!0}))}}_emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}}const Y=e("document-model");function X(e,t,i){if(!e||"object"!=typeof e)return[];const n=new Set,o=e,s=function(e,t,i){return(null==e?void 0:e.slotId)?i.resolveSlotEntity(e.slotId):(null==e?void 0:e.entityId)?e.entityId:i.resolveEntityForBlock(t.id).entityId}(o.entity,t,i);if(s&&n.add(s),"condition"===o.mode){const e=o;if(e.conditions)for(const t of e.conditions){K(t.condition).forEach(e=>n.add(e))}}const r=e;if("showWhen"in r&&r.showWhen){K(r.showWhen).forEach(e=>n.add(e))}if("hideWhen"in r&&r.hideWhen){K(r.hideWhen).forEach(e=>n.add(e))}if("activeWhen"in r&&r.activeWhen){K(r.activeWhen).forEach(e=>n.add(e))}return Array.from(n)}function K(e){const t=new Set;if(E(e))for(const n of e.rules){K(n).forEach(e=>t.add(e))}else"object"==typeof(i=e)&&null!==i&&"operator"in i&&!("rules"in i)&&e.entity&&t.add(e.entity);var i;return Array.from(t)}const J=e("event-bus");class Q{constructor(){this.listeners=new Map}addEventListener(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.removeEventListener(e,t)}removeEventListener(e,t){const i=this.listeners.get(e);i&&(i.delete(t),0===i.size&&this.listeners.delete(e))}dispatchEvent(e,t){const i=this.listeners.get(e);i&&i.forEach(i=>{try{i(t)}catch(n){console.error(`Error in event listener for "${e}":`,n)}})}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){var t;return(null==(t=this.listeners.get(e))?void 0:t.size)||0}hasListeners(e){return this.listenerCount(e)>0}}const ee="desktop";class te extends Q{constructor(e=null){super(),this.containers=new Map,this.containers.set(ee,{id:ee,name:"Desktop",width:0,order:1,isDefault:!0,isDevice:!0,icon:"mdi:monitor"});this.getDefaultContainers(e).forEach(e=>this.setContainer(e))}getDefaultContainers(e){return[{id:"tablet",name:"Tablet",width:768,order:2,isDefault:!1,isDevice:!0,icon:"mdi:tablet",disabled:!0},{id:"mobile",name:"Mobile",width:480,order:3,isDefault:!1,isDevice:!0,icon:"mdi:cellphone",disabled:!0}]}getContainers(){return Array.from(this.containers.values()).sort((e,t)=>e.order-t.order)}getDefaultContainer(){return this.containers.get(ee)}getDefaultContainerId(){return ee}getActiveContainer(){return this.containers.get(ee)}getActiveContainerId(){return ee}setContainer(e){if(this.containers.has(e.id))throw new Error(`Container is already registered: ${e.id}`);if(e.isDefault)throw new Error(`Container ${e.id} can not be registered ad default container`);this.containers.set(e.id,e),this.dispatchEvent("containers-updated",{containers:this.getContainers()})}getFallbackChain(e){return[this.getDefaultContainer()]}}new te;const ie=e("container-manager");var ne=Object.defineProperty,oe=(e,t,i,n)=>{for(var o,s=void 0,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(t,i,s)||s);return s&&ne(t,i,s),s};const se=e("drag-drop-manager");class re extends t{constructor(){super(...arguments),this.blockId="",this.canvasId="",this._registered=!1,this._wasDisconnected=!1}get dropId(){return this.blockId}get dropElement(){return this}get blockType(){return this.tagName.toLowerCase()}get isBlockDraggable(){return!0}get isBlockDroppable(){return!0}get isBlockContainer(){return!1}shouldShowDropIndicator(){return!0}get blockTypesAcceptedAsChildren(){return null}connectedCallback(){super.connectedCallback(),this.dragDropManager}disconnectedCallback(){this.dragDropManager&&(this._wasDisconnected=!0,this._unregisterFromManager()),super.disconnectedCallback()}updated(e){if(!this.dragDropManager)return;const t=this.blockId&&this.canvasId,i=e.has("blockId")||e.has("canvasId"),n=!this._registered||i||this._wasDisconnected;t&&n&&((i||this._wasDisconnected)&&this._registered&&(this._registered=!1),this._wasDisconnected=!1,this._registerWithManager())}getBlockedDropInstructions(){return null}_registerWithManager(){this.dragDropManager.registerBlock(this),this._registered=!0,this.blockId}_unregisterFromManager(){this._registered&&this.blockId&&(this.dragDropManager.unregisterBlock(this),this._registered=!1,this.blockId)}}oe([i({type:String,attribute:"block-id"})],re.prototype,"blockId"),oe([i({type:String,attribute:"canvas-id"})],re.prototype,"canvasId"),oe([n({context:se})],re.prototype,"dragDropManager");const le="data-dnd-draggable",ae=`[${le}="true"]`;var ce=(e=>(e.CANVAS="canvas",e.SOURCE_ZONE="source-zone",e))(ce||{}),de=(e=>(e.CANVAS="canvas",e.CONTAINER="container",e.BLOCK="block",e))(de||{}),ue=(e=>(e.SOURCE_NOT_ALLOWED="source_not_allowed",e.BLOCK_TYPE_NOT_ALLOWED="block_type_not_allowed",e.CONTAINER_REFUSES="container_refuses",e.BOUND_BLOCK_LOCKED="bound_block_locked",e.TRANSFER_NOT_ALLOWED="transfer_not_allowed",e))(ue||{});class he{constructor(e,t,i){this.restrictionManager=e,this.shakeAnimator=t,this.eventBus=i,this.draggables=new Map}attachToBlock(e){if(this.draggables.has(e))return e.blockId,void e.canvasId;e.blockId,e.blockType,e.setAttribute(le,"true");const t=S({element:e,getInitialData:()=>{const t={sourceId:e.canvasId,sourceType:ce.CANVAS,blockType:e.blockType,blockId:e.blockId};return e.blockId,t},onGenerateDragPreview:()=>{e.blockId,this.eventBus.dispatchEvent("block-drag-on-generate-preview",{sourceId:e.canvasId,sourceType:ce.CANVAS,blockId:e.blockId,blockType:e.blockType})},onDragStart:()=>{e.blockId,this.eventBus.dispatchEvent("block-drag-started",{sourceId:e.canvasId,sourceType:ce.CANVAS,blockId:e.blockId,blockType:e.blockType,canvasId:e.canvasId}),e.style.opacity="0.5"},onDrop:()=>{e.blockId,e.style.opacity="1"},canDrag:()=>{const t={sourceType:ce.CANVAS,sourceId:e.canvasId,blockType:e.blockType,blockId:e.blockId};e.blockId;const i=this.restrictionManager.canStartDrag(t);return i.allowed?(e.blockId,!0):(i.reason,i.message,this.eventBus.dispatchEvent("block-rejected",{blockType:e.blockType,blockId:e.blockId,sourceZoneId:e.canvasId,reason:i.reason,message:i.message||"Drag operation not allowed",element:e}),this.shakeAnimator.playShake(e),!1)}});this.draggables.set(e,t),e.blockId}detachFromBlock(e){const t=this.draggables.get(e);t&&(e.blockId,t(),this.draggables.delete(e))}destroy(){this.draggables.forEach(e=>e()),this.draggables.clear()}}class pe{constructor(){this.sourceAllowlist=new Map,this.blockTypeRestrictions=new Map,this.containerAcceptance=new Map,this.boundBlocks=new Set,this.transferRules=[]}setRestrictions(e){e.sourceAllowlist&&(this.sourceAllowlist=e.sourceAllowlist),e.blockTypeRestrictions&&(this.blockTypeRestrictions=e.blockTypeRestrictions),e.containerAcceptance&&(this.containerAcceptance=e.containerAcceptance),e.boundBlocks&&(this.boundBlocks=e.boundBlocks)}setTransferRules(e){this.transferRules=e}canStartDrag(e,t){return t&&this.boundBlocks.has(t)?{allowed:!1,reason:ue.BOUND_BLOCK_LOCKED,message:"This block is locked and cannot be moved"}:{allowed:!0}}canDropInCanvas(e,t){if(this.sourceAllowlist.has(t)){if(!this.sourceAllowlist.get(t).has(e.sourceId))return{allowed:!1,reason:ue.SOURCE_NOT_ALLOWED,message:"Blocks from this source cannot be dropped in this canvas"}}if(this.blockTypeRestrictions.has(t)){if(!this.blockTypeRestrictions.get(t).has(e.blockType))return{allowed:!1,reason:ue.BLOCK_TYPE_NOT_ALLOWED,message:"This block type is not allowed in this canvas"}}return{allowed:!0}}canNestInContainer(e,t,i=null){if(i&&i.length>0&&!i.includes(e.blockType))return{allowed:!1,reason:ue.CONTAINER_REFUSES,message:"This container does not accept this block type"};if(this.containerAcceptance.has(t)){if(!this.containerAcceptance.get(t).has(e.blockType))return{allowed:!1,reason:ue.CONTAINER_REFUSES,message:"This container type does not accept this block"}}return{allowed:!0}}canTransferBetweenCanvases(e,t,i){if(t===i)return{allowed:!0};if(0===this.transferRules.length)return{allowed:!0};for(const n of this.transferRules){const o=n.sourceCanvasId===t&&n.targetCanvasId===i,s=n.bidirectional&&n.sourceCanvasId===i&&n.targetCanvasId===t;if(o||s)return n.allowedBlockTypes&&n.allowedBlockTypes.length>0&&!n.allowedBlockTypes.includes(e.blockType)?{allowed:!1,reason:ue.TRANSFER_NOT_ALLOWED,message:"This block type cannot be transferred between these canvases"}:{allowed:!0}}return{allowed:!1,reason:ue.TRANSFER_NOT_ALLOWED,message:"Transfer between these canvases is not allowed"}}addBoundBlock(e){this.boundBlocks.add(e)}removeBoundBlock(e){this.boundBlocks.delete(e)}}class ge{constructor(e,t){this.restrictionManager=e,this.eventBus=t,this.dropTargets=new Map}register(e){this.dropTargets.has(e.dropElement)?console.warn(`[${this.getAdapterName()}] Drop target already registered, skip: `,e.dropElement):(this.getAdapterName(),e.dropId,this._attachDropTarget(e))}unregister(e){const t=this.dropTargets.get(e.dropElement);t&&(t(),this.dropTargets.delete(e.dropElement))}destroy(){this.dropTargets.forEach(e=>e()),this.dropTargets.clear()}_attachDropTarget(e){const t=w({element:e.dropElement,canDrop:({source:t})=>{const i=t.data;return this._canDrop(i,e)},getData:({input:t,element:i})=>{const n=this._getBlockChildren(i),o=this._getDropTargetData(e),s=this._getBlockedInstructions(e,n.length),r={"reorder-before":s.includes("reorder-before")?"not-available":"available","reorder-after":s.includes("reorder-after")?"not-available":"available",combine:s.includes("combine")?"not-available":"available"};return I(o,{input:t,element:i,axis:"vertical",operations:r})}});this.dropTargets.set(e.dropElement,t)}_getBlockChildren(e){return Array.from(e.children).filter(e=>e instanceof re)}_getBlockedInstructions(e,t){return[]}}class ve extends ge{constructor(e,t){super(e,t)}registerBlock(e){this.register(e)}unregisterBlock(e){this.unregister(e)}getAdapterName(){return"BlockDropAdapter"}_canDrop(e,t){const i=this.restrictionManager.canDropInCanvas(e,t.canvasId);return e.blockId!==t.blockId&&i.allowed}_getDropTargetData(e){return{type:de.BLOCK,canvasId:e.canvasId,targetBlockId:e.dropId,targetBlockType:e.blockType}}_getBlockedInstructions(e,t){return["combine"]}}class be extends ge{constructor(e,t){super(e,t)}registerCanvas(e){this.register(e)}unregisterCanvas(e){this.unregister(e)}getAdapterName(){return"CanvasAdapter"}_canDrop(e,t){return this.restrictionManager.canDropInCanvas(e,t.dropId).allowed}_getDropTargetData(e){return{type:de.CANVAS,canvasId:e.dropId}}_getBlockedInstructions(e,t){return 0==t?["reorder-before","reorder-after"]:["combine","reorder-before","reorder-after"]}}class me extends ge{constructor(e,t){super(e,t)}attachToContainer(e){this.register(e)}unregisterContainer(e){this.unregister(e)}getAdapterName(){return"ContainerAdapter"}_canDrop(e,t){return this.restrictionManager.canNestInContainer(e,t.blockType,t.blockTypesAcceptedAsChildren).allowed}_getDropTargetData(e){return{type:de.CONTAINER,canvasId:e.canvasId,targetBlockId:e.dropId,targetBlockType:e.blockType}}_getBlockedInstructions(e,t){const i=e.getBlockedDropInstructions();return null!==i?i:[]}}function fe(e,t){const i=new CSSStyleSheet;i.replaceSync(t),e.adoptedStyleSheets=[...e.adoptedStyleSheets,i]}const ye="\n@keyframes dnd-shake {\n  0%, 100% { transform: translateX(0); }\n  25% { transform: translateX(-4px); }\n  50% { transform: translateX(4px); }\n  75% { transform: translateX(-4px); }\n}\n\n.dnd-shaking {\n  animation: dnd-shake 0.4s ease-in-out;\n}\n";class ke{constructor(){this.injectedRoots=new WeakSet}playShake(e){this._ensureStyles(e),e.classList.add("dnd-shaking");const t=()=>{e.classList.remove("dnd-shaking"),e.removeEventListener("animationend",t)};e.addEventListener("animationend",t)}destroy(){}_ensureStyles(e){const t=e.getRootNode();if(t instanceof ShadowRoot&&!this.injectedRoots.has(t))fe(t,ye),this.injectedRoots.add(t);else if(t instanceof Document&&!document.getElementById("dnd-shake-styles")){const e=document.createElement("style");e.id="dnd-shake-styles",e.textContent=ye,document.head.appendChild(e)}}}class _e{constructor(e,t,i){this.restrictionManager=e,this.shakeAnimator=t,this.eventBus=i,this.zones=new Map,this.cleanupFunctions=new Map}registerZone(e){this.zones.has(e.sourceId)?console.warn(`Source zone ${e.sourceId} already registered`):(this.zones.set(e.sourceId,e),this._attachDraggables(e))}destroy(){this.cleanupFunctions.forEach(e=>{e.forEach(e=>e())}),this.cleanupFunctions.clear(),this.zones.clear()}_attachDraggables(e){const t=[];e.sourceElement.querySelectorAll(ae).forEach(i=>{if(!(i instanceof HTMLElement))return;const n=i.getAttribute("block-type")||i.dataset.blockType;if(n)if(!e.sourceAllowedBlockTypes||e.sourceAllowedBlockTypes.includes(n))try{const o={sourceId:e.sourceId,sourceType:ce.SOURCE_ZONE,blockType:n},s=S({element:i,getInitialData:()=>o,onGenerateDragPreview:()=>{this.eventBus.dispatchEvent("block-drag-on-generate-preview",{sourceId:e.sourceId,sourceType:ce.SOURCE_ZONE,blockType:n})},canDrag:()=>{const t=this.restrictionManager.canStartDrag(o);return!!t.allowed||(t.reason,t.message,this.eventBus.dispatchEvent("block-rejected",{blockType:n,sourceZoneId:e.sourceId,reason:t.reason,message:t.message||"Drag operation not allowed",element:i}),this.shakeAnimator.playShake(i),!1)}});t.push(s)}catch(o){console.error(`[SourceAdapter] Error attaching draggable to ${n}:`,o)}else e.sourceId;else console.warn("[SourceAdapter] Block missing data-block-type:",i)}),t.length,this.cleanupFunctions.set(e.sourceId,t)}}class xe{constructor(){this.transferRules=[],this.blockOwnership=new Map}setRules(e){this.transferRules=e}getRules(){return this.transferRules}canTransfer(e,t,i){if(e===t)return!0;if(0===this.transferRules.length)return!0;for(const n of this.transferRules){const o=n.sourceCanvasId===e&&n.targetCanvasId===t,s=n.bidirectional&&n.sourceCanvasId===t&&n.targetCanvasId===e;if(o||s)return!(n.allowedBlockTypes&&n.allowedBlockTypes.length>0)||n.allowedBlockTypes.includes(i)}return!1}trackBlock(e,t){this.blockOwnership.set(e,t)}untrackBlock(e){this.blockOwnership.delete(e)}getBlockCanvas(e){return this.blockOwnership.get(e)}destroy(){this.transferRules=[],this.blockOwnership.clear()}}const Se="\n.dnd-drop-indicator {\n  position: absolute;\n  background: var(--dnd-indicator-color, #0078d4);\n  pointer-events: none;\n  z-index: 10000;\n  border-radius: var(--dnd-indicator-radius, 2px);\n  transition: margin-left 0.15s ease-out;\n}\n\n.dnd-drop-indicator.dnd-edge-top,\n.dnd-drop-indicator.dnd-edge-bottom {\n  height: var(--dnd-indicator-width, 2px);\n  left: 0;\n  right: 0;\n}\n\n.dnd-drop-indicator.dnd-edge-top {\n  top: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-bottom {\n  bottom: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-left,\n.dnd-drop-indicator.dnd-edge-right {\n  width: var(--dnd-indicator-width, 2px);\n  top: 0;\n  bottom: 0;\n}\n\n.dnd-drop-indicator.dnd-edge-left {\n  left: -1px;\n}\n\n.dnd-drop-indicator.dnd-edge-right {\n  right: -1px;\n}\n\n.dnd-drop-indicator-indented {\n  box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.3);\n}\n";class we{constructor(){this.indicator=null,this.currentParent=null,this.injectedRoots=new WeakSet}show(e,t,i=0){var n;if(!t)return void this.hide();this._ensureStyles(e),this.indicator||(this.indicator=document.createElement("div"),this.indicator.className="dnd-drop-indicator"),this.indicator.className=`dnd-drop-indicator dnd-edge-${t}`,i>0&&(this.indicator.className+=" dnd-drop-indicator-indented");const o=this._getIndicatorParent(e);o&&o!==this.currentParent&&(this.currentParent&&this.indicator.parentNode===this.currentParent&&this.currentParent.removeChild(this.indicator),this.currentParent=o),this.currentParent&&!this.indicator.parentNode&&(this.currentParent instanceof ShadowRoot?this.currentParent.appendChild(this.indicator):"top"===t?this.currentParent.insertBefore(this.indicator,e):e.nextSibling?this.currentParent.insertBefore(this.indicator,e.nextSibling):this.currentParent.appendChild(this.indicator));const s=e.getBoundingClientRect(),r=this.currentParent instanceof ShadowRoot?this.currentParent.host.getBoundingClientRect():null==(n=this.currentParent)?void 0:n.getBoundingClientRect();if(r){const e=s.left-r.left,n=s.top-r.top,o=20*i;"top"===t||"bottom"===t?(this.indicator.style.left=`${e+o}px`,this.indicator.style.width=s.width-o+"px",this.indicator.style.top="top"===t?`${n}px`:`${n+s.height}px`):(this.indicator.style.top=`${n}px`,this.indicator.style.height=`${s.height}px`,this.indicator.style.left="left"===t?`${e}px`:`${e+s.width}px`)}}hide(){this.indicator&&this.indicator.parentNode&&this.indicator.parentNode.removeChild(this.indicator),this.currentParent=null}destroy(){this.hide(),this.indicator=null}_ensureStyles(e){const t=e.getRootNode();if(t instanceof ShadowRoot&&!this.injectedRoots.has(t))fe(t,Se),this.injectedRoots.add(t);else if(t instanceof Document&&!document.getElementById("dnd-indicator-styles")){const e=document.createElement("style");e.id="dnd-indicator-styles",e.textContent=Se,document.head.appendChild(e)}}_getIndicatorParent(e){if(e.parentElement)return e.parentElement;const t=e.getRootNode();return t instanceof ShadowRoot?t:null}}const Ie=class e{constructor(e){this.autoScrollCleanup=null,this.monitorCleanup=null,this.autoScrollInitialized=!1,this.activeDropTargetElement=null,this.autoScrollConfig={maxScrollSpeed:"standard",startEdgeThreshold:30},this._applyEventRetargetingPatch(),this.eventBus=e,this.restrictionManager=new pe,this.transferManager=new xe,this.dropIndicator=new we,this.shakeAnimator=new ke,this.sourceAdapter=new _e(this.restrictionManager,this.shakeAnimator,this.eventBus),this.canvasAdapter=new be(this.restrictionManager,this.eventBus),this.blockDropAdapter=new ve(this.restrictionManager,this.eventBus),this.blockDraggableAdapter=new he(this.restrictionManager,this.shakeAnimator,this.eventBus),this.containerAdapter=new me(this.restrictionManager,this.eventBus),this._setupMonitor()}registerSourceZone(e){e.sourceId,this.sourceAdapter.registerZone(e)}registerCanvas(e){e.dropId,this.canvasAdapter.registerCanvas(e)}registerBlock(e){e.isBlockDroppable&&(e.isBlockContainer?this.containerAdapter.attachToContainer(e):this.blockDropAdapter.registerBlock(e)),e.isBlockDraggable&&this.blockDraggableAdapter.attachToBlock(e),e.blockId,e.isBlockContainer,e.isBlockDraggable,e.isBlockDroppable}unregisterBlock(e){e.blockId,this.blockDropAdapter.unregisterBlock(e),this.blockDraggableAdapter.detachFromBlock(e),this.containerAdapter.unregisterContainer(e)}setRestrictions(e){this.restrictionManager.setRestrictions(e)}enableCrossCanvasTransfer(e){this.transferManager.setRules(e),this.restrictionManager.setTransferRules(e)}setAutoScrollConfig(e,t){this.autoScrollElement=e,this.autoScrollConfig={...this.autoScrollConfig,...t},this.autoScrollInitialized&&this.autoScrollCleanup&&this.autoScrollCleanup(),this._setupAutoScroll()}addBoundBlock(e){this.restrictionManager.addBoundBlock(e)}removeBoundBlock(e){this.restrictionManager.removeBoundBlock(e)}destroy(){this.sourceAdapter.destroy(),this.canvasAdapter.destroy(),this.blockDropAdapter.destroy(),this.blockDraggableAdapter.destroy(),this.containerAdapter.destroy(),this.dropIndicator.destroy(),this.shakeAnimator.destroy(),this.transferManager.destroy(),this.monitorCleanup&&(this.monitorCleanup(),this.monitorCleanup=null),this.autoScrollCleanup&&(this.autoScrollCleanup(),this.autoScrollCleanup=null)}_applyEventRetargetingPatch(){if(e._isEventRetargetingPatchApplied)return void console.warn("[DragDropManager] Event retargeting patch already applied");const t=(e,t)=>{const i=function(e,t){var i;if(!e)return null;let n=e;for(;n;){if(null==(i=n.matches)?void 0:i.call(n,t))return n;if(n.parentElement)n=n.parentElement;else{const e=n.getRootNode();if(!(e instanceof ShadowRoot&&e.host))break;n=e.host}}return null}(e.composedPath()[0],t);i&&e.target!==i&&Object.defineProperty(e,"target",{value:i,enumerable:!0,configurable:!0})};["dragstart","drag","dragend"].forEach(e=>{window.addEventListener(e,e=>t(e,ae),{capture:!0})}),["dragenter","dragover","dragleave","drop"].forEach(e=>{window.addEventListener(e,e=>t(e,'[data-dnd-drop-target="true"]'),{capture:!0})})}_setupMonitor(){this.monitorCleanup=P({onDrag:({source:e,location:t})=>{var i;const n=t.current.dropTargets;if(0===n.length)return this._setActiveDropTarget(null),void this.dropIndicator.hide();const o=e.element,s=n.find(e=>{const t=e.element;return!this._isTargetDescendantOfSource(o,t)});if(!s)return this._setActiveDropTarget(null),void this.dropIndicator.hide();const r=s.element,l=s.data,a=A(s.data),c=a?{operation:a.operation,blocked:a.blocked}:void 0;if(this._setActiveDropTarget(r,l,c),!(null==(i=r.shouldShowDropIndicator)?void 0:i.call(r)))return void this.dropIndicator.hide();if(!a||a.blocked)return void this.dropIndicator.hide();let d=null;switch(a.operation){case"reorder-before":case"combine":d="top";break;case"reorder-after":d="bottom"}if(d&&r){const e=0;this.dropIndicator.show(r,d,e)}else this.dropIndicator.hide()},onDropTargetChange:({location:e})=>{e.current.dropTargets},onDrop:({source:e,location:t})=>{this._setActiveDropTarget(null),this.dropIndicator.hide();const i=e.data;if(0===t.current.dropTargets.length)return void this.eventBus.dispatchEvent("block-drop-ignored",{blockType:i.blockType,sourceId:i.sourceId,sourceType:i.sourceType});const n=e.element,o=t.current.dropTargets.find(e=>{const t=e.element;return!this._isTargetDescendantOfSource(n,t)});if(!o)return void console.warn("[DragDropManager] Drop rejected: Cannot drop a block inside itself or its descendants");o.element;const s=o.data,r=A(s),l=r?{operation:r.operation,blocked:r.blocked}:void 0,a={blockType:i.blockType,sourceId:i.sourceId,sourceType:i.sourceType,targetCanvasId:s.canvasId,targetBlockId:s.targetBlockId,targetBlockType:s.targetBlockType,targetIsContainer:s.type===de.CONTAINER,instruction:l};i.sourceType===ce.SOURCE_ZONE?this.eventBus.dispatchEvent("block-created",a):this.eventBus.dispatchEvent("block-reordered",{...a,blockId:i.blockId})}})}_isTargetDescendantOfSource(e,t){const i=e.getAttribute("block-id");if(!i)return!1;let n=t;for(;n;){if(n.getAttribute("block-id")===i)return!0;if(n.parentElement)n=n.parentElement;else{if(!n.getRootNode||!n.getRootNode().host)break;n=n.getRootNode().host}}return!1}_setActiveDropTarget(e,t,i){this.activeDropTargetElement!==e&&(this.activeDropTargetElement&&this.eventBus.dispatchEvent("drop-target-hover",{active:!1,targetElement:this.activeDropTargetElement}),this.activeDropTargetElement=e,e&&this.eventBus.dispatchEvent("drop-target-hover",{active:!0,targetElement:e,targetCanvasId:null==t?void 0:t.canvasId,targetBlockId:null==t?void 0:t.targetBlockId,targetBlockType:null==t?void 0:t.targetBlockType,targetIsContainer:(null==t?void 0:t.type)===de.CONTAINER,instruction:i}))}_setupAutoScroll(){this.autoScrollCleanup=T({element:this.autoScrollElement,canScroll:({element:e})=>e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth,getConfiguration:()=>({maxScrollSpeed:this.autoScrollConfig.maxScrollSpeed})}),this.autoScrollInitialized=!0}};Ie._isEventRetargetingPatchApplied=!1;let Pe=Ie;const Ae=e("environment-context");async function Te(e){const{hass:t,element:i,action:n,trigger:a,entityId:c,eventBus:d,blockId:u,targetId:h,slotId:p,throwOnError:g}=e;if(t)try{await(async(e,t,i,n)=>{if(n||(n={action:"more-info"}),n.confirmation&&(!n.confirmation.exemptions||!n.confirmation.exemptions.some(e=>{var i;return e.user===(null==(i=t.user)?void 0:i.id)}))){o("warning");const e=n.confirmation.text||`Are you sure you want to ${n.action}?`;if(!confirm(e))return}switch(n.action){case"more-info":{const t="entity"in n&&n.entity||i.entity||i.camera_image||i.image_entity;t?s(e,"hass-more-info",{entityId:t}):o("failure");break}case"navigate":if(n.navigation_path){const t="navigation_replace"in n?n.navigation_replace:void 0;l(e,n.navigation_path,t)}else o("failure");break;case"url":n.url_path?window.open(n.url_path):o("failure");break;case"toggle":i.entity?(r(t,i.entity),o("light")):o("failure");break;case"perform-action":case"call-service":{const e="perform_action"in n&&n.perform_action||"service"in n&&n.service||"";if(!e)return void o("failure");const[i,s]=e.split(".",2);await t.callService(i,s,"data"in n&&void 0!==n.data?n.data:"service_data"in n?n.service_data:void 0,"target"in n?n.target:void 0),o("light");break}case"fire-dom-event":s(e,"ll-custom",n)}})(i,t,{entity:c},n)}catch(v){if(console.error("[Actions] Failed to dispatch action:",v),g)throw v}finally{null==d||d.dispatchEvent("block-action",{blockId:u,targetId:h,trigger:a,action:n.action,entityId:c,slotId:p})}}function Ce(e,t){if(!e)return t||{};if(!t)return e;const i={...e};for(const n of Object.keys(t)){const o=e[n],s=t[n];s&&(i[n]=o?{...o,...s}:{...s})}return i}const Ee=e("hass");var Me=Object.defineProperty,Le=(e,t,i,n)=>{for(var o,s=void 0,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(t,i,s)||s);return s&&Me(t,i,s),s};const Be=class extends re{constructor(){super(...arguments),this.isDragging=!1,this.isResizing=!1,this.canvasWidth=0,this.canvasHeight=0,this.selected=!1,this.templateSessions=new Map,this.actionHoldDelay=1e3,this.actionDoubleTapDelay=250,this._holdTimeoutId=null,this._tapTimeoutId=null,this._lastTapTimestamp=0,this._lastTapTarget=null,this._holdTriggered=!1,this._pointerId=null,this._pressTarget=null,this._pressStartX=0,this._pressStartY=0,this._pointerMoved=!1,this._feedbackTimeoutId=null,this._actionListenersActive=!1,this._handlePointerDown=e=>{if(!this._shouldHandleActions(e))return;const t=this._resolveActionTarget(e);if(t&&this._hasAnyConfiguredActionForTarget(t)){this._pointerId=e.pointerId,this._pressTarget=t,this._pressStartX=e.clientX,this._pressStartY=e.clientY,this._pointerMoved=!1,this._holdTriggered=!1;const{hasHold:i,hasDoubleTap:n,hasTap:o}=this._getActionTriggerFlags(t);if(n&&o&&this._tapTimeoutId&&this._lastTapTarget===this._pressTarget){performance.now()-this._lastTapTimestamp<this.actionDoubleTapDelay&&this._clearTapTimer()}return i&&this._pressTarget&&(this._clearHoldTimer(),this._holdTimeoutId=window.setTimeout(()=>{this._holdTriggered=!0,this._clearTapTimer(),this._lastTapTimestamp=0,this._lastTapTarget=null,this._executeAction("hold",this._pressTarget)},this.actionHoldDelay)),void(this.setPointerCapture&&this.setPointerCapture(e.pointerId))}const i=this._resolveRawTarget(e);this.handleNativePointerDown(e,i)},this._handlePointerMove=e=>{if(null===this._pointerId||e.pointerId!==this._pointerId)return;const t=e.clientX-this._pressStartX,i=e.clientY-this._pressStartY;Math.hypot(t,i)>6&&(this._pointerMoved=!0,this._clearHoldTimer())},this._handlePointerUp=e=>{if(null===this._pointerId||e.pointerId!==this._pointerId)return;if(this._clearHoldTimer(),!this.areActionsEnabled())return void this._resetPointerState(e.pointerId);if(this._holdTriggered||this._pointerMoved)return void this._resetPointerState(e.pointerId);const t=this._pressTarget||this._resolveActionTarget(e);if(!t||!this._hasAnyConfiguredActionForTarget(t))return void this._resetPointerState(e.pointerId);const{hasTap:i,hasDoubleTap:n}=this._getActionTriggerFlags(t);if(n){const e=performance.now();this._lastTapTimestamp>0&&e-this._lastTapTimestamp<this.actionDoubleTapDelay&&this._lastTapTarget===t?(this._clearTapTimer(),this._lastTapTimestamp=0,this._lastTapTarget=null,this._executeAction("double_tap",t)):(this._lastTapTimestamp=e,this._lastTapTarget=t,i&&(this._tapTimeoutId=window.setTimeout(()=>{this._executeAction("tap",t),this._lastTapTimestamp=0,this._lastTapTarget=null,this._tapTimeoutId=null},this.actionDoubleTapDelay)))}else i&&(this._clearTapTimer(),this._lastTapTimestamp=0,this._lastTapTarget=null,this._executeAction("tap",t));this._resetPointerState(e.pointerId)},this._handlePointerCancel=e=>{null!==this._pointerId&&e.pointerId!==this._pointerId||(this._clearHoldTimer(),this._resetPointerState(e.pointerId))}}get isBlockDraggable(){return!!this.block&&"static"!==this.block.layout}get isBlockDroppable(){return!!this.block&&"static"!==this.block.layout}get slotId(){var e,t;return null==(t=null==(e=this.block)?void 0:e.entityConfig)?void 0:t.slotId}static getBlockConfig(){return null}static getAvailableActionTargetIds(e,t){return Object.keys(t)}static getStyleOutputConfig(e,t){return null}hasNativeActions(){return!1}getNativeActionTargetIds(){return[]}handleNativePointerDown(e,t){return!1}getPanelConfig(){return{}}connectedCallback(){var e;super.connectedCallback(),this.entity=this.resolvedEntityId(),this.selected=this.documentModel.selectedId===(null==(e=this.block)?void 0:e.id),this.environment.isBuilder&&(this.documentModel.addEventListener("change",e=>{var t;(null==(t=(null==e?void 0:e.detail).block)?void 0:t.parentId)===this.block.id&&this.requestUpdate()}),this.documentModel.addEventListener("block-moved",e=>{const t=e.detail;t.oldParentId!==this.block.id&&t.newParentId!==this.block.id||this.requestUpdate()}),this.documentModel.addEventListener("selection-changed",e=>{const t=e.detail;this.selected=this.block.id===t.selectedId,this.selected?this.classList.add("block-selected"):this.classList.remove("block-selected")}),this.documentModel.addEventListener("link-anchor-highlight-changed",e=>{const t=e.detail;this.classList.toggle("block-anchor-highlight",this.block.id===(null==t?void 0:t.blockId))}),this.documentModel.addEventListener("slots-changed",()=>{const e=this.resolvedEntityId();this.entity!==e&&(this.entity=e),this.requestUpdate()}),this.eventBus.addEventListener("block-drag-start",({block:e})=>{e.id===this.block.id&&(this.isDragging=!0)}),this.eventBus.addEventListener("block-drag-end",({block:e})=>{e.id===this.block.id&&(this.isDragging=!1)}),this.eventBus.addEventListener("block-resize-start",({block:e})=>{e.id===this.block.id&&(this.isResizing=!0)}),this.eventBus.addEventListener("block-resize-end",({block:e})=>{e.id===this.block.id&&(this.isResizing=!1)}),this.eventBus.addEventListener("block-selection-disabled",e=>{if(!this.block)return;const t=Boolean(null==e?void 0:e.disabled),i=null==e?void 0:e.excluded;t?i&&this.block.id===i?this.classList.remove("block-selection-disabled"):this.classList.add("block-selection-disabled"):this.classList.remove("block-selection-disabled")})),this.eventBus.addEventListener("canvas-size-changed",({width:e,height:t})=>{this.canvasWidth=e,this.canvasHeight=t}),this._syncActionListeners()}disconnectedCallback(){this._clearActionTimers(),this._removeActionListeners(),this.disposeTemplateSessions(),super.disconnectedCallback()}shouldUpdate(e){var t,i;if(e.has("block")||e.has("entity"))return!0;if(e.has("hass")){const i=e.get("hass");if(!i)return!0;const n=this.documentModel.getTrackedEntitiesRecursiveFlat(this.block);if(0===n.length)return!1;for(const e of n){if(i.states[e]!==(null==(t=this.hass)?void 0:t.states[e]))return!0}return!1}return(null==(i=super.shouldUpdate)?void 0:i.call(this,e))??!0}willUpdate(e){super.willUpdate(e),this.activeStyleTargetId=this.selected?this.documentModel.getSelectedStyleTargetId():null,this.resolvedRenderContext=this.renderer.resolvedRenderContext(this.block,void 0,this.getPanelConfig().targetStyles),this.canvasWidth=this.resolvedRenderContext.canvasWidth,this.canvasHeight=this.resolvedRenderContext.canvasHeight,e.has("hass")&&this.disposeTemplateSessions(),(e.has("hass")||this.hass&&!this.bindingEvaluator)&&(this.bindingEvaluator=new O(this.hass,{resolveSlotEntity:e=>this.documentModel.resolveSlotEntity(e),onTemplateResult:()=>this.requestUpdate()}))}firstUpdated(e){super.firstUpdated(e),this.addEventListener("block-rendering-completed",e=>{this.documentModel.isDescendant(this.block.id,e.detail.block.id)&&this.updatePositionFromLayoutData()})}updated(e){var t;super.updated(e),e.has("block")&&this.block&&(this.entity=this.resolvedEntityId(),this.classList.remove(`block-${null==(t=e.get("block"))?void 0:t.layout}`),this.classList.add(`block-${this.block.layout}`)),e.has("block")&&this._syncActionListeners();const i={"block-selected":this.selected,"block-outline-enabled":this.environment.blocksOutlineEnabled,builder:this.environment.isBuilder,"actions-pass-through":this._shouldPassThroughActions()};Object.entries(i).forEach(([e,t])=>{this.classList.toggle(e,Boolean(t))}),this._syncActionTargetPointerEvents();const n=this.getResolvedContextStyles();this.style.cssText=this.stylesToString(n),this.updatePositionFromLayoutData(),this.dispatchEvent(new CustomEvent("block-rendering-completed",{detail:{block:this.block},bubbles:!0,composed:!0}))}getBlockEntities(){var e,t;if(!this.block)return[];if("fixed"===(null==(e=this.block.entityConfig)?void 0:e.mode)&&this.block.entityConfig.entityId)return[this.block.entityConfig.entityId];const i=null==(t=this.documentModel)?void 0:t.resolveEntityForBlock(this.block.id);return(null==i?void 0:i.entityId)?[i.entityId]:[]}updatePositionFromLayoutData(){if(!this.block||"absolute"!==this.block.layout||!this.resolvedRenderContext.layoutData)return;const e=this.renderer.getRuntimeBlockSize(this.block,this.resolvedRenderContext.layoutData),t=this.renderer.blockToMoveable(this.resolvedRenderContext.layoutData,e,this.canvasWidth,this.canvasHeight);this.style.left=`${t.left}px`,this.style.top=`${t.top}px`}getResolvedContextStyles(){return this.resolvedRenderContext.styles}resolvedEntityId(){if(!this.block||!this.documentModel)return;return this.documentModel.resolveEntityForBlock(this.block.id).entityId}getEntityState(){return this.hass&&this.entity?this.hass.states[this.entity]:null}isEntityAvailable(){const e=this.getEntityState();return!!e&&"unavailable"!==e.state&&"unknown"!==e.state}getTargetStyle(e){var t,i;return(null==(i=null==(t=this.resolvedRenderContext)?void 0:t.targetStyles)?void 0:i[e])||{}}isStyleTargetActive(e){return this.activeStyleTargetId===e}getActionSlotIds(e){var t,i,n;return(null==(n=null==(i=null==(t=this.block)?void 0:t.actions)?void 0:i.targets)?void 0:n[e])??[]}getResolvedActionSlots(e){return this.getActionSlotIds(e).map(e=>this.documentModel.resolveSlotAction(e)).filter(e=>Boolean(e))}_isActionConfigured(e){return!!e&&"none"!==e.action}_getActionTriggerFlags(e){const t=this.getResolvedActionSlots(e).filter(e=>this._isActionConfigured(e.action));return{hasTap:t.some(e=>"tap"===e.trigger),hasDoubleTap:t.some(e=>"double_tap"===e.trigger),hasHold:t.some(e=>"hold"===e.trigger)}}_hasAnyConfiguredActionForTarget(e){return this.getResolvedActionSlots(e).some(e=>this._isActionConfigured(e.action))}_hasAnyConfiguredAction(){var e,t;const i=null==(t=null==(e=this.block)?void 0:e.actions)?void 0:t.targets;if(!i)return!1;for(const n of Object.keys(i))if(this._hasAnyConfiguredActionForTarget(n))return!0;return!1}_syncActionListeners(){const e=this._hasAnyConfiguredAction()||this.hasNativeActions();e!==this._actionListenersActive&&(e?(this.addEventListener("pointerdown",this._handlePointerDown),this.addEventListener("pointerup",this._handlePointerUp),this.addEventListener("pointermove",this._handlePointerMove),this.addEventListener("pointercancel",this._handlePointerCancel)):(this._removeActionListeners(),this._clearActionTimers(),this._resetPointerState()),this._actionListenersActive=e)}_removeActionListeners(){this.removeEventListener("pointerdown",this._handlePointerDown),this.removeEventListener("pointerup",this._handlePointerUp),this.removeEventListener("pointermove",this._handlePointerMove),this.removeEventListener("pointercancel",this._handlePointerCancel),this._actionListenersActive=!1}_executeAction(e,t){if(!this.areActionsEnabled())return;if(!this.block||!this.hass)return;const i=this.resolvedEntityId(),n=this.getResolvedActionSlots(t).filter(t=>t.trigger===e).filter(e=>this._isActionConfigured(e.action));if(0===n.length)return;let o=!1;for(const s of n)this._isActionExecutable(s.action,i)&&(o=!0,Te({hass:this.hass,element:this,action:s.action,trigger:e,entityId:i,eventBus:this.eventBus,blockId:this.block.id,targetId:t,slotId:s.id}));o&&this._applyActionFeedback()}_isActionExecutable(e,t){if(!this._isActionConfigured(e))return!1;if(("toggle"===e.action||"more-info"===e.action)&&!t)return!1;if("call-service"===e.action||"perform-action"===e.action){if(!Boolean("perform_action"in e&&e.perform_action||"service"in e&&"string"==typeof e.service&&e.service||"domain"in e&&"string"==typeof e.domain&&"service"in e&&"string"==typeof e.service))return!1}return!("navigate"===e.action&&!e.navigation_path)}_applyActionFeedback(){this.classList.add("action-feedback"),this._feedbackTimeoutId&&window.clearTimeout(this._feedbackTimeoutId),this._feedbackTimeoutId=window.setTimeout(()=>{this.classList.remove("action-feedback"),this._feedbackTimeoutId=null},150)}_shouldHandleActions(e){return!!this.areActionsEnabled()&&(!this.isDragging&&!this.isResizing&&(("mouse"!==e.pointerType||0===e.button)&&!this._isInteractiveElement(e.target)))}areActionsEnabled(){var e;return Boolean(null==(e=this.environment)?void 0:e.actionsEnabled)}_shouldPassThroughActions(){return!!this.areActionsEnabled()&&(!this.hasNativeActions()&&!this._hasAnyConfiguredAction())}_resolveActionTarget(e){var t;const i=e.composedPath();for(const n of i){if(n===this)break;if(n instanceof HTMLElement){const e=null==(t=n.dataset)?void 0:t.actionTarget;if(e&&this._hasAnyConfiguredActionForTarget(e))return e}}return this._hasAnyConfiguredActionForTarget("block")?"block":null}_resolveRawTarget(e){var t;const i=e.composedPath();for(const n of i){if(n===this)break;if(n instanceof HTMLElement){const e=null==(t=n.dataset)?void 0:t.actionTarget;if(e)return e}}return"block"}_syncActionTargetPointerEvents(){var e,t;const i=new Set(this.getNativeActionTargetIds()),n=null==(t=null==(e=this.renderRoot)?void 0:e.querySelectorAll)?void 0:t.call(e,"[data-action-target]");n&&n.forEach(e=>{var t;if(!(e instanceof HTMLElement))return;const n=null==(t=e.dataset)?void 0:t.actionTarget;if(!n)return;const o=this._hasAnyConfiguredActionForTarget(n)||i.has(n);e.style.pointerEvents=o?"":"none"})}_isInteractiveElement(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=e.tagName.toLowerCase();return!!["input","textarea","select","button","a"].includes(t)||!!e.closest('input, textarea, select, button, a, [contenteditable="true"]')}_resetPointerState(e){if(void 0!==e&&this.releasePointerCapture)try{this.releasePointerCapture(e)}catch{}this._pointerId=null,this._pressTarget=null,this._pressStartX=0,this._pressStartY=0,this._pointerMoved=!1,this._holdTriggered=!1}_clearHoldTimer(){this._holdTimeoutId&&(window.clearTimeout(this._holdTimeoutId),this._holdTimeoutId=null)}_clearTapTimer(){this._tapTimeoutId&&(window.clearTimeout(this._tapTimeoutId),this._tapTimeoutId=null)}_clearActionTimers(){this._clearHoldTimer(),this._clearTapTimer(),this._feedbackTimeoutId&&(window.clearTimeout(this._feedbackTimeoutId),this._feedbackTimeoutId=null)}stylesToString(e){return Object.entries(e).map(([e,t])=>`${e.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${t}`).join("; ")}resolveRawValue(e,t=""){return this.resolveRawValueWithTemplate(e,t)}resolveRawValueWithTemplate(e,t="",i){if(null==e)return String(t);if("object"==typeof e){if("value"in e&&"isTemplate"in e){const n=e;if(n.isTemplate){const e=(null==i?void 0:i.keywords)?function(e){if(!e||0===e.length)return{};const t={};for(const i of e)t[i.key]=i.value;return t}(i.keywords):{},t={...(null==i?void 0:i.variables)??{},...e};return this.resolveTemplateString((null==i?void 0:i.key)??n.value,n.value,t,null==i?void 0:i.debounceMs)}return n.value??t}if("binding"in e||"value"in e&&!("isTemplate"in e)){const i=e,n=i.value??t;if(i.binding&&this.bindingEvaluator){const e=this.bindingEvaluator.evaluate(i.binding,{defaultEntityId:this.resolvedEntityId(),defaultValue:n});return String(e.value??n)}return String(n)}}else if("string"==typeof e)return e;return String(t)}resolveRawValueAsNumber(e,t){const i=this.resolveRawValueWithTemplate(e,t),n=parseFloat(i);return Number.isNaN(n)?t:n}resolveRawValueAsBoolean(e,t=!1){const i=this.resolveRawValueWithTemplate(e,t);if("true"===i.toLowerCase())return!0;const n=parseFloat(i);return Number.isNaN(n)?t:0!==n}resolveProperty(e,t,i){const n=this.getPropertyValue(e);return this.resolveRawValueWithTemplate(n,t,{...i,key:(null==i?void 0:i.key)??e})}resolvePropertyAsNumber(e,t,i){const n=this.resolveRawValueWithTemplate(this.getPropertyValue(e),t,{...i,key:(null==i?void 0:i.key)??e}),o=parseFloat(n);return Number.isNaN(o)?t:o}resolvePropertyAsBoolean(e,t=!1,i){const n=this.resolveRawValueWithTemplate(this.getPropertyValue(e),t,{...i,key:(null==i?void 0:i.key)??e});if("true"===n.toLowerCase())return!0;const o=parseFloat(n);return Number.isNaN(o)?t:0!==o}resolveTemplateString(e,t,i,n){var o;const s=null==t?void 0:t.trim();if(!this.hass||!s)return this.disposeTemplateSession(e),"";const r=this.getTemplateSession(e);r.update({template:s,variables:i,reportErrors:!0,debounceMs:n});return r.getError()?M:(null==(o=r.getResult())?void 0:o.result)??""}getTemplateSession(e){let t=this.templateSessions.get(e);return t||(t=new $(this.hass,{onResult:()=>this.requestUpdate(),onError:()=>this.requestUpdate()}),this.templateSessions.set(e,t)),t}disposeTemplateSession(e){const t=this.templateSessions.get(e);t&&(t.dispose(),this.templateSessions.delete(e))}disposeTemplateSessions(){for(const e of this.templateSessions.values())e.dispose();this.templateSessions.clear()}getPropertyValue(e){var t,i;const n=null==(i=null==(t=this.block)?void 0:t.props)?void 0:i[e];if(!n||"object"!=typeof n)return;return"value"in n||"binding"in n?n:void 0}};Be.styles=[a`
            :host {
                display: block;
                user-select: none;
                outline-offset: -2px;
                box-sizing: border-box;
                pointer-events: auto;
                line-height: normal;
                padding: 4px;
                transition:
                    /* all 0.5s ease, */ /* FIXME: This may be very dangerous, we must add transition only for some properties */
                    color 0.35s ease,
                    border-color 0.35s ease,
                    box-shadow 0.35s ease,
                    background 0.35s ease,
                    background-color 0.35s ease,
                    background-image 0.35s ease,
                    background-size 0.35s ease,
                    background-position 0.35s ease,
                    width 0.35s ease,
                    height 0.35s ease,
                    opacity 0.15s ease,
                    outline 0.15s ease;
            }

            :host(.block-absolute) {
                position: absolute;
            }

            :host(.block-flow) {
                position: relative;
                width: auto;
            }

            :host(.block-outline-enabled) {
                outline: 1px dashed rgba(100, 100, 100, 0.75);
            }
            
            :host(.block-selected) {
                transition: none !important;
                outline: 2px solid var(--accent-color, #0078d4);
                z-index: 1000;
            }

            :host(.block-anchor-highlight) {
                outline: 2px solid #ffc107 !important;
                outline-offset: 1px;
                box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
                transition: none !important;
                z-index: 999;
            }
            
            :host(.builder:hover) {
                cursor: pointer;
            }

            :host(.snap-highlight) {
                outline: 1px solid #ff4081 !important;
                outline-offset: 1px !important;
                box-shadow: 0 0 0 4px rgba(255, 64, 129, 0.15) !important;
                transition: none !important;
                z-index: 999;
            }

            .style-target-active {
                outline: 1px dashed var(--accent-color, #0078d4);
                outline-offset: 2px;
                box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.12);
            }

            :host(.actions-pass-through) {
                pointer-events: none;
            }

            :host(.block-selection-disabled) {
                pointer-events: none;
            }

            :host(.action-feedback) {
                opacity: 0.7;
                transition: opacity 0.15s ease;
            }
        `];let De=Be;Le([n({context:Ae,subscribe:!0}),c()],De.prototype,"environment"),Le([n({context:C})],De.prototype,"renderer"),Le([n({context:Y})],De.prototype,"documentModel"),Le([n({context:ie})],De.prototype,"containerManager"),Le([n({context:J})],De.prototype,"eventBus"),Le([n({context:Ee,subscribe:!0}),i({attribute:!1})],De.prototype,"hass"),Le([i({type:Object})],De.prototype,"block"),Le([i({type:String})],De.prototype,"activeContainerId"),Le([c()],De.prototype,"entity"),Le([c()],De.prototype,"activeStyleTargetId"),Le([c()],De.prototype,"isDragging"),Le([c()],De.prototype,"isResizing"),Le([c()],De.prototype,"canvasWidth"),Le([c()],De.prototype,"canvasHeight");var $e=Object.getOwnPropertyDescriptor;const Re="mdi:star-outline";let Oe=class extends De{static getBlockConfig(){return{definition:{label:"Icon",icon:'<ha-icon icon="mdi:star-outline"></ha-icon>',category:"basic"},defaults:{props:{iconSize:{value:24},iconSource:{value:"list"},icon:{value:Re},iconTemplate:{value:""},preTemplate:{value:""},postTemplate:{value:""}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"icon",label:"Icon",traits:[{type:"number",name:"iconSize",label:"Icon Size",min:12,max:128},{type:"select",name:"iconSource",label:"Icon Source",options:[{value:"list",label:"From List"},{value:"template",label:"From Template"}]},{type:"icon-picker",name:"icon",label:"Icon",placeholder:"mdi:icon-name",visible:{prop:"iconSource",eq:"list"},binding:{type:"icon-picker",placeholder:"mdi:icon-name"}},{type:"text",name:"iconTemplate",label:"Icon Template",placeholder:"{{ 'mdi:lightbulb' if state == 'on' else 'mdi:lightbulb-off' }}",description:"If set, overrides the selected icon.",templateKeywords:L,visible:{prop:"iconSource",eq:"template"}}]},{id:"templates",label:"Templates",traits:[{type:"text",name:"preTemplate",label:"Pre Template",placeholder:"Text before icon",templateKeywords:L},{type:"text",name:"postTemplate",label:"Post Template",placeholder:"Text after icon",templateKeywords:L}]}]},targetStyles:{block:{styles:{preset:"full"}},icon:{label:"Icon",description:"Icon element",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},pre:{label:"Pre Template",description:"Text before the icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},post:{label:"Post Template",description:"Text after the icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}render(){const e=this.getTemplateVariables(),t=this.resolveProperty("iconSource","list"),i=this.resolveProperty("iconTemplate",""),n=this.resolveProperty("preTemplate",""),o=this.resolveProperty("postTemplate",""),s=this.resolvePropertyAsNumber("iconSize",24),r="template"===t,l=i.trim().length>0,a=n.trim().length>0,c=o.trim().length>0,p=r&&l?this.resolveTemplateString("iconTemplate",i,e):"",g=this.resolveIcon(p,r),v=a?this.resolveTemplateString("preTemplate",n,e):"",b=c?this.resolveTemplateString("postTemplate",o,e):"",m={"--mdc-icon-size":`${s}px`,...this.getTargetStyle("icon")},f=this.getTargetStyle("pre"),y=this.getTargetStyle("post"),k=this.isStyleTargetActive("icon"),_=this.isStyleTargetActive("pre"),x=this.isStyleTargetActive("post");return h`
            ${a?h`
                <span
                    class="icon-template ${_?"style-target-active":""}"
                    style=${u(f)}
                    data-style-target="pre"
                >${v}</span>
            `:d}
            <ha-icon
                class="icon ${k?"style-target-active":""}"
                style=${u(m)}
                data-style-target="icon"
                .icon=${g}
            ></ha-icon>
            ${c?h`
                <span
                    class="icon-template ${x?"style-target-active":""}"
                    style=${u(y)}
                    data-style-target="post"
                >${b}</span>
            `:d}
        `}getTemplateVariables(){const e=this.getEntityState()??void 0;return D(e,null==e?void 0:e.state)}resolveIcon(e,t){if(t)return e&&e!==M?e:Re;const i=this.resolveProperty("icon",Re);return i&&i!==M?i:Re}};Oe.styles=[...De.styles,a`
            :host {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .icon {
                width: var(--mdc-icon-size, 24px);
                height: var(--mdc-icon-size, 24px);
            }
            .icon-template {
                white-space: nowrap;
            }
        `],Oe=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?$e(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-icon")],Oe);const ze="cb-media://local/card_builder",Ne="/local/card_builder";function Fe(e){return e===ze||e.startsWith(`${ze}/`)}function Ve(e){return Fe(e)}function je(e){return/^https?:\/\//i.test(e)||e.startsWith("data:")||e.startsWith("blob:")}function He(e){return e.replace(/^\/+/,"").replace(/\/+$/g,"").replace(/\/+/g,"/")}function We(e){const t=e?He(e):"";return t?`${ze}/${t}`:ze}function Ue(e){return e===ze?"":e.startsWith(`${ze}/`)?e.slice(30):""}function Ge(e){if(!e)return"";if(Fe(e)){const t=Ue(e);if(!t)return"card_builder";const i=t.split("/");return i[i.length-1]||t}if(je(e))try{const t=new URL(e,window.location.origin),i=t.pathname.replace(/\/+$/g,"").split("/");return i[i.length-1]||e}catch(n){return e}const t=He(e),i=t.split("/");return i[i.length-1]||t}function qe(e){if(Fe(e)){const t=He(Ue(e)).replace(/(^|\/)\.\//g,"$1");return t?`${Ne}/${t}`:Ne}return null}async function Ze(e,t){return t?je(t)?t:Fe(t)?qe(t):t:null}var Ye=Object.getOwnPropertyDescriptor;let Xe=class extends De{static getBlockConfig(){return{definition:{label:"Image",icon:'<ha-icon icon="mdi:image-outline"></ha-icon>',category:"basic"},defaults:{props:{imageSource:{value:"none"},imageUrl:{value:""},mediaReference:{value:""},objectFit:{value:"initial"},objectPositionMode:{value:"center"},objectPositionCustom:{value:"center"}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"image",label:"Image",traits:[{type:"select",name:"imageSource",label:"Image Source",options:[{value:"none",label:"None"},{value:"url",label:"Image URL"},{value:"media",label:"Media Library"}]},{type:"text",name:"imageUrl",label:"Image URL",placeholder:"https://example.com/image.png",visible:{prop:"imageSource",eq:"url"},binding:{type:"text",placeholder:"https://example.com/image.png"}},{type:"media-picker",name:"mediaReference",label:"Media",emptyLabel:"No media selected",selectLabel:"Select media",editLabel:"Edit",removeLabel:"Remove",sourceProp:"imageSource",sourceValue:"media",visible:{prop:"imageSource",eq:"media"},binding:{type:"text",placeholder:"cb-media://local/card_builder/..."}},{type:"select",name:"objectFit",label:"Image Fit",options:[{value:"initial",label:"None (Default)"},{value:"contain",label:"Contain (Fit Inside)"},{value:"cover",label:"Cover (Fill & Crop)"},{value:"fill",label:"Stretch (Fill)"},{value:"scale-down",label:"Scale Down Only"},{value:"none",label:"Original Size"}],binding:{type:"select",options:[{value:"initial",label:"None (Default)"},{value:"contain",label:"Contain (Fit Inside)"},{value:"cover",label:"Cover (Fill & Crop)"},{value:"fill",label:"Stretch (Fill)"},{value:"scale-down",label:"Scale Down Only"},{value:"none",label:"Original Size"}]}},{name:"objectPositionMode",label:"Image Position",type:"select",options:[{value:"center",label:"Center"},{value:"top",label:"Top"},{value:"bottom",label:"Bottom"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"top left",label:"Top Left"},{value:"top right",label:"Top Right"},{value:"bottom left",label:"Bottom Left"},{value:"bottom right",label:"Bottom Right"},{value:"custom",label:"Custom"}],binding:{type:"select",options:[{value:"center",label:"Center"},{value:"top",label:"Top"},{value:"bottom",label:"Bottom"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"top left",label:"Top Left"},{value:"top right",label:"Top Right"},{value:"bottom left",label:"Bottom Left"},{value:"bottom right",label:"Bottom Right"}]}},{type:"text",name:"objectPositionCustom",label:"Custom Position",placeholder:"e.g. 20% 80%",visible:{prop:"objectPositionMode",eq:"custom"},binding:{type:"text",placeholder:"e.g. 20% 80%"}}]}]},targetStyles:{block:{styles:{preset:"full"}}}}}render(){const e=this.getImageSource();if(!e)return h`<div class="empty">No Image Selected</div>`;const t=this.resolveProperty("objectFit","initial"),i=this.getObjectPosition(),n={};return t&&(n.objectFit=t),i&&(n.objectPosition=i),h`<img src="${e}" alt="" style=${u(n)} />`}getImageSource(){const e=this.resolveProperty("imageSource","none");if("none"===e)return null;const t="media"===e?this.resolveProperty("mediaReference",""):this.resolveProperty("imageUrl","");return t?Ve(t)?qe(t)??null:(je(t)||t.startsWith("/"),t):null}getObjectPosition(){const e=this.resolveProperty("objectPositionMode","center");return"custom"===e?this.resolveProperty("objectPositionCustom","center"):e||"center"}};Xe.styles=[...De.styles,a`
            :host {
                display: block;
                padding: 0;
                overflow: hidden;
            }
            .empty {
                text-align: center;
                padding: 16px;
                color: #000;
            }
            img {
                display: block;
                max-width: 100%;
                max-height: 100%;
                width: 100%;
                height: 100%;
            }
        `],Xe=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?Ye(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-image")],Xe);var Ke=Object.getOwnPropertyDescriptor;let Je=class extends De{static getBlockConfig(){return{definition:{label:"Text",icon:'<ha-icon icon="mdi:format-text"></ha-icon>',category:"basic"},defaults:{},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"content",label:"Content",traits:[{type:"text",name:"text",label:"Text",placeholder:"Enter text...",binding:{type:"text",placeholder:"Enter text..."}}]}]},targetStyles:{block:{styles:{preset:"full"}}}}}render(){const e=this.resolveProperty("text","Text");return h`
            <div class="text-content">
                ${e}
            </div>
        `}};function Qe(e){return"minmax"===e.unit&&void 0!==e.minValue&&void 0!==e.maxValue?`minmax(${e.minValue}px, ${e.maxValue}px)`:"auto"===e.unit?"auto":"fr"===e.unit?`minmax(0, ${e.value}fr)`:`${e.value}${e.unit}`}function et(e){return e.map(Qe).join(" ")}function tt(e,t="full"){try{const i=new Date(e);if(isNaN(i.getTime()))return String(e);switch(t){case"full":return i.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});case"long":return i.toLocaleString(void 0,{year:"numeric",month:"long",day:"numeric"});case"medium":return i.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric"});case"short":return i.toLocaleDateString(void 0,{year:"2-digit",month:"numeric",day:"numeric"});case"time":return i.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit"});case"datetime":return i.toLocaleString(void 0,{year:"2-digit",month:"numeric",day:"numeric",hour:"numeric",minute:"2-digit"});case"relative":return function(e){const t=(new Date).getTime()-e.getTime(),i=Math.floor(t/1e3),n=Math.floor(i/60),o=Math.floor(n/60),s=Math.floor(o/24),r=Math.floor(s/7),l=Math.floor(s/30),a=Math.floor(s/365);return i<60?1===i?"1 second ago":`${i} seconds ago`:n<60?1===n?"1 minute ago":`${n} minutes ago`:o<24?1===o?"1 hour ago":`${o} hours ago`:s<7?1===s?"1 day ago":`${s} days ago`:r<4?1===r?"1 week ago":`${r} weeks ago`:l<12?1===l?"1 month ago":`${l} months ago`:1===a?"1 year ago":`${a} years ago`}(i);case"iso":return i.toISOString();default:return i.toLocaleString()}}catch(i){return String(e)}}function it(e,t,i=void 0){if(null==e)return i;const n=t.format;if("numeric"===n||"integer"===n){return function(e,t=1){const i=parseFloat(e);return isNaN(i)?String(e):void 0!==t&&t>=0?i.toFixed(t):String(i)}(e,"integer"===n?0:t.precision??1)}return"date"===n&&e?tt(e,t.dateFormat??"full"):"boolean"===n?function(e,t="Yes",i="No"){return!0===e||"on"===e||"true"===e||"1"===e?t:i}(e):String(e)}Je.styles=[...De.styles,a`
            :host {
                overflow: hidden;
            }
            .text-content {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        `],Je=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?Ke(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-text")],Je);const nt=[{type:"select",name:"format",label:"Format",options:[{value:"text",label:"Text"},{value:"numeric",label:"Numeric"},{value:"integer",label:"Integer"},{value:"date",label:"Date/Time"},{value:"boolean",label:"Boolean"},{value:"template",label:"Template"}]},{type:"number",name:"precision",label:"Precision",min:0,max:10,visible:{prop:"format",in:["numeric","integer"]}},{type:"select",name:"dateFormat",label:"Date Format",options:[{value:"full",label:"Full (Feb 12, 2026, 3:45 PM)"},{value:"long",label:"Long (February 12, 2026)"},{value:"medium",label:"Medium (Feb 12, 2026)"},{value:"short",label:"Short (2/12/26)"},{value:"time",label:"Time Only (3:45 PM)"},{value:"datetime",label:"Date & Time (2/12/26, 3:45 PM)"},{value:"relative",label:"Time Ago (5 minutes ago)"},{value:"iso",label:"ISO 8601 (2026-02-12T15:45:00)"}],visible:{prop:"format",eq:"date"}},{type:"textarea",name:"formatTemplate",label:"Format Template",placeholder:"e.g., {{ value | round(2) }} units",rows:3,templateKeywords:L,visible:{prop:"format",eq:"template"}}],ot=class extends De{getEntityAttribute(e){var t;const i=this.getEntityState();if(i)return"last_changed"===e?i.last_changed:"last_updated"===e?i.last_updated:null==(t=i.attributes)?void 0:t[e]}getEntityIcon(e){const t=this.getEntityState();return t?g(t):e}getEntityName(){return this.getEntityAttribute("friendly_name")||this.entity||"Unknown"}getEntityDomain(){return this.entity?this.entity.split(".")[0]:null}getAttributeConfig(){var e,t;const i=this.resolveRawValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributes,[]);return Array.isArray(i)?i:[]}isAttributeVisible(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.visible)??!1}getVisibleAttributes(){return this.getAttributeConfig().filter(e=>e.visible)}getAttributeLabel(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.label)?t.label:e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}formatValue(e){const t=this.resolveProperty("format","text");if("template"===t){const t=this.resolveProperty("formatTemplate","");if(!t)return"";const i=this.getTemplateVariables(e);return this.resolveTemplateString("formatTemplate",t,i)}return it(e,{format:t,precision:this.resolvePropertyAsNumber("precision",1),dateFormat:this.resolveProperty("dateFormat","full")},"")}getTemplateVariables(e,t){const i=D(this.getEntityState(),e);return t&&Object.keys(t).length>0&&Object.assign(i,t),i}};ot.styles=[...De.styles,a`
      .no-entity {
        color: var(--warning-color, #ff9800);
        font-size: 14px;
        padding: 8px;
        text-align: center;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
      }
    `];let st=ot;const rt=class extends st{get hasLockedEntity(){var e,t;return"inherited"===(null==(t=null==(e=this.block)?void 0:e.entityConfig)?void 0:t.mode)}getAttributeConfig(){var e,t;const i=this.resolveRawValue(null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.attributes,[]);return Array.isArray(i)?i:[]}isAttributeVisible(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.visible)??!1}getVisibleAttributes(){return this.getAttributeConfig().filter(e=>e.visible)}getAttributeLabel(e){const t=this.getAttributeConfig().find(t=>t.name===e);return(null==t?void 0:t.label)?t.label:e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}renderAttribute(e){const t=this.getEntityAttribute(e),i=this.getAttributeLabel(e),n=this.getAttributeConfig().find(t=>t.name===e),o=(null==n?void 0:n.showLabel)??!0;return h`
      <div class="attribute-row">
        ${o?h`<span class="attribute-label">${i}</span>`:""}
        <span class="attribute-value">${void 0!==t?t:""}</span>
      </div>
    `}renderAttributes(){const e=this.getVisibleAttributes();return 0===e.length?h``:h`
      <div class="attributes-container">
        ${e.map(e=>this.renderAttribute(e.name))}
      </div>
    `}};rt.styles=[...st.styles];let lt=rt;var at=Object.getOwnPropertyDescriptor;let ct=class extends lt{static getBlockConfig(){return{definition:{label:"Entity Attribute",icon:'<ha-icon icon="mdi:tag-text-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{attributeName:{value:""},showLabel:{value:!0},customLabel:{value:""},labelPosition:{value:"top"},format:{value:"text"},precision:{value:1},dateFormat:{value:"full"},formatTemplate:{value:""},prefix:{value:""},suffix:{value:""}}},entityDefaults:{mode:"inherited"},actionTargets:{label:{label:"Label",description:"Attribute label"},value:{label:"Value",description:"Attribute value"}}}}getPanelConfig(){return{properties:{groups:[{id:"attribute",label:"Attribute",traits:[{type:"attribute-picker",name:"attributeName",label:"Attribute Name",placeholder:"Enter attribute name"}]},{id:"label",label:"Label",traits:[{type:"checkbox",name:"showLabel",label:"Show Label"},{type:"text",name:"customLabel",label:"Custom Label",placeholder:"Auto-generated from attribute name",visible:{prop:"showLabel",eq:!0}},{type:"select",name:"labelPosition",label:"Label Position",options:[{value:"top",label:"Top"},{value:"left",label:"Left"},{value:"inline",label:"Inline"}],visible:{prop:"showLabel",eq:!0}}]},{id:"formatting",label:"Formatting",traits:[...nt,{type:"text",name:"prefix",label:"Prefix",templateKeywords:L,visible:{prop:"format",neq:"template"}},{type:"text",name:"suffix",label:"Suffix",templateKeywords:L,visible:{prop:"format",neq:"template"}}]}]},targetStyles:{block:{styles:{preset:"full"}},label:{label:"Label",description:"Label shown for the attribute name",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},value:{label:"Value",description:"Formatted attribute value",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}render(){if(!this.entity)return h`
                <div class="no-entity">No entity selected</div>
            `;if(!this.resolveProperty("attributeName"))return h`
                <div class="no-entity">No attribute selected</div>
            `;const e=this.getAttributeValue(),t=this.resolveProperty("format","text"),i=this.formatValue(e),n=this.getTemplateVariables(e,{attribute:e}),o="template"!==t?this.resolveProperty("prefix"):null,s=o?this.resolveTemplateString("prefix",o,n):"",r="template"!==t?this.resolveProperty("suffix"):null,l=r?this.resolveTemplateString("suffix",r,n):"",a=this.resolvePropertyAsBoolean("showLabel"),c=this.getLabelText(),p=this.resolveProperty("labelPosition","top"),g=this.getTargetStyle("label"),v=this.getTargetStyle("value"),b=this.isStyleTargetActive("label"),m=this.isStyleTargetActive("value");return h`

            <div class="attribute-container layout-${p}">
                ${a?h`
                    <div
                            class="attribute-label ${b?"style-target-active":d}"
                            style=${u(g)}
                            data-style-target="label"
                            data-action-target="label"
                    >${c}:
                    </div>
                `:d}
                <div
                        class="attribute-value ${m?"style-target-active":d}"
                        style=${u(v)}
                        data-style-target="value"
                        data-action-target="value"
                >
                    <div class="value-content">
                        ${o?h`<span class="value-prefix">${s}</span>`:d}
                        <span>${i}</span>
                        ${r?h`<span class="value-suffix">${l}</span>`:d}
                    </div>
                </div>
            </div>

        `}getAttributeValue(){const e=this.resolveProperty("attributeName");if(e)return this.getEntityAttribute(e)}getLabelText(){const e=this.resolveProperty("customLabel");if(e)return e;const t=this.resolveProperty("attributeName");return t?this.getAttributeLabel(t):"Attribute"}};ct.styles=[...lt.styles,a`
            .attribute-container {
                width: 100%;
                height: 100%;
                display: flex;
                box-sizing: border-box;
            }

            .attribute-container.layout-top {
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .attribute-container.layout-left {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .attribute-container.layout-inline {
                flex-direction: row;
                align-items: baseline;
                gap: 4px;
            }
      
            .attribute-label {
                font-size: 12px;
                white-space: nowrap;
            }

            .layout-top .attribute-label {
                margin-bottom: 4px;
            }

            .attribute-value {
                font-size: 14px;
                white-space: nowrap;
            }

            .value-content {
                display: flex;
                align-items: baseline;
                gap: 4px;
            }
        `],ct=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?at(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-entity-field-attribute")],ct);var dt=Object.getOwnPropertyDescriptor;let ut=class extends lt{static getBlockConfig(){return{definition:{label:"Entity Icon",icon:'<ha-icon icon="mdi:gamepad-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{iconSize:{value:24},color:{value:""},colorMode:{value:"fixed"},stateColors:{value:[]},availableColor:{value:""},unavailableColor:{value:"#9e9e9e"}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"icon",label:"Icon",traits:[{type:"number",name:"iconSize",label:"Icon Size",min:12,max:128}]},{id:"color",label:"Color",traits:[{type:"select",name:"colorMode",label:"Color Mode",options:[{value:"fixed",label:"Fixed"},{value:"state",label:"State-based"},{value:"availability",label:"Availability-based"}]},{type:"color",name:"color",label:"Color",visible:{prop:"colorMode",eq:"fixed"}},{type:"color",name:"availableColor",label:"Available Color",visible:{prop:"colorMode",eq:"availability"}},{type:"color",name:"unavailableColor",label:"Unavailable Color",visible:{prop:"colorMode",eq:"availability"}}]}]},targetStyles:{block:{styles:{preset:"full"}}}}}render(){if(!this.entity)return h`
                <div class="no-entity">No entity selected</div>`;const e=this.getEntityIcon("mdi:alert-circle-outline"),t=this.resolvePropertyAsNumber("iconSize",24),i=this.getIconColor();return e?h`
            <div
                    class="icon-container"
                    style="
                --mdc-icon-size: ${t}px;
                ${i?`--icon-primary-color: ${i};`:""}
            "
            >
                <ha-icon
                        class="entity-icon"
                        .icon="${e}"
                ></ha-icon>
            </div>
        `:h`
                <div class="icon-container">
                    <div class="fallback-icon">?</div>
                </div>
            `}getIconColor(){var e,t,i;const n=this.resolveProperty("colorMode","fixed");if("fixed"===n){return this.resolveProperty("color")||void 0}if("state"===n){const n=null==(e=this.getEntityState())?void 0:e.state,o=this.resolveRawValue(null==(i=null==(t=this.block)?void 0:t.props)?void 0:i.stateColors,[]),s=(Array.isArray(o)?o:[]).find(e=>e.state===n);return null==s?void 0:s.color}if("availability"===n){const e=this.isEntityAvailable(),t=this.resolveProperty("availableColor"),i=this.resolveProperty("unavailableColor","#9e9e9e");return e?t||void 0:i}}};ut.styles=[...lt.styles,a`
            .icon-container {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-sizing: border-box;
            }

            .entity-icon {
                width: var(--mdc-icon-size, 24px);
                height: var(--mdc-icon-size, 24px);
                color: var(--icon-primary-color, currentColor);
                transition: color 0.3s ease;
            }

            .entity-icon svg,
            .entity-icon ha-icon,
            .entity-icon mwc-icon {
                width: 100%;
                height: 100%;
                fill: currentColor;
            }

            .fallback-icon {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: var(--mdc-icon-size, 24px);
            }
        `],ut=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?dt(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-entity-field-icon")],ut);var ht=Object.getOwnPropertyDescriptor;let pt=class extends lt{static getBlockConfig(){return{definition:{label:"Entity Image",icon:'<ha-icon icon="mdi:image-outline"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{customImageUrl:{value:""},fallbackIcon:{value:"mdi:image-off-outline"}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"image",label:"Image",traits:[{type:"text",name:"customImageUrl",label:"Custom Image URL",placeholder:"Leave empty to use entity_picture"},{type:"icon-picker",name:"fallbackIcon",label:"Fallback Icon",placeholder:"mdi:image-off-outline",binding:{type:"icon-picker",placeholder:"mdi:image-off-outline"}}]}]},targetStyles:{block:{styles:{preset:"full"}}}}}render(){if(!this.entity)return h`
                <div class="no-entity">No entity selected</div>`;const e=this.getImageUrl();if(!e){const e=this.getFallbackIcon();return h`
                <div class="image-container">
                    <div class="fallback-icon-container">
                        <ha-icon class="fallback-icon" .icon="${e}"></ha-icon>
                    </div>
                </div>
            `}return h`
            <div class="image-container">
                <img
                    class="entity-picture"
                    src="${e}"
                    alt="${this.getEntityName()}"
                    @error="${this._handleImageError}"
                />
            </div>
        `}updated(e){super.updated(e);const t=this.getImageUrl();this.classList.toggle("has-image",!!t)}getImageUrl(){const e=this.resolveProperty("customImageUrl");if(e)return e;return this.getEntityAttribute("entity_picture")||null}getFallbackIcon(){return this.resolveProperty("fallbackIcon","mdi:image-off-outline")}_handleImageError(e){const t=e.target,i=this.getFallbackIcon(),n=t.parentElement;n&&(n.innerHTML=`\n        <div class="fallback-icon-container">\n          <ha-icon class="fallback-icon" icon="${i}"></ha-icon>\n        </div>\n      `)}};pt.styles=[...lt.styles,a`
            :host(.has-image) {
                padding: 0;
                overflow: hidden;
            }
            .image-container {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-sizing: border-box;
                overflow: hidden;
            }

            .entity-picture {
                width: 100%;
                height: 100%;
                transition: filter 0.3s ease;
            }

            .fallback-icon-container {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .fallback-icon {
                width: 50%;
                height: 50%;
                max-width: 48px;
                max-height: 48px;
            }

            .fallback-icon svg,
            .fallback-icon ha-icon {
                width: 100%;
                height: 100%;
                fill: currentColor;
            }
        `],pt=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?ht(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-entity-field-image")],pt);var gt=Object.getOwnPropertyDescriptor;let vt=class extends lt{static getBlockConfig(){return{definition:{label:"Entity Name",icon:'<ha-icon icon="mdi:alphabetical-variant"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{customName:{value:""},case:{value:"none"},maxLength:{value:0},ellipsis:{value:!0}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"name",label:"Name",traits:[{type:"text",name:"customName",label:"Custom Name",placeholder:"Custom name or template (e.g. {{name}})",description:"Leave empty to use entity friendly name. Use {{name}} to display entity name inside text.",templateKeywords:B}]},{id:"formatting",label:"Formatting",traits:[{type:"select",name:"case",label:"Case",options:[{value:"none",label:"None"},{value:"upper",label:"Upper"},{value:"lower",label:"Lower"},{value:"title",label:"Title"},{value:"kebab",label:"Kebab"},{value:"camel",label:"Camel"}]},{type:"number",name:"maxLength",label:"Max Length",min:1,max:250,step:1,description:"Leave empty to disable truncation"},{type:"checkbox",name:"ellipsis",label:"Use Ellipsis",description:"If enabled, truncation will be done using ellipsis instead of hiding text"}]}]},targetStyles:{block:{styles:{preset:"full"}}}}}render(){if(!this.entity)return h`
                <div class="no-entity">No entity selected</div>
            `;const e=this.getEntityName(),t=this.resolveProperty("customName"),i=t?this.resolveTemplateString("customName",t,this.getTemplateVariables(e,{name:e})):e,n=this.formatName(i),o=this.truncateName(n),s=this.resolvePropertyAsBoolean("ellipsis"),r=this.resolvePropertyAsNumber("maxLength",0);return h`
            <div class="name-container">
                <div class="name-text ${s&&0===r?"ellipsis":""}">
                    ${o}
                </div>
            </div>
        `}formatName(e){var t;switch(this.resolveProperty("case","none")){case"upper":return e.toUpperCase();case"lower":return e.toLowerCase();case"title":return e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ");case"kebab":return(e.match(/[A-Za-z0-9]+/g)||[]).map(e=>e.toLowerCase()).join("-");case"camel":{const i=e.match(/[A-Za-z0-9]+/g)||[];return 0===i.length?"":(null==(t=i[0])?void 0:t.toLowerCase())+i.slice(1).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("")}default:return e}}truncateName(e){const t=this.resolvePropertyAsNumber("maxLength",0);if(t>0&&e.length>t){return this.resolvePropertyAsBoolean("ellipsis")?e.substring(0,t)+"...":e.substring(0,t)}return e}};vt.styles=[...lt.styles,a`
            .name-container {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: var(--text-align, flex-start);
                box-sizing: border-box;
            }
      
            .name-text {
                overflow: hidden;
                white-space: nowrap;
            }

            .name-text.ellipsis {
                text-overflow: ellipsis;
            }

            .name-text.wrap {
                white-space: normal;
                word-break: break-word;
            }
        `],vt=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?gt(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-entity-field-name")],vt);var bt=Object.getOwnPropertyDescriptor;let mt=class extends lt{static getBlockConfig(){return{definition:{label:"Entity State",icon:'<ha-icon icon="mdi:state-machine"></ha-icon>',category:"entities"},defaults:{requireEntity:!0,props:{format:{value:"text"},precision:{value:1},dateFormat:{value:"full"},formatTemplate:{value:""},showUnit:{value:!0},customUnit:{value:""}}},entityDefaults:{mode:"inherited"},actionTargets:{state:{label:"State",description:"State value"},unit:{label:"Unit",description:"Unit of measurement"}}}}getPanelConfig(){return{properties:{groups:[{id:"formatting",label:"Formatting",traits:nt},{id:"unit",label:"Unit",traits:[{type:"checkbox",name:"showUnit",label:"Show Unit"},{type:"text",name:"customUnit",label:"Custom Unit",placeholder:"Leave empty for auto",visible:{prop:"showUnit",eq:!0}}]}]},targetStyles:{block:{styles:{preset:"full"}},state:{label:"State value",description:"Main state text",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},unit:{label:"Unit",description:"Unit of measurement displayed after the value",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}render(){if(!this.entity)return h`
                <div class="no-entity">No entity selected</div>
            `;if(!this.hass||!this.getEntityState())return h`
                <div class="state-container">
                    <div class="state-value"></div>
                </div>
            `;const e=this.getDisplayValue(),t=this.formatValue(e),i=this.getUnit(),n=this.resolveProperty("format","text"),o="numeric"===n||"integer"===n,s=this.getTargetStyle("state"),r=this.getTargetStyle("unit"),l=this.isStyleTargetActive("state"),a=this.isStyleTargetActive("unit");return h`
            <div class="state-container">
                <div
                    class="state-value ${l?"style-target-active":""}"
                    style=${u(s)}
                    data-style-target="state"
                    data-action-target="state"
                >
                    <span class="${o?"state-number":""}">${t}</span>
                </div>
                ${i?h`
                    <span
                        class="state-unit ${a?"style-target-active":""}"
                        style=${u(r)}
                        data-style-target="unit"
                        data-action-target="unit"
                    >${i}</span>
                `:""}
            </div>
        `}getDisplayValue(){var e;return(null==(e=this.getEntityState())?void 0:e.state)||""}getUnit(){if(!this.resolvePropertyAsBoolean("showUnit"))return"";const e=this.resolveProperty("customUnit");return e||(this.getEntityAttribute("unit_of_measurement")||"")}};mt.styles=[...lt.styles,a`
            .state-value {
                font-size: 16px;
                white-space: nowrap;
                display: inline-block;
            }
            .state-number {
                font-variant-numeric: tabular-nums;
            }
            .state-unit {
                font-size: 0.8em;
                margin-left: 2px;
            }
        `],mt=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?bt(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-entity-field-state")],mt);var ft=Object.defineProperty;const yt={climate:[{id:"climate_hvac_mode",label:"HVAC Mode",domain:"climate",listAttributes:["hvac_modes"],valueAttribute:"hvac_mode",service:"set_hvac_mode",serviceField:"hvac_mode",iconAttribute:"hvac_mode"},{id:"climate_fan_mode",label:"Fan Mode",domain:"climate",listAttributes:["fan_modes"],valueAttribute:"fan_mode",service:"set_fan_mode",serviceField:"fan_mode",iconAttribute:"fan_mode"},{id:"climate_swing_mode",label:"Swing Mode",domain:"climate",listAttributes:["swing_modes"],valueAttribute:"swing_mode",service:"set_swing_mode",serviceField:"swing_mode",iconAttribute:"swing_mode"},{id:"climate_preset_mode",label:"Preset Mode",domain:"climate",listAttributes:["preset_modes"],valueAttribute:"preset_mode",service:"set_preset_mode",serviceField:"preset_mode",iconAttribute:"preset_mode"}],automation:[{id:"automation_enabled",label:"Enabled",domain:"automation",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"}],water_heater:[{id:"water_heater_operation_mode",label:"Operation Mode",domain:"water_heater",listAttributes:["operation_list","available_modes"],valueAttribute:"operation_mode",service:"set_operation_mode",serviceField:"operation_mode",iconAttribute:"operation_mode"}],humidifier:[{id:"humidifier_mode",label:"Mode",domain:"humidifier",listAttributes:["available_modes"],valueAttribute:"mode",service:"set_mode",serviceField:"mode",iconAttribute:"mode"}],media_player:[{id:"media_player_source",label:"Source",domain:"media_player",listAttributes:["source_list"],valueAttribute:"source",service:"select_source",serviceField:"source",iconAttribute:"source"},{id:"media_player_sound_mode",label:"Sound Mode",domain:"media_player",listAttributes:["sound_mode_list"],valueAttribute:"sound_mode",service:"select_sound_mode",serviceField:"sound_mode",iconAttribute:"sound_mode"}],fan:[{id:"fan_power",label:"Power",domain:"fan",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"},{id:"fan_preset_mode",label:"Preset Mode",domain:"fan",listAttributes:["preset_modes"],valueAttribute:"preset_mode",service:"set_preset_mode",serviceField:"preset_mode",iconAttribute:"preset_mode"},{id:"fan_speed",label:"Speed",domain:"fan",listAttributes:["speed_list"],valueAttribute:"speed",service:"set_speed",serviceField:"speed",iconAttribute:"speed"}],vacuum:[{id:"vacuum_fan_speed",label:"Fan Speed",domain:"vacuum",listAttributes:["fan_speed_list"],valueAttribute:"fan_speed",service:"set_fan_speed",serviceField:"fan_speed",iconAttribute:"fan_speed"}],cover:[{id:"cover_state",label:"Open/Close",domain:"cover",staticOptions:["open","closed"],valueSource:"state",serviceMap:{open:{service:"open_cover"},closed:{service:"close_cover"}},iconType:"state"}],lock:[{id:"lock_state",label:"Lock",domain:"lock",staticOptions:["locked","unlocked"],valueSource:"state",serviceMap:{locked:{service:"lock"},unlocked:{service:"unlock"}},iconType:"state"}],light:[{id:"light_power",label:"Power",domain:"light",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"},{id:"light_effect",label:"Effect",domain:"light",listAttributes:["effect_list"],valueAttribute:"effect",service:"turn_on",serviceField:"effect",iconAttribute:"effect"}],switch:[{id:"switch_power",label:"Power",domain:"switch",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"}],input_boolean:[{id:"input_boolean_state",label:"State",domain:"input_boolean",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"}],siren:[{id:"siren_state",label:"State",domain:"siren",staticOptions:["on","off"],valueSource:"state",serviceMap:{on:{service:"turn_on"},off:{service:"turn_off"}},iconType:"state"}],select:[{id:"select_option",label:"Option",domain:"select",listAttributes:["options"],valueSource:"state",service:"select_option",serviceField:"option",iconAttribute:"option"}],input_select:[{id:"input_select_option",label:"Option",domain:"input_select",listAttributes:["options"],valueSource:"state",service:"select_option",serviceField:"option",iconAttribute:"option"}]},kt=e=>e.map(e=>null==e?"":String(e)).filter(e=>""!==e),_t=e=>e.filter((t,i)=>e.indexOf(t)===i),xt=(e,t,i)=>{var n,o;return Boolean(null==(o=null==(n=null==e?void 0:e.services)?void 0:n[t])?void 0:o[i])},St=(e,t,i)=>(null==i?void 0:i.services)?e.serviceMap?t.filter(t=>{var n;const o=null==(n=e.serviceMap)?void 0:n[t];return!!o&&xt(i,e.domain,o.service)}):e.service?xt(i,e.domain,e.service)?t:[]:t:t,wt=(e,t,i)=>{var n,o;if((null==(n=e.listAttributes)?void 0:n.length)&&t){const n=e.listAttributes.find(e=>Array.isArray(t[e]));if(!n)return null;const o=t[n];if(!Array.isArray(o))return null;const s=_t(kt(o)),r=St(e,s,i);return r.length>=2?{listAttribute:n,options:r}:null}if(null==(o=e.staticOptions)?void 0:o.length){const t=_t(kt(e.staticOptions)),n=St(e,t,i);return n.length>=2?{options:n}:null}return null},It=class extends st{constructor(){super(...arguments),this._localValue=null,this._pendingValueAt=0,this._pendingTimeoutId=null}disconnectedCallback(){this._clearPendingTimeout(),super.disconnectedCallback()}_resolveAvailableFeatures(e,t){const i=yt[t]??[],n=e.attributes;return i.map(t=>{const i=wt(t,n,this.hass);if(!i)return null;const o=this._getCurrentValue(e,t);return{...t,listAttribute:i.listAttribute,options:i.options,currentValue:o}}).filter(e=>Boolean(e))}_resolveSelectedFeature(e){const t=String(this.resolveProperty("feature","auto")??"auto");return"auto"===t?1===e.length?e[0]:null:e.find(e=>e.id===t)??null}_getCurrentValue(e,t){if("state"===(t.valueSource??(t.valueAttribute?"attribute":"state")))return void 0!==e.state&&null!==e.state?String(e.state):void 0;if(t.valueAttribute&&e.attributes){const i=e.attributes[t.valueAttribute];return null!=i?String(i):void 0}}_buildOptions(e,t){return e.options.map(i=>({value:i,label:this._formatOptionLabel(i,e,t)}))}_formatOptionLabel(e,t,i){var n;if((null==(n=this.hass)?void 0:n.formatEntityAttributeValue)&&t.valueAttribute)try{return this.hass.formatEntityAttributeValue(i,t.valueAttribute,e)}catch{}return t.staticOptions?this._formatStaticOptionLabel(e):e}_renderOptionIcon(e,t,i,n){const o=e.iconType??(e.staticOptions?"state":"attribute");if(!this.hass)return d;if("state"===o){const e=this.getEntityState();if(!e)return d;const o=g({...e,state:t});return o?h`
                <span
                    class="option-icon ${this.isStyleTargetActive(n)?"style-target-active":""}"
                    style=${u(i)}
                    data-style-target=${n}
                >
                    <ha-icon .icon=${o}></ha-icon>
                </span>
            `:d}const s=e.iconAttribute??e.valueAttribute??e.serviceField;return s?h`
            <span
                class="option-icon ${this.isStyleTargetActive(n)?"style-target-active":""}"
                style=${u(i)}
                data-style-target=${n}
            >
                <ha-attribute-icon
                    .hass=${this.hass}
                    .stateObj=${this.getEntityState()}
                    .attribute=${s}
                    .attributeValue=${t}
                ></ha-attribute-icon>
            </span>
        `:d}_renderOptionLabel(e,t,i){return h`
            <span
                class="option-label ${this.isStyleTargetActive(i)?"style-target-active":""}"
                style=${u(t)}
                data-style-target=${i}
            >${e}</span>
        `}_getEffectiveValue(e,t){const i=this._getCurrentValue(t,e);if(!this._localValue)return i;if(i===this._localValue)return this._clearPendingValue(),i;return Date.now()-this._pendingValueAt<1500?this._localValue:(this._clearPendingValue(),i)}async _dispatchBlockAction(e,t){var i;if(!this.entity)return;const n=this._resolveServiceCall(e,t);if(!n)return;const o={...n.data??{},entity_id:this.entity},s={action:"call-service",service:`${e.domain}.${n.service}`,data:o};try{await Te({hass:this.hass,element:this,action:s,trigger:"tap",entityId:this.entity,eventBus:this.eventBus,blockId:null==(i=this.block)?void 0:i.id,targetId:"block",slotId:void 0,throwOnError:!0})}catch(r){this._clearPendingValue(),this._emitServiceError(r,o)}}_resolveServiceCall(e,t){return e.serviceMap?e.serviceMap[t]??null:e.service?e.serviceField?{service:e.service,data:{[e.serviceField]:t}}:{service:e.service}:null}_formatStaticOptionLabel(e){return e.split("_").map(e=>e?e[0].toUpperCase()+e.slice(1):"").join(" ")}_setPendingValue(e){this._localValue=e,this._pendingValueAt=Date.now(),this._schedulePendingTimeout()}_clearPendingValue(){this._localValue=null,this._pendingValueAt=0,this._clearPendingTimeout()}_schedulePendingTimeout(){this._clearPendingTimeout(),this._pendingTimeoutId=window.setTimeout(()=>{this._pendingTimeoutId=null,this._clearPendingValue(),this.requestUpdate()},1500)}_clearPendingTimeout(){null!==this._pendingTimeoutId&&(window.clearTimeout(this._pendingTimeoutId),this._pendingTimeoutId=null)}};It.styles=[...st.styles,a`
            .option-icon ha-icon,
            .option-icon ha-attribute-icon,
            .option-icon ha-svg-icon {
                --mdc-icon-size: 16px;
            }
        `];let Pt=It;((e,t,i)=>{for(var n,o=void 0,s=e.length-1;s>=0;s--)(n=e[s])&&(o=n(t,i,o)||o);o&&ft(t,i,o)})([c()],Pt.prototype,"_localValue");const At=e=>{var t,i,n,o,s,r;const l=e,a=null==(o=null==(n=null==(t=l.documentModel)?void 0:t.resolveEntityForBlock)?void 0:n.call(t,(null==(i=l.block)?void 0:i.id)??""))?void 0:o.entityId,c=a&&(null==(r=null==(s=l.hass)?void 0:s.states)?void 0:r[a])?l.hass.states[a]:void 0;if(!c)return[{value:"auto",label:"Auto"}];const d=c.entity_id.split(".")[0],u=yt[d]??[],h=c.attributes;return[{value:"auto",label:"Auto"},...u.map(e=>wt(e,h,l.hass)?e:null).filter(e=>Boolean(e)).map(e=>({value:e.id,label:e.label}))]};var Tt=Object.getOwnPropertyDescriptor;let Ct=class extends Pt{static getBlockConfig(){return{definition:{label:"Button Toggle",icon:'<ha-icon icon="mdi:toggle-switch-off-outline"></ha-icon>',category:"controls"},defaults:{requireEntity:!0,props:{orientation:{value:"horizontal"},feature:{value:"auto"},showIcon:{value:!0},showLabel:{value:!0},contentLayout:{value:"horizontal"},contentOrder:{value:"icon-first"},verticalAlign:{value:"center"}}},entityDefaults:{mode:"inherited"},exposeBlockActionTarget:!1}}hasNativeActions(){return!0}getPanelConfig(){return{properties:{groups:[{id:"options",label:"Options",traits:[{type:"context-select",name:"feature",label:"Feature",emptyLabel:"No options available",optionsProvider:At}]},{id:"appearance",label:"Appearance",traits:[{type:"select",name:"orientation",label:"Orientation",options:[{value:"horizontal",label:"Horizontal"},{value:"vertical",label:"Vertical"}]},{type:"checkbox",name:"showIcon",label:"Show Icon"},{type:"checkbox",name:"showLabel",label:"Show Label"},{type:"select",name:"contentLayout",label:"Icon + Label Layout",options:[{value:"horizontal",label:"Horizontal"},{value:"vertical",label:"Vertical"}],visible:{and:[{prop:"showIcon",eq:!0},{prop:"showLabel",eq:!0}]}},{type:"select",name:"contentOrder",label:"Content Order",options:[{value:"icon-first",label:"Icon First"},{value:"label-first",label:"Label First"}],visible:{and:[{prop:"showIcon",eq:!0},{prop:"showLabel",eq:!0}]}},{type:"select",name:"verticalAlign",label:"Vertical Align",options:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"}],visible:{prop:"orientation",eq:"vertical"}}]}]},targetStyles:{block:{styles:{preset:"full"}},container:{label:"Container",description:"Options container",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},option:{label:"Option",description:"Option button",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"option-active":{label:"Option Active",description:"Active option button",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},icon:{label:"Icon",description:"Option icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"icon-active":{label:"Icon Active",description:"Active option icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},label:{label:"Label",description:"Option label",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"label-active":{label:"Label Active",description:"Active option label",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}updated(e){super.updated(e),e.has("block")&&(this.entity=this.resolvedEntityId())}render(){if(!this.entity)return h`<div class="no-options">No entity selected</div>`;const e=this.getEntityState();if(!e)return h`<div class="no-options">Entity unavailable</div>`;const t=this.getEntityDomain();if(!t)return h`<div class="no-options">Entity unavailable</div>`;const i=this._resolveAvailableFeatures(e,t),n=this._resolveSelectedFeature(i);if(!n||n.options.length<2)return h`<div class="no-options">No options available</div>`;const o=this._getOrientation(),s=this.resolvePropertyAsBoolean("showIcon"),r=this.resolvePropertyAsBoolean("showLabel"),l=this.resolveProperty("contentLayout","horizontal"),a=this.resolveProperty("contentOrder","icon-first"),c=this.resolveProperty("verticalAlign","center"),p=this._getEffectiveValue(n,e),g=this._buildOptions(n,e),b=this.getTargetStyle("container"),m=this.getTargetStyle("option"),f=this.getTargetStyle("option-active"),y=this.getTargetStyle("icon"),k=this.getTargetStyle("icon-active"),_=this.getTargetStyle("label"),x=this.getTargetStyle("label-active"),S=v({"mode-selector":!0,vertical:"vertical"===o,"align-left":"vertical"===o&&"left"===c,"align-center":"vertical"===o&&"center"===c,"align-right":"vertical"===o&&"right"===c,"style-target-active":this.isStyleTargetActive("container")});return h`
            <div class="toggle-root">
                <div
                    class=${S}
                    style=${u(b)}
                    data-style-target="container"
                >
                    ${g.map(t=>{const i=t.value===p,o=i?"option-active":"option",c=i?"icon-active":"icon",g=i?"label-active":"label",b=v({"mode-option":!0,active:i,"style-target-active":this.isStyleTargetActive(o)}),S=i?{...m,...f}:m,w=i?{...y,...k}:y,I=i?{..._,...x}:_,P=v({"option-content":!0,"layout-vertical":"vertical"===l,"layout-horizontal":"horizontal"===l,"order-label-first":"label-first"===a}),A=s?this._renderOptionIcon(n,t.value,w,c):d,T=r?this._renderOptionLabel(t.label,I,g):d;return h`
                            <button
                                class=${b}
                                style=${u(S)}
                                data-style-target=${o}
                                type="button"
                                aria-disabled=${this.areActionsEnabled()&&this.isEntityAvailable()?"false":"true"}
                                aria-pressed=${i?"true":"false"}
                                @click=${i=>this._handleOptionClick(i,t.value,n,e)}
                            >
                                <div class=${P}>
                                    ${A}
                                    ${T}
                                </div>
                            </button>
                        `})}
                </div>
            </div>
        `}async _handleOptionClick(e,t,i,n){if(!this.hass||!this.entity)return;if(!this.areActionsEnabled())return;if(!this.isEntityAvailable())return;e.preventDefault(),e.stopPropagation();this._getEffectiveValue(i,n)!==t&&(this._setPendingValue(t),this._dispatchBlockAction(i,t))}_emitServiceError(e,t){var i,n;const o={entityId:this.entity,error:e,payload:t,blockId:null==(i=this.block)?void 0:i.id};null==(n=this.eventBus)||n.dispatchEvent("button-toggle-service-error",o),this.dispatchEvent(new CustomEvent("button-toggle-service-error",{detail:o,bubbles:!0,composed:!0}))}_getOrientation(){return"vertical"===this.resolveProperty("orientation","horizontal")?"vertical":"horizontal"}};Ct.styles=[...Pt.styles,a`
            :host {
                display: block;
            }

            .toggle-root {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 100%;
            }

            .mode-selector {
                display: flex;
                background: var(--bg-tertiary, #f5f5f5);
                border-radius: 6px;
                padding: 2px;
                gap: 2px;
                box-sizing: border-box;
            }

            .mode-selector.vertical {
                flex-direction: column;
            }

            .mode-selector.vertical.align-left .mode-option {
                justify-content: flex-start;
                text-align: left;
            }

            .mode-selector.vertical.align-center .mode-option {
                justify-content: center;
                text-align: center;
            }

            .mode-selector.vertical.align-right .mode-option {
                justify-content: flex-end;
                text-align: right;
            }

            .mode-option {
                flex: 1 1 auto;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--text-secondary, #666);
                cursor: pointer;
                border-radius: 4px;
                transition: all 0.2s ease;
                user-select: none;
                border: none;
                background: transparent;
                padding: 6px 10px;
                min-height: 30px;
            }

            .mode-option:hover {
                color: var(--text-primary, #333);
            }

            .mode-option.active {
                background: var(--accent-color, #2196f3);
                color: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }

            .option-content {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .option-content.layout-vertical {
                flex-direction: column;
                gap: 2px;
            }

            .option-content.order-label-first .option-icon {
                order: 2;
            }

            .option-content.order-label-first .option-label {
                order: 1;
            }

            .option-icon {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .option-label {
                white-space: nowrap;
                font-variant-numeric: tabular-nums;
            }

            .no-options {
                font-size: 12px;
                color: var(--text-secondary, #666);
                padding: 6px 8px;
            }
        `],Ct=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?Tt(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-button-toggle")],Ct);var Et=Object.defineProperty,Mt=Object.getOwnPropertyDescriptor,Lt=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?Mt(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&Et(t,i,s),s};let Bt=class extends Pt{constructor(){super(...arguments),this._dropdownOpen=!1,this._toggleDropdown=e=>{this.areActionsEnabled()&&this.isEntityAvailable()&&(e.preventDefault(),e.stopPropagation(),this._dropdownOpen?this._closeDropdown():this._openDropdown())}}static getBlockConfig(){return{definition:{label:"Select Menu",icon:'<ha-icon icon="mdi:form-dropdown"></ha-icon>',category:"controls"},defaults:{requireEntity:!0,props:{feature:{value:"auto"},contentOrder:{value:"icon-first"},dropdownPlacement:{value:"down"},containerShowIcon:{value:!0},containerShowLabel:{value:!0},dropdownShowIcon:{value:!0},dropdownShowLabel:{value:!0}}},entityDefaults:{mode:"inherited"},exposeBlockActionTarget:!1}}hasNativeActions(){return!0}getPanelConfig(){return{properties:{groups:[{id:"options",label:"Options",traits:[{type:"context-select",name:"feature",label:"Feature",emptyLabel:"No options available",optionsProvider:At}]},{id:"appearance",label:"Appearance",traits:[{type:"checkbox",name:"containerShowIcon",label:"Show Container Icon"},{type:"checkbox",name:"containerShowLabel",label:"Show Container Label"},{type:"checkbox",name:"dropdownShowIcon",label:"Show Dropdown Icon"},{type:"checkbox",name:"dropdownShowLabel",label:"Show Dropdown Label"},{type:"select",name:"contentOrder",label:"Content Order",options:[{value:"icon-first",label:"Icon First"},{value:"label-first",label:"Label First"}]},{type:"select",name:"dropdownPlacement",label:"Dropdown Placement",options:[{value:"down",label:"Below"},{value:"up",label:"Above"}]}]}]},targetStyles:{block:{styles:{preset:"full"}},container:{label:"Container",description:"Select container",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},dropdown:{label:"Dropdown",description:"Dropdown panel",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"container-icon":{label:"Container Icon",description:"Selected icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"container-label":{label:"Container Label",description:"Selected label",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"dropdown-icon":{label:"Dropdown Icon",description:"Option icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"dropdown-label":{label:"Dropdown Label",description:"Option label",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"dropdown-selected-icon":{label:"Selected Icon",description:"Selected option icon",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"dropdown-selected-label":{label:"Selected Label",description:"Selected option label",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}updated(e){super.updated(e),e.has("block")&&(this.entity=this.resolvedEntityId())}connectedCallback(){super.connectedCallback(),this._handleOutsideClick=this._handleOutsideClick.bind(this)}disconnectedCallback(){this._removeOutsideListener(),super.disconnectedCallback()}render(){var e;if(!this.entity)return h`<div class="no-options">No entity selected</div>`;const t=this.getEntityState();if(!t)return h`<div class="no-options">Entity unavailable</div>`;const i=this.getEntityDomain();if(!i)return h`<div class="no-options">Entity unavailable</div>`;const n=this._resolveAvailableFeatures(t,i),o=this._resolveSelectedFeature(n);if(!o||o.options.length<2)return h`<div class="no-options">No options available</div>`;const s=this._buildOptions(o,t),r=this._getEffectiveValue(o,t)??o.currentValue??(null==(e=s[0])?void 0:e.value),l=s.find(e=>e.value===r),a=(null==l?void 0:l.label)??"Select",c=this.resolveProperty("contentOrder","icon-first"),p=this.resolveProperty("dropdownPlacement","down"),g=this.resolvePropertyAsBoolean("containerShowIcon"),b=this.resolvePropertyAsBoolean("containerShowLabel"),m=this.resolvePropertyAsBoolean("dropdownShowIcon"),f=this.resolvePropertyAsBoolean("dropdownShowLabel"),y=this.getTargetStyle("container"),k=this.getTargetStyle("dropdown"),_=this.getTargetStyle("container-icon"),x=this.getTargetStyle("container-label"),S=this.getTargetStyle("dropdown-icon"),w=this.getTargetStyle("dropdown-label"),I=this.getTargetStyle("dropdown-selected-icon"),P=this.getTargetStyle("dropdown-selected-label"),A=v({"select-content":!0,"order-label-first":"label-first"===c}),T=v({dropdown:!0,"placement-up":"up"===p,"style-target-active":this.isStyleTargetActive("dropdown")}),C=v({"select-button":!0,open:this._dropdownOpen,"style-target-active":this.isStyleTargetActive("container")});return h`
            <div class="select-root">
                <button
                    class=${C}
                    style=${u(y)}
                    data-style-target="container"
                    type="button"
                    aria-disabled=${this.areActionsEnabled()&&this.isEntityAvailable()?"false":"true"}
                    @click=${this._toggleDropdown}
                >
                    <div class=${A}>
                        ${g&&r?this._renderOptionIcon(o,r,_,"container-icon"):d}
                        ${b?this._renderOptionLabel(a,x,"container-label"):d}
                    </div>
                    <span class="select-arrow"></span>
                </button>

                ${this._dropdownOpen?h`
                    <div class=${T} style=${u(k)} data-style-target="dropdown" @click=${e=>e.stopPropagation()}>
                        <div class="dropdown-options">
                            ${s.map(e=>{const i=e.value===r,n=i?{...S,...I}:S,s=i?{...w,...P}:w,l=v({"dropdown-option":!0,selected:i,"order-label-first":"label-first"===c});return h`
                                    <div
                                        class=${l}
                                        @click=${i=>this._handleOptionSelect(i,e.value,o,t)}
                                    >
                                        ${m?this._renderOptionIcon(o,e.value,n,i?"dropdown-selected-icon":"dropdown-icon"):d}
                                        ${f?this._renderOptionLabel(e.label,s,i?"dropdown-selected-label":"dropdown-label"):d}
                                    </div>
                                `})}
                        </div>
                    </div>
                `:d}
            </div>
        `}_openDropdown(){this._dropdownOpen=!0,setTimeout(()=>{document.addEventListener("click",this._handleOutsideClick)},0)}_closeDropdown(){this._dropdownOpen=!1,this._removeOutsideListener()}_removeOutsideListener(){document.removeEventListener("click",this._handleOutsideClick)}_handleOutsideClick(e){this.contains(e.target)||this._closeDropdown()}async _handleOptionSelect(e,t,i,n){if(!this.hass||!this.entity)return;if(!this.areActionsEnabled())return;if(!this.isEntityAvailable())return;e.preventDefault(),e.stopPropagation();this._getEffectiveValue(i,n)!==t?(this._setPendingValue(t),this._closeDropdown(),await this._dispatchBlockAction(i,t)):this._closeDropdown()}_emitServiceError(e,t){var i,n;const o={entityId:this.entity,error:e,payload:t,blockId:null==(i=this.block)?void 0:i.id};null==(n=this.eventBus)||n.dispatchEvent("select-menu-service-error",o),this.dispatchEvent(new CustomEvent("select-menu-service-error",{detail:o,bubbles:!0,composed:!0}))}};Bt.styles=[...Pt.styles,a`
            :host {
                display: block;
            }

            .select-root {
                position: relative;
                width: 100%;
            }

            .select-button {
                display: flex;
                align-items: center;
                gap: 8px;
                width: 100%;
                padding: 8px 12px;
                border: 1px solid var(--border-color, #d4d4d4);
                border-radius: 6px;
                background: var(--bg-primary, #fff);
                color: var(--text-primary, #333);
                font-size: 12px;
                cursor: pointer;
                transition: all 0.15s ease;
                box-sizing: border-box;
            }

            .select-button:hover:not(:disabled) {
                border-color: var(--accent-color, #2196f3);
            }

            .select-button.open {
                border-color: var(--accent-color, #2196f3);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            }

            .select-content {
                display: flex;
                align-items: center;
                gap: 6px;
                flex: 1;
                min-width: 0;
            }

            .select-content.order-label-first .option-icon {
                order: 2;
            }

            .select-content.order-label-first .option-label {
                order: 1;
            }

            .select-arrow {
                color: var(--text-tertiary, #999);
                font-size: 10px;
                margin-left: auto;
            }

            .option-label {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                margin-top: 6px;
                background: var(--bg-primary, #fff);
                border: 1px solid var(--border-color, #d4d4d4);
                border-radius: 6px;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
                z-index: 1000;
                max-height: 280px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .dropdown.placement-up {
                top: auto;
                bottom: 100%;
                margin-top: 0;
                margin-bottom: 6px;
            }

            .dropdown-options {
                overflow-y: auto;
                padding: 4px 0;
            }

            .dropdown-option {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.1s ease;
            }

            .dropdown-option.order-label-first .option-icon {
                order: 2;
            }

            .dropdown-option.order-label-first .option-label {
                order: 1;
            }

            .dropdown-option:hover {
                background: var(--bg-secondary, #f5f5f5);
            }

            .dropdown-option.selected {
                background: rgba(33, 150, 243, 0.1);
            }

            .no-options {
                font-size: 12px;
                color: var(--text-secondary, #666);
                padding: 6px 8px;
            }
        `],Lt([c()],Bt.prototype,"_dropdownOpen",2),Bt=Lt([p("block-select-menu")],Bt);var Dt=Object.defineProperty,$t=Object.getOwnPropertyDescriptor,Rt=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?$t(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&Dt(t,i,s),s};const Ot={light:"#f4b400",media_player:"#1e88e5",cover:"#8d6e63",fan:"#00acc1",humidifier:"#4fc3f7",climate:"#e53935",water_heater:"#ff7043",input_number:"#43a047",number:"#43a047"};let zt=class extends st{constructor(){super(...arguments),this._localDisplayValue=null,this._localDisplayLow=null,this._localDisplayHigh=null,this._activeThumb=null,this._isInteracting=!1,this._syncPending=!1,this._lastCommitAt=0,this._throttleTimerId=null,this._debounceTimerId=null,this._pendingCommit=null,this._pendingSync=null,this._pendingSyncTimeoutId=null,this._lastCommittedValues=null,this._holdActivationTimerId=null,this._pendingHold=null,this._dragState=null,this._onTrackPointerMove=e=>{if(!this._dragState||e.pointerId!==this._dragState.pointerId)return;const{config:t,thumb:i,rect:n}=this._dragState,o=this._displayFromPointer(e.clientX,e.clientY,n,t);this._applyDisplayValue(o,t,i)},this._onTrackPointerUp=e=>{if(!this._dragState||e.pointerId!==this._dragState.pointerId)return;const{config:t,thumb:i}=this._dragState;e.preventDefault(),e.stopPropagation(),this._dragState=null,window.removeEventListener("pointermove",this._onTrackPointerMove),window.removeEventListener("pointerup",this._onTrackPointerUp),this._commitOnRelease(t,i),this._activeThumb=null,this._isInteracting=!1},this._onHoldPointerMove=e=>{if(!this._pendingHold||e.pointerId!==this._pendingHold.pointerId)return;this._pendingHold.lastX=e.clientX,this._pendingHold.lastY=e.clientY;const t=e.clientX-this._pendingHold.startX,i=e.clientY-this._pendingHold.startY;Math.hypot(t,i)>6&&this._cancelHoldActivation(!0,!1)},this._onHoldPointerUp=e=>{this._pendingHold&&e.pointerId===this._pendingHold.pointerId&&this._cancelHoldActivation(!0,!0)}}static getBlockConfig(){return{definition:{label:"Slider",icon:'<ha-icon icon="mdi:arrow-left-right-bold"></ha-icon>',category:"controls"},defaults:{requireEntity:!0,props:{mode:{value:"auto"},coverControl:{value:"auto"},valueSource:{value:"state"},valueAttribute:{value:""},displayMode:{value:"auto"},displayMin:{value:0},displayMax:{value:100},shape:{value:"rounded"},showThumb:{value:!0},showValue:{value:!0},orientation:{value:"horizontal"},valuePositionHorizontal:{value:"inline"},inlinePositionHorizontal:{value:"right"},insidePositionHorizontal:{value:"center"},valuePositionVertical:{value:"top"},insidePositionVertical:{value:"middle"},activationMode:{value:"press"},holdTapEnabled:{value:!1},holdTapAction:{value:"more-info"},commitMode:{value:"onRelease"},commitThrottleMs:{value:200},commitDebounceMs:{value:300},disableMode:{value:"auto"},disabled:{value:!1},invert:{value:!1},rangeMinGap:{value:0},useMinOverride:{value:!1},minOverride:{value:0},useMaxOverride:{value:!1},maxOverride:{value:100},useStepOverride:{value:!1},stepOverride:{value:1},usePrecisionOverride:{value:!1},precisionOverride:{value:0}}},entityDefaults:{mode:"inherited"},exposeBlockActionTarget:!1,actionTargets:{value:{label:"Value",description:"Value label"}}}}hasNativeActions(){return!0}static getStyleOutputConfig(e,t){return t&&"block"!==t?null:{mode:"properties",filter:{exclude:{properties:["size.height","border.borderRadius"]}},varPrefix:"block"}}getPanelConfig(){return{properties:{groups:[{id:"appearance",label:"Appearance",traits:[{type:"select",name:"orientation",label:"Orientation",options:[{value:"horizontal",label:"Horizontal"},{value:"vertical",label:"Vertical"}]},{type:"select",name:"shape",label:"Shape",options:[{value:"rounded",label:"Rounded"},{value:"square",label:"Square"}]},{type:"checkbox",name:"showThumb",label:"Show Thumb"},{type:"checkbox",name:"showValue",label:"Show Value"},{type:"select",name:"valuePositionHorizontal",label:"Value Position",options:[{value:"inline",label:"Inline"},{value:"tooltip",label:"Tooltip"},{value:"inside",label:"Inside"}],visible:{and:[{prop:"showValue",eq:!0},{prop:"orientation",eq:"horizontal"}]}},{type:"select",name:"inlinePositionHorizontal",label:"Inline Position",options:[{value:"left",label:"Left"},{value:"right",label:"Right"}],visible:{and:[{prop:"orientation",eq:"horizontal"},{prop:"valuePositionHorizontal",eq:"inline"}]}},{type:"select",name:"insidePositionHorizontal",label:"Inside Position",options:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"}],visible:{and:[{prop:"orientation",eq:"horizontal"},{prop:"valuePositionHorizontal",eq:"inside"}]}},{type:"select",name:"valuePositionVertical",label:"Value Position",options:[{value:"top",label:"Top"},{value:"bottom",label:"Bottom"},{value:"inside",label:"Inside"},{value:"tooltip",label:"Tooltip"}],visible:{and:[{prop:"showValue",eq:!0},{prop:"orientation",eq:"vertical"}]}},{type:"select",name:"insidePositionVertical",label:"Inside Position",options:[{value:"top",label:"Top"},{value:"middle",label:"Middle"},{value:"bottom",label:"Bottom"}],visible:{and:[{prop:"orientation",eq:"vertical"},{prop:"valuePositionVertical",eq:"inside"}]}},{type:"checkbox",name:"invert",label:"Invert"}]},{id:"behavior",label:"Behavior",traits:[{type:"select",name:"activationMode",label:"Activation",options:[{value:"press",label:"Press"},{value:"hold",label:"Hold"}]},{type:"checkbox",name:"holdTapEnabled",label:"Enable Tap Action",visible:{prop:"activationMode",eq:"hold"}},{type:"select",name:"holdTapAction",label:"Tap Action",options:[{value:"more-info",label:"More Info"},{value:"toggle",label:"Toggle"}],visible:{and:[{prop:"activationMode",eq:"hold"},{prop:"holdTapEnabled",eq:!0}]}},{type:"select",name:"mode",label:"Mode",options:[{value:"auto",label:"Auto"},{value:"single",label:"Single"},{value:"range",label:"Range"}]},{type:"select",name:"coverControl",label:"Cover Control",options:[{value:"auto",label:"Auto"},{value:"position",label:"Position"},{value:"tilt",label:"Tilt"}],visible:{prop:"mode",in:["auto","single","range"]}},{type:"select",name:"valueSource",label:"Value Source",options:[{value:"state",label:"State"},{value:"attribute",label:"Attribute"}]},{type:"attribute-picker",name:"valueAttribute",label:"Value Attribute",placeholder:"Select or type attribute",visible:{prop:"valueSource",eq:"attribute"}},{type:"select",name:"displayMode",label:"Display Mode",options:[{value:"auto",label:"Auto"},{value:"raw",label:"Raw"},{value:"percent",label:"Percent"},{value:"custom",label:"Custom"}]},{type:"number",name:"displayMin",label:"Display Min",step:.01,binding:{type:"number"},visible:{prop:"displayMode",eq:"custom"}},{type:"number",name:"displayMax",label:"Display Max",step:.01,binding:{type:"number"},visible:{prop:"displayMode",eq:"custom"}},{type:"select",name:"commitMode",label:"Commit Mode",options:[{value:"onRelease",label:"On Release"},{value:"throttled",label:"Throttled"},{value:"debounced",label:"Debounced"}]},{type:"number",name:"commitThrottleMs",label:"Throttle (ms)",min:50,max:2e3,visible:{prop:"commitMode",eq:"throttled"}},{type:"number",name:"commitDebounceMs",label:"Debounce (ms)",min:50,max:2e3,visible:{prop:"commitMode",eq:"debounced"}}]},{id:"overrides",label:"Overrides",traits:[{type:"checkbox",name:"useMinOverride",label:"Override Min"},{type:"number",name:"minOverride",label:"Min",step:.01,binding:{type:"number"},visible:{prop:"useMinOverride",eq:!0}},{type:"checkbox",name:"useMaxOverride",label:"Override Max"},{type:"number",name:"maxOverride",label:"Max",step:.01,binding:{type:"number"},visible:{prop:"useMaxOverride",eq:!0}},{type:"checkbox",name:"useStepOverride",label:"Override Step"},{type:"number",name:"stepOverride",label:"Step",step:.01,binding:{type:"number"},visible:{prop:"useStepOverride",eq:!0}},{type:"checkbox",name:"usePrecisionOverride",label:"Override Precision"},{type:"number",name:"precisionOverride",label:"Precision",min:0,max:6,visible:{prop:"usePrecisionOverride",eq:!0}}]},{id:"range",label:"Range",traits:[{type:"number",name:"rangeMinGap",label:"Min Gap",min:0,max:100,step:.01}]},{id:"disabled",label:"Disabled",traits:[{type:"select",name:"disableMode",label:"Disabled When",options:[{value:"auto",label:"Unavailable/Unknown"},{value:"custom",label:"Custom"},{value:"never",label:"Never"}]},{type:"checkbox",name:"disabled",label:"Disabled",binding:{type:"select",options:[{label:"False",value:"false"},{label:"True",value:"true"}]},visible:{prop:"disableMode",eq:"custom"}}]}]},targetStyles:{block:{styles:{preset:"full"}},track:{label:"Track",description:"Slider track container",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"track-inactive":{label:"Track Inactive",description:"Inactive track area",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"track-active":{label:"Track Active",description:"Active track area",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},thumb:{label:"Thumb",description:"Single slider thumb",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"thumb-low":{label:"Thumb Low",description:"Range low thumb",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},"thumb-high":{label:"Thumb High",description:"Range high thumb",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},value:{label:"Value",description:"Value label text",styles:{preset:"full",exclude:{groups:["layout","flex"]}}},tooltip:{label:"Tooltip",description:"Tooltip value bubble",styles:{preset:"full",exclude:{groups:["layout","flex"]}}}}}}updated(e){super.updated(e),e.has("block")&&(this.entity=this.resolvedEntityId());const t=this.resolveProperty("orientation","horizontal");this.classList.toggle("vertical","vertical"===t)}disconnectedCallback(){this._clearCommitTimers(),this._clearPendingSync(),this._dragState&&(window.removeEventListener("pointermove",this._onTrackPointerMove),window.removeEventListener("pointerup",this._onTrackPointerUp),this._dragState=null),super.disconnectedCallback()}render(){if(!this.entity)return h`<div class="no-entity">No entity selected</div>`;const e=this._resolveConfig();if(!e)return h`<div class="no-entity">Entity unavailable</div>`;const t=this.resolveProperty("orientation","horizontal"),i=this._buildRenderContext(e,t);return"vertical"===t?this._renderVertical(i):this._renderHorizontal(i)}_buildRenderContext(e,t){const i=this._isDisabled(),n=this._getDisplayValues(e),o=this._getDefaultActiveColor(e.domain),s=this.resolvePropertyAsBoolean("showValue"),r=this._safeRange(e.displayMin,e.displayMax),l=n.single??e.displayMin,a=n.low??e.displayMin,c=n.high??e.displayMax,d=t=>(t-e.displayMin)/r*100,u=d(l),h=d(a),p=d(c),g=this._clamp(u,0,100),b=this._clamp(h,0,100),m=this._clamp(p,0,100),f=this.resolvePropertyAsBoolean("invert"),y=f?100-g:g,k=f?100-b:b,_=f?100-m:m,x="range"===e.mode?Math.min(k,_):f?y:0,S="range"===e.mode?Math.max(k,_):f?100:y,w=this.getTargetStyle("track"),I=this.getTargetStyle("track-inactive"),P=this._withDefaultActiveColor(this.getTargetStyle("track-active"),o),A=this.getTargetStyle("thumb"),T=this.getTargetStyle("thumb-low"),C=this.getTargetStyle("thumb-high"),E=this.getTargetStyle("value"),M=this.getTargetStyle("tooltip"),L=this.resolvePropertyAsBoolean("showThumb"),B=this.resolveProperty("shape","rounded"),D=v({"slider-root":!0,vertical:"vertical"===t,disabled:i,"sync-pending":this._syncPending,dragging:this._isInteracting,[`shape-${B}`]:!0}),$=this._formatRangeValue(n,e);return{config:e,displayValues:n,isDisabled:i,activeColor:o,showValue:s,singleValue:l,lowValue:a,highValue:c,positionSinglePercent:y,positionLowPercent:k,positionHighPercent:_,startPercent:x,endPercent:S,trackStyle:w,trackInactiveStyle:I,trackActiveStyle:P,thumbStyle:A,thumbLowStyle:T,thumbHighStyle:C,valueStyle:E,tooltipStyle:M,showThumb:L,shape:B,valueText:$,rootClasses:D}}_renderHorizontal(e){const t=this.resolveProperty("valuePositionHorizontal","inline"),i=this.resolveProperty("inlinePositionHorizontal","left"),n=this.resolveProperty("insidePositionHorizontal","left"),o=e.showValue,s=o&&"tooltip"===t&&this._isInteracting,r=o&&"inline"===t?h`
            <div
                class="value-inline align-${i} ${this.isStyleTargetActive("value")?"style-target-active":""}"
                style=${u(e.valueStyle)}
                data-style-target="value"
                data-action-target="value"
            >${e.valueText}</div>
        `:d,l=o&&"inside"===t?h`
            <div
                class=${v({"value-label":!0,"value-inside":!0,"position-center":"center"===n,"position-left":"left"===n,"position-right":"right"===n,"style-target-active":this.isStyleTargetActive("value")})}
                style=${u(e.valueStyle)}
                data-style-target="value"
                data-action-target="value"
            >${e.valueText}</div>
        `:d,a=v({"slider-row":!0}),c=o&&"inline"===t,p=c&&"left"===i,g=c&&"left"!==i;return h`
            <div
                class=${e.rootClasses}
                style=${u({"--slider-active-color":e.activeColor})}
            >
                <div class=${a}>
                    ${p?r:d}
                    <div
                        class="track ${this.isStyleTargetActive("track")?"style-target-active":""}"
                        style=${u(e.trackStyle)}
                        data-style-target="track"
                    >
                        <div
                            class="track-inactive ${this.isStyleTargetActive("track-inactive")?"style-target-active":""}"
                            style=${u(e.trackInactiveStyle)}
                            data-style-target="track-inactive"
                        ></div>
                        <div
                            class="track-active ${this.isStyleTargetActive("track-active")?"style-target-active":""}"
                            style=${u({...e.trackActiveStyle,left:`${e.startPercent}%`,width:e.endPercent-e.startPercent+"%"})}
                            data-style-target="track-active"
                        ></div>
                        ${l}

                        ${"range"===e.config.mode?h`
                            ${e.showThumb?h`
                                <div
                                    class="thumb ${"low"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb-low")?"style-target-active":""}"
                                    style=${u({...e.thumbLowStyle,left:`${e.positionLowPercent}%`})}
                                    data-style-target="thumb-low"
                                ></div>
                                <div
                                    class="thumb ${"high"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb-high")?"style-target-active":""}"
                                    style=${u({...e.thumbHighStyle,left:`${e.positionHighPercent}%`})}
                                    data-style-target="thumb-high"
                                ></div>
                            `:d}

                            ${s?h`
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,left:`${e.positionLowPercent}%`})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.lowValue,e.config)}</div>
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,left:`${e.positionHighPercent}%`})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.highValue,e.config)}</div>
                            `:d}
                        `:h`
                            ${e.showThumb?h`
                                <div
                                    class="thumb ${"single"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb")?"style-target-active":""}"
                                    style=${u({...e.thumbStyle,left:`${e.positionSinglePercent}%`})}
                                    data-style-target="thumb"
                                ></div>
                            `:d}

                            ${s?h`
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,left:`${e.positionSinglePercent}%`})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.singleValue,e.config)}</div>
                            `:d}
                        `}
                    </div>

                    ${g?r:d}
                </div>
            </div>
        `}_renderVertical(e){const t=this.resolveProperty("valuePositionVertical","top"),i=this.resolveProperty("insidePositionVertical","middle"),n=e.showValue,o=n&&"tooltip"===t&&this._isInteracting,s=!n||"top"!==t&&"bottom"!==t?d:h`
            <div
                class="value-label value-vertical ${this.isStyleTargetActive("value")?"style-target-active":""}"
                style=${u(e.valueStyle)}
                data-style-target="value"
                data-action-target="value"
            >${e.valueText}</div>
        `,r=n&&"inside"===t?h`
            <div
                class=${v({"value-label":!0,"value-inside":!0,vertical:!0,"position-top":"top"===i,"position-middle":"middle"===i,"position-bottom":"bottom"===i,"style-target-active":this.isStyleTargetActive("value")})}
                style=${u(e.valueStyle)}
                data-style-target="value"
                data-action-target="value"
            >${e.valueText}</div>
        `:d,l=n&&"top"===t,a=n&&"bottom"===t;return h`
            <div
                class=${e.rootClasses}
                style=${u({"--slider-active-color":e.activeColor})}
            >
                <div class="slider-row">
                    ${l?s:d}
                    <div
                        class="track ${this.isStyleTargetActive("track")?"style-target-active":""}"
                        style=${u(e.trackStyle)}
                        data-style-target="track"
                    >
                        <div
                            class="track-inactive ${this.isStyleTargetActive("track-inactive")?"style-target-active":""}"
                            style=${u(e.trackInactiveStyle)}
                            data-style-target="track-inactive"
                        ></div>
                        <div
                            class="track-active ${this.isStyleTargetActive("track-active")?"style-target-active":""}"
                            style=${u({...e.trackActiveStyle,bottom:`${e.startPercent}%`,height:e.endPercent-e.startPercent+"%"})}
                            data-style-target="track-active"
                        ></div>
                        ${r}

                        ${"range"===e.config.mode?h`
                            ${e.showThumb?h`
                                <div
                                    class="thumb ${"low"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb-low")?"style-target-active":""}"
                                    style=${u({...e.thumbLowStyle,bottom:`${e.positionLowPercent}%`})}
                                    data-style-target="thumb-low"
                                ></div>
                                <div
                                    class="thumb ${"high"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb-high")?"style-target-active":""}"
                                    style=${u({...e.thumbHighStyle,bottom:`${e.positionHighPercent}%`})}
                                    data-style-target="thumb-high"
                                ></div>
                            `:d}

                            ${o?h`
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,top:100-e.positionLowPercent+"%"})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.lowValue,e.config)}</div>
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,top:100-e.positionHighPercent+"%"})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.highValue,e.config)}</div>
                            `:d}
                        `:h`
                            ${e.showThumb?h`
                                <div
                                    class="thumb ${"single"===this._activeThumb?"active":""} ${this.isStyleTargetActive("thumb")?"style-target-active":""}"
                                    style=${u({...e.thumbStyle,bottom:`${e.positionSinglePercent}%`})}
                                    data-style-target="thumb"
                                ></div>
                            `:d}

                            ${o?h`
                                <div
                                    class="tooltip ${this.isStyleTargetActive("tooltip")?"style-target-active":""}"
                                    style=${u({...e.tooltipStyle,top:100-e.positionSinglePercent+"%"})}
                                    data-style-target="tooltip"
                                >${this._formatSingleValue(e.singleValue,e.config)}</div>
                            `:d}
                        `}
                    </div>

                    ${a?s:d}
                </div>
            </div>
        `}getNativeActionTargetIds(){return[]}handleNativePointerDown(e,t){var i;const n=this._resolveConfig();if(!n||this._isDisabled())return!1;if(!this.areActionsEnabled())return!1;if("mouse"===e.pointerType&&0!==e.button)return!1;const o=null==(i=this.renderRoot)?void 0:i.querySelector(".track");if(!o)return!1;if(!e.composedPath().includes(o))return!1;e.preventDefault(),e.stopPropagation();const s=o.getBoundingClientRect(),r=this._displayFromPointer(e.clientX,e.clientY,s,n),l="range"===n.mode?this._pickRangeThumb(r,n):"single";if("hold"===this.resolveProperty("activationMode","press")){const t=this.resolvePropertyAsBoolean("holdTapEnabled");return this._scheduleHoldActivation(e,s,n,l,o,t),!0}return this._beginDrag(e.pointerId,e.clientX,e.clientY,s,n,l,o),!0}_scheduleHoldActivation(e,t,i,n,o,s){var r;this._cancelHoldActivation(!1,!1),this._pendingHold={pointerId:e.pointerId,config:i,thumb:n,rect:t,target:o,startX:e.clientX,startY:e.clientY,lastX:e.clientX,lastY:e.clientY,hasDragStarted:!1,shouldTriggerTapAction:s},null==(r=o.setPointerCapture)||r.call(o,e.pointerId),window.addEventListener("pointermove",this._onHoldPointerMove),window.addEventListener("pointerup",this._onHoldPointerUp),window.addEventListener("pointercancel",this._onHoldPointerUp),this._holdActivationTimerId=window.setTimeout(()=>{const e=this._pendingHold;e&&(this._pendingHold=null,this._holdActivationTimerId=null,this._removeHoldListeners(),e.hasDragStarted=!0,this._beginDrag(e.pointerId,e.lastX,e.lastY,e.rect,e.config,e.thumb,e.target))},350)}_cancelHoldActivation(e,t){var i;const n=this._pendingHold;if(null!==this._holdActivationTimerId&&(window.clearTimeout(this._holdActivationTimerId),this._holdActivationTimerId=null),t&&n&&!n.hasDragStarted&&this._maybeTriggerHoldTapAction(n),e&&(null==(i=null==n?void 0:n.target)?void 0:i.releasePointerCapture))try{n.target.releasePointerCapture(n.pointerId)}catch{}this._pendingHold=null,this._removeHoldListeners()}_removeHoldListeners(){window.removeEventListener("pointermove",this._onHoldPointerMove),window.removeEventListener("pointerup",this._onHoldPointerUp),window.removeEventListener("pointercancel",this._onHoldPointerUp)}_maybeTriggerHoldTapAction(e){if(!e.shouldTriggerTapAction)return;if(!this.hass||!this.block||!this.eventBus)return;const t=this.resolvedEntityId();if(!t)return;const i="toggle"===this.resolveProperty("holdTapAction","more-info")?{action:"toggle"}:{action:"more-info"};Te({hass:this.hass,element:this,action:i,trigger:"tap",entityId:t,eventBus:this.eventBus,blockId:this.block.id,targetId:"block",slotId:void 0})}_beginDrag(e,t,i,n,o,s,r){var l;const a=this._displayFromPointer(t,i,n,o);this._activeThumb=s,this._isInteracting=!0,this._applyDisplayValue(a,o,s),this._dragState={pointerId:e,config:o,thumb:s,rect:n},null==(l=r.setPointerCapture)||l.call(r,e),window.addEventListener("pointermove",this._onTrackPointerMove),window.addEventListener("pointerup",this._onTrackPointerUp)}_applyDisplayValue(e,t,i){if("single"===t.mode){const i=this._normalizeDisplayValues({single:e},t);return this._localDisplayValue=i.single??e,void this._scheduleCommit(i,t,"single")}const n=this._getDisplayValues(t),o={low:n.low??t.displayMin,high:n.high??t.displayMax};"low"===i?o.low=e:o.high=e;const s=this._normalizeDisplayValues(o,t,i);this._localDisplayLow=s.low??o.low??t.displayMin,this._localDisplayHigh=s.high??o.high??t.displayMax,this._scheduleCommit(s,t,i)}_commitOnRelease(e,t){if("onRelease"===this._getCommitMode())if("single"===e.mode){if(null===this._localDisplayValue)return;this._commitDisplayValues({single:this._localDisplayValue},e,t)}else{if(null===this._localDisplayLow||null===this._localDisplayHigh)return;this._commitDisplayValues({low:this._localDisplayLow,high:this._localDisplayHigh},e,t)}}_displayFromPointer(e,t,i,n){let o=0;if("vertical"===this.resolveProperty("orientation","horizontal")){const e=this._clamp(i.bottom-t,0,i.height);o=i.height>0?e/i.height:0}else{const t=this._clamp(e-i.left,0,i.width);o=i.width>0?t/i.width:0}const s=100*o,r=this._applyInvert(s),l=n.displayMax-n.displayMin;return n.displayMin+r/100*l}_applyInvert(e){return this.resolvePropertyAsBoolean("invert")?100-e:e}_pickRangeThumb(e,t){const i=this._getDisplayValues(t),n=i.low??t.displayMin,o=i.high??t.displayMax;return Math.abs(e-n)<=Math.abs(e-o)?"low":"high"}_getCommitMode(){return this.resolveProperty("commitMode","onRelease")}_scheduleCommit(e,t,i){if(!t.supportsService)return;const n=this._getCommitMode();if("onRelease"!==n){if("throttled"===n){const n=Math.max(50,this.resolvePropertyAsNumber("commitThrottleMs",200)),o=Date.now();if(!this._lastCommitAt||o-this._lastCommitAt>=n)return this._lastCommitAt=o,void this._commitDisplayValues(e,t,i);if(this._pendingCommit=e,null===this._throttleTimerId){const e=Math.max(0,n-(o-this._lastCommitAt));this._throttleTimerId=window.setTimeout(()=>{this._throttleTimerId=null,this._pendingCommit&&(this._lastCommitAt=Date.now(),this._commitDisplayValues(this._pendingCommit,t,i),this._pendingCommit=null)},e)}return}if("debounced"===n){const n=Math.max(50,this.resolvePropertyAsNumber("commitDebounceMs",300));this._pendingCommit=e,null!==this._debounceTimerId&&window.clearTimeout(this._debounceTimerId),this._debounceTimerId=window.setTimeout(()=>{this._debounceTimerId=null,this._pendingCommit&&(this._commitDisplayValues(this._pendingCommit,t,i),this._pendingCommit=null)},n)}}}async _commitDisplayValues(e,t,i){var n;if(!(this.hass&&this.entity&&t.supportsService&&t.service))return;if(this._isDisabled())return;if(!this.areActionsEnabled())return;const o=this._normalizeDisplayValues(e,t,"high"===i?"high":"low"===i?"low":void 0),s=this._toActualValues(o,t,i),r="brightness_pct"===t.service.field?o:s,l=this._buildServicePayload(r,t);if(!l)return;this._lastCommittedValues={...t.values},this._setPendingSync(s);const a={action:"call-service",service:`${l.domain}.${l.service}`,data:l.data};try{await Te({hass:this.hass,element:this,action:a,trigger:"tap",entityId:this.entity,eventBus:this.eventBus,blockId:null==(n=this.block)?void 0:n.id,targetId:"block",slotId:void 0,throwOnError:!0})}catch(c){this._clearPendingSync(),this._revertToLastCommitted(t),this._emitServiceError(c,l)}}_clearCommitTimers(){null!==this._throttleTimerId&&(window.clearTimeout(this._throttleTimerId),this._throttleTimerId=null),null!==this._debounceTimerId&&(window.clearTimeout(this._debounceTimerId),this._debounceTimerId=null),this._pendingCommit=null}_resolveConfig(){const e=this.getEntityState(),t=this.getEntityDomain();if(!e||!t)return null;const i=e.attributes||{},n=this.resolveProperty("mode","auto"),o=this.resolveProperty("coverControl","auto"),s=this.resolveProperty("displayMode","auto"),r=this.resolveProperty("valueSource","state"),l=this.resolveProperty("valueAttribute","");let a,c="single",d={},u=0,h=100,p=1,g="",v="raw";switch(t){case"light":{const e=this._getNumberAttribute(i,"brightness");u=0,h=255,p=1,d.single=e??u,v="percent",a={domain:"light",service:"turn_on",field:"brightness"};break}case"media_player":{const e=this._getNumberAttribute(i,"volume_level");u=0,h=1,p=.01,d.single=e??u,v="percent",a={domain:"media_player",service:"volume_set",field:"volume_level"};break}case"cover":{const e=null!==this._getNumberAttribute(i,"current_tilt_position")||null!==this._getNumberAttribute(i,"tilt_position"),t="tilt"===o||"auto"===o&&e,n=t?this._firstNumber(i,["current_tilt_position","tilt_position"]):this._firstNumber(i,["current_position","position"]);u=0,h=100,p=1,d.single=n??u,a=t?{domain:"cover",service:"set_cover_tilt_position",field:"tilt_position"}:{domain:"cover",service:"set_cover_position",field:"position"},g="%";break}case"fan":{const e=this._firstNumber(i,["percentage","speed","speed_percent","speed_percentage"]);u=0,h=100,p=this._getNumberAttribute(i,"percentage_step")??1,d.single=e??u,a={domain:"fan",service:"set_percentage",field:"percentage"},g="%";break}case"humidifier":{const e=this._firstNumber(i,["humidity","target_humidity"]);u=this._getNumberAttribute(i,"min_humidity")??0,h=this._getNumberAttribute(i,"max_humidity")??100,p=this._getNumberAttribute(i,"humidity_step")??1,d.single=e??u,a={domain:"humidifier",service:"set_humidity",field:"humidity"},g="%";break}case"climate":{const e=this._getNumberAttribute(i,"target_temp_low"),t=this._getNumberAttribute(i,"target_temp_high");c=null!==e&&null!==t?"range":"single",u=this._getNumberAttribute(i,"min_temp")??7,h=this._getNumberAttribute(i,"max_temp")??35;const n=this._getTemperatureUnit(i);if(p=this._getNumberAttribute(i,"target_temp_step")??this._getDefaultTempStep(n),g=n,"range"===c)d.low=e??u,d.high=t??h,a={domain:"climate",service:"set_temperature",field:"temperature",fieldLow:"target_temp_low",fieldHigh:"target_temp_high"};else{const e=this._firstNumber(i,["temperature","target_temperature"]);d.single=e??u,a={domain:"climate",service:"set_temperature",field:"temperature"}}break}case"water_heater":{const e=this._firstNumber(i,["temperature","target_temperature"]);u=this._getNumberAttribute(i,"min_temp")??30,h=this._getNumberAttribute(i,"max_temp")??75;const t=this._getTemperatureUnit(i);p=this._getNumberAttribute(i,"target_temp_step")??this._getNumberAttribute(i,"temperature_step")??this._getDefaultTempStep(t),g=t,d.single=e??u,a={domain:"water_heater",service:"set_temperature",field:"temperature"};break}case"input_number":{const t=this._parseNumber(e.state)??0;u=this._getNumberAttribute(i,"min")??0,h=this._getNumberAttribute(i,"max")??100,p=this._getNumberAttribute(i,"step")??1,g=String(i.unit_of_measurement??""),d.single=t,a={domain:"input_number",service:"set_value",field:"value"};break}case"number":{const t=this._parseNumber(e.state)??0;u=this._getNumberAttribute(i,"min")??0,h=this._getNumberAttribute(i,"max")??100,p=this._getNumberAttribute(i,"step")??1,g=String(i.unit_of_measurement??""),d.single=t,a={domain:"number",service:"set_value",field:"value"};break}default:{const n=this._parseNumber(e.state);u=this._getNumberAttribute(i,"min")??0,h=this._getNumberAttribute(i,"max")??100,p=this._getNumberAttribute(i,"step")??1,d.single=n??u,g=String(i.unit_of_measurement??"");const o=this._resolveGenericService(t);o&&(a=o);break}}if("auto"!==n&&("climate"===t?c=n:"single"===n&&(c="single")),"range"!==c||void 0!==d.low&&void 0!==d.high||(d.low=d.low??u,d.high=d.high??h),"single"===c)if("attribute"===r&&l){const e=this._getNumberAttribute(i,l);null!==e&&(d.single=e)}else if("state"===r){const t=this._parseNumber(e.state);null!==t&&(d.single=t)}if("range"===c&&"attribute"===r&&l){const e=this._getNumberAttribute(i,l);null!==e&&(d.low=e,d.high=e)}if(this.resolvePropertyAsBoolean("useMinOverride")&&(u=this.resolvePropertyAsNumber("minOverride",u)),this.resolvePropertyAsBoolean("useMaxOverride")&&(h=this.resolvePropertyAsNumber("maxOverride",h)),this.resolvePropertyAsBoolean("useStepOverride")&&(p=this.resolvePropertyAsNumber("stepOverride",p)),u>h){const e=u;u=h,h=e}p<=0&&(p=1),"auto"!==s&&(v=s),"light"===t&&(a="percent"===v?{domain:"light",service:"turn_on",field:"brightness_pct"}:{domain:"light",service:"turn_on",field:"brightness"});let b=u,m=h,f=p;if("percent"===v)b=0,m=100,f=1,g="%";else if("custom"===v){if(b=this.resolvePropertyAsNumber("displayMin",u),m=this.resolvePropertyAsNumber("displayMax",h),b>m){const e=b;b=m,m=e}b===m&&(m=b+1),f=this._mapStep(p,u,h,b,m)}g||(g=this._guessUnitForDomain(t,v));let y=this._decimalsFromStep(f);return this.resolvePropertyAsBoolean("usePrecisionOverride")&&(y=Math.max(0,this.resolvePropertyAsNumber("precisionOverride",y))),{domain:t,mode:c,actualMin:u,actualMax:h,actualStep:p,displayMin:b,displayMax:m,displayStep:f,displayMode:v,precision:y,unit:g,values:d,service:a,supportsService:Boolean(a)}}_resolveGenericService(e){var t,i;const n=null==(i=null==(t=this.hass)?void 0:t.services)?void 0:i[e];if(n)return n.set_value?{domain:e,service:"set_value",field:"value"}:void 0}_getDisplayValues(e){if(this._isInteracting)return{single:this._localDisplayValue??this._toDisplayValue(e.values.single??e.actualMin,e),low:this._localDisplayLow??this._toDisplayValue(e.values.low??e.actualMin,e),high:this._localDisplayHigh??this._toDisplayValue(e.values.high??e.actualMax,e)};if(this._pendingSync){const t=Date.now();if(this._pendingSyncMatches(e))this._clearPendingSync();else if(t-this._pendingSync.startedAt<1500)return{single:this._toDisplayValue(this._pendingSync.values.single??e.values.single??e.actualMin,e),low:this._toDisplayValue(this._pendingSync.values.low??e.values.low??e.actualMin,e),high:this._toDisplayValue(this._pendingSync.values.high??e.values.high??e.actualMax,e)};this._clearPendingSync()}return{single:this._toDisplayValue(e.values.single??e.actualMin,e),low:this._toDisplayValue(e.values.low??e.actualMin,e),high:this._toDisplayValue(e.values.high??e.actualMax,e)}}_toDisplayValue(e,t){const i=this._safeRange(t.actualMin,t.actualMax),n=this._safeRange(t.displayMin,t.displayMax),o=(e-t.actualMin)/i,s=t.displayMin+o*n;return this._clamp(s,t.displayMin,t.displayMax)}_pendingSyncMatches(e){if(!this._pendingSync)return!1;const t=Math.max(e.actualStep,.01)/2;if("range"===e.mode){if(void 0===this._pendingSync.values.low||void 0===this._pendingSync.values.high)return!1;if(void 0===e.values.low||void 0===e.values.high)return!1;const i=Math.abs(e.values.low-this._pendingSync.values.low),n=Math.abs(e.values.high-this._pendingSync.values.high);return i<=t&&n<=t}if(void 0===this._pendingSync.values.single||void 0===e.values.single)return!1;return Math.abs(e.values.single-this._pendingSync.values.single)<=t}_normalizeDisplayValues(e,t,i){if("single"===t.mode){const i=this._toActualValue(e.single??t.displayMin,t),n=this._snapToStep(i,t.actualMin,t.actualStep);return{single:this._toDisplayValue(n,t)}}const n=this._toActualValue(e.low??t.displayMin,t),o=this._toActualValue(e.high??t.displayMax,t),s=this._applyRangeConstraints(n,o,t,"high"===i?"high":"low");return{low:this._toDisplayValue(s.low,t),high:this._toDisplayValue(s.high,t)}}_toActualValues(e,t,i){if("single"===t.mode){const i=this._toActualValue(e.single??t.displayMin,t);return{single:this._snapToStep(i,t.actualMin,t.actualStep)}}const n=this._toActualValue(e.low??t.displayMin,t),o=this._toActualValue(e.high??t.displayMax,t),s=this._applyRangeConstraints(n,o,t,"high"===i?"high":"low");return{low:this._snapToStep(s.low,t.actualMin,t.actualStep),high:this._snapToStep(s.high,t.actualMin,t.actualStep)}}_applyRangeConstraints(e,t,i,n){const o=Math.max(0,this.resolvePropertyAsNumber("rangeMinGap",0));let s=this._clamp(e,i.actualMin,i.actualMax),r=this._clamp(t,i.actualMin,i.actualMax);if("low"===n?s>r-o&&(s=r-o):r<s+o&&(r=s+o),s=this._clamp(s,i.actualMin,i.actualMax),r=this._clamp(r,i.actualMin,i.actualMax),s>r){const e=s;s=r,r=e}return{low:s,high:r}}_buildServicePayload(e,t){if(!t.service||!this.entity)return null;const i={entity_id:this.entity};return"range"===t.mode&&t.service.fieldLow&&t.service.fieldHigh?(i[t.service.fieldLow]=e.low,i[t.service.fieldHigh]=e.high):i[t.service.field]=e.single,{domain:t.service.domain,service:t.service.service,data:i}}_emitServiceError(e,t){var i,n;const o={entityId:this.entity,error:e,payload:t,blockId:null==(i=this.block)?void 0:i.id};null==(n=this.eventBus)||n.dispatchEvent("slider-service-error",o),this.dispatchEvent(new CustomEvent("slider-service-error",{detail:o,bubbles:!0,composed:!0}))}_setPendingSync(e){this._pendingSync={values:e,startedAt:Date.now()},this._syncPending=!0,null!==this._pendingSyncTimeoutId&&window.clearTimeout(this._pendingSyncTimeoutId),this._pendingSyncTimeoutId=window.setTimeout(()=>{this._clearPendingSync(),this.requestUpdate()},1500)}_clearPendingSync(){this._pendingSync=null,this._syncPending=!1,null!==this._pendingSyncTimeoutId&&(window.clearTimeout(this._pendingSyncTimeoutId),this._pendingSyncTimeoutId=null)}_revertToLastCommitted(e){if(!this._lastCommittedValues)return;const t=this._getDisplayValues({...e,values:this._lastCommittedValues});this._localDisplayValue=t.single??null,this._localDisplayLow=t.low??null,this._localDisplayHigh=t.high??null,this._lastCommittedValues=null,this.requestUpdate()}_formatSingleValue(e,t){const i=this._formatNumber(e,t.precision);return t.unit?`${i}${t.unit}`:i}_formatRangeValue(e,t){if("range"===t.mode){const i=e.low??t.displayMin,n=e.high??t.displayMax,o=this._formatNumber(i,t.precision),s=this._formatNumber(n,t.precision);return t.unit?`${o}-${s}${t.unit}`:`${o}-${s}`}const i=e.single??t.displayMin;return this._formatSingleValue(i,t)}_formatNumber(e,t){if(!Number.isFinite(e))return"-";const i=e.toFixed(t);return t>0?i.replace(/\.?0+$/,""):i}_isDisabled(){const e=this.resolveProperty("disableMode","auto");return"never"!==e&&("custom"===e?this.resolvePropertyAsBoolean("disabled"):!this.isEntityAvailable())}_getDefaultActiveColor(e){return e&&Ot[e]||"var(--accent-color, #2196f3)"}_withDefaultActiveColor(e,t){return"backgroundColor"in e||"background"in e?e:{...e,backgroundColor:t}}_safeRange(e,t){const i=t-e;return 0===i?1:i}_guessUnitForDomain(e,t){return"percent"===t||"fan"===e||"cover"===e||"humidifier"===e?"%":""}_getTemperatureUnit(e){var t,i,n;return String(e.temperature_unit||e.unit_of_measurement||(null==(n=null==(i=null==(t=this.hass)?void 0:t.config)?void 0:i.unit_system)?void 0:n.temperature)||"C")}_getDefaultTempStep(e){return e.includes("F")?1:.5}_getNumberAttribute(e,t){if(!e||!(t in e))return null;const i=this._parseNumber(e[t]);return null===i?null:i}_firstNumber(e,t){for(const i of t){const t=this._getNumberAttribute(e,i);if(null!==t)return t}return null}_parseNumber(e){if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}_decimalsFromStep(e){if(!Number.isFinite(e)||e<=0)return 0;const t=e.toString();if(t.includes("e-")){const e=parseInt(t.split("e-")[1]||"0",10);return Number.isFinite(e)?e:0}const i=t.indexOf(".");return-1===i?0:t.length-i-1}_mapStep(e,t,i,n,o){const s=i-t;if(0===s)return 1;const r=e/s*(o-n);return r>0?r:1}_snapToStep(e,t,i){if(!Number.isFinite(e))return t;if(i<=0)return e;return t+Math.round((e-t)/i)*i}_clamp(e,t,i){return Math.min(i,Math.max(t,e))}_toActualValue(e,t){const i=this._safeRange(t.actualMin,t.actualMax),n=this._safeRange(t.displayMin,t.displayMax),o=(this._clamp(e,t.displayMin,t.displayMax)-t.displayMin)/n;return t.actualMin+o*i}};zt.styles=[...st.styles,a`
            :host {
                --block-size-height: 20px;
                --block-size-width: 100%;
                --block-border-radius: var(--ha-card-border-radius, var(--ha-border-radius-lg));
                --slider-thumb-size: var(--block-size-height);
                display: block;
                height: var(--block-size-height);
                border-radius: var(--block-border-radius);
            }
            :host, :host(.block-flow) {
                width: var(--block-size-width);
            }
            :host(.vertical) {
                --block-size-height: 100px;
                --block-size-width: 30px;
                --slider-thumb-size: var(--block-size-width);
            }

            .slider-root {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 100%;
                height: 100%;
                box-sizing: border-box;
                border-radius: inherit;
            }

            .slider-row {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
                height: 100%;
                border-radius: inherit;
            }

            .slider-root.vertical .slider-row {
                flex-direction: column;
                gap: 10px;
            }

            .slider-root.vertical .track {
                flex: 1 1 auto;
                width: 100%;
            }

            .track {
                --slider-track-border-radius: var(--block-border-radius);
                position: relative;
                width: 100%;
                height: 100%;
                border-radius: var(--slider-track-border-radius);
                background: var(--slider-inactive-color, rgba(0, 0, 0, 0.12));
                overflow: visible;
                touch-action: none;
                cursor: pointer;
            }

            .slider-root.dragging,
            .slider-root.dragging .track {
                cursor: ew-resize;
            }

            .slider-root.vertical.dragging,
            .slider-root.vertical.dragging .track {
                cursor: ns-resize;
            }

            .track-inactive {
                position: absolute;
                inset: 0;
                border-radius: var(--slider-track-border-radius);
            }

            .track-active {
                position: absolute;
                top: 0;
                height: 100%;
                border-radius: var(--slider-track-border-radius);
                background: var(--slider-active-color, var(--accent-color, #2196f3));
            }

            .slider-root.vertical .track-active {
                top: auto;
                left: 0;
                width: 100%;
            }

            .thumb {
                position: absolute;
                top: 50%;
                width: var(--slider-thumb-size);
                height: var(--slider-thumb-size);
                border-radius: 50%;
                background: #fff;
                border: 2px solid var(--slider-active-color, var(--accent-color, #2196f3));
                transform: translate(-50%, -50%);
                box-sizing: border-box;
                pointer-events: none;
                transition: box-shadow 0.15s ease;
            }

            .slider-root.vertical .thumb {
                top: auto;
                left: 50%;
                transform: translate(-50%, 50%);
            }

            .thumb.active {
                box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.08);
            }

            .value-label,
            .value-inline {
                font-size: 12px;
                font-weight: 600;
                color: var(--primary-text-color, #111);
                white-space: nowrap;
                font-variant-numeric: tabular-nums;
            }

            .value-inline {
                min-width: 48px;
                text-align: right;
            }

            .value-inline.align-left {
                text-align: left;
            }

            .value-inline.align-right {
                text-align: right;
            }

            .value-vertical {
                text-align: center;
            }

            .value-inside {
                position: absolute;
                padding: 0;
                box-sizing: border-box;
                text-align: center;
                top: 50%;
                transform: translateY(-50%);
            }
            
            .value-inside.position-center {
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .value-inside.position-left {
                left: 0;
                margin-left: 10px;
            }

            .value-inside.position-right {
                right: 0;
                margin-right: 10px;
            }

            .value-inside.vertical {
                left: 50%;
                top: auto;
                transform: translateX(-50%);
            }

            .value-inside.vertical.position-top {
                top: 0;
                margin-top: 10px;
            }

            .value-inside.vertical.position-middle {
                top: 50%;
                transform: translate(-50%, -50%);
            }

            .value-inside.vertical.position-bottom {
                bottom: 0;
                margin-bottom: 10px;
            }

            .tooltip {
                position: absolute;
                top: -28px;
                transform: translateX(-50%);
                padding: 4px 6px;
                border-radius: 6px;
                background: rgba(0, 0, 0, 0.75);
                color: white;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                pointer-events: none;
            }

            .slider-root.vertical .tooltip {
                top: auto;
                left: calc(100% + 8px);
                transform: translateY(-50%);
            }

            .slider-root.disabled {
                opacity: 0.6;
                pointer-events: none;
            }

            .slider-root.sync-pending .thumb {
                box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
            }

            .slider-root.shape-square .track,
            .slider-root.shape-square .track-inactive,
            .slider-root.shape-square .track-active {
                border-radius: 0;
            }

            .slider-root.shape-square .thumb {
                border-radius: 0;
            }
        `],Rt([c()],zt.prototype,"_localDisplayValue",2),Rt([c()],zt.prototype,"_localDisplayLow",2),Rt([c()],zt.prototype,"_localDisplayHigh",2),Rt([c()],zt.prototype,"_activeThumb",2),Rt([c()],zt.prototype,"_isInteracting",2),Rt([c()],zt.prototype,"_syncPending",2),zt=Rt([p("block-slider")],zt);class Nt extends De{_getDropZones(){return this.block&&0!==this.block.children.length?this.block.children.map(e=>this.documentModel.getBlock(e)):[]}_updateDropZones(){this._getDropZones().forEach(e=>{const t=this.documentModel.getElement(e.id);null==t||t.requestUpdate()})}}const Ft=new class{constructor(){this.blocks=new Map,this.classes=new Map}get allBlocks(){const e={};return this.blocks.forEach((t,i)=>{null!==t.definition&&(e[i]=t.definition)}),e}register(e,t,i){this.blocks.has(e)&&console.warn(`[BlockRegistry] Block type "${e}" is already registered. Overwriting.`),this._validateRegistration(e,i),this.blocks.set(e,i),this.classes.set(e,t)}getBlock(e){var t;return null==(t=this.blocks.get(e))?void 0:t.definition}getBlockClass(e){return this.classes.get(e)}getDefaults(e){var t;return null==(t=this.blocks.get(e))?void 0:t.defaults}getByCategory(e){const t=[];return this.blocks.forEach((i,n)=>{null!==i.definition&&i.definition.category===e&&t.push({type:n,...i.definition})}),t}getAllCategories(){const e=new Set;return this.blocks.forEach(t=>{null!==t.definition&&e.add(t.definition.category)}),Array.from(e)}getAllTypes(){return Array.from(this.blocks.keys())}isRegistered(e){return this.blocks.has(e)}getRegistration(e){return this.blocks.get(e)}getBlockStyleOutputConfig(e,t){const i=this.classes.get(e.type);return i?i.getStyleOutputConfig(e,t):null}getBlockActionTargets(e){var t;return null==(t=this.blocks.get(e))?void 0:t.actionTargets}getBlockActionTargetsForBlock(e){var t,i;const n={...(null==(t=this.blocks.get(e.type))?void 0:t.actionTargets)||{}};((null==(i=this.blocks.get(e.type))?void 0:i.exposeBlockActionTarget)??!0)&&!n.block&&(n.block={label:"Block"});const o=this.classes.get(e.type);if(!o)return n;const s=o.getAvailableActionTargetIds(e,n);if(s.length===Object.keys(n).length)return n;const r={};for(const l of s){const e=n[l];e&&(r[l]=e)}return r}getBlockActionTargetDefinition(e,t){var i,n;return null==(n=null==(i=this.blocks.get(e))?void 0:i.actionTargets)?void 0:n[t]}getBlockDefaults(e){var t;return null==(t=this.blocks.get(e))?void 0:t.styleDefaults}getEntityDefaults(e){const t=this.blocks.get(e);return(null==t?void 0:t.entityDefaults)?t.entityDefaults:{mode:"inherited"}}_validateRegistration(e,t){const{definition:i}=t;if(null!==i){if(!i.label)throw new Error(`[BlockRegistry] Block "${e}" missing required field: label`);if(!i.icon)throw new Error(`[BlockRegistry] Block "${e}" missing required field: icon`);if(!i.category&&!i.internal)throw new Error(`[BlockRegistry] Block "${e}" missing required field: category`)}if(t.actionTargets)for(const[n,o]of Object.entries(t.actionTargets))if(!o.label)throw new Error(`[BlockRegistry] Block "${e}" action target "${n}" missing required field: label`)}},Vt=e("block-registry");class jt{constructor(e,t,i,n){this.documentModel=e,this.containerManager=t,this.presetService=i,this.blockRegistry=n,this.bindingContext={}}setBindingEvaluator(e){this.bindingEvaluator=e}setBindingContext(e){this.bindingContext=e}resolve(e,t,i,n=!0,o){return this.resolveTarget(e,t,o,i,n)}resolveTarget(e,t,i,n,o=!0){var s,r;const l=n||this.bindingContext,a=i??"block",c=this.documentModel.getBlock(e);if(!c)return{};const d=null==(r=null==(s=c.styles)?void 0:s[a])?void 0:r.stylePresetId,u={blockId:e,targetId:a,containerId:t,blockType:c.type,presetId:d,applyFallbacks:o};return this.resolveAllCategories(c,u,l)}resolveAllCategories(e,t,i){const n={},o=this.getAllCategories(e,t);for(const s of o){const o=this.resolveCategory(e,t,s,i);Object.keys(o).length>0&&(n[s]=o)}return n}getAllCategories(e,t){var i,n;const o=new Set,s=null==(i=this.blockRegistry)?void 0:i.getBlockDefaults(t.blockType),r="block"===t.targetId;if(s&&r&&Object.keys(s).forEach(e=>o.add(e)),t.presetId){const e=this.presetService.getCachedPreset(t.presetId);if(null==(n=null==e?void 0:e.data)?void 0:n.containers)for(const t of Object.values(e.data.containers))t&&Object.keys(t).forEach(e=>o.add(e))}const l=this.getInlineSources(e,t);for(const a of l)a&&Object.keys(a).forEach(e=>o.add(e));return Array.from(o)}resolveCategory(e,t,i,n){const o={},s=this.getAllPropertiesInCategory(e,t,i);for(const r of s){const s=this.resolvePropertyValue(e,t,i,r,n);s&&(o[r]=s)}return o}getAllPropertiesInCategory(e,t,i){var n;const o=new Set,s=null==(n=this.blockRegistry)?void 0:n.getBlockDefaults(t.blockType);if("block"===t.targetId&&(null==s?void 0:s[i])&&Object.keys(s[i]).forEach(e=>o.add(e)),t.presetId){this.getPresetPropertiesInCategory(i,t.presetId,t.containerId,t.applyFallbacks).forEach(e=>o.add(e))}return this.getInlinePropertiesInCategory(e,i,t.containerId,t.targetId,t.applyFallbacks).forEach(e=>o.add(e)),Array.from(o)}resolvePropertyValue(e,t,i,n,o){const s=this.hasLocalOverride(e,t.containerId,i,n,t.targetId),r=this.containerManager.getFallbackChain(t.containerId);for(const l of r){const r=this.getPropertyFromInline(e,l.id,i,n,t.targetId);if(void 0!==r.value){const e=l.id===t.containerId?"inline":"inline-fallback";return this.createResolvedValue(r,e,l.id,s,void 0,o)}}if(t.presetId)for(const l of r){const e=this.getPropertyFromPreset(t.presetId,l.id,i,n);if(void 0!==e.value){const i=l.id===t.containerId?"preset":"preset-fallback";return this.createResolvedValue(e,i,t.containerId,s,t.presetId,o)}}if("block"===t.targetId){const e=this.getPropertyFromBlockDefaults(t.blockType,i,n);if(void 0!==e.value)return this.createResolvedValue(e,"block-type-default",void 0,s,void 0,o)}}hasLocalOverride(e,t,i,n,o){var s,r,l,a,c;const d=o??"block";return void 0!==(null==(c=null==(a=null==(l=null==(r=null==(s=e.styles)?void 0:s[d])?void 0:r.containers)?void 0:l[t])?void 0:a[i])?void 0:c[n])}createResolvedValue(e,t,i,n,o,s){var r;const l=e.value,a=l.binding,c=l.unit;let d;if(a){const e=null==(r=this.bindingEvaluator)?void 0:r.evaluate(a,{defaultEntityId:(null==s?void 0:s.defaultEntityId)||this.bindingContext.defaultEntityId,defaultValue:l.value});d=null==e?void 0:e.value}else d=l.value;return{value:d,unit:c,origin:t,originContainer:i,presetId:o,binding:a,hasLocalOverride:n}}getInlinePropertiesInCategory(e,t,i,n,o=!0){var s,r,l,a;const c=n??"block",d=null==(r=null==(s=e.styles)?void 0:s[c])?void 0:r.containers,u=this.containerManager.getFallbackChain(i);if(!o&&(null==(l=null==d?void 0:d[i])?void 0:l[t]))return Object.keys(d[i][t]||{});const h=new Set;for(const p of u)for(const e of Object.keys((null==(a=null==d?void 0:d[p.id])?void 0:a[t])||{}))h.add(e);return Array.from(h)}getInlineSources(e,t){var i;const n=t.targetId??"block",o=null==(i=e.styles)?void 0:i[n];return(null==o?void 0:o.containers)?Object.values(o.containers).filter(Boolean):[]}getPresetPropertiesInCategory(e,t,i,n){var o,s,r;const l=this.getMergedPreset(t);if(!(null==l?void 0:l.containers))return[];const a=this.containerManager.getFallbackChain(i);if(!n&&(null==(o=l.containers[i])?void 0:o[e]))return Object.keys(l.containers[i][e]||{});const c=new Set;for(const d of a)for(const t of Object.keys((null==(r=null==(s=l.containers)?void 0:s[d.id])?void 0:r[e])||{}))c.add(t);return Array.from(c)}getPropertyFromInline(e,t,i,n,o){var s,r,l,a,c;const d=o??"block";return{value:null==(c=null==(a=null==(l=null==(r=null==(s=e.styles)?void 0:s[d])?void 0:r.containers)?void 0:l[t])?void 0:a[i])?void 0:c[n]}}getPropertyFromPreset(e,t,i,n){var o,s,r;const l=this.getMergedPreset(e);return{value:null==(r=null==(s=null==(o=null==l?void 0:l.containers)?void 0:o[t])?void 0:s[i])?void 0:r[n]}}getPropertyFromBlockDefaults(e,t,i){var n,o;const s=null==(n=this.blockRegistry)?void 0:n.getBlockDefaults(e);return{value:null==(o=null==s?void 0:s[t])?void 0:o[i]}}getMergedPreset(e){return this.mergePresetChain(e)}mergePresetChain(e,t=new Set){if(t.has(e))return void console.warn(`[StyleResolver] Circular preset inheritance detected: ${Array.from(t).join("  ")}  ${e}`);if(t.size>10)return void console.warn("[StyleResolver] Max preset inheritance depth exceeded");const i=this.presetService.getCachedPreset(e);if(!i)return void console.warn(`[StyleResolver] Preset not found: ${e}`);if(t.add(e),!i.extendsPresetId)return i.data;return function(e,t){if(!e)return t||{containers:{}};if(!t)return e;const i={containers:{}},n=new Set([...Object.keys(e.containers),...Object.keys(t.containers)]);for(const o of n)i.containers[o]=Ce(e.containers[o],t.containers[o]);return i}(this.mergePresetChain(i.extendsPresetId,t),i.data)}}function Ht(e,t){var i,n,o,s;if(!t)return!0;if(t.only){const o=(null==(i=t.only.categories)?void 0:i.includes(e))??!1,s=(null==(n=t.only.properties)?void 0:n.some(t=>t.startsWith(`${e}.`)))??!1;return o||s}if(t.exclude){return!((null==(o=t.exclude.categories)?void 0:o.includes(e))??!1)||((null==(s=t.include)?void 0:s.some(t=>t.startsWith(`${e}.`)))??!1)}return!0}function Wt(e,t,i){var n,o,s,r,l;if(!i)return!0;const a=`${e}.${t}`;if(i.only){const t=(null==(n=i.only.categories)?void 0:n.includes(e))??!1,s=(null==(o=i.only.properties)?void 0:o.includes(a))??!1;return t||s}if(i.exclude){const t=(null==(s=i.exclude.categories)?void 0:s.includes(e))??!1,n=(null==(r=i.exclude.properties)?void 0:r.includes(a))??!1;return!!(null==(l=i.include)?void 0:l.includes(a))||!t&&!n}return!0}const Ut=["px","rem","em","%","vh","vw","vmin","vmax","ch","ex","cm","mm","in","pt","pc"],Gt=["px","rem","em","vh","vw","vmin","vmax","ch","ex","cm","mm","in","pt","pc"],qt=[...Ut,"auto"],Zt=[...Ut,"none"],Yt={"size.width":qt,"size.height":qt,"size.minWidth":qt,"size.maxWidth":Zt,"size.minHeight":qt,"size.maxHeight":Zt,"spacing.margin":Ut,"spacing.padding":Ut,"spacing.marginTop":Ut,"spacing.marginRight":Ut,"spacing.marginBottom":Ut,"spacing.marginLeft":Ut,"spacing.paddingTop":Ut,"spacing.paddingRight":Ut,"spacing.paddingBottom":Ut,"spacing.paddingLeft":Ut,"typography.fontSize":Ut,"typography.letterSpacing":Gt,"border.borderWidth":Gt,"border.borderTopWidth":Gt,"border.borderRightWidth":Gt,"border.borderBottomWidth":Gt,"border.borderLeftWidth":Gt,"border.borderRadius":Ut,"border.borderTopLeftRadius":Ut,"border.borderTopRightRadius":Ut,"border.borderBottomRightRadius":Ut,"border.borderBottomLeftRadius":Ut,"svg.strokeWidth":Gt,"svg.strokeDashoffset":Gt,"flex.gap":Ut,"flex.rowGap":Ut,"flex.columnGap":Ut,"flex.flexBasis":qt,"effects.rotate":["deg","rad","grad","turn"]},Xt={"size.width":"px","size.height":"px","size.minWidth":"px","size.maxWidth":"px","size.minHeight":"px","size.maxHeight":"px","spacing.margin":"px","spacing.padding":"px","spacing.marginTop":"px","spacing.marginRight":"px","spacing.marginBottom":"px","spacing.marginLeft":"px","spacing.paddingTop":"px","spacing.paddingRight":"px","spacing.paddingBottom":"px","spacing.paddingLeft":"px","typography.fontSize":"px","typography.letterSpacing":"px","border.borderWidth":"px","border.borderTopWidth":"px","border.borderRightWidth":"px","border.borderBottomWidth":"px","border.borderLeftWidth":"px","border.borderRadius":"px","border.borderTopLeftRadius":"px","border.borderTopRightRadius":"px","border.borderBottomRightRadius":"px","border.borderBottomLeftRadius":"px","svg.strokeWidth":"px","svg.strokeDashoffset":"px","flex.gap":"px","flex.rowGap":"px","flex.columnGap":"px","flex.flexBasis":"px","effects.rotate":"deg"},Kt={width:"px",height:"px",minWidth:"px",maxWidth:"px",minHeight:"px",maxHeight:"px",margin:"px",padding:"px",marginTop:"px",marginRight:"px",marginBottom:"px",marginLeft:"px",paddingTop:"px",paddingRight:"px",paddingBottom:"px",paddingLeft:"px",fontSize:"px",letterSpacing:"px",borderWidth:"px",borderRadius:"px",borderTopWidth:"px",borderRightWidth:"px",borderBottomWidth:"px",borderLeftWidth:"px",borderTopLeftRadius:"px",borderTopRightRadius:"px",borderBottomRightRadius:"px",borderBottomLeftRadius:"px",strokeWidth:"px",strokeDashoffset:"px",rowGap:"px",columnGap:"px",gap:"px",flexBasis:"px",rotate:"deg"};function Jt(e,t){return Yt[`${e}.${t}`]}function Qt(e,t){return Xt[`${e}.${t}`]}function ei(e,t={}){const{filter:i,append:n}=t,o={};for(const[s,r]of Object.entries(e)){if(!r)continue;if("_internal"===s)continue;if(!Ht(s,i))continue;const e=ti(s,r,t);Object.assign(o,e)}return n&&Object.assign(o,n),o}function ti(e,t,i={}){const n={};switch(e){case"layout":Object.assign(n,function(e,t,i){var n,o,s,r,l,a;const c={},{filter:d}=i,u=ni(e,c,i);if(void 0!==(null==(n=t.display)?void 0:n.value)&&Wt(e,"display",d)){u("display","display",`${t.display.value}`,"layout-display")}if(void 0!==(null==(o=t.show)?void 0:o.value)&&Wt(e,"show",d)&&"no"===t.show.value){u("show","display","none","layout-show")}if(void 0!==(null==(s=t.positionX)?void 0:s.value)&&Wt(e,"positionX",d)){u("positionX","top",`${t.positionX.value}px`,"layout-position-x")}if(void 0!==(null==(r=t.positionY)?void 0:r.value)&&Wt(e,"positionY",d)){u("positionY","left",`${null==(l=t.positionY)?void 0:l.value}px`,"layout-position-y")}if(void 0!==(null==(a=t.zIndex)?void 0:a.value)&&Wt(e,"zIndex",d)){u("zIndex","zIndex",`${t.zIndex.value}`,"layout-z-index")}return c}(e,t,i));break;case"size":Object.assign(n,function(e,t,i){var n,o,s,r,l,a;const c={},{filter:d}=i,u=ni(e,c,i);if(void 0!==(null==(n=t.width)?void 0:n.value)&&Wt(e,"width",d)){const e=oi(t.width.value,t.width.unit,Qt("size","width"));void 0!==e&&u("width","width",e,"size-width")}if(void 0!==(null==(o=t.height)?void 0:o.value)&&Wt(e,"height",d)){const e=oi(t.height.value,t.height.unit,Qt("size","height"));void 0!==e&&u("height","height",e,"size-height")}if(void 0!==(null==(s=t.minWidth)?void 0:s.value)&&Wt(e,"minWidth",d)){const e=oi(t.minWidth.value,t.minWidth.unit,Qt("size","minWidth"));void 0!==e&&u("minWidth","minWidth",e,"size-min-width")}if(void 0!==(null==(r=t.maxWidth)?void 0:r.value)&&Wt(e,"maxWidth",d)){const e=oi(t.maxWidth.value,t.maxWidth.unit,Qt("size","maxWidth"));void 0!==e&&u("maxWidth","maxWidth",e,"size-max-width")}if(void 0!==(null==(l=t.minHeight)?void 0:l.value)&&Wt(e,"minHeight",d)){const e=oi(t.minHeight.value,t.minHeight.unit,Qt("size","minHeight"));void 0!==e&&u("minHeight","minHeight",e,"size-min-height")}if(void 0!==(null==(a=t.maxHeight)?void 0:a.value)&&Wt(e,"maxHeight",d)){const e=oi(t.maxHeight.value,t.maxHeight.unit,Qt("size","maxHeight"));void 0!==e&&u("maxHeight","maxHeight",e,"size-max-height")}return c}(e,t,i));break;case"spacing":Object.assign(n,function(e,t,i){var n,o,s,r;const l={},{filter:a}=i,c=ni(e,l,i);if(void 0!==(null==(n=t.margin)?void 0:n.value)&&Wt(e,"margin",a)){c("margin","margin",si(t.margin.value,t.margin.unit,Qt("spacing","margin")??"px"),"spacing-margin")}if(void 0!==(null==(o=t.padding)?void 0:o.value)&&Wt(e,"padding",a)){c("padding","padding",si(t.padding.value,t.padding.unit,Qt("spacing","padding")??"px"),"spacing-padding")}for(const d of["marginTop","marginRight","marginBottom","marginLeft"])if(void 0!==(null==(s=t[d])?void 0:s.value)&&Wt(e,d,a)){const e=oi(t[d].value,t[d].unit,Qt("spacing",d));void 0!==e&&c(d,d,e,`spacing-${d}`)}for(const d of["paddingTop","paddingRight","paddingBottom","paddingLeft"])if(void 0!==(null==(r=t[d])?void 0:r.value)&&Wt(e,d,a)){const e=oi(t[d].value,t[d].unit,Qt("spacing",d));void 0!==e&&c(d,d,e,`spacing-${d}`)}return l}(e,t,i));break;case"typography":Object.assign(n,function(e,t,i){var n,o,s,r,l,a,c,d,u,h,p,g;const v={},{filter:b}=i,m=ni(e,v,i);if(void 0!==(null==(n=t.fontFamily)?void 0:n.value)&&Wt(e,"fontFamily",b)){m("fontFamily","fontFamily",String(t.fontFamily.value),"typography-fontFamily")}if(void 0!==(null==(o=t.fontSize)?void 0:o.value)&&Wt(e,"fontSize",b)){const e=oi(t.fontSize.value,t.fontSize.unit,Qt("typography","fontSize"));void 0!==e&&m("fontSize","fontSize",e,"typography-fontSize")}if(void 0!==(null==(s=t.fontWeight)?void 0:s.value)&&Wt(e,"fontWeight",b)){m("fontWeight","fontWeight",String(t.fontWeight.value),"typography-fontWeight")}if(void 0!==(null==(r=t.fontStyle)?void 0:r.value)&&Wt(e,"fontStyle",b)){m("fontStyle","fontStyle",String(t.fontStyle.value),"typography-fontStyle")}if(void 0!==(null==(l=t.lineHeight)?void 0:l.value)&&Wt(e,"lineHeight",b)){m("lineHeight","lineHeight",String(t.lineHeight.value),"typography-lineHeight")}if(void 0!==(null==(a=t.letterSpacing)?void 0:a.value)&&Wt(e,"letterSpacing",b)){const e=oi(t.letterSpacing.value,t.letterSpacing.unit,Qt("typography","letterSpacing"));void 0!==e&&m("letterSpacing","letterSpacing",e,"typography-letterSpacing")}if(void 0!==(null==(c=t.textAlign)?void 0:c.value)&&Wt(e,"textAlign",b)){m("textAlign","textAlign",String(t.textAlign.value),"typography-textAlign")}if(void 0!==(null==(d=t.textDecoration)?void 0:d.value)&&Wt(e,"textDecoration",b)){m("textDecoration","textDecoration",String(t.textDecoration.value),"typography-textDecoration")}if(void 0!==(null==(u=t.textTransform)?void 0:u.value)&&Wt(e,"textTransform",b)){m("textTransform","textTransform",String(t.textTransform.value),"typography-textTransform")}if(void 0!==(null==(h=t.textShadow)?void 0:h.value)&&Wt(e,"textShadow",b)){m("textShadow","textShadow",String(t.textShadow.value),"typography-textShadow")}if(void 0!==(null==(p=t.whiteSpace)?void 0:p.value)&&Wt(e,"whiteSpace",b)){m("whiteSpace","whiteSpace",String(t.whiteSpace.value),"typography-whiteSpace")}if(void 0!==(null==(g=t.color)?void 0:g.value)&&Wt(e,"color",b)){m("color","color",String(t.color.value),"typography-color")}return v}(e,t,i));break;case"background":Object.assign(n,function(e,t,i){var n,o,s,r,l,a,c,d,u,h,p,g;const v={},{filter:b}=i,m=ni(e,v,i);if(void 0!==(null==(n=t.backgroundColor)?void 0:n.value)&&Wt(e,"backgroundColor",b)){m("backgroundColor","backgroundColor",String(t.backgroundColor.value),"background-color")}if(void 0!==(null==(o=t.color)?void 0:o.value)&&Wt(e,"color",b)){m("color","backgroundColor",String(t.color.value),"background-color")}if(void 0!==(null==(s=t.backgroundImage)?void 0:s.value)&&Wt(e,"backgroundImage",b)){const e=li(t.backgroundImage.value);void 0!==e&&m("backgroundImage","backgroundImage",e,"background-image")}if(void 0!==(null==(r=t.image)?void 0:r.value)&&Wt(e,"image",b)){const e=li(t.image.value);void 0!==e&&m("image","backgroundImage",e,"background-image")}if(void 0!==(null==(l=t.backgroundSize)?void 0:l.value)&&Wt(e,"backgroundSize",b)){m("backgroundSize","backgroundSize",String(t.backgroundSize.value),"background-size")}if(void 0!==(null==(a=t.size)?void 0:a.value)&&Wt(e,"size",b)){m("size","backgroundSize",String(t.size.value),"background-size")}if(void 0!==(null==(c=t.backgroundRepeat)?void 0:c.value)&&Wt(e,"backgroundRepeat",b)){m("backgroundRepeat","backgroundRepeat",String(t.backgroundRepeat.value),"background-repeat")}if(void 0!==(null==(d=t.repeat)?void 0:d.value)&&Wt(e,"repeat",b)){m("repeat","backgroundRepeat",String(t.repeat.value),"background-repeat")}if(void 0!==(null==(u=t.backgroundPosition)?void 0:u.value)&&Wt(e,"backgroundPosition",b)){m("backgroundPosition","backgroundPosition",String(t.backgroundPosition.value),"background-position")}if(void 0!==(null==(h=t.position)?void 0:h.value)&&Wt(e,"position",b)){m("position","backgroundPosition",String(t.position.value),"background-position")}if(void 0!==(null==(p=t.boxShadow)?void 0:p.value)&&Wt(e,"boxShadow",b)){m("boxShadow","boxShadow",String(t.boxShadow.value),"background-box-shadow")}if(void 0!==(null==(g=t.backgroundBlendMode)?void 0:g.value)&&Wt(e,"backgroundBlendMode",b)){m("backgroundBlendMode","backgroundBlendMode",String(t.backgroundBlendMode.value),"background-blend-mode")}return v}(e,t,i));break;case"border":Object.assign(n,function(e,t,i){var n,o,s,r,l,a,c,d,u,h;const p={},{filter:g}=i,v=ni(e,p,i);if(void 0!==(null==(n=t.borderWidth)?void 0:n.value)&&Wt(e,"borderWidth",g)){const e=oi(t.borderWidth.value,t.borderWidth.unit,Qt("border","borderWidth"));void 0!==e&&v("borderWidth","borderWidth",e,"border-width")}if(void 0!==(null==(o=t.width)?void 0:o.value)&&Wt(e,"width",g)){const e=oi(t.width.value,t.width.unit,Qt("border","borderWidth"));void 0!==e&&v("width","borderWidth",e,"border-width")}if(void 0!==(null==(s=t.borderStyle)?void 0:s.value)&&Wt(e,"borderStyle",g)){v("borderStyle","borderStyle",String(t.borderStyle.value),"border-style")}if(void 0!==(null==(r=t.style)?void 0:r.value)&&Wt(e,"style",g)){v("style","borderStyle",String(t.style.value),"border-style")}if(void 0!==(null==(l=t.borderColor)?void 0:l.value)&&Wt(e,"borderColor",g)){v("borderColor","borderColor",String(t.borderColor.value),"border-color")}if(void 0!==(null==(a=t.color)?void 0:a.value)&&Wt(e,"color",g)){v("color","borderColor",String(t.color.value),"border-color")}if(void 0!==(null==(c=t.borderRadius)?void 0:c.value)&&Wt(e,"borderRadius",g)){v("borderRadius","borderRadius",ri(t.borderRadius.value,t.borderRadius.unit,Qt("border","borderRadius")??"px"),"border-radius")}if(void 0!==(null==(d=t.radius)?void 0:d.value)&&Wt(e,"radius",g)){v("radius","borderRadius",ri(t.radius.value,t.radius.unit,Qt("border","borderRadius")??"px"),"border-radius")}for(const b of["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"])if(void 0!==(null==(u=t[b])?void 0:u.value)&&Wt(e,b,g)){const e=oi(t[b].value,t[b].unit,Qt("border",b));void 0!==e&&v(b,b,e,`border-${b}`)}for(const b of["borderTopLeftRadius","borderTopRightRadius","borderBottomRightRadius","borderBottomLeftRadius"])if(void 0!==(null==(h=t[b])?void 0:h.value)&&Wt(e,b,g)){v(b,b,ri(t[b].value,t[b].unit,Qt("border",b)??"px"),`border-${b}`)}return p}(e,t,i));break;case"svg":Object.assign(n,function(e,t,i){var n,o,s,r,l,a,c,d,u,h;const p={},{filter:g}=i,v=ni(e,p,i);if(void 0!==(null==(n=t.stroke)?void 0:n.value)&&Wt(e,"stroke",g)){v("stroke","stroke",String(t.stroke.value),"svg-stroke")}if(void 0!==(null==(o=t.strokeWidth)?void 0:o.value)&&Wt(e,"strokeWidth",g)){const e=oi(t.strokeWidth.value,t.strokeWidth.unit,Qt("svg","strokeWidth"));void 0!==e&&v("strokeWidth","strokeWidth",e,"svg-stroke-width")}if(void 0!==(null==(s=t.strokeLinecap)?void 0:s.value)&&Wt(e,"strokeLinecap",g)){v("strokeLinecap","strokeLinecap",String(t.strokeLinecap.value),"svg-stroke-linecap")}if(void 0!==(null==(r=t.strokeLinejoin)?void 0:r.value)&&Wt(e,"strokeLinejoin",g)){v("strokeLinejoin","strokeLinejoin",String(t.strokeLinejoin.value),"svg-stroke-linejoin")}if(void 0!==(null==(l=t.strokeDasharray)?void 0:l.value)&&Wt(e,"strokeDasharray",g)){v("strokeDasharray","strokeDasharray",String(t.strokeDasharray.value),"svg-stroke-dasharray")}if(void 0!==(null==(a=t.strokeDashoffset)?void 0:a.value)&&Wt(e,"strokeDashoffset",g)){const e=oi(t.strokeDashoffset.value,t.strokeDashoffset.unit,Qt("svg","strokeDashoffset"));void 0!==e&&v("strokeDashoffset","strokeDashoffset",e,"svg-stroke-dashoffset")}if(void 0!==(null==(c=t.strokeMiterlimit)?void 0:c.value)&&Wt(e,"strokeMiterlimit",g)){v("strokeMiterlimit","strokeMiterlimit",String(t.strokeMiterlimit.value),"svg-stroke-miterlimit")}if(void 0!==(null==(d=t.strokeOpacity)?void 0:d.value)&&Wt(e,"strokeOpacity",g)){v("strokeOpacity","strokeOpacity",String(t.strokeOpacity.value),"svg-stroke-opacity")}if(void 0!==(null==(u=t.fill)?void 0:u.value)&&Wt(e,"fill",g)){v("fill","fill",String(t.fill.value),"svg-fill")}if(void 0!==(null==(h=t.fillOpacity)?void 0:h.value)&&Wt(e,"fillOpacity",g)){v("fillOpacity","fillOpacity",String(t.fillOpacity.value),"svg-fill-opacity")}return p}(e,t,i));break;case"flex":Object.assign(n,function(e,t,i){var n,o,s,r,l,a,c,d,u,h,p;const g={},{filter:v}=i,b=ni(e,g,i);if(void 0!==(null==(n=t.flexDirection)?void 0:n.value)&&Wt(e,"flexDirection",v)){b("flexDirection","flexDirection",String(t.flexDirection.value),"flex-direction")}if(void 0!==(null==(o=t.direction)?void 0:o.value)&&Wt(e,"direction",v)){b("direction","flexDirection",String(t.direction.value),"flex-direction")}if(void 0!==(null==(s=t.justifyContent)?void 0:s.value)&&Wt(e,"justifyContent",v)){b("justifyContent","justifyContent",String(t.justifyContent.value),"flex-justify")}if(void 0!==(null==(r=t.justify)?void 0:r.value)&&Wt(e,"justify",v)){b("justify","justifyContent",String(t.justify.value),"flex-justify")}if(void 0!==(null==(l=t.alignItems)?void 0:l.value)&&Wt(e,"alignItems",v)){b("alignItems","alignItems",String(t.alignItems.value),"flex-align")}if(void 0!==(null==(a=t.align)?void 0:a.value)&&Wt(e,"align",v)){b("align","alignItems",String(t.align.value),"flex-align")}if(void 0!==(null==(c=t.flexWrap)?void 0:c.value)&&Wt(e,"flexWrap",v)){b("flexWrap","flexWrap",String(t.flexWrap.value),"flex-wrap")}if(void 0!==(null==(d=t.wrap)?void 0:d.value)&&Wt(e,"wrap",v)){b("wrap","flexWrap",String(t.wrap.value),"flex-wrap")}if(void 0!==(null==(u=t.gap)?void 0:u.value)&&Wt(e,"gap",v)){const e=oi(t.gap.value,t.gap.unit,Qt("flex","gap"));void 0!==e&&b("gap","gap",e,"flex-gap")}if(void 0!==(null==(h=t.rowGap)?void 0:h.value)&&Wt(e,"rowGap",v)){const e=oi(t.rowGap.value,t.rowGap.unit,Qt("flex","rowGap"));void 0!==e&&b("rowGap","rowGap",e,"flex-rowGap")}if(void 0!==(null==(p=t.columnGap)?void 0:p.value)&&Wt(e,"columnGap",v)){const e=oi(t.columnGap.value,t.columnGap.unit,Qt("flex","columnGap"));void 0!==e&&b("columnGap","columnGap",e,"flex-columnGap")}return g}(e,t,i));break;case"effects":Object.assign(n,function(e,t,i){var n,o,s,r,l;const a={},{filter:c}=i,d=ni(e,a,i);if(void 0!==(null==(n=t.opacity)?void 0:n.value)&&Wt(e,"opacity",c)){d("opacity","opacity",String(t.opacity.value),"effects-opacity")}if(void 0!==(null==(o=t.boxShadow)?void 0:o.value)&&Wt(e,"boxShadow",c)){d("boxShadow","boxShadow",String(t.boxShadow.value),"effects-boxShadow")}if(void 0!==(null==(s=t.transform)?void 0:s.value)&&Wt(e,"transform",c)){d("transform","transform",String(t.transform.value),"effects-transform")}if(void 0!==(null==(r=t.filter)?void 0:r.value)&&Wt(e,"filter",c)){d("filter","filter",String(t.filter.value),"effects-filter")}if(void 0!==(null==(l=t.rotate)?void 0:l.value)&&Wt(e,"rotate",c)){const e=oi(t.rotate.value,t.rotate.unit,Qt("effects","rotate"));void 0!==e&&d("rotate","rotate",e,"effects-rotate")}return a}(e,t,i));break;default:Object.assign(n,function(e,t,i){const n={},{filter:o}=i,s=ni(e,n,i);for(const[r,l]of Object.entries(t)){if(void 0===(null==l?void 0:l.value))continue;if(!Wt(e,r,o))continue;s(r,r,String(l.value),`${e}-${r}`)}return n}(e,t,i))}return n}function ii(e,t,i={}){if(!t||void 0===t.value)return;const n=function(e,t,i){if(null==t)return;const n=function(e){return Kt[e]}(e);switch(e){case"margin":case"padding":return si(t,i,n??"px");case"borderRadius":case"radius":return ri(t,i,n??"px");case"fontSize":case"letterSpacing":case"borderWidth":case"borderTopWidth":case"borderRightWidth":case"borderBottomWidth":case"borderLeftWidth":case"width":case"height":case"minWidth":case"maxWidth":case"minHeight":case"maxHeight":case"rowGap":case"columnGap":case"gap":case"rotate":return oi(t,i,n)??String(t);case"backgroundImage":case"image":return li(t);default:return String(t)}}(e,t.value,t.unit);return void 0!==n?i.useCSSVar&&i.varName?`var(${i.varName}, ${n})`:n:void 0}function ni(e,t,i){const n=i.outputMode,o=n?n.varPrefix??i.varPrefix??"block":i.varPrefix;return(n,s,r,l)=>{const a=function(e,t,i){const n=i.outputMode;return n?Wt(e,t,n.filter)?n.mode:"properties"===n.mode?"vars":"properties":null}(e,n,i);if("vars"===a)return o?void(t[`--${o}-${l}`]=r):void(t[s]=r);"properties"!==a&&i.useCSSVars?t[s]=`var(--${i.varPrefix}-${l}, ${r})`:t[s]=r}}function oi(e,t,i){if(null==e)return;if("string"==typeof e)return e;const n=t??i;return n?"auto"===n||"none"===n?n:`${e}${n}`:String(e)}function si(e,t,i="px"){if("string"==typeof e)return e;const n=t??i;return"auto"===n||"none"===n?n:"number"==typeof e?`${e}${n}`:`${e.top||0}${n} ${e.right||0}${n} ${e.bottom||0}${n} ${e.left||0}${n}`}function ri(e,t,i="px"){if("string"==typeof e)return e;const n=t??i;return"auto"===n||"none"===n?n:"number"==typeof e?`${e}${n}`:"object"==typeof e?`${e.topLeft||0}${n} ${e.topRight||0}${n} ${e.bottomRight||0}${n} ${e.bottomLeft||0}${n}`:String(e)}function li(e){if(null==e)return;const t=String(e).trim();if(!t)return;const i=t.match(/^url\((.*)\)$/i);let n=t;if(i&&(n=i[1].trim(),(n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))&&(n=n.slice(1,-1))),Ve(n)){const e=qe(n);return e?`url(${e})`:i?t:`url(${n})`}const o=t.toLowerCase();return"none"===o||o.startsWith("url(")||o.startsWith("var(")||o.startsWith("image-set(")||o.includes("gradient(")?t:`url(${t})`}const ai=e("style-resolver");var ci=Object.defineProperty,di=Object.getOwnPropertyDescriptor,ui=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?di(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&ci(t,i,s),s};let hi=class extends Nt{get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Container",icon:'<ha-icon icon="mdi:contain"></ha-icon>',category:"layout"},defaults:{},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{targetStyles:{block:{styles:{preset:"layout"}}}}}getDropZoneResolvedStyleData(e){const t=this.documentModel.resolveEntityForBlock(this.block.id),i=this.renderer.resolveBlockStyles(this.block,this.activeContainerId,{defaultEntityId:t.entityId}),{flex:n}=i??{};return{flex:n}}updated(e){super.updated(e),e.has("block")&&this.block&&(this._ensureDropZone(),this._updateDropZones())}render(){if(!this.block||0===this.block.children.length)return h``;const e=this._getDropZone();return h`
            <div class="container">
                <div class="container-slot">
                    ${this.renderer.renderBlock(e)}
                </div>
            </div>
        `}getBlockedDropInstructions(){return["combine"]}_getDropZone(){return this._getDropZones()[0]??void 0}_ensureDropZone(){if(!this.block)return;if(!this._getDropZone()){const e=this.documentModel.createBlock("block-drop-zone",this.blockId,this.blockRegistry.getDefaults("block-drop-zone"),{label:"Content",isHidden:!0});this.block.children=[e.id]}}};hi.styles=[...De.styles,a`
            .container {
                display: flex;
            }
            .container-slot {
                width: 100%;
            }
        `],ui([n({context:Vt})],hi.prototype,"blockRegistry",2),hi=ui([p("block-container")],hi);var pi=Object.getOwnPropertyDescriptor;const gi={groups:["background","border","flex"],properties:["layout.display","spacing.padding"]};let vi=class extends De{constructor(){super(...arguments),this._handleDropTargetHover=e=>{e&&e.targetElement===this&&this.classList.toggle("dnd-drop-zone-empty",e.active&&!this.shouldShowDropIndicator())}}get isBlockDraggable(){return!1}get isBlockContainer(){return!0}shouldShowDropIndicator(){var e;const t=this.documentModel.getBlock(this.blockId)??this.block;return((null==(e=null==t?void 0:t.children)?void 0:e.length)??0)>0}static getBlockConfig(){return{definition:{label:"Drop Zone",icon:'<ha-icon icon="mdi:download-box-outline"></ha-icon>',internal:!0},defaults:{canBeDeleted:!1,canBeDuplicated:!1,canChangeLayoutMode:!1},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{targetStyles:{block:{styles:this._getParentStyleConfig()??gi}}}}connectedCallback(){super.connectedCallback(),this.eventBus.addEventListener("drop-target-hover",this._handleDropTargetHover)}render(){var e;const t=(null==(e=this.block)?void 0:e.children)||[],i=t.length>0,n=t.map(e=>this.documentModel.getBlock(e)).filter(e=>!!e);return h`
            ${i?b(n,e=>e.id,e=>this.renderer.renderBlock(e)):h`
                        <div class="empty-state">
                            <div class="empty-state-message">
                                Drop Blocks Here
                            </div>
                        </div>`}
        `}getBlockedDropInstructions(){const e=this.documentModel.getBlock(this.blockId),t=this.documentModel.getBlock(e.parentId),i=this.documentModel.getElement(t),n=(null==i?void 0:i.getBlockedDropInstructions())??null;return n&&n.includes("combine")?["reorder-before","reorder-after"]:null}getResolvedContextStyles(){var e;const t=this.documentModel.getBlock(this.blockId)??this.block,i=null==t?void 0:t.parentId,n=this.documentModel.getElement(i),o=null==(e=null==n?void 0:n.getDropZoneResolvedStyleData)?void 0:e.call(n,this.block);return o?ei(o):this.resolvedRenderContext.styles}_getParentStyleConfig(){var e;const t=this.documentModel.getBlock(this.blockId)??this.block,i=null==t?void 0:t.parentId;if(!i)return;const n=this.documentModel.getElement(i);return null==(e=null==n?void 0:n.getDropZoneStyleConfig)?void 0:e.call(n)}};vi.styles=[...De.styles,a`
            :host {
                display: flex;
                flex-direction: column;
                flex: 1;
                min-height: 1px;
                padding: 0;
                width: 100%;
                height: 100%;
                position: relative;
            }

            :host(.dnd-drop-zone-empty) {
                opacity: 0.5;
            }

            /* Empty state - shown only when no children */

            .empty-state {
                min-height: 40px;
                height: 100%;
                padding: 4px;
            }

            .empty-state-message {
                display: flex;
                align-items: center;
                justify-content: center;
                color: black;
                font-size: 10px;
                font-weight: bold;
                text-transform: uppercase;
                background: rgba(0, 0, 0, 0.2);
                text-align: center;
                box-sizing: border-box;
                height: 100%;
            }
        `],vi=((e,t,i,n)=>{for(var o,s=n>1?void 0:n?pi(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(s)||s);return s})([p("block-drop-zone")],vi);var bi=Object.defineProperty,mi=Object.getOwnPropertyDescriptor,fi=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?mi(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&bi(t,i,s),s};let yi=class extends Nt{constructor(){super(...arguments),this._resizeState=null,this._resizeHandleIndex=null,this._handleResizeMove=e=>{if(!this._resizeState||!this.block)return;const t=(e.clientX-this._resizeState.startX)/this._resizeState.containerWidth*100;let i=this._resizeState.startLeft+t,n=this._resizeState.totalPair-i;i<1?(i=1,n=this._resizeState.totalPair-i):n<1&&(n=1,i=this._resizeState.totalPair-n),this._setDropZoneWidthsPercent([{zoneId:this._resizeState.leftId,width:i},{zoneId:this._resizeState.rightId,width:n}]),this._resizeState.currentLeft=i,this._resizeState.currentRight=n,this.requestUpdate()},this._handleResizeEnd=e=>{if(this._resizeState){const t=e.target;(null==t?void 0:t.releasePointerCapture)&&t.releasePointerCapture(e.pointerId)}this._resizeState=null,this._resizeHandleIndex=null,this.requestUpdate(),window.removeEventListener("pointermove",this._handleResizeMove),window.removeEventListener("pointerup",this._handleResizeEnd),window.removeEventListener("pointercancel",this._handleResizeEnd)}}get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Columns",icon:'<ha-icon icon="mdi:view-column-outline"></ha-icon>',category:"layout"},defaults:{props:{columns:{value:2},gap:{value:0}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"layout",label:"Layout",traits:[{type:"number",name:"columns",label:"Columns",min:2,max:12},{type:"number",name:"gap",label:"Gap",min:0,max:100}]}]},targetStyles:{block:{styles:{preset:"layout",exclude:{properties:["flex.flexDirection"]}}}}}}getDropZoneStyleConfig(){return{...gi,properties:["size.width","spacing.padding"]}}getDropZoneResolvedStyleData(e){const t={defaultEntityId:this.documentModel.resolveEntityForBlock(e.id).entityId},i=this.renderer.resolveBlockStyles(e,this.activeContainerId,t),{size:n,...o}=i??{};return o}updated(e){var t;if(super.updated(e),e.has("block")&&this.block){const i=e.get("block"),n=this.resolvePropertyAsNumber("columns",2),o=this.resolveRawValueAsNumber(null==(t=null==i?void 0:i.props)?void 0:t.columns,0);if(!i||o!==n){this._ensureDropZones();const e=this._getDropZones();i&&o!==n&&this._resetDropZoneWidths(e,n)}this._updateDropZones()}}render(){var e;const t=this.resolvePropertyAsNumber("gap",0),i=((null==(e=this.block)?void 0:e.children)||[]).map(e=>this.documentModel.getBlock(e)).filter(e=>!!e),n=ei(this.resolvedRenderContext.resolved,{filter:{only:{categories:["flex"]}},append:{"--columns-gap":`${t}px`}}),o=0===i.length||!i.every(e=>{var t;return null==(t=e.children)?void 0:t.length}),s=i.length>0?100/i.length:0,r=this._resizeState&&this._resizeState.index<i.length-1?(()=>{const e=i.map(e=>this._getDropZoneWidthPercent(e,s)).slice(0,this._resizeState.index).reduce((e,t)=>e+t,0),t=`${this._formatPercent(this._resizeState.currentLeft)}%`,n=`${this._formatPercent(this._resizeState.currentRight)}%`;return h`
                    <div
                            class="column-resize-overlay"
                            style=${u({left:`${e}%`,width:`${this._resizeState.currentLeft}%`})}
                    >
                        <div class="column-resize-overlay__label">${t}</div>
                    </div>
                    <div
                            class="column-resize-overlay"
                            style=${u({left:`${e+this._resizeState.currentLeft}%`,width:`${this._resizeState.currentRight}%`})}
                    >
                        <div class="column-resize-overlay__label">${n}</div>
                    </div>
                `})():null;return h`
            <div class="content ${o?"empty-state":""}" style="${u(n)}">
                ${b(i,e=>e.id,(e,t)=>{const n=this.documentModel.resolveEntityForBlock(e.id),o=this.renderer.resolveBlockStyles(e,this.activeContainerId,{defaultEntityId:n.entityId}),{size:s}=o??{},r=ei({size:s}??{}),l=t<i.length-1,a=this._resizeHandleIndex===t;return h`
                        <div class="column-slot" style=${u(r)}>
                            ${l?h`
                                <div
                                    class="column-resize-handle ${a?"active":""}"
                                    @pointerdown=${e=>this._handleResizeStart(e,t)}
                                ></div>
                            `:null}
                            ${this.renderer.renderBlock(e)}
                        </div>
                    `})}
                ${r}
            </div>
        `}getBlockedDropInstructions(){return["combine"]}_getConfiguredContainerIds(e){var t,i;const n=new Set;n.add(this.containerManager.getDefaultContainerId());for(const o of e){const e=null==(i=null==(t=o.styles)?void 0:t.block)?void 0:i.containers;if(e)for(const t of Object.keys(e))n.add(t)}return Array.from(n)}_resetDropZoneWidths(e,t){var i,n,o;const s=t>0?100/t:0,r=this._getConfiguredContainerIds(e);for(const l of e){const e={};for(const c of r){const t={...(null==(o=null==(n=null==(i=l.styles)?void 0:i.block)?void 0:n.containers)?void 0:o[c])||{}},r={...t.size||{}};r.width={value:this._roundPercent(s),unit:"%"},t.size=r,e[c]=t}const t={...l.styles||{}},a={...t.block||{}};a.containers=e,t.block=a,this.documentModel.updateBlock(l.id,{styles:t})}}_roundPercent(e){return Math.round(1e3*e)/1e3}_formatPercent(e){return e.toFixed(1)}_getDropZoneWidthPercent(e,t){var i;const n=this.documentModel.resolveEntityForBlock(e.id),o=null==(i=this.renderer.resolveBlockStyles(e,this.activeContainerId,{defaultEntityId:n.entityId}).size)?void 0:i.width;if(o){if("%"===o.unit&&"number"==typeof o.value)return o.value;if("string"==typeof o.value&&o.value.endsWith("%")){const e=parseFloat(o.value);if(!Number.isNaN(e))return e}}return t}_setDropZoneWidthsPercent(e){var t,i,n;const o=this.activeContainerId;for(const s of e){const e=this.documentModel.getBlock(s.zoneId);if(!e)continue;const r={...(null==(n=null==(i=null==(t=e.styles)?void 0:t.block)?void 0:i.containers)?void 0:n[o])||{}},l={...r.size||{}};l.width={value:this._roundPercent(s.width),unit:"%"},r.size=l;const a={...e.styles||{}},c={...a.block||{}},d={...c.containers||{}};d[o]=r,c.containers=d,a.block=c,this.documentModel.updateBlock(e.id,{styles:a})}}_handleResizeStart(e,t){var i;if(!this.block)return;const n=null==(i=this.renderRoot)?void 0:i.querySelector(".content");if(!n)return;const o=n.getBoundingClientRect();if(o.width<=0)return;e.preventDefault(),e.stopPropagation();const s=this._getDropZones();if(t<0||t>=s.length-1)return;const r=s.length>0?100/s.length:0,l=s[t],a=s[t+1],c=this._getDropZoneWidthPercent(l,r),d=this._getDropZoneWidthPercent(a,r);this._resizeState={index:t,startX:e.clientX,containerWidth:o.width,startLeft:c,startRight:d,totalPair:c+d,leftId:l.id,rightId:a.id,currentLeft:c,currentRight:d},this._resizeHandleIndex=t,this.requestUpdate();const u=e.currentTarget;(null==u?void 0:u.setPointerCapture)&&u.setPointerCapture(e.pointerId),window.addEventListener("pointermove",this._handleResizeMove),window.addEventListener("pointerup",this._handleResizeEnd),window.addEventListener("pointercancel",this._handleResizeEnd)}_ensureDropZones(){if(!this.block)return;const e=this.resolvePropertyAsNumber("columns",2),t=this.block.children||[];if(t.length<e){const i=e-t.length,n=t.length,o={};o[this.activeContainerId]={size:{width:{value:this._roundPercent(100/e),unit:"%"}}};for(let e=0;e<i;e++)this.documentModel.createBlock("block-drop-zone",this.blockId,this.blockRegistry.getDefaults("block-drop-zone"),{label:`Column ${n+e+1}`,props:{columnIndex:n+e},styles:{block:{containers:o}}})}else if(t.length>e){t.slice(e).forEach(e=>this.documentModel.deleteBlock(e,!0))}const i=this.documentModel.getBlock(this.block.id);(null==i?void 0:i.children)&&i.children.forEach((e,t)=>{const i=this.documentModel.getBlock(e);if(!i)return;i.props.columnIndex!==t&&this.documentModel.updateBlock(e,{props:{...i.props||{},columnIndex:t}})})}};yi.styles=[...De.styles,a`
            .content {
                display: flex;
                flex-direction: row;
                gap: var(--columns-gap, 0);
                position: relative;
                height: 100%;
            }

            .column-slot {
                display: flex;
                flex-direction: column;
                min-width: 0;
                position: relative;
            }

            .column-resize-handle {
                position: absolute;
                top: 0;
                right: calc(min(var(--columns-gap, 0px), 5px) / -2);
                width: 10px;
                height: 100%;
                cursor: col-resize;
                touch-action: none;
                z-index: 200;
            }

            .column-resize-handle::before {
                content: '';
                position: absolute;
                left: 100%;
                top: 0;
                width: 2px;
                height: 100%;
                background: var(--accent-color, #ddd);
                opacity: 0;
                transform: translateX(-50%);
            }

            .column-resize-handle:hover::before,
            .column-resize-handle.active::before {
                opacity: 1;
            }

            .column-resize-overlay {
                position: absolute;
                top: 0;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.08);
                pointer-events: none;
                z-index: 250;
            }

            .column-resize-overlay__label {
                padding: 6px 10px;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(0, 0, 0, 0.08);
                font-size: 12px;
                font-weight: 600;
                color: var(--primary-text-color, #111);
            }

            :host(.block-selected) .content {
                box-shadow: 0 0 1px 1px var(--border-color, #ddd);
            }
        `],fi([n({context:Vt})],yi.prototype,"blockRegistry",2),yi=fi([p("block-columns")],yi);var ki=Object.defineProperty,_i=Object.getOwnPropertyDescriptor,xi=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?_i(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&ki(t,i,s),s};const Si={rows:2,columns:2,rowSizes:[{value:1,unit:"fr"},{value:1,unit:"fr"}],columnSizes:[{value:1,unit:"fr"},{value:1,unit:"fr"}],areas:[],gap:{row:0,column:0}};let wi=class extends Nt{constructor(){super(...arguments),this._onBlockUpdated=e=>{const t=e.detail,i=t.block;"block-drop-zone"===i.type&&i.parentId===this.block.id&&this._handleDropZoneLabelUpdate(t.block)}}get isBlockContainer(){return!0}static getBlockConfig(){return{definition:{label:"Grid",icon:'<ha-icon icon="mdi:grid"></ha-icon>',category:"layout"},defaults:{props:{gridConfig:{...Si}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){return{properties:{groups:[{id:"grid-editor",label:"Grid Layout",traits:[{type:"action",name:"editGrid",label:"Grid Editor",buttonLabel:"Edit Grid Layout",actionId:"open-grid-editor",icon:""},{type:"info",name:"gridInfo",label:"Grid Info",description:"Configure grid rows, columns and areas"}]}]},targetStyles:{block:{styles:{preset:"layout"}}}}}connectedCallback(){super.connectedCallback(),this.documentModel.addEventListener("block-updated",this._onBlockUpdated)}disconnectedCallback(){this.documentModel.removeEventListener("block-updated",this._onBlockUpdated),super.disconnectedCallback()}updated(e){super.updated(e),e.has("block")&&this.block&&(this._ensureDropZones(),this._updateDropZones())}render(){var e,t;const i=(null==(e=this.block)?void 0:e.props.gridConfig)||Si,n=((null==(t=this.block)?void 0:t.children)||[]).map(e=>this.documentModel.getBlock(e)).filter(e=>!!e),o=0===n.length||!n.every(e=>{var t;return null==(t=e.children)?void 0:t.length}),s={gridTemplateRows:et(i.rowSizes),gridTemplateColumns:et(i.columnSizes),gap:`${i.gap.row}px ${i.gap.column}px`};if(i.areas.length>0){const e=function(e,t,i){if(0===e.length)return"";const n=[];for(let o=0;o<t;o++){n[o]=[];for(let e=0;e<i;e++)n[o][e]="."}return e.forEach(e=>{for(let o=e.rowStart;o<e.rowEnd;o++)for(let s=e.columnStart;s<e.columnEnd;s++)o<t&&s<i&&(n[o][s]=e.id)}),n.map(e=>`"${e.join(" ")}"`).join("\n    ")}(i.areas,i.rows,i.columns);e&&(s.gridTemplateAreas=e)}return h`
      <div class="grid-content ${o?"empty-state":""}" style=${u(s)}>
        ${b(n,e=>e.id,e=>{const t={gridArea:e.props.areaId||e.props.gridArea};return h`
              <div class="grid-zone" style=${u(t)}>
                ${this.renderer.renderBlock(e)}
              </div>
            `})}
      </div>
    `}getBlockedDropInstructions(){return["combine"]}_ensureDropZones(){const e=this.block.props.gridConfig||Si,t=e.areas||[],i=t.length>0?t.length:e.rows*e.columns,n=this.block.children||[];if(n.length<i){const o=i-n.length;for(let i=0;i<o;i++){const n=i,o={zoneIndex:n};let s=`Grid Area ${n+1}`;const r=t.length>0?t[n]:void 0;if(r)o.areaName=r.name,o.gridArea=r.name,s=r.name;else{const t=Math.floor(n/e.columns),i=n%e.columns;o.row=t,o.column=i,o.gridArea=`${t+1} / ${i+1} / span 1 / span 1`}this.documentModel.createBlock("block-drop-zone",this.blockId,this.blockRegistry.getDefaults("block-drop-zone"),{label:s,props:o})}}else if(n.length>i){n.slice(i).forEach(e=>this.documentModel.deleteBlock(e,!0))}n.forEach((i,n)=>{const o=this.documentModel.getBlock(i);if(!o)return;const s={zoneIndex:n},r=t.length>0?t[n]:void 0;if(r)s.areaId=r.id,s.areaName=r.name,s.gridArea=r.name;else{const t=Math.floor(n/e.columns),i=n%e.columns;s.areaId=void 0,s.areaName=void 0,s.row=t,s.column=i,s.gridArea=`${t+1} / ${i+1} / span 1 / span 1`}const l=Object.keys(s).some(e=>o.props[e]!==s[e]),a=r&&o.label!==r.name;if(l||a){const e={};l&&(e.props=s),a&&(e.label=null==r?void 0:r.name),this.documentModel.updateBlock(i,e)}})}_handleDropZoneLabelUpdate(e){var t;const i=this.block.props.gridConfig||Si;if(!i.areas.length)return;const n="number"==typeof e.props.zoneIndex?e.props.zoneIndex:this.block.children.indexOf(e.id);if(n<0||n>=i.areas.length)return;const o=null==(t=e.label)?void 0:t.trim();if(!o)return;const s=i.areas[n];if(!s||s.name===o)return;const r=i.areas.map((e,t)=>t===n?{...e,name:o}:e);this.documentModel.updateBlock(this.block.id,{props:{gridConfig:{...i,areas:r}}})}};wi.styles=[...De.styles,a`
            .grid-content {
                display: grid;
            }

            .grid-zone {
                display: flex;
                flex-direction: column;
                min-width: 0;
                min-height: 0;
                position: relative;
            }
        `],xi([n({context:Vt})],wi.prototype,"blockRegistry",2),wi=xi([p("block-grid")],wi);const Ii={type:"line"};function Pi(e){return Number.isNaN(e)?0:Math.min(100,Math.max(0,e))}function Ai(e,t){const i=Math.max(0,e.length-1),n=(t||[]).slice(0,i).map(e=>({...e}));for(;n.length<i;)n.push({...Ii});return n}function Ti(e){return{...e,x:Pi(e.x),y:Pi(e.y)}}const Ci={showGrid:!1,snapToGrid:!1,snapToPoints:!1,snapToBlocks:!1,showPoints:!0};function Ei(e){return{...Ci,...e??{}}}const Mi=e("link-editor-preferences");class Li{constructor(e){this.activeLinkId=null,this.linkElement=null,this.drawListenersAttached=!1,this.pickListenerAttached=!1,this.attachRetryHandle=null,this.dragListenersAttached=!1,this.dragging=null,this.snapGuideBlockId=null,this.preferences={...Ci},this.snapBlocksCache=null,this.pathDragging=null,this._handleLinkModeChanged=e=>{const t=e.detail;this._applyState((null==t?void 0:t.state)??{enabled:!1,mode:"idle",activeLinkId:null})},this._handleLinkSelectionChanged=e=>{const t=e.detail;this._syncAnchorHighlight((null==t?void 0:t.selection)??null)},this._handleBlockDeleted=e=>{const t=e.detail;(null==t?void 0:t.blockId)&&(this.activeLinkId&&t.blockId===this.activeLinkId&&this.closeEditor(),this._cleanupAnchorsForDeletedBlock(t.blockId))},this._handleLinkPointerDown=e=>{if(!this.state.enabled||"draw"!==this.state.mode||!this.activeLinkId)return;if(0!==e.button)return;if(!this.linkElement)return;const t=this._getNormalizedFromEvent(e,this.linkElement);if(!t)return;const i=this._getConnectedPointIdsForDraw(this.activeLinkId),n=this._applySnapping(this.activeLinkId,t,{connectedPointIds:i});this._emitSnapGuide(this.activeLinkId,n.guide),this._addPoint(this.activeLinkId,n.point),this.documentModel.select(this.activeLinkId),e.stopPropagation(),e.preventDefault()},this._handleLinkPointerMove=e=>{if(!this.state.enabled||"draw"!==this.state.mode||!this.activeLinkId)return;if(!this.linkElement)return;const t=this._getNormalizedFromEvent(e,this.linkElement);if(!t)return;const i=this._getConnectedPointIdsForDraw(this.activeLinkId),n=this._applySnapping(this.activeLinkId,t,{connectedPointIds:i});this._emitSnapGuide(this.activeLinkId,n.guide),this.eventBus.dispatchEvent("link-preview-move",{blockId:this.activeLinkId,point:n.point})},this._handleLinkPointerLeave=()=>{this.state.enabled&&"draw"===this.state.mode&&(this.eventBus.dispatchEvent("link-preview-clear",{blockId:this.activeLinkId??void 0}),this._clearSnapGuide())},this._handleLinkContextMenu=e=>{this.state.enabled&&"draw"===this.state.mode&&(e.preventDefault(),e.stopPropagation(),this._finishDrawing())},this._handlePickAnchor=e=>{if(!this.state.enabled||"pick-anchor"!==this.state.mode)return;if(0!==e.button)return e.stopPropagation(),void e.preventDefault();if(!this.activeLinkId||!this.state.anchorPickPointId)return e.stopPropagation(),void e.preventDefault();const t=this._getBlockIdFromEvent(e);if(!t||t===this.activeLinkId)return e.stopPropagation(),void e.preventDefault();this._applyAnchorPick(this.activeLinkId,this.state.anchorPickPointId,t),this.documentModel.setLinkModeState({mode:"edit",anchorPickPointId:null}),e.stopPropagation(),e.preventDefault()},this._handleDragMove=e=>{if(this.pathDragging){const{blockId:t,start:i,points:n,startClient:o}=this.pathDragging;if(!this._isEditingActive(t)||"edit"!==this.state.mode)return void(this.pathDragging=null);const s=this._getNormalizedFromEventForLink(t,e);if(!s)return;const r=Math.hypot(e.clientX-o.x,e.clientY-o.y);if(!this.pathDragging.moved){if(r<3)return;this.pathDragging.moved=!0}const l={x:s.x-i.x,y:s.y-i.y},a=this._applyDeltaToPoints(t,n,l);return void this._updateGeometry(t,a)}if(!this.dragging)return;const{blockId:t,pointId:i,handle:n}=this.dragging;if(!this._isEditingActive(t))return void this._endDrag();const o=this._getNormalizedFromEventForLink(t,e);if(!o)return;if(!n){const e=this._applySnapping(t,o,{excludePointId:i,currentPointId:i});return this._emitSnapGuide(t,e.guide),void this._updatePointPosition(t,i,e.point)}const s=this._applySnapping(t,o,{includeHandles:!0,excludeHandle:{pointId:i,handle:n},currentPointId:i});this._emitSnapGuide(t,s.guide),this._updateHandlePosition(t,i,n,s.point)},this._handleDragEnd=()=>{this.pathDragging&&!this.pathDragging.moved&&this._selectSegmentAtPoint(this.pathDragging.blockId,this.pathDragging.start),this._endDrag(),this.pathDragging=null,this._clearSnapGuide()},this.documentModel=e.documentModel,this.eventBus=e.eventBus,this.blockRegistry=e.blockRegistry,e.preferences&&(this.preferences={...e.preferences}),this.state=this.documentModel.getLinkModeState(),this.activeLinkId=this.state.activeLinkId??null,this.documentModel.addEventListener("link-mode-changed",this._handleLinkModeChanged),this.documentModel.addEventListener("block-deleted",this._handleBlockDeleted),this.documentModel.addEventListener("link-editor-selection-changed",this._handleLinkSelectionChanged),this._applyState(this.state)}destroy(){this.documentModel.removeEventListener("link-mode-changed",this._handleLinkModeChanged),this.documentModel.removeEventListener("block-deleted",this._handleBlockDeleted),this.documentModel.removeEventListener("link-editor-selection-changed",this._handleLinkSelectionChanged),this._detachDrawListeners(),this._detachPickListener(),this._detachOutsideListener(),this._detachDragListeners(),this._cancelLinkElementRetry(),this.eventBus.dispatchEvent("link-preview-clear",{blockId:this.activeLinkId??void 0}),this._clearSnapGuide(),this.documentModel.setLinkAnchorHighlight(null)}setPreferences(e){this.preferences={...e}}toggleLinkMode(){this.state.enabled?this.closeEditor():this.startNewLink()}startNewLink(){const e=this._createLinkBlock();e&&(this.documentModel.select(e.id),this.documentModel.setLinkModeState({enabled:!0,mode:"draw",activeLinkId:e.id,anchorPickPointId:null}),this.documentModel.setLinkEditorSelection({blockId:e.id,pointId:null,segmentIndex:null,handle:null}),this.eventBus.dispatchEvent("link-editor-open",{blockId:e.id}))}openEditor(e){const t=this.documentModel.getBlock(e);t&&"block-link"===t.type&&(this.documentModel.select(e),this.documentModel.setLinkModeState({enabled:!0,mode:"edit",activeLinkId:e,anchorPickPointId:null}),this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:null,handle:null}),this.eventBus.dispatchEvent("link-editor-open",{blockId:e}))}closeEditor(){this.documentModel.setLinkModeState({enabled:!1,mode:"idle",activeLinkId:null,anchorPickPointId:null}),this.documentModel.setLinkEditorSelection({blockId:null,pointId:null,segmentIndex:null,handle:null}),this.eventBus.dispatchEvent("link-editor-close"),this.eventBus.dispatchEvent("link-preview-clear",{blockId:this.activeLinkId??void 0}),this._clearSnapGuide(),this.pathDragging=null}finishDrawing(){this._finishDrawing()}selectPoint(e,t){this.documentModel.setLinkEditorSelection({blockId:e,pointId:t,segmentIndex:null,handle:null})}selectSegment(e,t){this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:t,handle:null})}startPathDrag(e,t){if(!this._isEditingActive(e)||"edit"!==this.state.mode)return;if(0!==t.button)return;const i=this._getNormalizedFromEventForLink(e,t);if(!i)return;const n=this.documentModel.getBlock(e);n&&(this.pathDragging={blockId:e,start:i,startClient:{x:t.clientX,y:t.clientY},moved:!1,points:this._getLinkPoints(n).map(e=>({...e}))},this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:null,handle:null}),this._attachDragListeners(),t.stopPropagation(),t.preventDefault())}updateProp(e,t,i){this.documentModel.updateBlock(e,{props:{[t]:{value:i}}})}updatePointCoordinate(e,t,i,n){const o=this.documentModel.getBlock(e);if(!o)return;const s=this._getLinkPoints(o).map(o=>{var s;if(o.id!==t)return o;const r=Pi(n),l={...o,[i]:r};if(null==(s=o.anchor)?void 0:s.blockId){const t=this._getAnchorBaseForLink(e,o.anchor.blockId,o.anchor.anchor||"middle-center");if(t){const e="x"===i?r:o.x,n="y"===i?r:o.y;l.anchor={...o.anchor,offset:{x:this._clampOffset(e-t.x),y:this._clampOffset(n-t.y)}}}}return l}),r=this._applyCurveAutoUpdate(e,s,t);this._updateGeometry(e,r)}toggleAnchor(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;if(i)return void this.enterAnchorPick(e,t);const o=this._getLinkPoints(n).map(i=>{if(i.id!==t)return i;const n=this._resolvePointPosition(e,i);return{...i,x:n.x,y:n.y,anchor:void 0}});this._updateGeometry(e,o),this.documentModel.setLinkModeState({mode:"edit",anchorPickPointId:null}),this._syncAnchorHighlight(this.documentModel.getLinkEditorSelection())}enterAnchorPick(e,t){this.documentModel.setLinkEditorSelection({blockId:e,pointId:t,segmentIndex:null,handle:null}),this.documentModel.setLinkModeState({enabled:!0,mode:"pick-anchor",activeLinkId:e,anchorPickPointId:t})}updateAnchorPoint(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n).map(n=>{var o;if(n.id!==t)return n;if(null==(o=n.anchor)?void 0:o.blockId){const t=this._resolvePointPosition(e,n),o=this._getAnchorBaseForLink(e,n.anchor.blockId,i);if(o)return{...n,anchor:{...n.anchor,anchor:i,offset:{x:this._clampOffset(t.x-o.x),y:this._clampOffset(t.y-o.y)}}}}return{...n,anchor:{...n.anchor||{blockId:""},anchor:i}}});this._updateGeometry(e,o),this._syncAnchorHighlight(this.documentModel.getLinkEditorSelection())}updateAnchorOffset(e,t,i,n){const o=this.documentModel.getBlock(e);if(!o)return;const s=this._getLinkPoints(o).map(e=>{var o;if(e.id!==t)return e;const s=(null==(o=e.anchor)?void 0:o.offset)??{x:0,y:0};return{...e,anchor:{...e.anchor||{blockId:""},offset:{...s,[i]:this._clampOffset(n)}}}});this._updateGeometry(e,s)}setSegmentType(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n),s=Ai(o,this._getLinkSegments(n)).map((e,n)=>n!==t?e:"curve"===i?{...e,type:i,curvePreset:e.curvePreset??"smooth",curveBulge:"number"==typeof e.curveBulge?e.curveBulge:.25,curveAutoUpdate:Boolean(e.curveAutoUpdate??!1)}:{type:i});let r=o;"curve"===i&&(r=this._applyCurvePreset(e,o,t,s[t])),this._updateGeometry(e,r,s)}setSegmentCurvePreset(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n),s=Ai(o,this._getLinkSegments(n));if(t<0||t>=s.length)return;const r=s.map((e,n)=>n===t?{...e,type:"curve",curvePreset:i,curveBulge:"number"==typeof e.curveBulge?e.curveBulge:.25,curveAutoUpdate:Boolean(e.curveAutoUpdate??!1)}:e),l=this._applyCurvePreset(e,o,t,r[t]);this._updateGeometry(e,l,r)}setSegmentCurveBulge(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n),s=Ai(o,this._getLinkSegments(n));if(t<0||t>=s.length)return;const r=s.map((e,n)=>n===t?{...e,type:"curve",curveBulge:this._clampBulge(i),curvePreset:e.curvePreset??"arc",curveAutoUpdate:Boolean(e.curveAutoUpdate??!1)}:e),l=this._applyCurvePreset(e,o,t,r[t]);this._updateGeometry(e,l,r)}setSegmentCurveAutoUpdate(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n),s=Ai(o,this._getLinkSegments(n));if(t<0||t>=s.length)return;const r=s.map((e,n)=>n===t?{...e,type:"curve",curveAutoUpdate:i,curvePreset:e.curvePreset??"smooth",curveBulge:"number"==typeof e.curveBulge?e.curveBulge:.25}:e);let l=o;i&&"manual"!==r[t].curvePreset&&(l=this._applyCurvePreset(e,o,t,r[t])),this._updateGeometry(e,l,r)}deletePoint(e,t){const i=this.documentModel.getBlock(e);if(!i)return;const n=this._getLinkPoints(i);if(n.length<=2)return;const o=n.findIndex(e=>e.id===t);if(-1===o)return;const s=n.filter(e=>e.id!==t),r=[...Ai(n,this._getLinkSegments(i))];0===o?r.splice(0,1):r.splice(o-1,1),this._updateGeometry(e,s,r),this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:null,handle:null})}handleLineContextMenu(e,t){if(!this._isEditingActive(e))return;if("draw"===this.state.mode)return;t.preventDefault(),t.stopPropagation();const i=this._getNormalizedFromEventForLink(e,t);if(!i)return;const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n);if(o.length<2)return;const s=this._getResolvedPoints(e),r=this._getRenderScaleForLink(e),l=r?this._getRenderPointFromEvent(e,t):i;if(!l)return;const a=r?this._toRenderPoints(s,r):s,c=this._findNearestSegment(a,l),d={id:this._generateLinkPointId(),x:i.x,y:i.y},u=[...o];u.splice(c+1,0,d);const h=[...Ai(o,this._getLinkSegments(n))];h.splice(c,1,{type:"line"},{type:"line"}),this._updateGeometry(e,u,h),this.documentModel.setLinkEditorSelection({blockId:e,pointId:d.id,segmentIndex:null,handle:null})}handlePointContextMenu(e,t,i){this._isEditingActive(e)&&(t.preventDefault(),t.stopPropagation(),this.deletePoint(e,i))}startPointDrag(e,t,i){this._isEditingActive(e)&&(t.stopPropagation(),this.dragging={blockId:e,pointId:i},this._clearSnapGuide(e),this.documentModel.setLinkEditorSelection({blockId:e,pointId:i,segmentIndex:null,handle:null}),this._attachDragListeners())}startHandleDrag(e,t,i,n){this._isEditingActive(e)&&(t.stopPropagation(),this.dragging={blockId:e,pointId:i,handle:n},this._clearSnapGuide(e),this.documentModel.setLinkEditorSelection({blockId:e,pointId:i,segmentIndex:null,handle:n}),this._attachDragListeners())}_syncAnchorHighlight(e){var t;if(!e||!e.blockId||!e.pointId)return void this.documentModel.setLinkAnchorHighlight(null);if(!this.state.enabled||"edit"!==this.state.mode)return void this.documentModel.setLinkAnchorHighlight(null);if(!this.activeLinkId||e.blockId!==this.activeLinkId)return void this.documentModel.setLinkAnchorHighlight(null);const i=this.documentModel.getBlock(e.blockId);if(!i)return void this.documentModel.setLinkAnchorHighlight(null);const n=this._getLinkPoints(i).find(t=>t.id===e.pointId),o=(null==(t=null==n?void 0:n.anchor)?void 0:t.blockId)??null;this.documentModel.setLinkAnchorHighlight(o)}_applyState(e){const t=this.activeLinkId;this.state=e,this.activeLinkId=e.activeLinkId??null,t&&this.activeLinkId!==t&&(this.pathDragging=null),e.enabled&&e.activeLinkId||(this.snapBlocksCache=null),e.enabled&&"edit"===e.mode?this._syncAnchorHighlight(this.documentModel.getLinkEditorSelection()):this.documentModel.setLinkAnchorHighlight(null),this._syncDrawListeners(),this._syncPickListener(),this.dragging&&!this._isEditingActive(this.dragging.blockId)&&this._endDrag(),e.enabled&&"draw"===e.mode||this.eventBus.dispatchEvent("link-preview-clear",{blockId:e.activeLinkId??void 0}),e.enabled&&e.activeLinkId||(this.pathDragging=null)}_syncDrawListeners(){if(!Boolean(this.state.enabled&&"draw"===this.state.mode&&this.activeLinkId))return this._detachDrawListeners(),this._detachOutsideListener(),this._cancelLinkElementRetry(),void(this.linkElement=null);const e=this._getActiveLinkElement();e?(this.linkElement!==e&&(this._detachDrawListeners(),this.linkElement=e),this._attachDrawListeners(),this._attachOutsideListener()):this._scheduleLinkElementRetry()}_syncPickListener(){Boolean(this.state.enabled&&"pick-anchor"===this.state.mode&&this.activeLinkId&&this.state.anchorPickPointId)?this._attachPickListener():this._detachPickListener()}_attachDrawListeners(){!this.drawListenersAttached&&this.linkElement&&(this.linkElement.addEventListener("pointerdown",this._handleLinkPointerDown),this.linkElement.addEventListener("pointermove",this._handleLinkPointerMove),this.linkElement.addEventListener("pointerleave",this._handleLinkPointerLeave),this.linkElement.addEventListener("contextmenu",this._handleLinkContextMenu),this.drawListenersAttached=!0)}_detachDrawListeners(){this.drawListenersAttached&&this.linkElement&&(this.linkElement.removeEventListener("pointerdown",this._handleLinkPointerDown),this.linkElement.removeEventListener("pointermove",this._handleLinkPointerMove),this.linkElement.removeEventListener("pointerleave",this._handleLinkPointerLeave),this.linkElement.removeEventListener("contextmenu",this._handleLinkContextMenu),this.drawListenersAttached=!1)}_attachOutsideListener(){}_detachOutsideListener(){}_scheduleLinkElementRetry(){null===this.attachRetryHandle&&(this.attachRetryHandle=window.requestAnimationFrame(()=>{this.attachRetryHandle=null,this.state.enabled&&"draw"===this.state.mode&&this.activeLinkId&&this._syncDrawListeners()}))}_cancelLinkElementRetry(){null!==this.attachRetryHandle&&(window.cancelAnimationFrame(this.attachRetryHandle),this.attachRetryHandle=null)}_attachPickListener(){this.pickListenerAttached||(document.addEventListener("pointerdown",this._handlePickAnchor,!0),this.pickListenerAttached=!0)}_detachPickListener(){this.pickListenerAttached&&(document.removeEventListener("pointerdown",this._handlePickAnchor,!0),this.pickListenerAttached=!1)}_finishDrawing(){this.state.enabled&&"draw"===this.state.mode&&(this.documentModel.setLinkModeState({mode:"edit",anchorPickPointId:null}),this.eventBus.dispatchEvent("link-preview-clear",{blockId:this.activeLinkId??void 0}),this._clearSnapGuide())}_addPoint(e,t){const i=this.documentModel.getBlock(e);if(!i)return;const n=this._getLinkPoints(i),o=this._getLinkSegments(i),s={id:this._generateLinkPointId(),x:Pi(t.x),y:Pi(t.y)},r=[...n,s],l=Ai(r,o);this.documentModel.updateBlock(e,{props:{points:r,segments:l}}),this.documentModel.setLinkEditorSelection({blockId:e,pointId:s.id,segmentIndex:null,handle:null})}_applyAnchorPick(e,t,i){var n;const o=this.documentModel.getBlock(e);if(!o)return;const s=this._getLinkPoints(o),r=s.findIndex(e=>e.id===t);if(-1===r)return;const l=(null==(n=s[r].anchor)?void 0:n.anchor)||"middle-center",a=this._resolvePointPosition(e,s[r]),c=this._getAnchorBaseForLink(e,i,l);if(!c)return;const d={x:this._clampOffset(a.x-c.x),y:this._clampOffset(a.y-c.y)},u={...s[r],anchor:{blockId:i,anchor:l,offset:d}},h=[...s];h[r]=u,this.documentModel.updateBlock(e,{props:{points:h}}),this.documentModel.setLinkEditorSelection({blockId:e,pointId:u.id,segmentIndex:null,handle:null}),this._syncAnchorHighlight({blockId:e,pointId:u.id,segmentIndex:null,handle:null})}_attachDragListeners(){this.dragListenersAttached||(window.addEventListener("pointermove",this._handleDragMove),window.addEventListener("pointerup",this._handleDragEnd),window.addEventListener("pointercancel",this._handleDragEnd),this.dragListenersAttached=!0)}_detachDragListeners(){this.dragListenersAttached&&(window.removeEventListener("pointermove",this._handleDragMove),window.removeEventListener("pointerup",this._handleDragEnd),window.removeEventListener("pointercancel",this._handleDragEnd),this.dragListenersAttached=!1)}_endDrag(){this.dragging=null,this._detachDragListeners()}_applyDeltaToPoints(e,t,i){return t.map(t=>{var n;const o=this._resolvePointPosition(e,t),s=Pi(o.x+i.x),r=Pi(o.y+i.y),l={...t,x:s,y:r};if(null==(n=t.anchor)?void 0:n.blockId){const i=this._getAnchorBaseForLink(e,t.anchor.blockId,t.anchor.anchor||"middle-center");i&&(l.anchor={...t.anchor,offset:{x:this._clampOffset(s-i.x),y:this._clampOffset(r-i.y)}})}return l})}_selectSegmentAtPoint(e,t){if(!this._isEditingActive(e))return;if("edit"!==this.state.mode)return;const i=this._getResolvedPoints(e);if(i.length<2)return;const n=this._getRenderScaleForLink(e);if(n){const o=this._toRenderPoints(i,n),s={x:t.x*n.sx,y:t.y*n.sy},r=this._findNearestSegment(o,s);return void this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:r,handle:null})}const o=this._findNearestSegment(i,t);this.documentModel.setLinkEditorSelection({blockId:e,pointId:null,segmentIndex:o,handle:null})}_createLinkBlock(){const e=this.blockRegistry.getDefaults("block-link");if(!e)return null;const t=this.blockRegistry.getEntityDefaults("block-link");return this.documentModel.createBlock("block-link",this.documentModel.rootId,{...e,entityConfig:{mode:t.mode||"inherited",slotId:t.slotId}},{layout:"static"})}_updateGeometry(e,t,i){const n={points:t};i&&(n.segments=i),this.documentModel.updateBlock(e,{props:n})}_applyCurvePreset(e,t,i,n){if("curve"!==n.type)return t;const o=n.curvePreset??"smooth";if("manual"===o)return t;const s=t[i],r=t[i+1];if(!s||!r)return t;const l=this._resolvePointPosition(e,s),a=this._resolvePointPosition(e,r);let c={x:0,y:0},d={x:0,y:0};if("smooth"===o){const n=t[i-1]??s,o=t[i+2]??r,u=this._resolvePointPosition(e,n),h=this._resolvePointPosition(e,o),p=1/6,g={x:l.x+(a.x-u.x)*p,y:l.y+(a.y-u.y)*p},v={x:a.x-(h.x-l.x)*p,y:a.y-(h.y-l.y)*p};c={x:g.x-l.x,y:g.y-l.y},d={x:v.x-a.x,y:v.y-a.y}}else if("arc"===o||"symmetric"===o){const e=a.x-l.x,t=a.y-l.y,i=Math.hypot(e,t);if(i>0){const s=-t/i,r=e/i,l=i*(1/3),a=this._clampBulge(n.curveBulge??.25)*i*("arc"===o?.35:.2);c={x:e*(l/i)+s*a,y:t*(l/i)+r*a},d={x:l/i*-e+s*a,y:l/i*-t+r*a}}}const u=t.map(e=>({...e}));return u[i]={...u[i],handleOut:c},u[i+1]={...u[i+1],handleIn:d},u}_clampBulge(e){return Number.isNaN(e)?0:Math.max(-1,Math.min(1,e))}_applyCurveAutoUpdate(e,t,i){const n=t.findIndex(e=>e.id===i);if(-1===n)return t;const o=this.documentModel.getBlock(e);if(!o)return t;const s=Ai(t,this._getLinkSegments(o));let r=t;const l=t=>{if(t<0||t>=s.length)return;const i=s[t];i&&"curve"===i.type&&"manual"!==i.curvePreset&&i.curveAutoUpdate&&(r=this._applyCurvePreset(e,r,t,i))};return l(n-1),l(n),r}_getLinkPoints(e){var t;const i=null==(t=e.props)?void 0:t.points;return Array.isArray(i)?i:[]}_getLinkSegments(e){var t;const i=null==(t=e.props)?void 0:t.segments;return Array.isArray(i)?i:[]}_getPropValue(e,t,i){var n;const o=this.documentModel.getBlock(e),s=null==(n=null==o?void 0:o.props)?void 0:n[t];return s&&"object"==typeof s&&"value"in s?s.value??i:i}_resolvePointPosition(e,t){var i;if(null==(i=t.anchor)?void 0:i.blockId){const i=this._getAnchorBaseForLink(e,t.anchor.blockId,t.anchor.anchor||"middle-center");if(i){const e=t.anchor.offset??{x:t.x-i.x,y:t.y-i.y};return{x:Pi(i.x+e.x),y:Pi(i.y+e.y)}}}return{x:Pi(t.x),y:Pi(t.y)}}_getResolvedPoints(e){const t=this.documentModel.getBlock(e);return t?this._getLinkPoints(t).map(t=>({...t,...this._resolvePointPosition(e,t)})):[]}_updatePointPosition(e,t,i){const n=this.documentModel.getBlock(e);if(!n)return;const o=this._getLinkPoints(n).map(n=>{var o;if(n.id!==t)return n;const s={...n,x:i.x,y:i.y};if(null==(o=n.anchor)?void 0:o.blockId){const t=this._getAnchorBaseForLink(e,n.anchor.blockId,n.anchor.anchor||"middle-center");if(t){const e={x:this._clampOffset(i.x-t.x),y:this._clampOffset(i.y-t.y)};s.anchor={...n.anchor,offset:e}}}return Ti(s)}),s=this._applyCurveAutoUpdate(e,o,t);this._updateGeometry(e,s)}_updateHandlePosition(e,t,i,n){const o=this.documentModel.getBlock(e);if(!o)return;const s=this._getLinkPoints(o),r=Ai(s,this._getLinkSegments(o));let l=!1;const a=r.map((e,n)=>{var o,r;if("curve"!==e.type||"manual"===e.curvePreset)return e;return"out"===i&&(null==(o=s[n])?void 0:o.id)===t||"in"===i&&(null==(r=s[n+1])?void 0:r.id)===t?(l=!0,{...e,curvePreset:"manual",curveAutoUpdate:!1}):e}),c=s.map(e=>{if(e.id!==t)return e;const o={x:n.x-e.x,y:n.y-e.y};return"in"===i?{...e,handleIn:o}:{...e,handleOut:o}});this._updateGeometry(e,c,l?a:void 0)}_getAnchorBaseForLink(e,t,i){const n=this._getReferenceRect(e);if(!n)return null;if(!this.documentModel.getBlock(t))return null;const o=this.documentModel.getElement(t);if(!o)return null;const s=o.getBoundingClientRect();if(!n.width||!n.height)return null;const r=this._getAnchorOffset(i,s);return{x:Pi((r.x-n.left)/n.width*100),y:Pi((r.y-n.top)/n.height*100)}}_getReferenceRect(e){const t=this.documentModel.getElement(e)??this._getActiveLinkElement();return t?t.getBoundingClientRect():null}_getAnchorOffset(e,t){const i={left:t.left,center:t.left+t.width/2,right:t.right},n={top:t.top,middle:t.top+t.height/2,bottom:t.bottom},[o,s]=e.split("-");return{x:i[s],y:n[o]}}_cleanupAnchorsForDeletedBlock(e){this.documentModel.getLinkAnchorHighlight().blockId===e&&this.documentModel.setLinkAnchorHighlight(null);const t=Object.values(this.documentModel.blocks);for(const i of t){if(!i||"block-link"!==i.type)continue;const t=this._getLinkPoints(i);let n=!1;const o=t.map(t=>{var o;if((null==(o=t.anchor)?void 0:o.blockId)!==e)return t;n=!0;const s=this._resolvePointPosition(i.id,t);return{...t,x:s.x,y:s.y,anchor:void 0}});n&&this.documentModel.updateBlock(i.id,{props:{points:o}})}}_getNormalizedFromEvent(e,t){const i=t.getBoundingClientRect();return i.width&&i.height?{x:Pi((e.clientX-i.left)/i.width*100),y:Pi((e.clientY-i.top)/i.height*100)}:null}_getNormalizedFromEventForLink(e,t){const i=this._getReferenceRect(e);return i&&i.width&&i.height?{x:Pi((t.clientX-i.left)/i.width*100),y:Pi((t.clientY-i.top)/i.height*100)}:null}_applySnapping(e,t,i){const n=this.preferences.showGrid&&this.preferences.snapToGrid,o=this.preferences.snapToPoints,s=this.preferences.snapToBlocks;if(!n&&!o&&!s)return{point:t};const r=this._getReferenceRect(e);if(!r||!r.width||!r.height)return{point:t};const l=8/r.width*100,a=8/r.height*100,c=t.x,d=t.y;let u=t.x,h=t.y,p=null,g=null,v=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY;const m=(e,t)=>{const i=Math.abs(c-e);i<=l&&i<v&&(v=i,u=e,p=t??null)},f=(e,t)=>{const i=Math.abs(d-e);i<=a&&i<b&&(b=i,h=e,g=t??null)};if(n){const e=5*Math.round(c/5),t=5*Math.round(d/5);m(e),f(t)}if(o){const t=this._getResolvedPoints(e).filter(e=>e.id!==(null==i?void 0:i.excludePointId));if(t.length)for(const e of t)m(e.x,{kind:"point",id:e.id,x:e.x,y:e.y}),f(e.y,{kind:"point",id:e.id,x:e.x,y:e.y});if(null==i?void 0:i.includeHandles){const t=this._getHandleSnapTargets(e,i.excludeHandle);for(const e of t)m(e.x,e),f(e.y,e)}}if(s){const t=this._getSnapBlocks();for(const i of t){const t=this._getAnchorBaseForLink(e,i.id,"middle-center");if(!t)continue;m(t.x,{kind:"block",id:i.id,x:t.x,y:t.y}),f(t.y,{kind:"block",id:i.id,x:t.x,y:t.y});const n=c-t.x,o=d-t.y;if(Math.abs(n)>=Math.abs(o)){const t=this._getAnchorBaseForLink(e,i.id,"top-center"),n=this._getAnchorBaseForLink(e,i.id,"bottom-center");t&&f(t.y,{kind:"block",id:i.id,x:t.x,y:t.y}),n&&f(n.y,{kind:"block",id:i.id,x:n.x,y:n.y})}else{const t=this._getAnchorBaseForLink(e,i.id,"middle-left"),n=this._getAnchorBaseForLink(e,i.id,"middle-right");t&&m(t.x,{kind:"block",id:i.id,x:t.x,y:t.y}),n&&m(n.x,{kind:"block",id:i.id,x:n.x,y:n.y})}}}const y={x:Pi(u),y:Pi(h)},k=new Set((null==i?void 0:i.connectedPointIds)??this._getConnectedPointIds(e,null==i?void 0:i.currentPointId));let _;if(p){const e=p;("point"!==e.kind||!k.has(e.id))&&(_={..._??{},x:{x:e.x,y1:Math.min(y.y,e.y),y2:Math.max(y.y,e.y)}})}if(g){const e=g;("point"!==e.kind||!k.has(e.id))&&(_={..._??{},y:{y:e.y,x1:Math.min(y.x,e.x),x2:Math.max(y.x,e.x)}})}return{point:y,guide:_}}_getConnectedPointIds(e,t){if(!t)return[];const i=this.documentModel.getBlock(e);if(!i)return[];const n=this._getLinkPoints(i),o=n.findIndex(e=>e.id===t);if(-1===o)return[];const s=[];return o>0&&s.push(n[o-1].id),o<n.length-1&&s.push(n[o+1].id),s}_getConnectedPointIdsForDraw(e){const t=this.documentModel.getBlock(e);if(!t)return[];const i=this._getLinkPoints(t),n=i[i.length-1];return n?[n.id]:[]}_getHandleSnapTargets(e,t){const i=this._getResolvedPoints(e),n=[];for(const o of i)o.handleIn&&(t&&t.pointId===o.id&&"in"===t.handle||n.push({kind:"handle",id:`${o.id}:in`,x:Pi(o.x+o.handleIn.x),y:Pi(o.y+o.handleIn.y)})),o.handleOut&&(t&&t.pointId===o.id&&"out"===t.handle||n.push({kind:"handle",id:`${o.id}:out`,x:Pi(o.x+o.handleOut.x),y:Pi(o.y+o.handleOut.y)}));return n}_getSnapBlocks(){return this.snapBlocksCache||(this.snapBlocksCache=Object.values(this.documentModel.blocks).filter(e=>e&&e.id!==this.documentModel.rootId&&"block-link"!==e.type)),this.snapBlocksCache}_emitSnapGuide(e,t){t?(this.snapGuideBlockId=e,this.eventBus.dispatchEvent("link-snap-guide",{blockId:e,guide:t})):this._clearSnapGuide(e)}_clearSnapGuide(e){if(!this.snapGuideBlockId&&!e)return;const t=e??this.snapGuideBlockId;this.eventBus.dispatchEvent("link-snap-clear",{blockId:t}),e&&e!==this.snapGuideBlockId||(this.snapGuideBlockId=null)}_getRenderScaleForLink(e){const t=this._getReferenceRect(e);return t&&t.width&&t.height?{sx:t.width/100,sy:t.height/100}:null}_getRenderPointFromEvent(e,t){const i=this._getReferenceRect(e);return i&&i.width&&i.height?{x:t.clientX-i.left,y:t.clientY-i.top}:null}_toRenderPoints(e,t){return e.map(e=>this._toRenderPoint(e,t))}_toRenderPoint(e,t){const{sx:i,sy:n}=t;return{...e,x:e.x*i,y:e.y*n,handleIn:e.handleIn?{x:e.handleIn.x*i,y:e.handleIn.y*n}:void 0,handleOut:e.handleOut?{x:e.handleOut.x*i,y:e.handleOut.y*n}:void 0}}_findNearestSegment(e,t){let i=Number.POSITIVE_INFINITY,n=0;for(let o=0;o<e.length-1;o+=1){const s=e[o],r=e[o+1],l=this._distancePointToSegment(t,s,r);l<i&&(i=l,n=o)}return n}_distancePointToSegment(e,t,i){const n=i.x-t.x,o=i.y-t.y;if(0===n&&0===o)return Math.hypot(e.x-t.x,e.y-t.y);const s=((e.x-t.x)*n+(e.y-t.y)*o)/(n*n+o*o),r=Math.max(0,Math.min(1,s)),l=t.x+r*n,a=t.y+r*o;return Math.hypot(e.x-l,e.y-a)}_getBlockIdFromEvent(e){const t=e.composedPath();for(const i of t){if(!(i instanceof HTMLElement))continue;const e=i.getAttribute("block-id");if(e)return e}return null}_isEditingActive(e){return Boolean(this.state.enabled&&this.state.activeLinkId===e)}_getActiveLinkElement(){return this.activeLinkId?this.documentModel.getElement(this.activeLinkId):null}_clampOffset(e){return Number.isNaN(e)?0:Math.max(-100,Math.min(100,e))}_generateLinkPointId(){return`lp-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}}const Bi=e("link-mode-controller");class Di{constructor(){this.animations=[],this.baseDuration=1e3,this.iterations=1e9,this.lastRate=null,this.lastActive=null,this.lastConfigKey=null}getPanelConfig(){return{}}getResolvedProps(e){return{}}update(e){if(this.ensureAnimations(e),!this.animations.length)return;const{active:t,playbackRate:i}=this.computePlayback(e);if(!t)return void(!1!==this.lastActive&&(this.animations.forEach(e=>e.pause()),this.lastActive=!1));(null===this.lastRate||Math.abs(i-this.lastRate)>1e-6)&&(this.applyPlayback(i),this.lastRate=i),!0!==this.lastActive&&(this.startFromEdge(i),this.lastActive=!0)}destroy(){this.resetAnimations()}computePlayback(e){const t=Math.abs(e.speedValue);if(!(e.flowEnabled&&t>0&&e.pathLength>0))return{active:!1,playbackRate:0};const i="reverse"===e.flowDirectionPositive?-1:1,n=(e.speedValue<0?-1:1)*i;return{active:!0,playbackRate:t/e.pathLength*n}}applyPlayback(e){this.animations.forEach(t=>{t.playbackRate=e})}startFromEdge(e){this.animations.forEach(t=>{var i;if(null===t.currentTime){const n=null==(i=t.effect)?void 0:i.getTiming(),o="number"==typeof(null==n?void 0:n.duration)?n.duration:this.baseDuration;t.currentTime=e<0?o:0}t.play()})}ensureAnimations(e){const t=this.getConfigKey(e);if(!(!this.animations.length||this.shouldRebuild(e)||null!==t&&t!==this.lastConfigKey))return;this.resetAnimations();const i=this.createAnimations(e);i.length&&(this.animations=i,this.lastConfigKey=t)}resetAnimations(){this.animations.forEach(e=>e.cancel()),this.animations=[],this.lastRate=null,this.lastActive=null,this.lastConfigKey=null}parseSize(e,t){if("number"==typeof e)return e;if(!e)return t;const i=parseFloat(e);return Number.isNaN(i)?t:i}getConfigKey(e){return null}shouldRebuild(e){return!1}}class $i extends Di{constructor(){super(...arguments),this.particleRef=m()}getDefaultStyle(){return a`
            .link-flow-particle {
                fill: var(--link-flow-color);
                stroke: none;
                stroke-width: 0;
                opacity: 1;
                filter: none;
                offset-rotate: auto;
                pointer-events: none;
            }
        `}getPanelConfig(){return{properties:{groups:[{id:"particle-animation",label:"Particle",traits:[{type:"number",name:"particleSize",label:"Particle Size",min:1,max:48,step:1,description:"Overrides the particle size when set."}]}]},targetStyles:{particle:{label:"Particle",description:"Animated particle style",styles:{groups:["svg"],properties:["effects.opacity","effects.filter"]}}}}}getResolvedProps(e){return{particleSize:e.resolveNumber("particleSize",0)}}render(e){const t={offsetPath:`path('${e.path}')`},{style:i,radius:n}=this.buildParticleStyle(e);return y`
            <g class="link-particle-layer">
                <circle
                    class="link-flow-particle"
                    r=${n}
                    ${f(this.particleRef)}
                    style=${u({...i,...t})}
                ></circle>
            </g>
        `}createAnimations(e){const t=this.particleRef.value;return t?[t.animate([{offsetDistance:"0%"},{offsetDistance:"100%"}],{duration:this.baseDuration,iterations:this.iterations,easing:"linear"})]:[]}shouldRebuild(e){var t;const i=this.particleRef.value;return!i||(1!==this.animations.length||(null==(t=this.animations[0].effect)?void 0:t.target)!==i)}buildParticleStyle(e){var t,i;const n=(null==(t=e.animationStyles)?void 0:t.particle)||{},o=this.parseSize(null==(i=e.animationConfig)?void 0:i.particleSize,0),s=o>0?o:10,r=this.parseSize(s,10);return{style:n,radius:Math.max(1,r/2)}}}var Ri=Object.defineProperty,Oi=Object.getOwnPropertyDescriptor,zi=(e,t,i,n)=>{for(var o,s=n>1?void 0:n?Oi(t,i):t,r=e.length-1;r>=0;r--)(o=e[r])&&(s=(n?o(t,i,s):o(s))||s);return n&&s&&Ri(t,i,s),s};const Ni="particle",Fi={linear:"{{ value | abs }}",slow:"{{ (value | abs) / 3 }}",fast:"{{ (value | abs) * 2 }}"};let Vi=class extends st{constructor(){super(...arguments),this.linkModeState=null,this.linkEditorSelection=null,this.previewPoint=null,this.snapGuide=null,this.pathLength=0,this.gridColor="#000000",this.animation=null,this.animationId=null,this.lastAnimationContext=null,this.linkEditorPreferences={...Ci},this._handleLinkModeChanged=e=>{var t;const i=e.detail;this.linkModeState=i.state,"draw"!==(null==(t=this.linkModeState)?void 0:t.mode)&&(this.previewPoint=null),this.isEditingActive()||(this.snapGuide=null)},this._handleLinkGridColorChanged=e=>{const t=e.detail;this.gridColor=(null==t?void 0:t.color)||"#000000"},this._handleLinkSelectionChanged=e=>{const t=e.detail;this.linkEditorSelection=t.selection}}static registerAnimation(e,t){this.animationRegistry.set(e,t)}getAnimation(e){var t;const i=Vi.animationRegistry.get(e);return i?(this.animation&&this.animationId===e||(null==(t=this.animation)||t.destroy(),this.animation=i.factory(),this.animationId=e),this.animation):null}getAnimationPanelConfig(e){var t;const i=this.getAnimation(e);return(null==(t=null==i?void 0:i.getPanelConfig)?void 0:t.call(i))??null}getAnimationTargetIds(e){const t=this.getAnimationPanelConfig(e);return(null==t?void 0:t.targetStyles)?Object.keys(t.targetStyles):[]}getAnimationResolvedProps(e){const t=this.getAnimation(e);if(!(null==t?void 0:t.getResolvedProps))return{};const i={resolveString:(e,t)=>this.resolveProperty(e,t),resolveNumber:(e,t)=>this.resolvePropertyAsNumber(e,t),resolveBoolean:(e,t=!1)=>this.resolvePropertyAsBoolean(e,t)};return t.getResolvedProps(i)}static getBlockConfig(){return{definition:{label:"Link",icon:'<ha-icon icon="mdi:vector-line"></ha-icon>',internal:!0},defaults:{canChangeLayoutMode:!1,canBeDuplicated:!0,requireEntity:!0,props:{points:[],segments:[],renderStyle:{value:Ni},flowEnabled:{value:!0},flowDirectionPositive:{value:"forward"},speedPreset:{value:"linear"},speedTemplate:{value:Fi.linear},speedSource:{value:"state"},speedAttribute:{value:""},smoothingEnabled:{value:!1},smoothingTension:{value:.15}}},entityDefaults:{mode:"inherited"}}}getPanelConfig(){var e,t;const i=this.block?this.documentModel.getBlock(this.block.id)??this.block:this.block,n=null==(e=null==i?void 0:i.props)?void 0:e.renderStyle,o=void 0!==(null==n?void 0:n.value)?String(n.value):this.resolveProperty("renderStyle",Ni),s=this.getAnimationPanelConfig(o),r=(null==(t=null==s?void 0:s.properties)?void 0:t.groups)??[],l=(null==s?void 0:s.targetStyles)??{},a=[{id:"link-editor",label:"Link Editor",traits:[{type:"action",name:"editLink",label:"Link Editor",buttonLabel:"Edit Link",actionId:"open-link-editor",icon:""}]},{id:"rendering",label:"Rendering",traits:[{type:"select",name:"renderStyle",label:"Style",options:Array.from(Vi.animationRegistry.values()).map(({id:e,label:t})=>({value:e,label:t}))}]}],c={id:"flow",label:"Flow",traits:[{type:"checkbox",name:"flowEnabled",label:"Enable Animation"},{type:"select",name:"flowDirectionPositive",label:"Positive Direction",options:[{value:"forward",label:"Start  End"},{value:"reverse",label:"End  Start"}]},{type:"select",name:"speedPreset",label:"Speed Preset",options:[{value:"linear",label:"Linear"},{value:"slow",label:"Slow"},{value:"fast",label:"Fast"},{value:"custom",label:"Custom"}]},{type:"textarea",name:"speedTemplate",label:"Custom Formula",rows:3,placeholder:"{{ value }}",templateKeywords:L,visible:{prop:"speedPreset",eq:"custom"}},{type:"select",name:"speedSource",label:"Value Source",options:[{value:"state",label:"Entity State"},{value:"attribute",label:"Attribute"}]},{type:"attribute-picker",name:"speedAttribute",label:"Attribute",placeholder:"Enter attribute name",visible:{prop:"speedSource",eq:"attribute"}}]},d={block:{styles:{properties:["layout.show","layout.zIndex"]}},path:{label:"Path",description:"Base path style",styles:{groups:["svg"],properties:["effects.opacity","effects.filter"]}}};return 0===r.length&&0===Object.keys(l).length?{properties:{groups:[...a,c]},targetStyles:d}:{properties:{groups:[...a,...r,c]},targetStyles:{...d,...l}}}connectedCallback(){super.connectedCallback(),this.linkModeState=this.documentModel.getLinkModeState(),this.linkEditorSelection=this.documentModel.getLinkEditorSelection(),this.gridColor=this.documentModel.getLinkGridColor(),this.documentModel.addEventListener("link-mode-changed",this._handleLinkModeChanged),this.documentModel.addEventListener("link-editor-selection-changed",this._handleLinkSelectionChanged),this.documentModel.addEventListener("link-grid-color-changed",this._handleLinkGridColorChanged),this.eventBus.addEventListener("link-preview-move",e=>{var t;e.blockId===(null==(t=this.block)?void 0:t.id)&&(this.previewPoint=e.point)}),this.eventBus.addEventListener("link-preview-clear",e=>{var t;e.blockId&&e.blockId!==(null==(t=this.block)?void 0:t.id)||(this.previewPoint=null)}),this.eventBus.addEventListener("link-snap-guide",e=>{var t;e.blockId===(null==(t=this.block)?void 0:t.id)&&(this.snapGuide=e.guide)}),this.eventBus.addEventListener("link-snap-clear",e=>{var t;e.blockId&&e.blockId!==(null==(t=this.block)?void 0:t.id)||(this.snapGuide=null)}),this.blockUpdateListener=e=>{const t=e.detail;if(!(null==t?void 0:t.block)||!this.block)return;if(t.block.id===this.block.id)return;this.getPoints().map(e=>{var t;return null==(t=e.anchor)?void 0:t.blockId}).filter(Boolean).includes(t.block.id)&&this.requestUpdate()},this.documentModel.addEventListener("block-updated",this.blockUpdateListener)}disconnectedCallback(){var e;this.documentModel.removeEventListener("link-mode-changed",this._handleLinkModeChanged),this.documentModel.removeEventListener("link-editor-selection-changed",this._handleLinkSelectionChanged),this.documentModel.removeEventListener("link-grid-color-changed",this._handleLinkGridColorChanged),this.blockUpdateListener&&this.documentModel.removeEventListener("block-updated",this.blockUpdateListener),null==(e=this.animation)||e.destroy(),this.animation=null,this.animationId=null,this.lastAnimationContext=null,super.disconnectedCallback()}updated(e){var t,i,n,o;super.updated(e);const s=null==(i=null==(t=this.linePath)?void 0:t.getTotalLength)?void 0:i.call(t);"number"==typeof s&&Number.isFinite(s)&&Math.abs(s-this.pathLength)>.1&&(this.pathLength=s),this.classList.toggle("editing-active",this.isEditingActive()),e.has("linkModeState")&&(this.classList.remove(`editing-mode-${(null==(n=e.get("linkModeState"))?void 0:n.mode)??"view"}`),this.classList.add(`editing-mode-${(null==(o=this.linkModeState)?void 0:o.mode)??"view"}`)),this.animation&&this.lastAnimationContext&&this.animation.update(this.lastAnimationContext)}firstUpdated(e){super.firstUpdated(e),this.animation&&this.lastAnimationContext&&this.animation.update(this.lastAnimationContext)}render(){var e,t,i,n;if(!this.block)return d;if(!this.canvasWidth||!this.canvasHeight)return d;const o=this.getResolvedPoints(),s={sx:this.canvasWidth/100,sy:this.canvasHeight/100},r=o.map(e=>this.toRenderPoint(e,s)),l=r.length>1,a=this.resolveProperty("renderStyle",Ni),c=v({"link-svg":!0,[`style-${a}`]:!0}),h=Ai(this.getPoints(),this.getSegments()),p=this.resolvePropertyAsBoolean("smoothingEnabled"),g=this.resolvePropertyAsNumber("smoothingTension",.15),b=this.resolvePropertyAsBoolean("flowEnabled"),m=l?this.buildPath(r,h,p,g):"",f=this.buildSvgStyle(this.getTargetStyle("path"),{color:"var(--link-line-color)",width:"var(--link-line-width)"}),k=this.isEditingActive()&&"edit"===(null==(e=this.linkModeState)?void 0:e.mode),_=v({"link-path":!0,"link-line":!0,"move-enabled":k}),x=k?(null==(t=this.linkEditorSelection)?void 0:t.segmentIndex)??null:null,S=null!==x?this.buildSegmentPath(r,h,x,p,g):"",w=S?{...f,stroke:"var(--link-line-selected-color, var(--accent-color, #0078d4))",color:"var(--link-line-selected-color, var(--accent-color, #0078d4))",strokeWidth:"calc(var(--link-line-width) + 1px)"}:null,I=this.getAnimationTargetIds(a),P={};for(const d of I)P[d]=this.getTargetStyle(d);const A=this.resolveSpeedValue(),T=b&&Math.abs(A)>0,C=this.getAnimation(a),E=this.getAnimationResolvedProps(a),M=null==(n=null==(i=null==C?void 0:C.getDefaultStyle)?void 0:i.call(C))?void 0:n.cssText,L={blockId:this.block.id,path:m,pathLength:this.pathLength,flowEnabled:T,speedValue:A,flowDirectionPositive:this.resolveProperty("flowDirectionPositive","forward"),animationStyles:P,animationConfig:E};return this.lastAnimationContext=L,y`
            <svg class=${c} viewBox="0 0 ${this.canvasWidth} ${this.canvasHeight}" preserveAspectRatio="none" width="${this.canvasWidth}px" height="${this.canvasHeight}px">
                ${M?y`<style>${M}</style>`:d}
                ${this.renderGrid(s)}
                ${this.renderSnapGuides(s)}
                ${l?y`
                        <path
                            class=${_}
                            d=${m}
                            style=${u(f)}
                            @pointerdown=${e=>{var t;return null==(t=this.linkModeController)?void 0:t.startPathDrag(this.block.id,e)}}
                            @contextmenu=${e=>{var t;return null==(t=this.linkModeController)?void 0:t.handleLineContextMenu(this.block.id,e)}}
                        ></path>
                        ${w?y`
                                  <path
                                      class=${v({"link-path":!0,"link-line":!0,selected:!0,"link-element-no-pointer":!0})}
                                      d=${S}
                                      style=${u(w)}
                                  ></path>
                              `:d}
                    `:d}

                ${l&&T&&C&&L?C.render(L):d}

                ${this.renderEditorNodes(r,h)}
            </svg>
        `}updatePositionFromLayoutData(){this.style.left="0px",this.style.top="0px",this.style.width="100%",this.style.height="100%",this.block&&(this.style.zIndex=String(this.block.zIndex??1))}renderEditorNodes(e,t){if(!this.block)return d;if(!this.isEditingActive())return d;if(!this.linkEditorPreferences.showPoints)return d;const i=e.filter(e=>"preview"!==e.id),n=this.linkEditorSelection,o=null==n?void 0:n.pointId,s=null==n?void 0:n.handle;return y`
            <g class="link-nodes link-element-no-pointer">
                ${i.map((e,i)=>{var n;const r=o===e.id,l=Boolean(null==(n=e.anchor)?void 0:n.blockId),a=v({"link-node":!0,selected:r,anchored:l}),c=this.getHandlePosition(e,"out"),u=this.getHandlePosition(e,"in"),h=this.isCurveSegment(t[i]),p=this.isCurveSegment(t[i-1]);return y`
                        ${h?y`
                                  <line class="handle-line" x1=${e.x} y1=${e.y} x2=${c.x} y2=${c.y}></line>
                                  <circle
                                      class=${v({"link-handle":!0,selected:r&&"out"===s})}
                                      cx=${c.x}
                                      cy=${c.y}
                                      r=${5}
                                      @pointerdown=${t=>this.linkModeController.startHandleDrag(this.block.id,t,e.id,"out")}
                                  ></circle>
                              `:d}
                        ${p?y`
                                  <line class="handle-line" x1=${e.x} y1=${e.y} x2=${u.x} y2=${u.y}></line>
                                  <circle
                                      class=${v({"link-handle":!0,selected:r&&"in"===s})}
                                      cx=${u.x}
                                      cy=${u.y}
                                      r=${5}
                                      @pointerdown=${t=>this.linkModeController.startHandleDrag(this.block.id,t,e.id,"in")}
                                  ></circle>
                              `:d}
                        <circle
                            class=${a}
                            cx=${e.x}
                            cy=${e.y}
                            r=${5}
                            @pointerdown=${t=>this.linkModeController.startPointDrag(this.block.id,t,e.id)}
                            @contextmenu=${t=>this.linkModeController.handlePointContextMenu(this.block.id,t,e.id)}
                        ></circle>
                    `})}
            </g>
        `}renderGrid(e){if(!this.isEditingActive())return d;if(!this.linkEditorPreferences.showGrid)return d;const t=[];for(let i=0;i<=100;i+=5){const n=i*e.sx,o=i*e.sy,s=i%10==0,r={stroke:this.gridColor,strokeOpacity:s?"0.50":"0.25"};t.push(y`
                <line
                    class=${v({"grid-line":!0,major:s})}
                    x1=${n}
                    y1="0"
                    x2=${n}
                    y2=${this.canvasHeight}
                    style=${u(r)}
                ></line>
            `),t.push(y`
                <line
                    class=${v({"grid-line":!0,major:s})}
                    x1="0"
                    y1=${o}
                    x2=${this.canvasWidth}
                    y2=${o}
                    style=${u(r)}
                ></line>
            `)}return y`<g class="link-grid">${t}</g>`}renderSnapGuides(e){if(!this.isEditingActive())return d;if(!this.snapGuide)return d;const t=[];return this.snapGuide.x&&t.push(y`
                <line
                    x1=${this.snapGuide.x.x*e.sx}
                    y1=${this.snapGuide.x.y1*e.sy}
                    x2=${this.snapGuide.x.x*e.sx}
                    y2=${this.snapGuide.x.y2*e.sy}
                ></line>
            `),this.snapGuide.y&&t.push(y`
                <line
                    x1=${this.snapGuide.y.x1*e.sx}
                    y1=${this.snapGuide.y.y*e.sy}
                    x2=${this.snapGuide.y.x2*e.sx}
                    y2=${this.snapGuide.y.y*e.sy}
                ></line>
            `),t.length?y`<g class="link-snap-guides">${t}</g>`:d}buildPath(e,t,i,n){if(e.length<2)return"";const o=e[0];let s=`M ${o.x.toFixed(2)} ${o.y.toFixed(2)}`;for(let r=0;r<e.length-1;r+=1){const o=e[r],l=e[r+1],a=t[r];if("curve"===(null==a?void 0:a.type)){const e=this.getHandlePosition(o,"out"),t=this.getHandlePosition(l,"in");s+=` C ${e.x.toFixed(2)} ${e.y.toFixed(2)} ${t.x.toFixed(2)} ${t.y.toFixed(2)} ${l.x.toFixed(2)} ${l.y.toFixed(2)}`;continue}if(i&&e.length>2){const t=e[r-1]??o,i=e[r+2]??l,a=Math.max(0,Math.min(1,1-n))/6,c={x:o.x+(l.x-t.x)*a,y:o.y+(l.y-t.y)*a},d={x:l.x-(i.x-o.x)*a,y:l.y-(i.y-o.y)*a};s+=` C ${c.x.toFixed(2)} ${c.y.toFixed(2)} ${d.x.toFixed(2)} ${d.y.toFixed(2)} ${l.x.toFixed(2)} ${l.y.toFixed(2)}`;continue}s+=` L ${l.x.toFixed(2)} ${l.y.toFixed(2)}`}return s}buildSegmentPath(e,t,i,n,o){if(e.length<2)return"";if(i<0||i>=e.length-1)return"";const s=e[i],r=e[i+1],l=t[i];let a=`M ${s.x.toFixed(2)} ${s.y.toFixed(2)}`;if("curve"===(null==l?void 0:l.type)){const e=this.getHandlePosition(s,"out"),t=this.getHandlePosition(r,"in");return a+=` C ${e.x.toFixed(2)} ${e.y.toFixed(2)} ${t.x.toFixed(2)} ${t.y.toFixed(2)} ${r.x.toFixed(2)} ${r.y.toFixed(2)}`,a}if(n&&e.length>2){const t=e[i-1]??s,n=e[i+2]??r,l=Math.max(0,Math.min(1,1-o))/6,c={x:s.x+(r.x-t.x)*l,y:s.y+(r.y-t.y)*l},d={x:r.x-(n.x-s.x)*l,y:r.y-(n.y-s.y)*l};return a+=` C ${c.x.toFixed(2)} ${c.y.toFixed(2)} ${d.x.toFixed(2)} ${d.y.toFixed(2)} ${r.x.toFixed(2)} ${r.y.toFixed(2)}`,a}return a+=` L ${r.x.toFixed(2)} ${r.y.toFixed(2)}`,a}resolveSpeedValue(){var e;const t=this.resolveProperty("speedPreset","linear"),i="custom"===t?this.resolveProperty("speedTemplate",Fi.linear):Fi[t]??Fi.linear,n=this.getEntityState(),o=this.resolveProperty("speedSource","state"),s=this.resolveProperty("speedAttribute","");let r=null==n?void 0:n.state;"attribute"===o&&s&&(r=this.getEntityAttribute(s));const l=this.toNumber(r);if(!i||""===i.trim())return l;const a=D(n,l),c=this.resolveTemplateString(`link-speed-${(null==(e=this.block)?void 0:e.id)??""}`,i,a);if(c===M)return 0;const d=parseFloat(c);return Number.isNaN(d)?0:d}toNumber(e){if(null==e)return 0;if("number"==typeof e)return e;const t=parseFloat(String(e));return Number.isNaN(t)?0:t}buildSvgStyle(e,t){const i=e.stroke||t.color,n=e.strokeWidth||t.width,o=e.fill??"none",s=e.color||i;return{...e,stroke:i,strokeWidth:n,fill:o,color:s}}isEditingActive(){var e,t;return!!(null==(e=this.linkModeState)?void 0:e.enabled)&&this.linkModeState.activeLinkId===(null==(t=this.block)?void 0:t.id)}getPoints(){var e,t;const i=null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.points;return Array.isArray(i)?i:[]}getSegments(){var e,t;const i=null==(t=null==(e=this.block)?void 0:e.props)?void 0:t.segments;return Array.isArray(i)?i:[]}getResolvedPoints(){var e;const t=this.getPoints().map(e=>({...e})).map(e=>{var t;if(!(null==(t=e.anchor)?void 0:t.blockId))return Ti(e);const i=this.resolveAnchorBase(e);if(!i)return Ti(e);const n=e.anchor.offset??{x:e.x-i.x,y:e.y-i.y};return{...e,x:Pi(i.x+n.x),y:Pi(i.y+n.y)}});return"draw"===(null==(e=this.linkModeState)?void 0:e.mode)&&this.previewPoint&&t.push({id:"preview",x:this.previewPoint.x,y:this.previewPoint.y}),t}toRenderPoint(e,t){return{...e,x:e.x*t.sx,y:e.y*t.sy,handleIn:e.handleIn?{x:e.handleIn.x*t.sx,y:e.handleIn.y*t.sy}:void 0,handleOut:e.handleOut?{x:e.handleOut.x*t.sx,y:e.handleOut.y*t.sy}:void 0}}resolveAnchorBase(e){var t;if(!(null==(t=e.anchor)?void 0:t.blockId))return null;if(!this.documentModel.getBlock(e.anchor.blockId))return null;const i=this.documentModel.getElement(e.anchor.blockId);if(!i)return null;const n=this.renderer.getCanvasElement();if(!n)return null;const o=n.getBoundingClientRect(),s=i.getBoundingClientRect();if(!o.width||!o.height)return null;const r=e.anchor.anchor||"middle-center",{x:l,y:a}=this.getAnchorOffset(r,s);return{x:Pi((l-o.left)/o.width*100),y:Pi((a-o.top)/o.height*100)}}getAnchorOffset(e,t){const i={left:t.left,center:t.left+t.width/2,right:t.right},n={top:t.top,middle:t.top+t.height/2,bottom:t.bottom},[o,s]=e.split("-");return{x:i[s],y:n[o]}}getHandlePosition(e,t){const i="in"===t?e.handleIn:e.handleOut;return i?{x:this.clampRender(e.x+i.x,this.canvasWidth),y:this.clampRender(e.y+i.y,this.canvasHeight)}:{x:e.x,y:e.y}}clampRender(e,t){return Number.isNaN(e)?0:!Number.isFinite(t)||t<=0?e:Math.min(t,Math.max(0,e))}isCurveSegment(e){return"curve"===(null==e?void 0:e.type)}};Vi.animationRegistry=new Map,Vi.styles=[...st.styles,a`
            :host {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                pointer-events: none;
                --link-line-color: var(--text-secondary, rgba(0, 0, 0, 0.35));
                --link-flow-color: var(--accent-color, rgba(33, 150, 243, 0.95));
                --link-line-width: 4px;
            }

            :host(.editing-active.editing-mode-draw) {
                pointer-events: auto;
            }

            svg {
                width: 100%;
                height: 100%;
                display: block;
                pointer-events: none;
            }

            .link-path {
                fill: none;
                vector-effect: non-scaling-stroke;
                pointer-events: visibleStroke;
                stroke-linecap: round;
                stroke-linejoin: round;
            }

            .link-line {
                stroke: var(--link-line-color);
                stroke-width: var(--link-line-width);
            }

            .link-line.move-enabled {
                cursor: move;
            }

            .link-line.selected {
                stroke: var(--link-line-selected-color, var(--accent-color, #0078d4));
            }

            .link-grid {
                pointer-events: none;
            }

            .link-grid line {
                stroke-width: 1px;
                vector-effect: non-scaling-stroke;
            }

            .link-snap-guides {
                pointer-events: none;
            }

            .link-snap-guides line {
                stroke: var(--accent-color, #0078d4);
                stroke-width: 1px;
                stroke-dasharray: 4 4;
                vector-effect: non-scaling-stroke;
            }

            .link-element-no-pointer {
                pointer-events: none;
            }

            .link-node,
            .link-handle {
                pointer-events: all;
                cursor: pointer;
                vector-effect: non-scaling-stroke;
            }

            .link-node {
                fill: #ffffff;
                stroke: #000000;
                stroke-width: 1px;
            }

            .link-node.selected {
                fill: #ff4081;
            }

            .link-node.anchored {
                fill: #ffc107;
            }

            .handle-line {
                stroke: #aaa;
                stroke-width: 2px;
            }

            .link-handle {
                fill: #ffffff;
                stroke: #2196f3;
                stroke-width: 1px;
            }

            .link-handle.selected {
                fill: #ff4081;
                stroke: #8d0734;
            }

        `],zi([c()],Vi.prototype,"linkModeState",2),zi([c()],Vi.prototype,"linkEditorSelection",2),zi([c()],Vi.prototype,"previewPoint",2),zi([c()],Vi.prototype,"snapGuide",2),zi([c()],Vi.prototype,"pathLength",2),zi([c()],Vi.prototype,"gridColor",2),zi([k("path.link-line")],Vi.prototype,"linePath",2),zi([n({context:Bi})],Vi.prototype,"linkModeController",2),zi([n({context:Mi,subscribe:!0})],Vi.prototype,"linkEditorPreferences",2),Vi=zi([p("block-link")],Vi),Vi.registerAnimation("particle",{id:"particle",label:"Particle",factory:()=>new $i}),[{type:"block-text",blockClass:Je},{type:"block-icon",blockClass:Oe},{type:"block-image",blockClass:Xe},{type:"block-container",blockClass:hi},{type:"block-columns",blockClass:yi},{type:"block-drop-zone",blockClass:vi},{type:"block-grid",blockClass:wi},{type:"block-link",blockClass:Vi},{type:"block-entity-field-state",blockClass:mt},{type:"block-entity-field-icon",blockClass:ut},{type:"block-entity-field-name",blockClass:vt},{type:"block-entity-field-attribute",blockClass:ct},{type:"block-entity-field-image",blockClass:pt},{type:"block-button-toggle",blockClass:Ct},{type:"block-select-menu",blockClass:Bt},{type:"block-slider",blockClass:zt}].forEach(({type:e,blockClass:t})=>{const i=t.getBlockConfig();i?Ft.register(e,t,i):console.warn(`[BlockRegistry] Block class "${e}" does not provide getBlockConfig()`)});const ji="card_builder",Hi=`${ji}/cards`;class Wi{constructor(e){this.hass=e}async listCards(){return this.hass.callWS({type:`${Hi}/list`})}async getCard(e){return(await this.listCards()).find(t=>t.id===e)}async createCard(e){return this.hass.callWS({type:`${Hi}/create`,...e})}async updateCard(e,t){return this.hass.callWS({type:`${Hi}/update`,card_id:e,...t})}async deleteCard(e){await this.hass.callWS({type:`${Hi}/delete`,card_id:e})}async subscribeToUpdates(e){return await this.hass.connection.subscribeMessage(()=>{e()},{type:`${Hi}/subscribe`})}}const Ui=`${ji}/style_presets`;class Gi{constructor(e){this.hass=e,this.cache=new Map,this.initialized=!1,this.subscribers=new Set,this.unsubscribe=null}async initialize(){this.initialized||(await this.loadPresets(),await this.subscribeToUpdates(),this.initialized=!0)}dispose(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.cache.clear(),this.subscribers.clear(),this.initialized=!1}async loadPresets(){const e=await this.hass.callWS({type:`${Ui}/list`});this.cache.clear();for(const t of e)this.cache.set(t.id,t);return e}getAllPresets(){return Array.from(this.cache.values())}getCachedPreset(e){return this.cache.get(e)}async getPreset(e){try{const t=await this.hass.callWS({type:`${Ui}/get`,preset_id:e});return this.cache.set(t.id,t),t}catch{return}}async createPreset(e){const t=await this.hass.callWS({type:`${Ui}/create`,name:e.name,description:e.description||"",extends_preset_id:e.extendsPresetId,data:e.data});return this.cache.set(t.id,t),this.notifySubscribers(),t}async updatePreset(e,t){const i=await this.hass.callWS({type:`${Ui}/update`,preset_id:e,...t});return this.cache.set(i.id,i),this.notifySubscribers(),i}async deletePreset(e){await this.hass.callWS({type:`${Ui}/delete`,preset_id:e}),this.cache.delete(e),this.notifySubscribers()}subscribe(e){return this.subscribers.add(e),e(this.getAllPresets()),()=>{this.subscribers.delete(e)}}hasPreset(e){return this.cache.has(e)}getChildPresets(e){return this.getAllPresets().filter(t=>t.extendsPresetId===e)}getInheritanceChain(e){const t=[],i=new Set;let n=e;for(;n&&!i.has(n);){i.add(n);const e=this.cache.get(n);if(!e)break;t.unshift(e),n=e.extendsPresetId}return t}async subscribeToUpdates(){try{this.unsubscribe=await this.hass.connection.subscribeMessage(e=>{e.preset&&(this.cache.set(e.preset.id,e.preset),this.notifySubscribers())},{type:`${Ui}/subscribe`})}catch(e){console.warn("[StylePresetService] Failed to subscribe to updates:",e)}}notifySubscribers(){const e=this.getAllPresets();for(const i of this.subscribers)try{i(e)}catch(t){console.error("[StylePresetService] Subscriber error:",t)}}}let qi=null,Zi=null;function Yi(e){return qi&&qi.hass===e||(qi=new Wi(e)),qi}async function Xi(e){return Zi&&Zi.hass===e||(Zi=new Gi(e),await Zi.initialize()),Zi}function Ki(e){const t=e.slots;if(!t||"object"!=typeof t||Array.isArray(t))return{...e,slots:{entities:{},actions:{}}};if("entities"in t){const i=t,n=i.actions??function(e){const t=Object.entries(e);if(0===t.length)return{};const i={action:"none"};return t.reduce((e,[t,n])=>{const o=n.id||t;return e[o]={id:o,name:n.name,description:n.description,trigger:"tap",action:i},e},{})}(i.targets??{});return{...e,slots:{entities:i.entities??{},actions:n}}}return{...e,slots:{entities:t,actions:{}}}}function Ji(e){return("number"==typeof e.version?e.version:1)<3}function Qi(e){const t=e.version,i=t<3;let n={...e};return t<2&&(n=function(e){const t=e.blocks;if(!t||"object"!=typeof t)return{...e};let i=!1;const n={...t};for(const[o,s]of Object.entries(t)){if(!s||"object"!=typeof s)continue;const e=s,t="deviceStyles"in e||"stylePresetId"in e||"styleSlots"in e;let r=e,l=e.styles?{...e.styles}:void 0,a=!1;if(e.deviceStyles||e.stylePresetId){const t={...(null==l?void 0:l.block)||{}};let i=!1;void 0===t.stylePresetId&&void 0!==e.stylePresetId&&(t.stylePresetId=e.stylePresetId,i=!0),void 0===t.containers&&void 0!==e.deviceStyles&&(t.containers=e.deviceStyles,i=!0),i&&(l={...l||{},block:t},a=!0)}if(e.styleSlots&&"object"==typeof e.styleSlots)for(const[i,n]of Object.entries(e.styleSlots)){if(!i||!n||"object"!=typeof n)continue;const e={...(null==l?void 0:l[i])||{}};let t=!1;void 0===e.stylePresetId&&void 0!==n.stylePresetId&&(e.stylePresetId=n.stylePresetId,t=!0),void 0===e.containers&&void 0!==n.deviceStyles&&(e.containers=n.deviceStyles,t=!0),t&&(l={...l||{},[i]:e},a=!0)}(a||t)&&(r={...e},a&&(r.styles=l),t&&(delete r.deviceStyles,delete r.stylePresetId,delete r.styleSlots),n[o]=r,i=!0)}return i?{...e,blocks:n}:{...e}}(n)),t<3&&(n=Ki(n)),n={...n,version:3},{config:n,fromVersion:t,toVersion:3,migrated:i}}class en{constructor(){this._registry=new Map,this._isBooted=!1}define(e,t){this._registry.set(e,t),this._isBooted&&this.registerTag(e,t)}boot(){this._isBooted=!0,this._registry.forEach((e,t)=>{this.registerTag(t,e)})}registerTag(e,t){customElements.get(e)||customElements.define(e,t)}}const tn=50,nn=50,on="top-left",sn="px",rn=e=>"number"==typeof e&&!Number.isNaN(e),ln=(e,t)=>rn(e)?e:t,an=e=>{var t,i,n,o,s,r,l,a,c,d;const u=(e=>{const t=(null==e?void 0:e.anchor)??on,i=(null==e?void 0:e.originPoint)??t,n=(null==e?void 0:e.unitSystem)??sn;return{x:rn(null==e?void 0:e.x)?e.x:tn,y:rn(null==e?void 0:e.y)?e.y:nn,anchor:t,originPoint:i,unitSystem:n}})(null==(i=null==(t=e._internal)?void 0:t.position_config)?void 0:i.value);return{position:{x:ln(null==(o=null==(n=e.layout)?void 0:n.positionX)?void 0:o.value,u.x),y:ln(null==(r=null==(s=e.layout)?void 0:s.positionY)?void 0:r.value,u.y)},size:{width:ln(null==(a=null==(l=e.size)?void 0:l.width)?void 0:a.value,0),height:ln(null==(d=null==(c=e.size)?void 0:c.height)?void 0:d.value,0)},positionConfig:u}};function cn(e,t){const{width:i,height:n}=t;switch(e){case"top-left":return{x:0,y:0};case"top-center":return{x:i/2,y:0};case"top-right":return{x:i,y:0};case"middle-left":return{x:0,y:n/2};case"middle-center":return{x:i/2,y:n/2};case"middle-right":return{x:i,y:n/2};case"bottom-left":return{x:0,y:n};case"bottom-center":return{x:i/2,y:n};case"bottom-right":return{x:i,y:n}}}class dn{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}toMoveableSpace(e){const{anchorPoint:t,originPoint:i,unitSystem:n,x:o,y:s}=e;let r=o,l=s;"%"===n&&(r=o/100*this.config.containerSize.width,l=s/100*this.config.containerSize.height),t.includes("right")&&(r=-r),t.includes("bottom")&&(l=-l);const a=cn(t,this.config.containerSize),c=cn(i,this.config.elementSize);return{x:a.x+r-c.x,y:a.y+l-c.y}}fromMoveableSpace(e){const{anchorPoint:t,originPoint:i,unitSystem:n}=this.config,o=cn(i,this.config.containerSize),s=cn(i,this.config.elementSize);let r=e.x-o.x+s.x,l=e.y-o.y+s.y;t.includes("right")&&(r=-r),t.includes("bottom")&&(l=-l);let a=r,c=l;return"%"===n?(a=r/this.config.containerSize.width*100,c=l/this.config.containerSize.height*100,a=Math.round(100*a)/100,c=Math.round(100*c)/100):(a=Math.round(a),c=Math.round(c)),{x:a,y:c,anchorPoint:t,originPoint:i,unitSystem:n}}convertUnits(e,t){if(e.unitSystem===t)return e;const i=this.toMoveableSpace(e),n={...this.config,unitSystem:t};return new dn(n).fromMoveableSpace(i)}convertAnchor(e,t,i){const n=this.toMoveableSpace(e),o={...this.config,anchorPoint:t,originPoint:i||t};return new dn(o).fromMoveableSpace(n)}clampToContainer(e){const t=this.config.containerSize.width-this.config.elementSize.width,i=this.config.containerSize.height-this.config.elementSize.height;return{x:Math.max(0,Math.min(e.x,t)),y:Math.max(0,Math.min(e.y,i))}}getConfig(){return{...this.config}}}class un{constructor(){this.subscriptions=new Map,this.previousStates=new Map}setHass(e){const t=this.hass;if(this.hass=e,t)for(const i of this.subscriptions.keys()){const t=this.previousStates.get(i),n=e.states[i];t!==n&&(this.previousStates.set(i,n),this.notifySubscribers(i,n,t))}else for(const i of this.subscriptions.keys())this.previousStates.set(i,e.states[i])}getHass(){return this.hass}subscribe(e,t){return this.subscriptions.has(e)||(this.subscriptions.set(e,new Set),this.hass&&this.previousStates.set(e,this.hass.states[e])),this.subscriptions.get(e).add(t),()=>{const i=this.subscriptions.get(e);null==i||i.delete(t),0===(null==i?void 0:i.size)&&(this.subscriptions.delete(e),this.previousStates.delete(e))}}subscribeMultiple(e,t){const i=e.map(e=>this.subscribe(e,t));return()=>{i.forEach(e=>e())}}isSubscribed(e){return this.subscriptions.has(e)}getSubscribedEntities(){return Array.from(this.subscriptions.keys())}getSubscriberCount(e){var t;return(null==(t=this.subscriptions.get(e))?void 0:t.size)??0}getEntityState(e){var t;return null==(t=this.hass)?void 0:t.states[e]}clear(){this.subscriptions.clear(),this.previousStates.clear()}notifySubscribers(e,t,i){const n=this.subscriptions.get(e);if(n)for(const s of n)try{s(e,t,i)}catch(o){console.error(`[EntitySubscriptionManager] Error in callback for ${e}:`,o)}}}var hn=Object.defineProperty,pn=(e,t,i,n)=>{for(var o,s=void 0,r=e.length-1;r>=0;r--)(o=e[r])&&(s=o(t,i,s)||s);return s&&hn(t,i,s),s};const gn=class extends t{constructor(){super(...arguments),this.rendererManager=this,this.rootBlocks=[],this.overflowShow=!0,this.canvas=null,this.canvasFlowContainer=null,this.entitySubscriptionManager=new un,this.resizeObserver=null,this.blockEntityUnsubscribers=new Map,this.canvasStyleProperties=["background.boxShadow","border.borderRadius","typography.fontFamily","typography.fontSize","typography.fontWeight","typography.fontStyle","typography.lineHeight","typography.letterSpacing","typography.textAlign","typography.textDecoration","typography.textTransform","typography.textShadow","typography.whiteSpace","typography.color","animations.motion"]}renderBlock(e){if(!customElements.get(e.type))throw new Error(`Block type "${e.type}" not registered as custom element`);return this.doBlockRender(e,{tag:_(e.type)})}connectedCallback(){var e,t,i;super.connectedCallback(),this.activeContainerId=this.containerManager.getActiveContainerId(),this.overflowShow=(null==(i=null==(t=null==(e=this.documentModel.getBlock(this.documentModel.rootId))?void 0:e.props)?void 0:t.overflow_show)?void 0:i.value)??!0,this.setupResizeObserver(),this.templateUpdateUnsubscribe=this.eventBus.addEventListener("template-updated",()=>{this.requestUpdate()})}disconnectedCallback(){super.disconnectedCallback();for(const e of this.blockEntityUnsubscribers.values())e();this.templateUpdateUnsubscribe&&(this.templateUpdateUnsubscribe(),this.templateUpdateUnsubscribe=void 0),this.resizeObserver&&this.resizeObserver.disconnect(),this.blockEntityUnsubscribers.clear(),this.entitySubscriptionManager.clear(),this.documentModel.registerElement(this.documentModel.rootId,void 0)}shouldUpdate(e){var t,i;if(e.has("hass")&&1===e.size){const i=e.get("hass");if(!i)return!0;const n=this.documentModel.getTrackedEntitiesRecursiveFlat(this.documentModel.getBlock(this.documentModel.rootId));if(0===n.length)return!1;for(const e of n){if(i.states[e]!==(null==(t=this.hass)?void 0:t.states[e]))return!0}return!1}return(null==(i=super.shouldUpdate)?void 0:i.call(this,e))??!0}async updated(e){var t;e.has("hass")&&this.hass&&this.entitySubscriptionManager.setHass(this.hass),null==(t=this.canvas)||t.style.setProperty("overflow",this.overflowShow?"visible":"hidden"),super.updated(e)}setupResizeObserver(){this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(e=>{for(const t of e){const{width:e,height:i}=t.contentRect,n=this.canvasWidth!==e||this.canvasHeight!==i;this.canvasWidth=e,this.canvasHeight=i,n&&(this.eventBus.dispatchEvent("canvas-size-changed",{width:e,height:i}),this.canvasSizeChanged(),this.requestUpdate())}}),this.updateComplete.then(()=>{if(this.canvas){this.resizeObserver.observe(this.canvas);const e=this.canvas.getBoundingClientRect();e.width>0&&e.height>0&&(this.canvasWidth=e.width,this.canvasHeight=e.height,this.eventBus.dispatchEvent("canvas-size-changed",{width:this.canvasWidth,height:this.canvasHeight}))}})}getRenderData(e={}){var t,i,n,o,s,r,l;const a=this.rootBlocks.filter(e=>"absolute"===e.layout),c=this.rootBlocks.filter(e=>"static"===e.layout),d=this.rootBlocks.filter(e=>"flow"===e.layout).sort((e,t)=>e.order-t.order),u=this.documentModel.resolveEntityForBlock(this.documentModel.rootId),h=this.resolveBlockStyles(this.documentModel.getBlock(this.documentModel.rootId),this.activeContainerId,{defaultEntityId:u.entityId}),p=ei(h,{filter:{only:{properties:this.canvasStyleProperties}},append:e}),g=ei(h,{filter:{exclude:{properties:this.canvasStyleProperties}}}),v={};((null==(t=h.background)?void 0:t.background)||(null==(i=h.background)?void 0:i.backgroundColor)||(null==(n=h.background)?void 0:n.backgroundImage))&&(v["--ha-card-background"]="transparent"),(null==(o=h.border)?void 0:o.borderStyle)&&"none"!==(null==(s=h.border)?void 0:s.borderStyle.value)&&(v["--ha-card-border-color"]="transparent",v["--ha-card-border-width"]="0"),(null==(r=h.border)?void 0:r.borderRadius)&&(v["--ha-card-border-radius"]=null==(l=h.border)?void 0:l.borderRadius.value);return{absoluteBlocks:a,staticBlocks:c,flowBlocks:d,haCardStyles:ei(h,{filter:{only:{properties:["border.borderRadius"]}},append:{...v,...e}}),canvasStyles:p,canvasFlowContainerStyles:g}}resolveBlockStyles(e,t=this.activeContainerId,i,n){return this.styleResolver.resolve(e.id,t,i,!0,n)}resolvedRenderContext(e,t=null,i){const n={defaultEntityId:this.documentModel.resolveEntityForBlock(e.id).entityId};t=t??this.resolveBlockStyles(e,this.activeContainerId,n);const o=an(t),s=this.blockRegistry.getBlockStyleOutputConfig(e),r=s?ei(t,{outputMode:s,varPrefix:s.varPrefix??"block"}):ei(t),l={},a=i?Object.keys(i).filter(e=>"block"!==e):[];if(a.length>0)for(const d of a){const t=this.styleResolver.resolve(e.id,this.activeContainerId,n,!0,d),i=this.blockRegistry.getBlockStyleOutputConfig(e,d);l[d]=i?ei(t,{outputMode:i,varPrefix:i.varPrefix??"block"}):ei(t)}const c={zIndex:String(e.zIndex||"auto")};return Object.assign(c,r),{canvasWidth:this.canvasWidth,canvasHeight:this.canvasHeight,resolved:t,layoutData:o,styles:c,targetStyles:l}}computeAbsoluteBlockSize(e){const t=this.documentModel.getElement(e);if(!t)return;const i=t.getBoundingClientRect();return{width:i.width,height:i.height}}getRuntimeBlockSize(e,t){if(t.size.width&&t.size.height)return t.size;return this.computeAbsoluteBlockSize(e.id)??t.size}canvasSizeChanged(){}getCanvasElement(){return this.canvas}blockToMoveable(e,t,i,n){if("%"===e.positionConfig.unitSystem&&i&&n){const o={containerSize:{width:i,height:n},elementSize:{width:t.width,height:t.height},anchorPoint:e.positionConfig.anchor,originPoint:e.positionConfig.originPoint,unitSystem:e.positionConfig.unitSystem},s=new dn(o),r={x:e.positionConfig.x,y:e.positionConfig.y,anchorPoint:e.positionConfig.anchor,originPoint:e.positionConfig.originPoint,unitSystem:e.positionConfig.unitSystem},l=s.toMoveableSpace(r);return{left:l.x,top:l.y}}return{left:e.position.x,top:e.position.y}}moveableToBlock(e,t,i,n,o){const s={x:e.left,y:e.top},r={containerSize:{width:n,height:o},elementSize:{width:i.width,height:i.height},anchorPoint:t.anchor,originPoint:t.originPoint,unitSystem:t.unitSystem},l=new dn(r).fromMoveableSpace(s);return{position:{x:Math.round(s.x),y:Math.round(s.y)},positionConfig:{anchor:l.anchorPoint,x:l.x,y:l.y,unitSystem:l.unitSystem,originPoint:l.originPoint??l.anchorPoint}}}moveableResizeToBlock(e,t,i,n,o){const s={x:e.left,y:e.top},r={containerSize:{width:n,height:o},elementSize:{width:t.width,height:t.height},anchorPoint:i.anchor,originPoint:i.originPoint,unitSystem:i.unitSystem},l=new dn(r).fromMoveableSpace(s);return{position:{x:Math.round(s.x),y:Math.round(s.y)},size:t,positionConfig:{anchor:l.anchorPoint,x:l.x,y:l.y,unitSystem:l.unitSystem,originPoint:l.originPoint??l.anchorPoint}}}subscribeBlockEntities(e,t){if(this.unsubscribeBlockEntities(e),0===t.length)return;const i=this.entitySubscriptionManager.subscribeMultiple(t,e=>this.handleBlockEntityChange(e));this.blockEntityUnsubscribers.set(e,i)}unsubscribeBlockEntities(e){const t=this.blockEntityUnsubscribers.get(e);t&&(t(),this.blockEntityUnsubscribers.delete(e))}handleBlockEntityChange(e){this.requestUpdate()}};gn.styles=[a`
            .canvas {
                min-height: 1px;
                position: relative;
                background: var(--ha-card-background, var(--bg-primary));
                border-radius: var(--ha-card-border-radius, var(--ha-border-radius-lg));
                box-sizing: border-box;
                overflow: hidden;
                z-index: 0;
            }

            .canvas-flow-container {
                border-radius: inherit;
                box-sizing: border-box;
                inset: 0;
                display: flex;
                flex-direction: column;
                padding: 20px;
            }
        `];let vn=gn;pn([n({context:Y})],vn.prototype,"documentModel"),pn([n({context:Vt})],vn.prototype,"blockRegistry"),pn([n({context:ie})],vn.prototype,"containerManager"),pn([n({context:ai})],vn.prototype,"styleResolver"),pn([n({context:J})],vn.prototype,"eventBus"),pn([x({context:C})],vn.prototype,"rendererManager"),pn([n({context:Ee,subscribe:!0}),i({attribute:!1})],vn.prototype,"hass"),pn([c()],vn.prototype,"rootBlocks"),pn([c()],vn.prototype,"activeContainerId"),pn([c()],vn.prototype,"canvasWidth"),pn([c()],vn.prototype,"canvasHeight"),pn([c()],vn.prototype,"overflowShow");export{Ee as A,O as B,en as C,Si as D,Z as E,Ft as F,te as G,$ as H,Q as I,Ci as J,Pe as K,Li as L,Qi as M,Ei as N,Ae as O,dn as P,Yi as Q,Ji as R,jt as S,q as T,Y as a,Vt as b,et as c,se as d,J as e,Ai as f,Ue as g,Ge as h,Fe as i,D as j,L as k,Mi as l,Bi as m,Xi as n,an as o,Ve as p,Jt as q,Qt as r,ie as s,ai as t,vn as u,ii as v,ze as w,We as x,qe as y,Ze as z};